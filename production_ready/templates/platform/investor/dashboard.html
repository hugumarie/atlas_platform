{% extends "platform/base.html" %}

{% block title %}Tableau de bord - Atlas{% endblock %}

{% block page_title %}Tableau de bord{% endblock %}

{% block content %}


<!-- Ancien popup supprim√© - Les prospects passent maintenant par /plateforme/choisir-plan -->
{% if false %} 
<div class="prospect-welcome-overlay" id="prospectOverlay">
    <div class="prospect-welcome-popup">
        <div class="popup-header">
            <div class="popup-logo">
                <div class="popup-logo-icon">A</div>
                <span class="popup-logo-text">Atlas</span>
            </div>
            <h2 class="popup-title">Bienvenue sur la plateforme Atlas !</h2>
            <p class="popup-subtitle">Veuillez choisir votre plan pour acc√©der √† toutes les fonctionnalit√©s</p>
        </div>
        
        <div class="popup-plans">
            <div class="plan-card" data-plan="initia">
                <div class="plan-header">
                    <h3 class="plan-name">INITIA</h3>
                    <p class="plan-tagline">Pour d√©buter sereinement</p>
                </div>
                <div class="plan-price">
                    <span class="price-amount">24,99‚Ç¨</span>
                    <span class="price-period">/mois</span>
                </div>
                <div class="plan-features">
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Suivi de patrimoine en temps r√©el</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Plans d'investissement personnalis√©s</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Analyses de risque</span>
                    </div>
                </div>
                <button class="plan-button" onclick="allerVersPaiement('initia')">Choisir INITIA</button>
            </div>
            
            <div class="plan-card plan-popular" data-plan="optima">
                <div class="plan-popular-badge">POPULAIRE</div>
                <div class="plan-header">
                    <h3 class="plan-name">OPTIMA</h3>
                    <p class="plan-tagline">Pour structurer votre patrimoine</p>
                </div>
                <div class="plan-price">
                    <span class="price-amount">49,99‚Ç¨</span>
                    <span class="price-period">/mois</span>
                </div>
                <div class="plan-features">
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Tout d'INITIA inclus</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Conseils d'experts d√©di√©s</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Optimisation fiscale avanc√©e</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Rapports PDF d√©taill√©s</span>
                    </div>
                </div>
                <button class="plan-button" onclick="allerVersPaiement('optima')">Choisir OPTIMA</button>
            </div>
        </div>
        
        <!-- √âtape 2 : Paiement (masqu√©e par d√©faut) -->
        <div id="paiementStep" style="display: none;">
            <div class="popup-header">
                <div class="popup-logo">
                    <div class="popup-logo-icon">A</div>
                    <span class="popup-logo-text">Atlas</span>
                </div>
                <h2 class="popup-title">Finaliser votre abonnement</h2>
                <p class="popup-subtitle">Plan s√©lectionn√© : <span id="selectedPlanName">INITIA</span></p>
            </div>
            
            <div class="payment-form" style="padding: 30px;">
                <form id="paymentForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Num√©ro de carte</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required
                               style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Expiration</label>
                            <input type="text" id="cardExpiry" placeholder="MM/AA" maxlength="5" required
                                   style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">CVV</label>
                            <input type="text" id="cardCvv" placeholder="123" maxlength="4" required
                                   style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Nom du porteur</label>
                        <input type="text" id="cardName" placeholder="Nom sur la carte" required
                               style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button type="button" onclick="retourAuxPlans()" style="flex: 1; background: #f5f5f5; color: #333; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚Üê Retour
                        </button>
                        <button type="submit" id="payButton" style="flex: 2; background: linear-gradient(135deg, #137C8B 0%, #0EA5E9 100%); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            Finaliser - <span id="planPrice">24,99‚Ç¨</span>/mois
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Overlay flout√© pour le dashboard -->
<div class="dashboard-blur-overlay" id="dashboardBlur">
{% endif %}
<!-- Section principale avec les deux nouvelles bo√Ætes -->
<div class="dashboard-new-section">
    <!-- Bo√Æte Patrimoine (1/3 gauche) -->
    <div class="dashboard-card patrimoine-card">
        <div class="card-header">
            <h3>Patrimoine total net</h3>
            <a href="{{ url_for('platform_investor.investor_data') }}" class="card-action-btn" title="Voir les donn√©es investisseur">
                <i class="fas fa-eye"></i>
            </a>
        </div>
        <div class="card-body">
            <div class="patrimoine-value">
                {% if patrimoine_total_net and patrimoine_total_net > 0 %}
                    {{ "{:,.0f}".format(patrimoine_total_net) }}‚Ç¨
                {% else %}
                    0‚Ç¨
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bo√Æte Actions √† R√©aliser (2/3 droite) -->
    <div class="dashboard-card actions-card">
        <div class="card-header">
            <h3>Actions √† r√©aliser</h3>
        </div>
        <div class="card-body">
            <div class="no-actions">
                <div class="no-actions-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="no-actions-text">
                    <h4>Aucune action √† r√©aliser</h4>
                    <p>Votre portefeuille est √† jour</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- M√©triques principales - Design moderne une par ligne -->
<div class="modern-metrics-container mb-4">
</div>

<!-- Bo√Æte Plan d'investissement -->
<div class="platform-card mb-4">
    <div class="platform-card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="platform-card-title">
            <i class="fas fa-chart-pie text-primary"></i>
            Plan d'investissement
        </h3>
        <a href="{{ url_for('platform_investor.investment_plan') }}" class="platform-eye-btn" title="Voir le plan d'investissement">
            <i class="fas fa-eye"></i>
        </a>
    </div>
    <div class="platform-card-body">
        {% if investment_plan and investment_plan.lines %}
            <div class="investment-plan-content">
                {% for line in investment_plan.lines|sort(attribute='order_index') %}
                <div class="plan-investment-item">
                    <div class="plan-investment-info">
                        <div class="plan-investment-name">
                            <span class="plan-investment-envelope">{{ line.support_envelope }}</span>
                            {{ line.description }}
                            {% if line.reference %}
                            <span class="plan-investment-reference">{{ line.reference }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="plan-investment-allocation">
                        <span class="plan-allocation-percentage">{{ line.percentage }}%</span>
                        <span class="plan-allocation-amount">{{ "%.0f"|format(line.computed_amount) }}‚Ç¨</span>
                    </div>
                </div>
                {% endfor %}
                
                {% if investment_plan.lines|length > 5 %}
                <div class="plan-investment-more">
                    <span>+ {{ investment_plan.lines|length - 5 }} autres investissements</span>
                </div>
                {% endif %}
                
                <div class="plan-total-section">
                    <span class="plan-total-label">Total mensuel allou√©</span>
                    <span class="plan-total-value">{{ "%.0f"|format(investment_plan.lines|sum(attribute='computed_amount')) }}‚Ç¨</span>
                </div>
            </div>
        {% else %}
            <div class="no-plan-configured">
                <div class="no-plan-configured-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="no-plan-configured-text">
                    <h4>Aucun plan configur√©</h4>
                    <p>Contactez votre conseiller pour configurer votre plan d'investissement personnalis√©</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Barre de progression √©pargne annuelle -->
<div class="platform-card mb-4">
    <div class="platform-card-header">
        <h3 class="platform-card-title">
            <i class="fas fa-calendar-alt text-primary"></i>
            {% set has_data = current_user.investor_profile and current_user.investor_profile.monthly_savings_capacity and current_user.investor_profile.monthly_savings_capacity > 0 %}
            {% if has_data %}
            Objectif d'√©pargne annuelle
            {% else %}
            D√©finissez vos objectifs
            {% endif %}
        </h3>
        {% if has_data %}
        <p class="platform-card-subtitle">Progression depuis votre inscription</p>
        {% elif current_user.is_prospect_type() %}
        <p class="platform-card-subtitle">Personnalisez votre strat√©gie d'√©pargne</p>
        {% else %}
        <p class="platform-card-subtitle">Compl√©tez votre profil investisseur</p>
        {% endif %}
    </div>
    <div class="platform-card-body">
        <div class="savings-progress-container">
            <div class="savings-progress-info">
                <div class="savings-current">
                    <span class="savings-amount" id="currentYearlySavings">0‚Ç¨</span>
                    <span class="savings-label">√âpargn√© cette ann√©e</span>
                </div>
                <div class="savings-target">
                    {% set has_data = current_user.investor_profile and current_user.investor_profile.monthly_savings_capacity and current_user.investor_profile.monthly_savings_capacity > 0 %}
                    {% if has_data %}
                    <span class="savings-amount" id="targetYearlySavings">{{ "{:,.0f}".format(current_user.investor_profile.monthly_savings_capacity * 12) }}‚Ç¨</span>
                    <span class="savings-label">Objectif annuel</span>
                    {% else %}
                    <span class="savings-amount" id="targetYearlySavings">Objectif √† d√©finir</span>
                    <span class="savings-label">{% if current_user.is_prospect_type() %}Apr√®s souscription{% else %}Compl√©tez votre profil{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            <div class="savings-progress-bar">
                <div class="savings-progress-track">
                    <div class="savings-progress-fill" id="savingsProgressFill"></div>
                </div>
                <div class="savings-progress-percentage" id="savingsProgressPercentage">0%</div>
            </div>
        </div>
    </div>
</div>

<!-- R√©partition des actifs moderne -->
<div class="modern-portfolio-card">
    <div class="portfolio-header">
        <div class="portfolio-header-content">
            <div class="portfolio-title-section">
                {% set has_portfolio_data = patrimoine_total_net and patrimoine_total_net > 0 %}
                {% if has_portfolio_data %}
                <h3 class="portfolio-title">R√©partition de vos actifs</h3>
                <p class="portfolio-subtitle">Diversification de votre portefeuille</p>
                {% elif current_user.is_prospect_type() %}
                <h3 class="portfolio-title">Votre futur portefeuille</h3>
                <p class="portfolio-subtitle">Apr√®s souscription √† Atlas</p>
                {% else %}
                <h3 class="portfolio-title">Votre portefeuille</h3>
                <p class="portfolio-subtitle">Ajoutez vos actifs pour voir la r√©partition</p>
                {% endif %}
            </div>
        </div>
        <div class="portfolio-total">
            <span class="total-label">Total</span>
            {% if has_portfolio_data %}
            <span class="total-value" id="portfolioTotal">{{ "{:,.0f}".format(patrimoine_total_net) }}‚Ç¨</span>
            {% else %}
            <span class="total-value" id="portfolioTotal">0‚Ç¨</span>
            {% endif %}
        </div>
    </div>
    <div class="portfolio-content">
        <div class="portfolio-chart-container">
            <div class="portfolio-chart">
                <canvas id="portfolioChart"></canvas>
            </div>
            <div class="portfolio-legend" id="portfolioLegend">
                <!-- L√©gende g√©n√©r√©e dynamiquement -->
            </div>
        </div>
    </div>
</div>

<!-- Fermeture de l'overlay flout√© si pr√©sent -->
{% if current_user.user_type == 'prospect' %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// TEST IMM√âDIAT - S'EX√âCUTE D√àS LE CHARGEMENT
alert("SCRIPT CHARG√â !");
document.body.style.backgroundColor = "red";
console.log("EMAIL:", "{{ current_user.email }}");

// Debug visuel temporaire
{% if current_user.user_type == 'prospect' %}
console.log("üéØ POPUP DEVRAIT S'AFFICHER ! (prospect d√©tect√©)");
document.body.style.border = "5px solid red";
setTimeout(() => {
    alert("DEBUG: Prospect d√©tect√© ! Le popup devrait s'afficher.");
}, 2000);
{% else %}
console.log("‚ùå Pas un prospect, type:", "{{ current_user.user_type }}");
{% endif %}

// Fonction pour revenir au choix des plans
function retourAuxPlans() {
    // Masquer l'√©tape de paiement
    document.getElementById('paiementStep').style.display = 'none';
    
    // R√©afficher l'√©tape de choix de plans
    document.querySelector('.popup-plans').style.display = 'flex';
    document.querySelector('.popup-plans').previousElementSibling.style.display = 'block';
}

// Configuration du formulaire de paiement
function setupPaymentForm() {
    // Formatage de la carte
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
        e.target.value = formattedValue;
    });
    
    // Formatage de l'expiration
    document.getElementById('cardExpiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });
    
    // Soumission du formulaire
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        traiterPaiement();
    });
}

// Traiter le paiement
function traiterPaiement() {
    const button = document.getElementById('payButton');
    button.disabled = true;
    button.innerHTML = 'Traitement...';
    
    // Simulation du paiement
    setTimeout(() => {
        // Rediriger vers la route de paiement Flask
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/plateforme/paiement';
        
        const fields = [
            ['selected_plan', window.selectedPlan],
            ['card_number', document.getElementById('cardNumber').value.replace(/\s/g, '')],
            ['card_expiry', document.getElementById('cardExpiry').value],
            ['card_cvv', document.getElementById('cardCvv').value],
            ['card_name', document.getElementById('cardName').value]
        ];
        
        fields.forEach(([name, value]) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }, 2000);
}

// Fonction globale pour s√©lectionner un plan (accessible via onclick)
window.selectPlan = function(planType) {
    try {
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) debugInfo.innerHTML = 'DEBUG: Plan ' + planType + ' cliqu√© !';
        console.log('Plan s√©lectionn√©:', planType);
        
        // Sauvegarder le plan s√©lectionn√©
        localStorage.setItem('selectedPlan', planType);
        
        // Marquer le plan comme s√©lectionn√© en base de donn√©es
        fetch('/plateforme/api/select-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ plan: planType })
        }).then(response => {
            if (response.ok) {
                console.log('Plan marqu√© comme s√©lectionn√© en base');
            }
        }).catch(err => {
            console.log('Erreur API:', err);
        });
        
        // Masquer le popup de choix de plans
        const choiceOverlay = document.getElementById('prospectOverlay');
        if (choiceOverlay) {
            choiceOverlay.classList.add('closing');
            
            // Afficher le popup de paiement apr√®s un d√©lai
            setTimeout(() => {
                choiceOverlay.style.display = 'none';
                showPaymentPopup(planType);
            }, 300);
        } else {
            alert('Erreur: popup non trouv√©');
        }
        
    } catch (error) {
        alert('Erreur dans selectPlan: ' + error.message);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Animation des statistiques au chargement
    animateStatsCards();
    
    // Animation de la barre de progression
    animateSavingsProgress();
    
    // Cr√©er le camembert
    createPortfolioChart();
    
    // Animations d'entr√©e pour les nouvelles cartes
    animateNewCards();
    
    // Gestion du popup pour prospects
    {% if current_user.user_type == 'prospect' %}
    console.log('DEBUG: Utilisateur prospect d√©tect√©');
    
    // V√©rifier si on revient d'un paiement r√©ussi
    const urlParams = new URLSearchParams(window.location.search);
    const paymentSuccess = urlParams.get('payment_success');
    
    if (paymentSuccess) {
        // L'utilisateur a pay√© avec succ√®s, ne plus afficher le popup
        console.log('Paiement r√©ussi, masquage du popup');
        return;
    }
    
    // V√©rifier l'√©tape du prospect
    const planSelected = {{ current_user.plan_selected | lower }};
    console.log('DEBUG: Plan selected =', planSelected);
    
    if (!planSelected) {
        console.log('DEBUG: Appel de initProspectPopup()');
        // Afficher le popup de choix de plans
        initProspectPopup();
    } else {
        // Le plan est s√©lectionn√© mais pas le paiement -> afficher directement le popup de paiement
        // R√©cup√©rer le plan s√©lectionn√© depuis l'URL ou localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const selectedPlan = urlParams.get('plan') || localStorage.getItem('selectedPlan') || 'initia';
        
        setTimeout(() => {
            showPaymentPopup(selectedPlan);
        }, 500);
    }
    {% endif %}
});

// Fonction pour attacher les event listeners aux boutons de plans
function attachProspectEventListeners() {
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) debugInfo.innerHTML = 'DEBUG: Fonction attachProspectEventListeners appel√©e...';
    
    const btnInitia = document.getElementById('planButtonInitia');
    const btnOptima = document.getElementById('planButtonOptima');
    
    if (btnInitia && btnOptima) {
        document.getElementById('debugInfo').innerHTML = 'DEBUG: Event listeners ajout√©s !';
        btnInitia.addEventListener('click', () => selectPlan('initia'));
        btnOptima.addEventListener('click', () => selectPlan('optima'));
    } else {
        document.getElementById('debugInfo').innerHTML = 'DEBUG: ERREUR - Boutons non trouv√©s !';
    }
}

// Fonction pour initialiser le popup prospect
function initProspectPopup() {
    console.log('DEBUG: initProspectPopup() appel√©e');
    const overlay = document.getElementById('prospectOverlay');
    const dashboardBlur = document.getElementById('dashboardBlur');
    
    if (!overlay) {
        console.log('DEBUG: ERREUR - prospectOverlay non trouv√©');
        return;
    }
    
    console.log('DEBUG: Affichage du popup dans 500ms');
    // Afficher le popup avec animation
    setTimeout(() => {
        overlay.style.display = 'flex';
        console.log('DEBUG: Popup display=flex appliqu√©');
        if (dashboardBlur) {
            dashboardBlur.style.filter = 'blur(10px)';
        }
        
        setTimeout(() => {
            overlay.classList.add('show');
            console.log('DEBUG: Classe show ajout√©e');
        }, 100);
    }, 500);
}


// Fonction pour afficher le popup de paiement
function showPaymentPopup(planType) {
    // Cr√©er le popup de paiement s'il n'existe pas
    if (!document.getElementById('paymentOverlay')) {
        createPaymentPopup();
    }
    
    const paymentOverlay = document.getElementById('paymentOverlay');
    updatePaymentPlan(planType);
    
    // Afficher le popup de paiement
    paymentOverlay.style.display = 'flex';
    setTimeout(() => {
        paymentOverlay.classList.add('show');
    }, 100);
}

// Fonction pour cr√©er le popup de paiement dynamiquement
function createPaymentPopup() {
    const paymentHTML = `
    <div class="payment-overlay" id="paymentOverlay">
        <div class="payment-popup">
            <div class="payment-header">
                <div class="popup-logo">
                    <div class="popup-logo-icon">A</div>
                    <span class="popup-logo-text">Atlas</span>
                </div>
                <h2 class="payment-title">Finaliser votre abonnement</h2>
                <p class="payment-subtitle">S√©curis√© par cryptage SSL 256 bits</p>
            </div>
            
            <div class="payment-body">
                <!-- R√©sum√© du plan s√©lectionn√© -->
                <div class="plan-summary" id="paymentPlanSummary">
                    <div class="plan-summary-header">
                        <div class="plan-name" id="paymentPlanName">INITIA</div>
                        <div class="plan-price" id="paymentPlanPrice">24,99‚Ç¨/mois</div>
                    </div>
                    <div class="plan-tagline" id="paymentPlanTagline">Pour d√©buter sereinement</div>
                </div>
                
                <!-- Informations de s√©curit√© -->
                <div class="security-info">
                    <div class="security-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="security-text">
                        <strong>Paiement 100% s√©curis√©</strong><br>
                        Simulation de paiement - Aucun pr√©l√®vement r√©el
                    </div>
                </div>
                
                <!-- Formulaire de paiement -->
                <form id="paymentPopupForm">
                    <div class="form-group">
                        <label for="popup_card_number" class="form-label">
                            <i class="fas fa-credit-card"></i>
                            Num√©ro de carte
                        </label>
                        <input type="text" class="form-input card-input" id="popup_card_number" 
                               placeholder="1234 5678 9012 3456" maxlength="19" required>
                    </div>
                    
                    <div class="form-group-half">
                        <div>
                            <label for="popup_card_expiry" class="form-label">
                                <i class="fas fa-calendar-alt"></i>
                                Expiration
                            </label>
                            <input type="text" class="form-input card-input" id="popup_card_expiry" 
                                   placeholder="MM/AA" maxlength="5" required>
                        </div>
                        <div>
                            <label for="popup_card_cvv" class="form-label">
                                <i class="fas fa-lock"></i>
                                CVV
                            </label>
                            <input type="text" class="form-input card-input" id="popup_card_cvv" 
                                   placeholder="123" maxlength="4" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="popup_card_name" class="form-label">
                            <i class="fas fa-user"></i>
                            Nom du porteur
                        </label>
                        <input type="text" class="form-input" id="popup_card_name" 
                               placeholder="Nom sur la carte" required>
                    </div>
                    
                    <button type="submit" class="payment-button" id="paymentPopupButton">
                        <i class="fas fa-lock"></i>
                        <span id="paymentPopupButtonText">Finaliser le paiement - 24,99‚Ç¨</span>
                    </button>
                    
                    <button type="button" class="cancel-button" onclick="closePaymentPopup()">
                        Retour au choix des plans
                    </button>
                </form>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', paymentHTML);
    setupPaymentPopupEvents();
}

// Fonction pour mettre √† jour le plan dans le popup de paiement
function updatePaymentPlan(planType) {
    const plans = {
        initia: {
            name: 'INITIA',
            price: '24,99‚Ç¨',
            tagline: 'Pour d√©buter sereinement'
        },
        optima: {
            name: 'OPTIMA', 
            price: '49,99‚Ç¨',
            tagline: 'Pour structurer votre patrimoine'
        }
    };
    
    const plan = plans[planType] || plans.initia;
    
    document.getElementById('paymentPlanName').textContent = plan.name;
    document.getElementById('paymentPlanPrice').textContent = plan.price + '/mois';
    document.getElementById('paymentPlanTagline').textContent = plan.tagline;
    document.getElementById('paymentPopupButtonText').textContent = \`Finaliser le paiement - \${plan.price}\`;
    
    // Stocker le type de plan pour la soumission
    document.getElementById('paymentPopupForm').dataset.planType = planType;
}

// Fonction pour configurer les √©v√©nements du popup de paiement
function setupPaymentPopupEvents() {
    // Formatage des champs de carte
    const cardNumberField = document.getElementById('popup_card_number');
    const cardExpiryField = document.getElementById('popup_card_expiry');
    const cardCvvField = document.getElementById('popup_card_cvv');
    
    cardNumberField.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
        e.target.value = formattedValue;
    });
    
    cardExpiryField.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });
    
    cardCvvField.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    // Soumission du formulaire
    document.getElementById('paymentPopupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        processPayment();
    });
}

// Fonction pour traiter le paiement
function processPayment() {
    const planType = document.getElementById('paymentPopupForm').dataset.planType;
    const cardNumber = document.getElementById('popup_card_number').value.replace(/\s/g, '');
    const cardExpiry = document.getElementById('popup_card_expiry').value;
    const cardCvv = document.getElementById('popup_card_cvv').value;
    const cardName = document.getElementById('popup_card_name').value.trim();
    
    // Validation basique
    if (!cardNumber || !cardExpiry || !cardCvv || !cardName) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (cardNumber.length < 15) {
        alert('Num√©ro de carte invalide');
        return;
    }
    
    if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
        alert('Date d\'expiration invalide (MM/AA)');
        return;
    }
    
    if (!/^\d{3,4}$/.test(cardCvv)) {
        alert('Code CVV invalide');
        return;
    }
    
    // Animation de traitement
    const button = document.getElementById('paymentPopupButton');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement du paiement...';
    
    // Simuler le traitement du paiement via AJAX
    setTimeout(() => {
        fetch('/plateforme/paiement', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                selected_plan: planType,
                card_number: cardNumber,
                card_expiry: cardExpiry,
                card_cvv: cardCvv,
                card_name: cardName
            })
        })
        .then(response => {
            if (response.ok) {
                // Paiement r√©ussi - recharger la page pour voir le dashboard sans popup
                window.location.href = '/plateforme/dashboard?payment_success=1';
            } else {
                alert('Erreur lors du paiement. Veuillez r√©essayer.');
                button.disabled = false;
                button.innerHTML = \`<i class="fas fa-lock"></i> \${document.getElementById('paymentPopupButtonText').textContent}\`;
            }
        })
        .catch(error => {
            alert('Erreur de connexion. Veuillez r√©essayer.');
            button.disabled = false;
            button.innerHTML = \`<i class="fas fa-lock"></i> \${document.getElementById('paymentPopupButtonText').textContent}\`;
        });
    }, 2000);
}

// Fonction pour fermer le popup de paiement
function closePaymentPopup() {
    const paymentOverlay = document.getElementById('paymentOverlay');
    paymentOverlay.classList.remove('show');
    
    setTimeout(() => {
        paymentOverlay.style.display = 'none';
        // R√©afficher le popup de choix des plans
        const choiceOverlay = document.getElementById('prospectOverlay');
        choiceOverlay.style.display = 'flex';
        choiceOverlay.classList.remove('closing');
        setTimeout(() => {
            choiceOverlay.classList.add('show');
        }, 100);
    }, 300);
}

function animateNewCards() {
    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
}

function animateStatsCards() {
    const statValues = document.querySelectorAll('.platform-stat-value');
    statValues.forEach((stat, index) => {
        setTimeout(() => {
            stat.style.opacity = '1';
            stat.style.transform = 'scale(1)';
        }, index * 150);
        
        stat.style.opacity = '0';
        stat.style.transform = 'scale(0.8)';
        stat.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    });
}

function animateSavingsProgress() {
    // V√©rifier si l'utilisateur a des donn√©es d'√©pargne
    const monthlyGoal = {% if current_user.investor_profile and current_user.investor_profile.monthly_savings_capacity %}{{ current_user.investor_profile.monthly_savings_capacity }}{% else %}0{% endif %};
    
    // Masquer la barre si pas de donn√©es
    if (monthlyGoal === 0) {
        document.querySelector('.savings-progress-bar').style.display = 'none';
        return;
    }
    
    // Calculer le nombre de mois r√©ellement √©coul√©s depuis l'inscription
    const registrationDate = new Date('{{ current_user.date_created.strftime("%Y-%m-%d") if current_user.date_created else "2024-01-01" }}');
    const now = new Date();
    const currentYear = now.getFullYear();
    const registrationYear = registrationDate.getFullYear();
    
    // Calcul des mois complets √©coul√©s depuis l'inscription
    // Inscription 30 septembre -> mois complets: octobre (9), novembre (10), d√©cembre (11) = 3 mois
    const registrationMonth = registrationDate.getMonth(); // septembre = 8
    const currentMonth = now.getMonth(); // d√©cembre = 11
    
    let monthsSinceRegistration;
    if (currentYear === registrationYear) {
        // M√™me ann√©e: compter les mois depuis le mois suivant l'inscription
        monthsSinceRegistration = currentMonth - registrationMonth; // 11 - 8 = 3
    } else {
        // Ann√©e diff√©rente: calcul classique
        monthsSinceRegistration = (now.getFullYear() - registrationDate.getFullYear()) * 12;
        monthsSinceRegistration += now.getMonth() - registrationDate.getMonth();
        if (now.getDate() < registrationDate.getDate()) {
            monthsSinceRegistration--;
        }
    }
    
    // Assurer qu'on a au moins 0 mois
    monthsSinceRegistration = Math.max(monthsSinceRegistration, 0);
    
    // Calculer l'objectif annuel selon l'ann√©e d'inscription
    let annualGoal;
    if (currentYear === registrationYear) {
        // Premi√®re ann√©e : objectif bas√© sur les mois r√©ellement √©coul√©s depuis l'inscription
        // Si on s'inscrit le 30 septembre, on compte octobre, novembre, d√©cembre = 3 mois
        const monthsFromRegistration = Math.max(monthsSinceRegistration, 1); // Au minimum 1 mois
        annualGoal = monthlyGoal * monthsFromRegistration;
    } else {
        // Ann√©es suivantes : 12 mois complets
        annualGoal = monthlyGoal * 12;
    }
    
    const currentSavings = monthlyGoal * monthsSinceRegistration;
    const progressPercentage = Math.min((currentSavings / annualGoal) * 100, 100);
    
    // Debug console (√† supprimer plus tard)
    console.log('Date inscription:', registrationDate);
    console.log('Date actuelle:', now);
    console.log('Mois √©coul√©s:', monthsSinceRegistration);
    console.log('Objectif annuel:', annualGoal);
    console.log('√âpargne actuelle:', currentSavings);
    console.log('Pourcentage:', progressPercentage);
    
    // Mettre √† jour les valeurs
    document.getElementById('targetYearlySavings').textContent = annualGoal.toLocaleString() + '‚Ç¨';
    
    // Animation de la barre et du montant
    let currentAmount = 0;
    const duration = 2000; // 2 secondes
    const steps = 60;
    const amountStep = currentSavings / steps;
    const progressStep = progressPercentage / steps;
    
    const progressBar = document.getElementById('savingsProgressFill');
    const progressText = document.getElementById('savingsProgressPercentage');
    const currentAmountElement = document.getElementById('currentYearlySavings');
    
    let step = 0;
    const interval = setInterval(() => {
        step++;
        currentAmount += amountStep;
        
        // Mettre √† jour la barre
        progressBar.style.width = (progressStep * step) + '%';
        
        // Mettre √† jour le texte
        progressText.textContent = Math.round(progressStep * step) + '%';
        currentAmountElement.textContent = Math.round(currentAmount).toLocaleString() + '‚Ç¨';
        
        if (step >= steps) {
            clearInterval(interval);
            // Valeurs finales exactes
            progressBar.style.width = progressPercentage + '%';
            progressText.textContent = Math.round(progressPercentage) + '%';
            currentAmountElement.textContent = currentSavings.toLocaleString() + '‚Ç¨';
        }
    }, duration / steps);
}

function createPortfolioChart() {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    
    // Vraies donn√©es patrimoniales regroup√©es par cat√©gories (valeurs fra√Æches depuis DB)
    const patrimoineData = {
        liquidites: {{ patrimoine_repartition.liquidites or 0 }},
        placements: {{ patrimoine_repartition.placements or 0 }},
        immobilier: {{ patrimoine_repartition.immobilier or 0 }},
        crypto: {{ patrimoine_repartition.crypto or 0 }},
        autres_biens: {{ patrimoine_repartition.autres_biens or 0 }}
    };
    
    // Cr√©er les donn√©es du portfolio avec les vraies valeurs regroup√©es
    const portfolioData = {};
    
    if (patrimoineData.liquidites > 0) {
        portfolioData['Liquidit√©s'] = { amount: patrimoineData.liquidites, color: '#7A90A4' };
    }
    if (patrimoineData.placements > 0) {
        portfolioData['Placements'] = { amount: patrimoineData.placements, color: '#137C8B' };
    }
    if (patrimoineData.immobilier > 0) {
        portfolioData['Immobilier'] = { amount: patrimoineData.immobilier, color: '#B8CBD0' };
    }
    if (patrimoineData.crypto > 0) {
        portfolioData['Cryptomonnaies'] = { amount: patrimoineData.crypto, color: '#709CA7' };
    }
    if (patrimoineData.autres_biens > 0) {
        portfolioData['Autres biens'] = { amount: patrimoineData.autres_biens, color: '#344D59' };
    }
    
    // Si aucune donn√©e, utiliser des donn√©es par d√©faut
    if (Object.keys(portfolioData).length === 0) {
        portfolioData['Pas de donn√©es'] = { amount: 1, color: '#dee2e6' };
    }
    
    const labels = Object.keys(portfolioData);
    const amounts = Object.values(portfolioData).map(item => item.amount);
    const colors = Object.values(portfolioData).map(item => item.color);
    const total = amounts.reduce((sum, amount) => sum + amount, 0);
    
    // Cr√©er le graphique
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: amounts,
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverBorderWidth: 4,
                hoverBorderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // On utilise notre propre l√©gende
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#137C8B',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const amount = context.parsed;
                            const percentage = ((amount / total) * 100).toFixed(1);
                            return `${amount.toLocaleString()}‚Ç¨ (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%',
            animation: {
                animateRotate: true,
                duration: 1500,
                easing: 'easeInOutCubic'
            }
        }
    });
    
    // Cr√©er la l√©gende personnalis√©e
    createCustomLegend(portfolioData, total);
    
    // Mettre √† jour le total dans l'en-t√™te
    document.getElementById('portfolioTotal').textContent = total.toLocaleString() + '‚Ç¨';
}

function createCustomLegend(portfolioData, total) {
    const legendContainer = document.getElementById('portfolioLegend');
    legendContainer.innerHTML = '';
    
    Object.entries(portfolioData).forEach(([label, data]) => {
        const percentage = ((data.amount / total) * 100).toFixed(1);
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        
        legendItem.innerHTML = `
            <div class="legend-info">
                <div class="legend-color" style="background-color: ${data.color};"></div>
                <span class="legend-label">${label}</span>
            </div>
            <div class="legend-values">
                <div class="legend-amount">${data.amount.toLocaleString()}‚Ç¨</div>
                <div class="legend-percentage">${percentage}%</div>
            </div>
        `;
        
        legendContainer.appendChild(legendItem);
    });
}
</script>

<style>
/* Nouvelles bo√Ætes en haut */
.dashboard-new-section {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 24px;
    margin-bottom: 8px;
}

.dashboard-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    height: 200px;
    display: flex;
    flex-direction: column;
}

.dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
}

.card-header {
    background: linear-gradient(135deg, var(--qlower-primary), var(--qlower-dark));
    color: white;
    padding: 14px 20px;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.card-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.card-action-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-size: 0.9rem;
}

.card-action-btn:hover {
    background: rgba(255,255,255,0.3);
    color: white;
    transform: scale(1.05);
}

.card-status-icon {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
}

.platform-eye-btn {
    background: rgba(19, 124, 139, 0.1);
    color: var(--qlower-primary);
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.platform-eye-btn:hover {
    background: var(--qlower-primary);
    color: white;
    transform: scale(1.05);
    text-decoration: none;
}

.card-body {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Patrimoine Card */
.patrimoine-card .card-body {
    text-align: center;
}

.patrimoine-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 6px;
    letter-spacing: -0.02em;
}

.patrimoine-trend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 1rem;
}

.trend-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
}

.trend-indicator.positive {
    color: #28a745;
}

.trend-period {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Investment Plan Card */
.investment-list {
    max-height: 140px;
    overflow-y: auto;
    width: 100%;
}

.investment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.investment-item:last-child {
    border-bottom: none;
}

.investment-item:hover {
    background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
    padding: 8px 12px;
    margin: 0 -12px;
    border-radius: 8px;
}

.investment-info {
    flex: 1;
}

.investment-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.investment-envelope {
    background: linear-gradient(135deg, var(--qlower-primary), var(--qlower-dark));
    color: white;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.investment-reference {
    font-size: 0.75rem;
    color: #6c757d;
    font-family: 'Courier New', monospace;
}

.investment-allocation {
    text-align: right;
    min-width: 80px;
}

.allocation-percentage {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 1px;
}

.allocation-amount {
    font-size: 0.8rem;
    color: #6c757d;
}

.investment-more {
    text-align: center;
    padding: 8px 0;
    color: #6c757d;
    font-style: italic;
    font-size: 0.8rem;
    border-top: 1px dashed #dee2e6;
    margin-top: 4px;
}

/* Actions √† R√©aliser Card */
.no-actions {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #6c757d;
    height: 100%;
    width: 100%;
}

.no-actions-icon {
    font-size: 2rem;
    margin-bottom: 8px;
    color: var(--qlower-primary);
}

.no-actions-text h4 {
    margin-bottom: 4px;
    color: #495057;
    font-size: 1rem;
}

.no-actions-text p {
    margin: 0;
    font-size: 0.85rem;
}

/* Plan d'investissement principal */
.investment-plan-content {
    max-height: 400px;
    overflow-y: auto;
}

.plan-investment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.plan-investment-item:last-child {
    border-bottom: none;
}

.plan-investment-item:hover {
    background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
    padding: 8px 16px;
    margin: 0 -16px;
    border-radius: 8px;
}

.plan-investment-info {
    flex: 1;
}

.plan-investment-name {
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.plan-investment-envelope {
    background: linear-gradient(135deg, var(--qlower-primary), var(--qlower-dark));
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    min-width: 40px;
    text-align: center;
}

.plan-investment-reference {
    font-size: 0.85rem;
    color: #6c757d;
    font-family: 'Courier New', monospace;
    margin-left: 8px;
    font-weight: 500;
}

.plan-investment-allocation {
    text-align: right;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

.plan-allocation-percentage {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--qlower-primary);
    margin-right: 8px;
}

.plan-allocation-amount {
    font-size: 1rem;
    color: var(--qlower-primary);
    font-weight: 700;
}

.plan-investment-more {
    text-align: center;
    padding: 16px 0;
    color: #6c757d;
    font-style: italic;
    border-top: 1px dashed #dee2e6;
    margin-top: 12px;
}

.plan-total-section {
    background: linear-gradient(135deg, var(--qlower-primary), var(--qlower-dark));
    padding: 12px 16px;
    border-radius: 8px;
    margin-top: 16px;
    border: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.plan-total-label {
    font-size: 0.85rem;
    color: white;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.plan-total-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
}

/* No Plan Configured */
.no-plan-configured {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #6c757d;
    padding: 40px 20px;
}

.no-plan-configured-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    color: #dee2e6;
}

.no-plan-configured-text h4 {
    margin-bottom: 8px;
    color: #495057;
}

.no-plan-configured-text p {
    margin: 0;
    font-size: 0.95rem;
}

.no-plan-icon {
    font-size: 2rem;
    margin-bottom: 8px;
    color: #dee2e6;
}

.no-plan-text h4 {
    margin-bottom: 4px;
    color: #495057;
    font-size: 1rem;
}

.no-plan-text p {
    margin: 0;
    font-size: 0.85rem;
}

/* MODERN DASHBOARD METRICS */
.modern-metrics-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.metric-card {
    background: linear-gradient(135deg, var(--qlower-white) 0%, #fafbfc 100%);
    border-radius: 20px;
    box-shadow: 0 8px 40px rgba(19, 124, 139, 0.08);
    border: 1px solid rgba(19, 124, 139, 0.06);
    padding: 24px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--qlower-primary), var(--qlower-light));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s ease;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 60px rgba(19, 124, 139, 0.15);
    border-color: rgba(19, 124, 139, 0.15);
}

.metric-card:hover::before {
    transform: scaleX(1);
}

.metric-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.metric-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--qlower-text-dark);
    letter-spacing: -0.025em;
}

.metric-value {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 36px;
    font-weight: 800;
    color: var(--qlower-primary);
    line-height: 1;
    letter-spacing: -0.05em;
}

.metric-progress {
    display: flex;
    align-items: center;
    gap: 12px;
}

.progress-track {
    flex: 1;
    height: 8px;
    background: var(--qlower-bg-light);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    border-radius: 4px;
    transition: width 0.6s ease;
}

.progress-text {
    font-size: 13px;
    font-weight: 600;
    color: #28a745;
}

.metric-subtitle {
    font-size: 13px;
    color: var(--qlower-text-light);
    font-style: italic;
}

.metric-action {
    flex-shrink: 0;
}

.action-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: var(--qlower-bg-light);
    border: 1px solid var(--qlower-border);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--qlower-text-dark);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 16px;
}

.action-btn:hover {
    background: var(--qlower-primary);
    color: white;
    border-color: var(--qlower-primary);
    transform: scale(1.05);
}

/* MODERN PORTFOLIO SECTION */
.modern-portfolio-card {
    background: linear-gradient(135deg, var(--qlower-white) 0%, #fafbfc 100%);
    border-radius: 24px;
    box-shadow: 0 12px 48px rgba(19, 124, 139, 0.08);
    border: 1px solid rgba(19, 124, 139, 0.06);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 32px;
}

.modern-portfolio-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 24px 80px rgba(19, 124, 139, 0.12);
}

.portfolio-header {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    padding: 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.portfolio-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.portfolio-header-content {
    display: flex;
    align-items: center;
}

.portfolio-title-section {
    color: white;
}

.portfolio-title {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 28px;
    font-weight: 800;
    margin: 0;
    line-height: 1.1;
    letter-spacing: -0.025em;
}

.portfolio-subtitle {
    font-size: 16px;
    opacity: 0.9;
    margin: 4px 0 0 0;
    font-weight: 400;
}

.portfolio-total {
    text-align: right;
    color: white;
}

.total-label {
    display: block;
    font-size: 14px;
    opacity: 0.8;
    margin-bottom: 4px;
    font-weight: 500;
}

.total-value {
    display: block;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.portfolio-content {
    padding: 40px;
}

.portfolio-chart-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: center;
}

.portfolio-chart {
    position: relative;
    height: 320px;
}

.portfolio-legend {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.legend-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--qlower-bg-light) 0%, #f1f3f4 100%);
    border-radius: 16px;
    transition: all 0.3s ease;
    border: 1px solid rgba(19, 124, 139, 0.04);
}

.legend-item:hover {
    background: var(--qlower-white);
    box-shadow: 0 8px 24px rgba(19, 124, 139, 0.08);
    transform: translateX(4px);
    border-color: rgba(19, 124, 139, 0.1);
}

.legend-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 8px;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.legend-label {
    font-weight: 600;
    color: var(--qlower-text-dark);
    font-size: 15px;
}

.legend-values {
    text-align: right;
}

.legend-amount {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-weight: 700;
    color: var(--qlower-dark);
    font-size: 16px;
    line-height: 1.2;
}

.legend-percentage {
    font-size: 13px;
    color: var(--qlower-text-light);
    font-weight: 500;
}

/* Styles pour la barre de progression d'√©pargne */
.savings-progress-container {
    padding: 20px 0;
}

.savings-progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.savings-current, .savings-target {
    text-align: center;
}

.savings-amount {
    display: block;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 28px;
    font-weight: 800;
    color: var(--qlower-primary);
    line-height: 1;
}

.savings-target .savings-amount {
    color: var(--qlower-text-dark);
}

.savings-label {
    display: block;
    font-size: 14px;
    color: var(--qlower-text-light);
    font-weight: 500;
    margin-top: 4px;
}

.savings-progress-bar {
    position: relative;
    margin-bottom: 16px;
}

.savings-progress-track {
    width: 100%;
    height: 12px;
    background: var(--qlower-bg-light);
    border-radius: 6px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.savings-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    border-radius: 6px;
    width: 0%;
    transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.savings-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.savings-progress-percentage {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--qlower-white);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.savings-progress-months {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--qlower-text-light);
    margin-top: 8px;
}

/* Scrollbar Styling */
.investment-list::-webkit-scrollbar {
    width: 6px;
}

.investment-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.investment-list::-webkit-scrollbar-thumb {
    background: var(--qlower-light);
    border-radius: 3px;
}

.investment-list::-webkit-scrollbar-thumb:hover {
    background: var(--qlower-primary);
}

/* Responsive */
@media (max-width: 1024px) {
    .dashboard-new-section {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .patrimoine-value {
        font-size: 2.5rem;
    }
    
    .portfolio-chart-container {
        grid-template-columns: 1fr;
        gap: 32px;
    }
    
    .portfolio-chart {
        height: 280px;
    }
}

@media (max-width: 768px) {
    .dashboard-new-section {
        gap: 16px;
    }
    
    .card-header {
        padding: 16px 20px;
    }
    
    .card-header h3 {
        font-size: 1.1rem;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .patrimoine-card .card-body {
        padding: 32px 20px;
    }
    
    .patrimoine-value {
        font-size: 2.2rem;
    }
    
    .investment-item {
        padding: 12px 0;
    }
    
    .investment-name {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .investment-envelope {
        align-self: flex-start;
    }
    
    .metric-card {
        padding: 20px;
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .metric-value {
        font-size: 28px;
    }
    
    .metric-action {
        align-self: flex-end;
    }
    
    .portfolio-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
        padding: 24px;
    }
    
    .portfolio-content {
        padding: 24px;
    }
    
    .savings-progress-info {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .savings-progress-months {
        font-size: 10px;
    }
}

/* Animation d'entr√©e */
.metric-card {
    opacity: 0;
    transform: translateY(20px);
    animation: slideInMetric 0.6s ease forwards;
}

.metric-card:nth-child(1) { animation-delay: 0.1s; }
.metric-card:nth-child(2) { animation-delay: 0.2s; }

@keyframes slideInMetric {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* STYLES POPUP PROSPECT */
.prospect-welcome-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
    opacity: 0;
    transition: opacity 0.4s ease;
}

.prospect-welcome-overlay.show {
    opacity: 1;
}

.prospect-welcome-overlay.closing {
    opacity: 0;
}

.prospect-welcome-popup {
    background: white;
    border-radius: 24px;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.3);
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9) translateY(20px);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.prospect-welcome-overlay.show .prospect-welcome-popup {
    transform: scale(1) translateY(0);
}

.popup-header {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    padding: 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.popup-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
    opacity: 0.3;
}

.popup-logo {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
}

.popup-logo-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: 700;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.popup-logo-text {
    font-size: 28px;
    font-weight: 700;
    color: white;
    letter-spacing: -0.025em;
}

.popup-title {
    position: relative;
    z-index: 2;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 800;
    color: white;
    margin: 0 0 8px 0;
    letter-spacing: -0.025em;
}

.popup-subtitle {
    position: relative;
    z-index: 2;
    font-size: 16px;
    color: var(--qlower-tertiary-color);
    margin: 0;
    opacity: 0.9;
}

.popup-plans {
    padding: 40px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
}

.plan-card {
    background: linear-gradient(135deg, #fafbfc 0%, white 100%);
    border-radius: 20px;
    padding: 32px;
    border: 2px solid var(--qlower-border);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.plan-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 60px rgba(19, 124, 139, 0.15);
    border-color: var(--qlower-primary);
}

.plan-card.plan-popular {
    border-color: var(--qlower-primary);
    box-shadow: 0 8px 30px rgba(19, 124, 139, 0.1);
}

.plan-popular-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    background: linear-gradient(135deg, var(--qlower-primary), var(--qlower-dark));
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.plan-header {
    margin-bottom: 24px;
    text-align: center;
}

.plan-name {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 24px;
    font-weight: 800;
    color: var(--qlower-dark);
    margin: 0 0 8px 0;
    letter-spacing: -0.025em;
}

.plan-tagline {
    font-size: 14px;
    color: var(--qlower-text-light);
    margin: 0;
    font-weight: 500;
}

.plan-price {
    text-align: center;
    margin-bottom: 32px;
}

.price-amount {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 36px;
    font-weight: 800;
    color: var(--qlower-primary);
    letter-spacing: -0.025em;
}

.price-period {
    font-size: 16px;
    color: var(--qlower-text-light);
    font-weight: 500;
}

.plan-features {
    margin-bottom: 32px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.feature-item:last-child {
    margin-bottom: 0;
}

.feature-item i {
    color: var(--qlower-primary);
    font-size: 16px;
    flex-shrink: 0;
}

.feature-item span {
    font-size: 14px;
    color: var(--qlower-text-dark);
    font-weight: 500;
}

.plan-button {
    width: 100%;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    padding: 16px 32px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
}

.plan-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(19, 124, 139, 0.3);
    background: linear-gradient(135deg, #0f6b75 0%, #5d8a94 100%);
}

.plan-popular .plan-button {
    box-shadow: 0 8px 20px rgba(19, 124, 139, 0.2);
}

.dashboard-blur-overlay {
    transition: filter 0.4s ease;
}

/* Responsive Popup */
@media (max-width: 768px) {
    .prospect-welcome-popup {
        width: 95%;
        margin: 20px;
    }
    
    .popup-header {
        padding: 32px 24px;
    }
    
    .popup-title {
        font-size: 28px;
    }
    
    .popup-plans {
        padding: 24px;
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    .plan-card {
        padding: 24px;
    }
    
    .plan-name {
        font-size: 20px;
    }
    
    .price-amount {
        font-size: 32px;
    }
}

/* STYLES POPUP PAIEMENT */
.payment-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 11000;
    backdrop-filter: blur(8px);
    opacity: 0;
    transition: opacity 0.4s ease;
}

.payment-overlay.show {
    opacity: 1;
}

.payment-popup {
    background: white;
    border-radius: 24px;
    box-shadow: 0 28px 100px rgba(0, 0, 0, 0.4);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.85) translateY(30px);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.payment-overlay.show .payment-popup {
    transform: scale(1) translateY(0);
}

.payment-header {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    padding: 32px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.payment-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="8" height="8" patternUnits="userSpaceOnUse"><path d="M 8 0 L 0 0 0 8" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
}

.payment-title {
    position: relative;
    z-index: 2;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 24px;
    font-weight: 800;
    color: white;
    margin: 0 0 8px 0;
    letter-spacing: -0.025em;
}

.payment-subtitle {
    position: relative;
    z-index: 2;
    font-size: 14px;
    color: var(--qlower-tertiary-color);
    margin: 0;
    opacity: 0.9;
}

.payment-body {
    padding: 32px;
}

.plan-summary {
    background: linear-gradient(135deg, #fafbfc 0%, white 100%);
    border: 2px solid var(--qlower-primary);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    position: relative;
}

.plan-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--qlower-primary), var(--qlower-light));
}

.plan-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.security-info {
    background: rgba(19, 124, 139, 0.05);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
}

.security-icon {
    color: var(--qlower-primary);
    font-size: 18px;
    flex-shrink: 0;
}

.security-text {
    font-size: 13px;
    color: var(--qlower-text-dark);
    font-weight: 500;
}

.form-group {
    margin-bottom: 20px;
}

.form-group-half {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: var(--qlower-dark);
    margin-bottom: 8px;
    font-size: 14px;
}

.form-label i {
    margin-right: 8px;
    color: var(--qlower-primary);
}

.form-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--qlower-border);
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.3s ease;
    background: white;
    color: var(--qlower-text-dark);
    font-family: 'Inter', sans-serif;
}

.form-input:focus {
    outline: none;
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.card-input {
    font-family: 'Courier New', monospace;
    letter-spacing: 0.1em;
}

.payment-button {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    padding: 16px 32px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    font-family: 'Inter', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
}

.payment-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(19, 124, 139, 0.3);
}

.payment-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.cancel-button {
    background: transparent;
    color: var(--qlower-text-light);
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    font-family: 'Inter', sans-serif;
}

.cancel-button:hover {
    background: rgba(19, 124, 139, 0.05);
    color: var(--qlower-primary);
}

/* Responsive Payment Popup */
@media (max-width: 768px) {
    .payment-popup {
        width: 95%;
        margin: 20px;
    }
    
    .payment-header {
        padding: 24px 20px;
    }
    
    .payment-body {
        padding: 24px 20px;
    }
    
    .payment-title {
        font-size: 20px;
    }
    
    .form-group-half {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}
</style>

<script>
// Fonction globale pour les popups - accessible partout
window.allerVersPaiement = function(planType) {
    // Masquer l'√©tape de choix de plans
    document.querySelector('.popup-plans').style.display = 'none';
    document.querySelector('.popup-header').style.display = 'none';
    
    // Afficher l'√©tape de paiement
    document.getElementById('paiementStep').style.display = 'block';
    
    // Mettre √† jour les infos du plan
    const planNames = { initia: 'INITIA', optima: 'OPTIMA' };
    const planPrices = { initia: '24,99‚Ç¨', optima: '49,99‚Ç¨' };
    
    document.getElementById('selectedPlanName').textContent = planNames[planType];
    document.getElementById('planPrice').textContent = planPrices[planType];
    
    // Stocker le plan s√©lectionn√©
    window.selectedPlan = planType;
    
    // Configurer le formulaire de paiement
    setupPaymentFormPopup();
}

window.retourAuxPlans = function() {
    // Masquer l'√©tape de paiement
    document.getElementById('paiementStep').style.display = 'none';
    
    // R√©afficher l'√©tape de choix de plans avec les bonnes propri√©t√©s
    const popupHeader = document.querySelector('.popup-header');
    const popupPlans = document.querySelector('.popup-plans');
    
    if (popupHeader) {
        popupHeader.style.display = 'block';
    }
    
    if (popupPlans) {
        popupPlans.style.display = 'grid';
        // Restaurer les propri√©t√©s CSS originales
        popupPlans.style.gridTemplateColumns = '';
        popupPlans.style.gap = '';
        popupPlans.style.justifyContent = '';
        popupPlans.style.alignItems = '';
    }
}

function setupPaymentFormPopup() {
    // Formatage de la carte
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
        e.target.value = formattedValue;
    });
    
    // Formatage de l'expiration
    document.getElementById('cardExpiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });
    
    // CVV seulement des chiffres
    document.getElementById('cardCvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    // Soumission du formulaire
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        traiterPaiementPopup();
    });
}

function traiterPaiementPopup() {
    const button = document.getElementById('payButton');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    
    // R√©cup√©rer les donn√©es du formulaire
    const formData = new FormData();
    formData.append('selected_plan', window.selectedPlan);
    formData.append('card_number', document.getElementById('cardNumber').value.replace(/\s/g, ''));
    formData.append('card_expiry', document.getElementById('cardExpiry').value);
    formData.append('card_cvv', document.getElementById('cardCvv').value);
    formData.append('card_name', document.getElementById('cardName').value);
    
    // Simulation du traitement puis soumission
    setTimeout(() => {
        fetch('/plateforme/paiement', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Paiement r√©ussi - recharger la page
                window.location.href = '/plateforme/dashboard?payment_success=1';
            } else {
                // Erreur
                button.disabled = false;
                button.innerHTML = originalText;
                alert('Erreur lors du paiement. Veuillez r√©essayer.');
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = originalText;
            alert('Erreur de connexion. Veuillez r√©essayer.');
        });
    }, 2000);
}
</script>

{% endblock %}