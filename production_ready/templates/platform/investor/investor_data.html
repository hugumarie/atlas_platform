{% extends "platform/base.html" %}

{% block title %}Données investisseur - Atlas{% endblock %}

{% block page_title %}Données investisseur{% endblock %}

{% block content %}

<!-- COMPLETE DEBT COLORS SYSTEM -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Target debt totals with red-orange
    const debtElements = document.querySelectorAll('.liquidites-compact-item-total, .patrimoine-super-total');
    debtElements.forEach(element => {
        const text = element.textContent || '';
        if (text.includes('Capital restant dû') || 
            text.includes('Montant restant du crédit') ||
            text.includes('Total Crédits à Rembourser')) {
            
            element.style.setProperty('background', 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)', 'important');
            element.style.setProperty('color', 'white', 'important');
            
            const children = element.querySelectorAll('*');
            children.forEach(child => {
                child.style.setProperty('color', 'white', 'important');
            });
        }
    });
    
    // Target edit mode credits total section
    const editModeCreditsTotal = document.querySelectorAll('div[style*="border-left: 4px solid #dc3545"]');
    editModeCreditsTotal.forEach(element => {
        const text = element.textContent || '';
        if (text.includes('Total Crédits à Rembourser')) {
            element.style.setProperty('background', 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)', 'important');
            element.style.setProperty('color', 'white', 'important');
            
            const children = element.querySelectorAll('*');
            children.forEach(child => {
                child.style.setProperty('color', 'white', 'important');
            });
        }
    });
    
    // ADD "Capital restant dû" TOTALS FOR EACH CREDIT IN EDIT MODE
    document.querySelectorAll('.credit-remaining-total').forEach(element => element.remove());
    
    const creditCards = document.querySelectorAll('.credit-edit-card');
    creditCards.forEach((card) => {
        const montantRestantInput = card.querySelector('input[name="credit_conso_montant_restant[]"]');
        
        if (montantRestantInput) {
            const totalLine = document.createElement('div');
            totalLine.className = 'credit-remaining-total liquidites-compact-item-total';
            totalLine.style.cssText = `
                background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
                color: white !important;
                padding: 10px 12px !important;
                border-radius: 6px !important;
                margin-top: 15px !important;
                display: flex !important;
                justify-content: space-between !important;
            `;
            
            const getValue = () => {
                const value = parseFloat(montantRestantInput.value) || 0;
                const rounded = Math.round(value);
                return rounded.toLocaleString('fr-FR') + '€';
            };
            
            totalLine.innerHTML = `
                <div style="color: white !important; font-weight: 600;">Capital restant dû</div>
                <div style="color: white !important; font-weight: 700;">${getValue()}</div>
            `;
            
            montantRestantInput.addEventListener('input', () => {
                const valueDiv = totalLine.querySelector('div:last-child');
                if (valueDiv) {
                    valueDiv.textContent = getValue();
                }
            });
            
            card.appendChild(totalLine);
        }
    });
    
    // HIDE THE "Montant restant à rembourser" INPUT FIELD IN EDIT MODE
    const montantRestantInputs = document.querySelectorAll('input[name="credit_conso_montant_restant[]"]');
    montantRestantInputs.forEach(input => {
        const editItem = input.closest('.edit-item');
        if (editItem) {
            const label = editItem.querySelector('label');
            if (label && label.textContent.includes('Montant restant à rembourser')) {
                editItem.style.display = 'none';
            }
        }
    });
    
    // FORCE ALL DELETE BUTTONS TO RED-ORANGE
    const allButtons = document.querySelectorAll('button');
    allButtons.forEach(button => {
        const text = button.textContent || '';
        const hasTrashIcon = button.querySelector('i.fa-trash, i.fa-times, i.fa-remove, i.fa-delete');
        const isRemoveButton = button.getAttribute('onclick') && button.getAttribute('onclick').includes('remove');
        const hasRemoveClass = button.classList.contains('btn-remove');
        
        if (text.includes('Supprimer ce crédit') || hasTrashIcon || isRemoveButton || hasRemoveClass) {
            button.style.setProperty('background', 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)', 'important');
            button.style.setProperty('color', 'white', 'important');
            button.style.setProperty('border', 'none', 'important');
            
            button.addEventListener('mouseenter', () => {
                button.style.setProperty('background', 'linear-gradient(135deg, #c82333 0%, #e55a00 100%)', 'important');
            });
            
            button.addEventListener('mouseleave', () => {
                button.style.setProperty('background', 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)', 'important');
            });
        }
    });
    
    // Edit mode notification box styling removed per user request
});
</script>

<style>
/* Backup CSS rules */

/* FORCE DEBT STYLING WITH MAXIMUM PRIORITY */
.liquidites-compact-item-total[style*="background: linear-gradient(135deg, #dc3545"] {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
    color: white !important;
}

.liquidites-compact-item-total[style*="background: linear-gradient(135deg, #dc3545"] .liquidites-compact-name-total,
.liquidites-compact-item-total[style*="background: linear-gradient(135deg, #dc3545"] .liquidites-compact-value-total {
    color: white !important;
}

.patrimoine-super-total[style*="background: linear-gradient(135deg, #dc3545"] {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
    color: white !important;
}

.patrimoine-super-total[style*="background: linear-gradient(135deg, #dc3545"] .patrimoine-super-label,
.patrimoine-super-total[style*="background: linear-gradient(135deg, #dc3545"] .patrimoine-super-value {
    color: white !important;
}

/* FORCE ALL REMOVE BUTTONS TO RED */
.btn-remove,
button[onclick*="remove"],
button[style*="background: #dc3545"] {
    background: #dc3545 !important;
    background-color: #dc3545 !important;
    color: white !important;
    border: none !important;
}

.btn-remove:hover,
button[onclick*="remove"]:hover {
    background: #c82333 !important;
    background-color: #c82333 !important;
}

/* FORCE CREDIT TOTAL SECTIONS */
div[style*="border-left: 4px solid #dc3545"] {
    background: linear-gradient(135deg, #fee 0%, #fdd 100%) !important;
    border-left: 4px solid #dc3545 !important;
}

div[style*="border-left: 4px solid #dc3545"] i {
    color: #dc3545 !important;
}

div[style*="border-left: 4px solid #dc3545"] div[style*="color: #dc3545"] {
    color: #dc3545 !important;
}
</style>

<style>
/* DESIGN ULTRA MODERNE ALIGNÉ ATLAS */
:root {
    --qlower-primary: #137C8B;
    --qlower-dark: #344D59;
    --qlower-light: #709CA7;
    --qlower-tertiary-color: #B8CBD0;
    --qlower-quaternary-color: #7A90A4;
    --qlower-bg-light: #f8f9fa;
    --qlower-text-dark: #344D59;
    --qlower-text-light: #7A90A4;
    --qlower-border: #e5e7eb;
    --qlower-white: #ffffff;
}

.investor-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
    background: var(--qlower-bg-light);
    min-height: 100vh;
}

/* CARTES STYLE ATLAS MODERNE */
.platform-card {
    background: var(--qlower-white);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--qlower-border);
    margin-bottom: 24px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.platform-card:hover {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

.platform-card-header {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white !important;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
}

.platform-card-header *,
.platform-card-header .platform-card-title,
.platform-card-header .platform-card-subtitle,
.platform-card-header h1,
.platform-card-header h2,
.platform-card-header h3,
.platform-card-header h4,
.platform-card-header h5,
.platform-card-header h6,
.platform-card-header p,
.platform-card-header span,
.platform-card-header div {
    color: white !important;
}

.platform-card-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: -100px;
    width: 100px;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: skewX(-20deg);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { right: -100px; }
    100% { right: calc(100% + 100px); }
}


.platform-card-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    font-family: 'Inter', sans-serif;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.platform-card-subtitle {
    font-size: 13px;
    opacity: 0.9;
    margin: 4px 0 0 0;
    font-weight: 400;
}

.platform-card-body {
    padding: 16px 24px 24px 24px;
}

/* STYLE DES DONNÉES - UNE PAR LIGNE */
.data-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.data-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--qlower-border);
}

.data-item:last-child {
    border-bottom: none;
}

.data-label {
    font-size: 15px;
    font-weight: 500;
    color: var(--qlower-text-dark);
    flex: 1;
}


.data-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--qlower-primary);
    text-align: right;
    min-width: 120px;
}

.data-value.financial {
    color: var(--qlower-primary);
    font-weight: 700;
}

.data-value.positive {
    color: #10b981;
}

.data-value.negative {
    color: #ef4444;
}

/* BADGES OBJECTIFS MODERNES */
.objectives-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.objective-badge {
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.05) 0%, rgba(112, 156, 167, 0.05) 100%);
    border: 1px solid rgba(19, 124, 139, 0.2);
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    color: var(--qlower-primary);
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
}

.objective-badge:hover {
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.1) 0%, rgba(112, 156, 167, 0.1) 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(19, 124, 139, 0.15);
}

.objective-badge::before {
    content: '✓';
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    background: var(--qlower-primary);
    border-radius: 50%;
    color: white;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

.objective-badge {
    padding-left: 32px;
}

/* SECTIONS DYNAMIQUES MODERNES */
.dynamic-section {
    background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid rgba(19, 124, 139, 0.1);
    backdrop-filter: blur(10px);
}

.dynamic-section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.dynamic-section-icon {
    width: 24px;
    height: 24px;
    background: var(--qlower-primary);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

.dynamic-item {
    background: var(--qlower-white);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid var(--qlower-border);
}


.dynamic-item:last-child {
    margin-bottom: 0;
}

/* SOUS-SECTIONS ÉPARGNE & PATRIMOINE */
.revenue-subsection {
    margin-top: 32px;
}

.revenue-subsection:first-of-type {
    margin-top: 2px;
}

.revenue-subsection-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.revenue-subsection-title i {
    color: var(--qlower-primary);
}

/* Styles compacts pour liquidités */
.liquidites-compact-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.liquidites-compact-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--qlower-white);
    border: 1px solid var(--qlower-border);
    border-radius: 6px;
}

.liquidites-compact-name {
    font-size: 14px;
    color: var(--qlower-text-dark);
    font-weight: 500;
}

.liquidites-compact-value {
    font-size: 14px;
    color: var(--qlower-primary);
    font-weight: 700;
}

.liquidites-compact-item-total {
    display: flex;
    justify-content: space-between;
    padding: 10px 12px;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    border-radius: 6px;
    margin-top: 8px;
}

.liquidites-compact-name-total,
.liquidites-compact-value-total {
    color: white !important;
    font-weight: 700;
}

/* Styles compacts pour placements */
.placements-compact-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.placements-compact-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--qlower-white);
    border: 1px solid var(--qlower-border);
    border-radius: 6px;
}

.placements-compact-name {
    font-size: 14px;
    color: var(--qlower-text-dark);
    font-weight: 500;
}

.placements-compact-value {
    font-size: 14px;
    color: var(--qlower-primary);
    font-weight: 700;
}

.placements-compact-item-total {
    display: flex;
    justify-content: space-between;
    padding: 10px 12px;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    border-radius: 6px;
    margin-top: 8px;
}

.placements-compact-name-total,
.placements-compact-value-total {
    color: white !important;
    font-weight: 700;
}

/* Styles compacts pour immobilier */
.immobilier-compact-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.immobilier-compact-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--qlower-white);
    border: 1px solid var(--qlower-border);
    border-radius: 6px;
}

.immobilier-compact-name {
    font-size: 14px;
    color: var(--qlower-text-dark);
    font-weight: 500;
}

.immobilier-compact-value {
    font-size: 14px;
    color: var(--qlower-primary);
    font-weight: 700;
}

.immobilier-view-item {
    background: rgba(248, 249, 250, 0.5);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

.revenue-subsection-subtitle {
    font-size: 14px;
    font-weight: 600;
    color: var(--qlower-text-dark);
    margin-bottom: 8px;
}

/* SECTION CRÉDIT IMMOBILIER */
.credit-section {
    background: rgba(19, 124, 139, 0.03);
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
    border-left: 3px solid var(--qlower-primary);
}

.credit-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--qlower-primary);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.credit-details {
    margin-left: 8px;
}

/* TOTAUX SECTION MODERNE */
.section-total {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    border-radius: 12px;
    padding: 20px 24px;
    margin-top: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.25);
    position: relative;
    overflow: hidden;
}

.section-total::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.6s;
}

.section-total:hover::before {
    left: 100%;
}

.total-label {
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.total-icon {
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.total-value {
    font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    font-size: 20px;
    font-weight: 900;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* BILAN PATRIMONIAL FINAL COMPACT */
.patrimoine-final {
    background: linear-gradient(135deg, var(--qlower-dark) 0%, var(--qlower-primary) 100%);
    color: white;
    border-radius: 16px;
    padding: 24px;
    margin-top: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(19, 124, 139, 0.25);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.patrimoine-final::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transition: left 0.8s ease;
}

.patrimoine-final:hover::before {
    left: 100%;
}

.patrimoine-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin: 0 auto 16px;
    backdrop-filter: blur(10px);
}

.patrimoine-title {
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: -0.025em;
    color: white;
}

.patrimoine-value {
    font-family: 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 12px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    color: white;
    letter-spacing: -0.05em;
}

.patrimoine-details {
    font-size: 15px;
    font-weight: 500;
    opacity: 0.9;
    color: white;
}

/* GRILLES RESPONSIVES */
.platform-grid {
    display: grid;
    gap: 24px;
}

.platform-grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
}

.platform-grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .investor-dashboard {
        padding: 16px;
    }
    
    .platform-grid-2,
    .platform-grid-3 {
        grid-template-columns: 1fr;
    }
    
    .platform-card-body {
        padding: 20px;
    }
    
    .data-item {
        padding: 14px 0;
    }
    
    .data-label,
    .data-value {
        font-size: 14px;
    }
    
    .patrimoine-value {
        font-size: 36px;
    }
}

/* ÉTATS SPÉCIAUX */
.data-item.highlighted {
    background: linear-gradient(90deg, rgba(19, 124, 139, 0.05) 0%, transparent 100%);
    border-left: 3px solid var(--qlower-primary);
    padding-left: 16px;
    border-radius: 0 8px 8px 0;
}

/* CRYPTO LAYOUT */
.crypto-layout {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid var(--qlower-border);
}

.crypto-symbol {
    font-size: 15px;
    font-weight: 500;
    color: var(--qlower-text-dark);
    min-width: 60px;
    flex: 0 0 auto;
}

.crypto-quantity {
    flex: 1;
    text-align: center;
    color: var(--qlower-text-dark);
    font-size: 15px;
    font-weight: 500;
}

.crypto-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--qlower-dark);
    min-width: 80px;
    text-align: right;
    flex: 0 0 auto;
}

.crypto-value .loading {
    color: var(--qlower-text-light);
    font-style: italic;
    font-weight: 400;
}

.crypto-value .error {
    color: #dc3545;
    font-size: 14px;
}

/* SUPER TOTAL PATRIMOINE */
.patrimoine-super-total {
    background: linear-gradient(135deg, var(--qlower-dark) 0%, var(--qlower-primary) 100%);
    color: white;
    border-radius: 16px;
    padding: 24px 20px;
    margin-top: 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 8px 32px rgba(19, 124, 139, 0.25);
    border: 2px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
}

.patrimoine-super-total::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transition: left 0.8s ease;
}

.patrimoine-super-total:hover::before {
    left: 100%;
}

.patrimoine-super-label {
    font-size: 18px;
    font-weight: 700;
    color: white;
    letter-spacing: -0.025em;
}

.patrimoine-super-value {
    font-size: 24px;
    font-weight: 800;
    color: white;
    font-family: 'Inter', sans-serif;
    letter-spacing: -0.05em;
}

.empty-state {
    text-align: center;
    padding: 60px 40px;
    color: var(--qlower-text-light);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 24px;
    opacity: 0.3;
}

.empty-state-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--qlower-text-dark);
    margin-bottom: 12px;
}

.empty-state-text {
    font-size: 14px;
    margin-bottom: 24px;
}

.platform-btn-primary {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
}

.platform-btn-primary:hover {
    background: linear-gradient(135deg, #0f6b75 0%, #5d8a94 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(19, 124, 139, 0.3);
    color: white;
}

/* NAVIGATION RAPIDE STICKY SIMPLE */
.quick-nav {
    background: linear-gradient(135deg, var(--qlower-white) 0%, #fafbfc 100%);
    border-radius: 16px;
    border: 1px solid var(--qlower-border);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.08);
    position: sticky;
    top: 24px;
    z-index: 500;
    backdrop-filter: blur(10px);
    margin-bottom: 24px;
}

.quick-nav-container {
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 24px;
}

.quick-nav-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--qlower-text-dark);
    white-space: nowrap;
}

.quick-nav-items {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    flex: 1;
}

.quick-nav-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 12px;
    background: transparent;
    color: var(--qlower-text-dark);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    border: 1px solid transparent;
    white-space: nowrap;
}

.quick-nav-item:hover {
    background: rgba(19, 124, 139, 0.08);
    color: var(--qlower-primary);
    border-color: rgba(19, 124, 139, 0.15);
    transform: translateY(-1px);
}

.quick-nav-item.active {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    border-color: var(--qlower-primary);
}

.quick-nav-item i {
    font-size: 12px;
}

.quick-nav-item span {
    font-size: 13px;
}

/* Responsive */
@media (max-width: 768px) {
    .quick-nav {
        top: 16px;
    }
    
    .quick-nav-container {
        padding: 12px 16px;
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .quick-nav-title {
        font-size: 12px;
    }
    
    .quick-nav-items {
        gap: 4px;
        width: 100%;
    }
    
    .quick-nav-item {
        padding: 6px 12px;
        font-size: 12px;
        flex: 1;
        justify-content: center;
        min-width: 0;
    }
    
    .quick-nav-item span {
        font-size: 11px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
}

/* BOUTON D'ÉDITION FLOTTANT */
.edit-floating-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    border: none;
    border-radius: 50px;
    box-shadow: 0 8px 32px rgba(19, 124, 139, 0.3);
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    white-space: nowrap;
    font-family: 'Inter', sans-serif;
    letter-spacing: -0.025em;
}

.edit-floating-btn:hover {
    transform: translateY(-4px) scale(1.1);
    box-shadow: 0 16px 48px rgba(19, 124, 139, 0.4);
    background: linear-gradient(135deg, var(--qlower-dark) 0%, var(--qlower-primary) 100%);
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
}

.edit-floating-btn:active {
    transform: translateY(-2px) scale(1.05);
}

.edit-floating-btn i {
    font-size: 16px;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

/* Animation d'apparition */
.edit-floating-btn {
    opacity: 0;
    transform: translateY(100px);
    animation: slideUpFadeIn 0.6s ease forwards;
    animation-delay: 0.5s;
}

@keyframes slideUpFadeIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* BOUTONS D'ACTION FLOTTANTS EN BAS A DROITE */
.action-floating-buttons {
    position: fixed;
    bottom: 80px;
    right: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 1000;
}

.action-floating-btn {
    padding: 14px 20px;
    border: none;
    border-radius: 50px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    white-space: nowrap;
    font-family: 'Inter', sans-serif;
    letter-spacing: -0.025em;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    color: white;
}

.action-floating-btn i {
    font-size: 16px;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

/* Bouton Annuler - style gris */
.cancel-btn {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
}

.cancel-btn:hover {
    transform: translateY(-4px) scale(1.1);
    box-shadow: 0 16px 48px rgba(108, 117, 125, 0.4);
    background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
}

/* Bouton Sauvegarder - style Atlas */
.save-btn {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
}

.save-btn:hover {
    transform: translateY(-4px) scale(1.1);
    box-shadow: 0 16px 48px rgba(19, 124, 139, 0.4);
    background: linear-gradient(135deg, var(--qlower-dark) 0%, var(--qlower-primary) 100%);
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
}

.action-floating-btn:active {
    transform: translateY(-2px) scale(1.05);
}

/* Animation d'apparition pour les boutons d'action */
.action-floating-buttons {
    opacity: 0;
    transform: translateX(100px);
    animation: slideRightFadeIn 0.6s ease forwards;
    animation-delay: 0.5s;
}

@keyframes slideRightFadeIn {
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Responsive */
@media (max-width: 768px) {
    .edit-floating-btn {
        bottom: 20px;
        right: 20px;
        padding: 12px 16px;
        font-size: 14px;
    }
    
    .edit-floating-btn i {
        font-size: 14px;
    }
    
    .action-floating-buttons {
        bottom: 70px;
        right: 20px;
    }
    
    .action-floating-btn {
        padding: 12px 16px;
        font-size: 14px;
    }
    
    .action-floating-btn i {
        font-size: 14px;
    }
}

/* CSS POUR CLASSES D'ÉDITION */
.edit-label {
    display: block;
    font-weight: 600;
    color: #344D59;
    margin-bottom: 8px;
    font-family: 'Inter', sans-serif;
}

.edit-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    transition: border-color 0.2s ease;
}

.edit-input:focus {
    outline: none;
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 2px rgba(19, 124, 139, 0.1);
}

.btn-remove {
    padding: 8px 12px;
    background: #dc3545 !important;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: background-color 0.2s ease;
}

.btn-remove:hover {
    background: #c82333;
}
</style>

{% if current_user.investor_profile %}
<div class="investor-dashboard">
    
    <!-- NAVIGATION RAPIDE FIXE -->
    <nav class="quick-nav" id="quickNav">
        <div class="quick-nav-container">
            <div class="quick-nav-title">Navigation rapide</div>
            <div class="quick-nav-items">
                <a href="#infos-personnelles" class="quick-nav-item active">
                    <i class="fas fa-user"></i>
                    <span>Infos perso</span>
                </a>
                <a href="#objectifs-investissement" class="quick-nav-item">
                    <i class="fas fa-target"></i>
                    <span>Objectifs</span>
                </a>
                <a href="#profil-risque" class="quick-nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Profil risque</span>
                </a>
                <a href="#revenus-charges" class="quick-nav-item">
                    <i class="fas fa-wallet"></i>
                    <span>Revenus</span>
                </a>
                <a href="#epargne-patrimoine" class="quick-nav-item">
                    <i class="fas fa-piggy-bank"></i>
                    <span>Patrimoine</span>
                </a>
                <a href="#credits" class="quick-nav-item">
                    <i class="fas fa-credit-card"></i>
                    <span>Crédits</span>
                </a>
                <a href="#patrimoine-net-total" class="quick-nav-item">
                    <i class="fas fa-crown"></i>
                    <span>Bilan</span>
                </a>
            </div>
        </div>
    </nav>
    
    {% if edit_mode %}
    <!-- EN-TÊTE MODE ÉDITION -->
    <div class="platform-card mb-3" style="">
        <div class="platform-card-body" style="padding: 10px 15px;">
            <div class="alert alert-info mb-0" style="border: none; background: transparent; border-radius: 8px; padding: 10px 15px;">
                <i class="fas fa-edit" style="color: #137C8B; font-size: 16px; margin-right: 8px;"></i>
                <strong style="color: #344D59; font-size: 14px;">Mode édition activé</strong>
                <p style="margin: 4px 0 0 0; color: #7A90A4; font-size: 13px;">Modifiez vos données ci-dessous. Les calculs patrimoniaux seront automatiquement mis à jour lors de la sauvegarde.</p>
            </div>
        </div>
    </div>
    
    <!-- FORMULAIRE D'ÉDITION PRINCIPAL -->
    <form id="investorEditForm" method="POST" action="{{ url_for('platform_investor.update_investor_data') }}">
        <!-- Champs cachés pour les totaux calculés par JavaScript -->
        <input type="hidden" name="calculated_total_actifs_js" id="hiddenTotalActifs" value="">
        <input type="hidden" name="calculated_patrimoine_net_js" id="hiddenPatrimoineNet" value="">
        <input type="hidden" name="calculated_total_dettes_js" id="hiddenTotalDettes" value="">
    {% endif %}
    
    <!-- INFORMATIONS PERSONNELLES -->
    <div class="platform-card" id="infos-personnelles">
        <div class="platform-card-header">
            <div>
                <div class="platform-card-title">INFORMATIONS PERSONNELLES</div>
                <div class="platform-card-subtitle">Vos données personnelles et de contact</div>
            </div>
        </div>
        <div class="platform-card-body">
            {% if edit_mode %}
            <!-- MODE ÉDITION -->
            <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Civilité *</label>
                    <select class="form-control edit-input" name="civilite" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        <option value="">Choisir...</option>
                        <option value="M." {{ 'selected' if current_user.investor_profile.civilite == 'M.' }}>M.</option>
                        <option value="Mme" {{ 'selected' if current_user.investor_profile.civilite == 'Mme' }}>Mme</option>
                    </select>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Prénom *</label>
                    <input type="text" class="form-control edit-input" name="first_name" value="{{ current_user.first_name }}" 
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;" required>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Nom *</label>
                    <input type="text" class="form-control edit-input" name="last_name" value="{{ current_user.last_name }}" 
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;" required>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Situation familiale *</label>
                    <select class="form-control edit-input" name="family_situation" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        <option value="">Choisir...</option>
                        <option value="Célibataire" {{ 'selected' if current_user.investor_profile.family_situation == 'Célibataire' }}>Célibataire</option>
                        <option value="Marié(e)" {{ 'selected' if current_user.investor_profile.family_situation == 'Marié(e)' }}>Marié(e)</option>
                        <option value="Pacsé(e)" {{ 'selected' if current_user.investor_profile.family_situation == 'Pacsé(e)' }}>Pacsé(e)</option>
                        <option value="En concubinage" {{ 'selected' if current_user.investor_profile.family_situation == 'En concubinage' }}>En concubinage</option>
                        <option value="En couple" {{ 'selected' if current_user.investor_profile.family_situation == 'En couple' }}>En couple</option>
                        <option value="En couple avec enfants" {{ 'selected' if current_user.investor_profile.family_situation == 'En couple avec enfants' }}>En couple avec enfants</option>
                        <option value="Autre" {{ 'selected' if current_user.investor_profile.family_situation == 'Autre' }}>Autre</option>
                    </select>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Email</label>
                    <input type="email" class="form-control edit-input" value="{{ current_user.email }}" 
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background-color: #f8f9fa; color: #6c757d;" disabled>
                    <small style="color: #7A90A4; font-size: 12px;">L'email ne peut pas être modifié</small>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Téléphone</label>
                    <input type="tel" class="form-control edit-input" name="phone" value="{{ current_user.phone or '' }}" 
                           placeholder="Ex: +33 1 23 45 67 89"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Nationalité *</label>
                    <select class="form-control edit-input" name="nationalite" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        <option value="">Choisir...</option>
                        <option value="Française" {{ 'selected' if current_user.investor_profile.nationalite == 'Française' }}>Française</option>
                        <option value="Union Européenne" {{ 'selected' if current_user.investor_profile.nationalite == 'Union Européenne' }}>Union Européenne</option>
                        <option value="Autre" {{ 'selected' if current_user.investor_profile.nationalite == 'Autre' }}>Autre</option>
                    </select>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Date de naissance *</label>
                    <input type="date" class="form-control edit-input" name="date_naissance" 
                           value="{{ current_user.investor_profile.date_naissance.strftime('%Y-%m-%d') if current_user.investor_profile.date_naissance }}"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Lieu de naissance</label>
                    <input type="text" class="form-control edit-input" name="lieu_naissance" 
                           value="{{ current_user.investor_profile.lieu_naissance or '' }}" placeholder="Ex: Paris, France"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Pays de résidence</label>
                    <input type="text" class="form-control edit-input" name="pays_residence" 
                           value="{{ current_user.investor_profile.pays_residence or '' }}" placeholder="Ex: France"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
            </div>
            {% else %}
            <!-- MODE VISUALISATION -->
            <div class="data-list">
                {% if current_user.investor_profile.civilite %}
                <div class="data-item">
                    <div class="data-label">Civilité</div>
                    <div class="data-value">{{ current_user.investor_profile.civilite }}</div>
                </div>
                {% endif %}
                <div class="data-item">
                    <div class="data-label">Nom complet</div>
                    <div class="data-value">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                </div>
                {% if current_user.investor_profile.family_situation %}
                <div class="data-item">
                    <div class="data-label">Situation familiale</div>
                    <div class="data-value">{{ current_user.investor_profile.family_situation }}</div>
                </div>
                {% endif %}
                <div class="data-item">
                    <div class="data-label">Email</div>
                    <div class="data-value">{{ current_user.email }}</div>
                </div>
                {% if current_user.phone %}
                <div class="data-item">
                    <div class="data-label">Téléphone</div>
                    <div class="data-value">{{ current_user.phone }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.nationalite %}
                <div class="data-item">
                    <div class="data-label">Nationalité</div>
                    <div class="data-value">{{ current_user.investor_profile.nationalite }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.date_naissance %}
                <div class="data-item">
                    <div class="data-label">Date de naissance</div>
                    <div class="data-value">{{ current_user.investor_profile.date_naissance.strftime('%d/%m/%Y') }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.lieu_naissance %}
                <div class="data-item">
                    <div class="data-label">Lieu de naissance</div>
                    <div class="data-value">{{ current_user.investor_profile.lieu_naissance }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.pays_residence %}
                <div class="data-item">
                    <div class="data-label">Pays de résidence</div>
                    <div class="data-value">{{ current_user.investor_profile.pays_residence }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- OBJECTIFS D'INVESTISSEMENT -->
    <div class="platform-card" id="objectifs-investissement">
        <div class="platform-card-header">
            <div>
                <div class="platform-card-title">OBJECTIFS D'INVESTISSEMENT</div>
                <div class="platform-card-subtitle">Vos motivations et buts financiers</div>
            </div>
        </div>
        <div class="platform-card-body">
            {% if edit_mode %}
            <!-- MODE ÉDITION - OBJECTIFS -->
            <div style="margin-bottom: 24px;">
                <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 12px;">Sélectionnez vos objectifs d'investissement :</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_premiers_pas" value="true" {{ 'checked' if current_user.investor_profile.objectif_premiers_pas }} 
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Faire mes premiers pas dans l'investissement</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_constituer_capital" value="true" {{ 'checked' if current_user.investor_profile.objectif_constituer_capital }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Constituer progressivement un capital</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_diversifier" value="true" {{ 'checked' if current_user.investor_profile.objectif_diversifier }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Diversifier mes placements</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_optimiser_rendement" value="true" {{ 'checked' if current_user.investor_profile.objectif_optimiser_rendement }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Optimiser le rendement de mon épargne</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_preparer_retraite" value="true" {{ 'checked' if current_user.investor_profile.objectif_preparer_retraite }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Préparer ma retraite</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_securite_financiere" value="true" {{ 'checked' if current_user.investor_profile.objectif_securite_financiere }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Assurer ma sécurité financière à long terme</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_projet_immobilier" value="true" {{ 'checked' if current_user.investor_profile.objectif_projet_immobilier }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Financer un projet immobilier</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_revenus_complementaires" value="true" {{ 'checked' if current_user.investor_profile.objectif_revenus_complementaires }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Générer des revenus complémentaires</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_transmettre_capital" value="true" {{ 'checked' if current_user.investor_profile.objectif_transmettre_capital }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Transmettre un capital à mes proches</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="objectif_proteger_famille" value="true" {{ 'checked' if current_user.investor_profile.objectif_proteger_famille }}
                               style="margin: 0; transform: scale(1.2);">
                        <span style="font-size: 14px; color: #344D59;">Protéger ma famille en cas d'imprévu</span>
                    </label>
                </div>
            </div>
            {% else %}
            <!-- MODE VISUALISATION - OBJECTIFS -->
            <div class="objectives-container">
                {% if current_user.investor_profile.objectif_premiers_pas %}
                <div class="objective-badge">Faire mes premiers pas dans l'investissement</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_constituer_capital %}
                <div class="objective-badge">Constituer progressivement un capital</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_diversifier %}
                <div class="objective-badge">Diversifier mes placements</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_optimiser_rendement %}
                <div class="objective-badge">Optimiser le rendement de mon épargne</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_preparer_retraite %}
                <div class="objective-badge">Préparer ma retraite</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_securite_financiere %}
                <div class="objective-badge">Assurer ma sécurité financière à long terme</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_projet_immobilier %}
                <div class="objective-badge">Financer un projet immobilier</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_revenus_complementaires %}
                <div class="objective-badge">Générer des revenus complémentaires</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_transmettre_capital %}
                <div class="objective-badge">Transmettre un capital à mes proches</div>
                {% endif %}
                {% if current_user.investor_profile.objectif_proteger_famille %}
                <div class="objective-badge">Protéger ma famille en cas d'imprévu</div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PROFIL DE RISQUE -->
    <div class="platform-card" id="profil-risque">
        <div class="platform-card-header">
            <div>
                <div class="platform-card-title">PROFIL DE RISQUE</div>
                <div class="platform-card-subtitle">Votre approche face au risque et à la volatilité</div>
            </div>
        </div>
        <div class="platform-card-body">
            {% if edit_mode %}
            <!-- MODE ÉDITION - QUESTIONNAIRE PROFIL DE RISQUE OPTIMISÉ -->
            <div style="max-width: 900px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #344D59; margin-bottom: 8px; font-size: 18px;">Évaluation de votre profil d'investisseur</h3>
                    <p style="color: #7A90A4; font-size: 13px;">Répondez aux 5 questions pour déterminer votre profil de risque</p>
                </div>
                
                <!-- Questions en grille compacte 2x3 -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    
                    <!-- Question 1: Tolérance au risque -->
                    <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f8f9fa;">
                        <h4 style="color: #344D59; margin-bottom: 8px; font-size: 14px; font-weight: 600;">1. Baisse acceptable</h4>
                        <p style="color: #7A90A4; margin-bottom: 10px; font-size: 12px;">Quelle baisse maximale acceptez-vous par an ?</p>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="tolerance_baisse" value="5" {{ 'checked' if current_user.investor_profile.tolerance_risque == '5' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Jusqu'à –5 %</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="tolerance_baisse" value="15" {{ 'checked' if current_user.investor_profile.tolerance_risque == '15' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Jusqu'à –15 %</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="tolerance_baisse" value="30" {{ 'checked' if current_user.investor_profile.tolerance_risque == '30' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Jusqu'à –30 % ou plus</span>
                            </label>
                        </div>
                    </div>

                    <!-- Question 2: Horizon de placement -->
                    <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f8f9fa;">
                        <h4 style="color: #344D59; margin-bottom: 8px; font-size: 14px; font-weight: 600;">2. Horizon de placement</h4>
                        <p style="color: #7A90A4; margin-bottom: 10px; font-size: 12px;">Sur quelle durée investissez-vous ?</p>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="horizon_placement" value="court" {{ 'checked' if current_user.investor_profile.horizon_placement == 'court' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Moins de 2 ans</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="horizon_placement" value="moyen" {{ 'checked' if current_user.investor_profile.horizon_placement == 'moyen' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">2 à 5 ans</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="horizon_placement" value="long" {{ 'checked' if current_user.investor_profile.horizon_placement == 'long' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Plus de 5 ans</span>
                            </label>
                        </div>
                    </div>

                    <!-- Question 3: Besoin de liquidité -->
                    <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f8f9fa;">
                        <h4 style="color: #344D59; margin-bottom: 8px; font-size: 14px; font-weight: 600;">3. Besoin de liquidité</h4>
                        <p style="color: #7A90A4; margin-bottom: 10px; font-size: 12px;">Besoin de récupérer rapidement vos fonds ?</p>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="besoin_liquidite" value="oui" {{ 'checked' if current_user.investor_profile.besoin_liquidite == 'oui' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Oui, à court terme</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="besoin_liquidite" value="non" {{ 'checked' if current_user.investor_profile.besoin_liquidite == 'non' }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Non, plusieurs années OK</span>
                            </label>
                        </div>
                    </div>

                    <!-- Question 4: Expérience -->
                    <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f8f9fa;">
                        <h4 style="color: #344D59; margin-bottom: 8px; font-size: 14px; font-weight: 600;">4. Expérience</h4>
                        <p style="color: #7A90A4; margin-bottom: 10px; font-size: 12px;">Votre niveau en investissement ?</p>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="experience_investissement" value="debutant" {{ 'checked' if current_user.investor_profile.experience_investissement in ['débutant', 'debutant'] or current_user.investor_profile.investment_experience in ['débutant', 'debutant'] }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Débutant</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="experience_investissement" value="intermediaire" {{ 'checked' if current_user.investor_profile.experience_investissement in ['intermédiaire', 'intermediaire'] or current_user.investor_profile.investment_experience in ['intermédiaire', 'intermediaire'] }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Intermédiaire</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="experience_investissement" value="confirme" {{ 'checked' if current_user.investor_profile.experience_investissement in ['confirmé', 'confirme'] or current_user.investor_profile.investment_experience in ['confirmé', 'confirme'] }} style="margin: 0; transform: scale(1.1);">
                                <span style="color: #344D59;">Confirmé</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Question 5: Attitude face à la volatilité (pleine largeur) -->
                <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f8f9fa; margin-bottom: 20px;">
                    <h4 style="color: #344D59; margin-bottom: 8px; font-size: 14px; font-weight: 600;">5. Attitude face à la volatilité</h4>
                    <p style="color: #7A90A4; margin-bottom: 10px; font-size: 12px;">Comment réagiriez-vous si vos placements baissaient fortement ?</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                            <input type="radio" name="attitude_volatilite" value="vendre" {{ 'checked' if current_user.investor_profile.attitude_volatilite == 'vendre' }} style="margin: 0; transform: scale(1.1);">
                            <span style="color: #344D59;">Je vendrais pour limiter les pertes</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                            <input type="radio" name="attitude_volatilite" value="attendre" {{ 'checked' if current_user.investor_profile.attitude_volatilite == 'attendre' }} style="margin: 0; transform: scale(1.1);">
                            <span style="color: #344D59;">J'attendrais que ça remonte</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;" onmouseover="this.style.borderColor='#137C8B'" onmouseout="this.style.borderColor='#e5e7eb'">
                            <input type="radio" name="attitude_volatilite" value="investir_plus" {{ 'checked' if current_user.investor_profile.attitude_volatilite == 'investir_plus' }} style="margin: 0; transform: scale(1.1);">
                            <span style="color: #344D59;">J'en profiterais pour investir davantage</span>
                        </label>
                    </div>
                </div>

                <!-- Résultat du profil (calculé par le backend) - Style compact personnalisé -->
                <div style="background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%); color: white; border-radius: 12px; padding: 12px 20px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(19, 124, 139, 0.25); position: relative; overflow: hidden;">
                    <div style="font-size: 14px; font-weight: 600; color: white; font-family: 'Inter', sans-serif;">
                        Profil d'investisseur
                    </div>
                    <div style="font-size: 16px; font-weight: 700; color: white; font-family: 'Inter', sans-serif;">
                        {% if current_user.investor_profile.risk_tolerance == 'faible' or current_user.investor_profile.risk_tolerance == 'prudent' %}
                            PRUDENT
                        {% elif current_user.investor_profile.risk_tolerance == 'modéré' or current_user.investor_profile.risk_tolerance == 'moderate' %}
                            MODÉRÉ
                        {% elif current_user.investor_profile.risk_tolerance == 'élevé' or current_user.investor_profile.risk_tolerance == 'dynamique' %}
                            DYNAMIQUE
                        {% else %}
                            MODÉRÉ
                        {% endif %}
                    </div>
                    <input type="hidden" name="risk_tolerance" value="{{ current_user.investor_profile.risk_tolerance or 'modéré' }}">
                </div>
            </div>
            {% else %}
            <!-- MODE VISUALISATION - PROFIL DE RISQUE -->
            <div class="data-list">
                {% if current_user.investor_profile.tolerance_risque %}
                <div class="data-item">
                    <div class="data-label">Tolérance au risque</div>
                    <div class="data-value">
                        {% if current_user.investor_profile.tolerance_risque == '5' %}
                            Jusqu'à -5%
                        {% elif current_user.investor_profile.tolerance_risque == '15' %}
                            Jusqu'à -15%
                        {% elif current_user.investor_profile.tolerance_risque == '30' %}
                            Jusqu'à -30% ou plus
                        {% else %}
                            {{ current_user.investor_profile.tolerance_risque }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if current_user.investor_profile.horizon_placement %}
                <div class="data-item">
                    <div class="data-label">Horizon de placement</div>
                    <div class="data-value">
                        {% if current_user.investor_profile.horizon_placement == 'court' %}
                            Moins de 2 ans
                        {% elif current_user.investor_profile.horizon_placement == 'moyen' %}
                            2 à 5 ans
                        {% elif current_user.investor_profile.horizon_placement == 'long' %}
                            Plus de 5 ans
                        {% else %}
                            {{ current_user.investor_profile.horizon_placement }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if current_user.investor_profile.besoin_liquidite %}
                <div class="data-item">
                    <div class="data-label">Besoin de liquidité</div>
                    <div class="data-value">
                        {% if current_user.investor_profile.besoin_liquidite == 'oui' %}
                            Oui, à court terme
                        {% elif current_user.investor_profile.besoin_liquidite == 'non' %}
                            Non, plusieurs années OK
                        {% else %}
                            {{ current_user.investor_profile.besoin_liquidite }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if current_user.investor_profile.experience_investissement %}
                <div class="data-item">
                    <div class="data-label">Expérience d'investissement</div>
                    <div class="data-value">
                        {% if current_user.investor_profile.experience_investissement in ['debutant', 'débutant'] %}
                            Débutant
                        {% elif current_user.investor_profile.experience_investissement in ['intermediaire', 'intermédiaire'] %}
                            Intermédiaire
                        {% elif current_user.investor_profile.experience_investissement in ['confirme', 'confirmé'] %}
                            Confirmé
                        {% else %}
                            {{ current_user.investor_profile.experience_investissement }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if current_user.investor_profile.attitude_volatilite %}
                <div class="data-item">
                    <div class="data-label">Attitude face à la volatilité</div>
                    <div class="data-value">
                        {% if current_user.investor_profile.attitude_volatilite == 'vendre' %}
                            Je vendrais pour limiter les pertes
                        {% elif current_user.investor_profile.attitude_volatilite == 'attendre' %}
                            J'attendrais que ça remonte
                        {% elif current_user.investor_profile.attitude_volatilite == 'investir_plus' %}
                            J'en profiterais pour investir davantage
                        {% else %}
                            {{ current_user.investor_profile.attitude_volatilite }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if current_user.investor_profile.risk_tolerance %}
                <div class="data-item">
                    <div class="data-label">Profil de risque calculé</div>
                    <div class="data-value">
                        <span class="badge" style="background: var(--qlower-primary); color: white; padding: 4px 12px; border-radius: 12px;">
                            {{ current_user.investor_profile.risk_tolerance|title }}
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- REVENUS ET CHARGES -->
    <div class="platform-card" id="revenus-charges">
        <div class="platform-card-header">
            <div>
                <div class="platform-card-title">REVENUS ET CHARGES</div>
                <div class="platform-card-subtitle">Votre situation financière mensuelle</div>
            </div>
        </div>
        <div class="platform-card-body">
            {% if edit_mode %}
            <!-- MODE ÉDITION - REVENUS ET CHARGES -->
            <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Situation professionnelle *</label>
                    <select class="form-control edit-input" name="professional_situation" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        <option value="">Choisir...</option>
                        <option value="Salarié" {{ 'selected' if current_user.investor_profile.professional_situation == 'Salarié' }}>Salarié</option>
                        <option value="Fonctionnaire" {{ 'selected' if current_user.investor_profile.professional_situation == 'Fonctionnaire' }}>Fonctionnaire</option>
                        <option value="Indépendant" {{ 'selected' if current_user.investor_profile.professional_situation == 'Indépendant' }}>Indépendant</option>
                        <option value="Chef d'entreprise" {{ 'selected' if current_user.investor_profile.professional_situation == 'Chef d\'entreprise' }}>Chef d'entreprise</option>
                        <option value="Étudiant" {{ 'selected' if current_user.investor_profile.professional_situation == 'Étudiant' }}>Étudiant</option>
                        <option value="Retraité" {{ 'selected' if current_user.investor_profile.professional_situation == 'Retraité' }}>Retraité</option>
                        <option value="Sans emploi" {{ 'selected' if current_user.investor_profile.professional_situation == 'Sans emploi' }}>Sans emploi</option>
                        <option value="Autre" {{ 'selected' if current_user.investor_profile.professional_situation == 'Autre' }}>Autre</option>
                    </select>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Précisions</label>
                    <input type="text" class="form-control edit-input" name="professional_situation_other" 
                           value="{{ current_user.investor_profile.professional_situation_other or '' }}" 
                           placeholder="Ex: Cadre supérieur, Ingénieur..."
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Métier</label>
                    <input type="text" class="form-control edit-input" name="metier" 
                           value="{{ current_user.investor_profile.metier or '' }}" 
                           placeholder="Ex: Développeur, Commercial..."
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Revenu mensuel net *</label>
                    <input type="number" class="form-control edit-input" name="monthly_net_income" 
                           value="{{ current_user.investor_profile.monthly_net_income or '' }}" 
                           placeholder="Ex: 4000" min="0" step="100"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Impôts mensuels</label>
                    <input type="number" class="form-control edit-input" name="impots_mensuels" 
                           value="{{ current_user.investor_profile.impots_mensuels or '' }}" 
                           placeholder="Ex: 800" min="0" step="0.01"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Capacité d'épargne mensuelle *</label>
                    <input type="number" class="form-control edit-input" name="monthly_savings_capacity" 
                           value="{{ current_user.investor_profile.monthly_savings_capacity or '' }}" 
                           placeholder="Ex: 1000" min="0" step="100"
                           style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>
            </div>

            <!-- REVENUS COMPLÉMENTAIRES DYNAMIQUES -->
            <div style="margin-bottom: 30px;">
                <h5 style="color: #344D59; margin-bottom: 15px; font-weight: 600;">Revenus complémentaires</h5>
                <div id="revenus_complementaires_container">
                    {% for revenu in current_user.investor_profile.revenus_complementaires_data %}
                    <div class="dynamic-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
                        <div>
                            <input type="text" class="form-control" name="revenu_complementaire_name[]" 
                                   value="{{ revenu.name }}" placeholder="Type de revenu"
                                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <input type="number" class="form-control" name="revenu_complementaire_amount[]" 
                                   value="{{ revenu.amount }}" placeholder="Montant en €" min="0" step="0.01"
                                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success btn-sm" onclick="addRevenuComplementaire()" 
                        style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px; margin-top: 8px;">
                    <i class="fas fa-plus"></i> Ajouter un revenu
                </button>
            </div>

            <!-- CHARGES MENSUELLES DYNAMIQUES -->
            <div>
                <h5 style="color: #344D59; margin-bottom: 15px; font-weight: 600;">Charges mensuelles</h5>
                <div id="charges_mensuelles_container">
                    {% for charge in current_user.investor_profile.charges_mensuelles_data %}
                    <div class="dynamic-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
                        <div>
                            <input type="text" class="form-control" name="charge_mensuelle_name[]" 
                                   value="{{ charge.name }}" placeholder="Type de charge"
                                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <input type="number" class="form-control" name="charge_mensuelle_amount[]" 
                                   value="{{ charge.amount }}" placeholder="Montant en €" min="0" step="0.01"
                                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success btn-sm" onclick="addChargeMensuelle()" 
                        style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px; margin-top: 8px;">
                    <i class="fas fa-plus"></i> Ajouter une charge
                </button>
            </div>
            {% else %}
            <!-- MODE VISUALISATION - REVENUS ET CHARGES -->
            <div class="data-list">
                {% if current_user.investor_profile.professional_situation %}
                <div class="data-item">
                    <div class="data-label">Situation professionnelle</div>
                    <div class="data-value">{{ current_user.investor_profile.professional_situation }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.professional_situation_other %}
                <div class="data-item">
                    <div class="data-label">Précisions</div>
                    <div class="data-value">{{ current_user.investor_profile.professional_situation_other }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.metier %}
                <div class="data-item">
                    <div class="data-label">Métier</div>
                    <div class="data-value">{{ current_user.investor_profile.metier }}</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.monthly_net_income %}
                <div class="data-item">
                    <div class="data-label">Revenu mensuel net</div>
                    <div class="data-value financial">{{ "{:,.0f}".format(current_user.investor_profile.monthly_net_income) }}€</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.impots_mensuels %}
                <div class="data-item">
                    <div class="data-label">Impôts mensuels</div>
                    <div class="data-value financial">{{ "{:,.0f}".format(current_user.investor_profile.impots_mensuels) }}€</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.monthly_savings_capacity %}
                <div class="data-item">
                    <div class="data-label">Capacité d'épargne mensuelle</div>
                    <div class="data-value financial">{{ "{:,.0f}".format(current_user.investor_profile.monthly_savings_capacity) }}€</div>
                </div>
                {% endif %}
                {% if current_user.investor_profile.monthly_net_income and current_user.investor_profile.monthly_savings_capacity %}
                {% set taux_epargne = (current_user.investor_profile.monthly_savings_capacity / current_user.investor_profile.monthly_net_income * 100) %}
                <div class="data-item">
                    <div class="data-label">Taux d'épargne</div>
                    <div class="data-value">{{ "{:.1f}".format(taux_epargne) }}%</div>
                </div>
                {% endif %}
            </div>
            
            <!-- Revenus complémentaires -->
            {% if current_user.investor_profile.revenus_complementaires_data %}
            <div class="dynamic-section">
                <div class="dynamic-section-title">Revenus complémentaires</div>
                {% for revenu in current_user.investor_profile.revenus_complementaires_data %}
                <div class="dynamic-item">
                    <div class="data-item">
                        <div class="data-label">{{ revenu.name }}</div>
                        <div class="data-value financial">{{ "{:,.0f}".format(revenu.amount) }}€/mois</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Charges mensuelles -->
            {% if current_user.investor_profile.charges_mensuelles_data %}
            <div class="dynamic-section">
                <div class="dynamic-section-title">Charges mensuelles</div>
                {% for charge in current_user.investor_profile.charges_mensuelles_data %}
                <div class="dynamic-item">
                    <div class="data-item">
                        <div class="data-label">{{ charge.name }}</div>
                        <div class="data-value">{{ "{:,.0f}".format(charge.amount) }}€/mois</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- ÉPARGNE ET PLACEMENTS -->
    <div class="platform-card" id="epargne-patrimoine">
        <div class="platform-card-header">
            <div>
                <div class="platform-card-title">ÉPARGNE & PATRIMOINE</div>
                <div class="platform-card-subtitle">Situation patrimoniale complète : liquidités, placements, immobilier et autres actifs</div>
            </div>
        </div>
        <div class="platform-card-body">
            {% if edit_mode %}
            <!-- MODE ÉDITION - ÉPARGNE & PATRIMOINE -->
            
            <!-- Section LIQUIDITÉS -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #344D59; margin-bottom: 20px; font-weight: 600; font-size: 16px;">
                    <i class="fas fa-tint" style="color: var(--qlower-primary); margin-right: 8px;"></i>
                    Liquidités
                </h4>
                <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Livret A</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="livret_a_value" 
                               value="{{ current_user.investor_profile.livret_a_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">LDDS</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="ldds_value" 
                               value="{{ current_user.investor_profile.ldds_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">PEL/CEL</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="pel_cel_value" 
                               value="{{ current_user.investor_profile.pel_cel_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Épargne courante</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="current_savings" 
                               value="{{ current_user.investor_profile.current_savings or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                
                <!-- Liquidités personnalisées -->
                <div style="margin-top: 25px;">
                    <h5 style="color: #344D59; margin-bottom: 15px; font-weight: 600;">Liquidités personnalisées</h5>
                    <div id="liquiditesContainer">
                        {% if current_user.investor_profile.liquidites_personnalisees_data %}
                            {% for liquidite in current_user.investor_profile.liquidites_personnalisees_data %}
                            <div class="dynamic-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
                                <div>
                                    <input type="text" class="form-control" name="liquidite_personnalisee_name[]" 
                                           value="{{ liquidite.name }}" placeholder="Nom de la liquidité"
                                           style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <input type="number" step="0.01" class="form-control" name="liquidite_personnalisee_amount[]" 
                                           value="{{ liquidite.amount }}" placeholder="Montant en €"
                                           style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-success btn-sm" onclick="addLiquidite()" 
                            style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px; margin-top: 8px;">
                        <i class="fas fa-plus"></i> Ajouter une liquidité
                    </button>
                </div>
                
                <!-- Total Liquidités -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(19, 124, 139, 0.7); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-tint" style="color: white;"></i>
                            <span style="font-weight: 600; color: white;">Total Liquidités</span>
                        </div>
                        <div id="edit-total-liquidites-value" style="font-weight: 700; font-size: 16px; color: white;">
                            {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_liquidites or 0) }}€
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section PLACEMENTS FINANCIERS -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #344D59; margin-bottom: 20px; font-weight: 600; font-size: 16px;">
                    <i class="fas fa-chart-line" style="color: var(--qlower-primary); margin-right: 8px;"></i>
                    Placements Financiers
                </h4>
                <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">PEA</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="pea_value" 
                               value="{{ current_user.investor_profile.pea_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">PER</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="per_value" 
                               value="{{ current_user.investor_profile.per_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Assurance Vie</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="life_insurance_value" 
                               value="{{ current_user.investor_profile.life_insurance_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">CTO</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="cto_value" 
                               value="{{ current_user.investor_profile.cto_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">PEE/PERCO</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="pee_value" 
                               value="{{ current_user.investor_profile.pee_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Private Equity</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="private_equity_value" 
                               value="{{ current_user.investor_profile.private_equity_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="edit-item">
                        <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">SCPI</label>
                        <input type="number" step="0.01" class="form-control edit-input" name="scpi_value" 
                               value="{{ current_user.investor_profile.scpi_value or '' }}" 
                               placeholder="0.00"
                               style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                
                <!-- Placements personnalisés -->
                <div style="margin-top: 25px;">
                    <h5 style="color: #344D59; margin-bottom: 15px; font-weight: 600;">Placements personnalisés</h5>
                    <div id="placementsContainer">
                        {% if current_user.investor_profile.placements_personnalises_data %}
                            {% for placement in current_user.investor_profile.placements_personnalises_data %}
                            <div class="dynamic-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
                                <div>
                                    <input type="text" class="form-control" name="placement_personnalise_name[]" 
                                           value="{{ placement.name }}" placeholder="Nom du placement"
                                           style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <input type="number" step="0.01" class="form-control" name="placement_personnalise_amount[]" 
                                           value="{{ placement.amount }}" placeholder="Montant en €"
                                           style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-success btn-sm" onclick="addPlacement()" 
                            style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px; margin-top: 8px;">
                        <i class="fas fa-plus"></i> Ajouter un placement
                    </button>
                </div>
                
                <!-- Total Placements Financiers -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(19, 124, 139, 0.7); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-line" style="color: white;"></i>
                            <span style="font-weight: 600; color: white;">Total Placements Financiers</span>
                        </div>
                        <div id="edit-total-placements-value" style="font-weight: 700; font-size: 16px; color: white;">
                            {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_placements or 0) }}€
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section IMMOBILIER -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #344D59; margin-bottom: 20px; font-weight: 600; font-size: 16px;">
                    <i class="fas fa-home" style="color: var(--qlower-primary); margin-right: 8px;"></i>
                    Patrimoine Immobilier
                </h4>
                
                <div id="immobilierContainer">
                    {% if current_user.investor_profile.immobilier_data %}
                        {% for bien in current_user.investor_profile.immobilier_data %}
                        <div class="bien-edit-card" style="background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                            <div class="bien-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h5 style="color: var(--qlower-dark); font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px;">
                                    {% if bien.type == 'residence_principale' %}
                                        🏠 Résidence principale
                                    {% elif bien.type == 'residence_secondaire' %}
                                        🏖️ Résidence secondaire  
                                    {% elif bien.type == 'investissement_locatif' %}
                                        🏢 Investissement locatif
                                    {% else %}
                                        🏠 Bien immobilier
                                    {% endif %}
                                </h5>
                                <button type="button" class="btn-remove" onclick="this.closest('.bien-edit-card').remove()" 
                                        style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                            
                            <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                                <div class="edit-item">
                                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Type de bien *</label>
                                    <select class="form-control edit-input" name="bien_type[]" required
                                            style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                        <option value="">Choisir...</option>
                                        <option value="residence_principale" {{ 'selected' if bien.type == 'residence_principale' }}>Résidence principale</option>
                                        <option value="residence_secondaire" {{ 'selected' if bien.type == 'residence_secondaire' }}>Résidence secondaire</option>
                                        <option value="investissement_locatif" {{ 'selected' if bien.type == 'investissement_locatif' }}>Investissement locatif</option>
                                    </select>
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Description</label>
                                    <input type="text" class="form-control edit-input" name="bien_description[]" 
                                           value="{{ bien.description or '' }}" placeholder="Ex: Appartement 3 pièces Paris"
                                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Valeur du bien *</label>
                                    <input type="number" step="0.01" class="form-control edit-input bien-valeur-input" name="bien_valeur[]" 
                                           value="{{ bien.valeur }}" placeholder="0.00" required
                                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Surface (m²)</label>
                                    <input type="number" step="0.01" class="form-control edit-input bien-surface-input" name="bien_surface[]" 
                                           value="{{ bien.surface or '' }}" placeholder="0.00"
                                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <!-- Prix au m² (calculé automatiquement via JavaScript) -->
                                <div class="edit-item" style="{% if bien.valeur and bien.surface and bien.valeur > 0 and bien.surface > 0 %}display: block;{% else %}display: none;{% endif %}">
                                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Prix au m²</label>
                                    <input type="text" class="form-control edit-input prix-m2-display" 
                                           readonly placeholder="Calculé automatiquement"
                                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; background-color: #f8f9fa; color: #6c757d;">
                                </div>
                            </div>
                            
                            <!-- Section Crédit Immobilier associé -->
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                    <input type="checkbox" name="bien_has_credit[]" value="1" {{ 'checked' if bien.get('credit_montant') and bien.get('credit_montant')|float > 0 }}
                                           onchange="toggleCreditSection(this)" style="transform: scale(1.2); accent-color: var(--qlower-primary);">
                                    <label style="font-weight: 600; color: #344D59; margin: 0;">Ce bien a un crédit immobilier associé</label>
                                </div>
                                
                                <div class="credit-details" style="{{ 'display: block;' if bien.get('credit_montant') and bien.get('credit_montant')|float > 0 else 'display: none;' }} background: white; border-radius: 8px; padding: 20px; border: 1px solid #e5e7eb;">
                                    <h6 style="color: var(--qlower-primary); font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-credit-card"></i>
                                        Crédit immobilier
                                    </h6>
                                    <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div class="edit-item">
                                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Montant emprunté</label>
                                            <input type="number" step="0.01" class="form-control edit-input credit-montant-input" name="credit_montant[]" 
                                                   value="{{ bien.get('credit_montant', '') }}" placeholder="0.00"
                                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                        </div>
                                        <div class="edit-item">
                                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Taux TAEG (%)</label>
                                            <input type="number" step="0.01" class="form-control edit-input credit-taeg-input" name="credit_taeg[]" 
                                                   value="{{ bien.get('credit_taeg', '') }}" placeholder="Ex: 3.5"
                                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                        </div>
                                        <div class="edit-item">
                                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Durée (années)</label>
                                            <input type="number" class="form-control edit-input credit-duree-input" name="credit_duree[]" 
                                                   value="{{ bien.get('credit_duree', '') }}" placeholder="25"
                                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                        </div>
                                        <div class="edit-item">
                                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Date de début</label>
                                            <input type="month" class="form-control edit-input credit-date-input" name="credit_date[]" 
                                                   value="{{ bien.get('credit_date', '') }}"
                                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Détails calculés du crédit (mise à jour automatique via JavaScript) -->
                                    <div class="credit-calculations" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; {% if bien.get('credit_montant') and bien.get('credit_montant')|float > 0 %}display: block;{% else %}display: none;{% endif %}">
                                        <h6 style="color: var(--qlower-primary); font-weight: 600; margin-bottom: 15px; font-size: 14px;">Détails calculés du crédit</h6>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 12px; color: #7A90A4; margin-bottom: 4px;">Mensualités</div>
                                                <div class="credit-mensualite" style="font-size: 16px; font-weight: 700; color: var(--qlower-primary);">Calcul en cours...</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 12px; color: #7A90A4; margin-bottom: 4px;">Montant restant à rembourser</div>
                                                <div class="credit-montant-restant" style="font-size: 16px; font-weight: 700; color: var(--qlower-primary);">Calcul en cours...</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 12px; color: #7A90A4; margin-bottom: 4px;">Total payé</div>
                                                <div class="credit-total-paye" style="font-size: 16px; font-weight: 700; color: var(--qlower-primary);">Calcul en cours...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Valeur nette du bien (mise à jour automatique via JavaScript) -->
                            <div style="margin-top: 15px; padding: 10px 15px; background: rgba(19, 124, 139, 0.7); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 600;">Valeur nette du bien</span>
                                <span class="valeur-nette-display" style="font-size: 16px; font-weight: 700; color: white;">Calcul en cours...</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <div style="display: flex; justify-content: center; margin: 20px 0;">
                    <button type="button" class="btn btn-success btn-sm add-bien-btn" onclick="addBienImmobilier()" 
                            style="padding: 12px 24px; background: var(--qlower-primary); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 15px; box-shadow: 0 2px 8px rgba(19, 124, 139, 0.2); transition: all 0.2s ease;">
                        <i class="fas fa-plus" style="font-size: 16px;"></i> Ajouter un bien immobilier
                    </button>
                </div>
                
                <style>
                .add-bien-btn:hover {
                    background: var(--qlower-dark) !important;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(19, 124, 139, 0.3) !important;
                }
                </style>
                
                <!-- Total Immobilier Net -->
                <div id="totalImmobilierNetEdit" style="margin-top: 20px; padding: 15px; background: rgba(19, 124, 139, 0.7); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-home" style="color: white;"></i>
                            <span style="font-weight: 600; color: white;">Total Immobilier Net</span>
                        </div>
                        <div style="font-weight: 700; font-size: 16px; color: white;">
                            {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_immobilier_net or 0) }}€
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section CRYPTOMONNAIES -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #344D59; margin-bottom: 20px; font-weight: 600; font-size: 16px;">
                    <i class="fab fa-bitcoin" style="color: var(--qlower-primary); margin-right: 8px;"></i>
                    Cryptomonnaies
                </h4>
                <div id="cryptoContainer">
                    {% if current_user.investor_profile.cryptomonnaies_data %}
                        {% for crypto in current_user.investor_profile.cryptomonnaies_data %}
                        <div class="crypto-edit-row" style="background: #f8f9fa; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                                <div>
                                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Cryptomonnaie</label>
                                    <select class="form-control crypto-select" name="crypto_symbol[]"
                                            style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;">
                                        <option value="">Choisir une crypto...</option>
                                        <optgroup label="🥇 Top 50 Cryptomonnaies">
                                            <option value="bitcoin" {{ 'selected' if crypto.symbol == 'bitcoin' }}>1. Bitcoin (BTC)</option>
                                            <option value="ethereum" {{ 'selected' if crypto.symbol == 'ethereum' }}>2. Ethereum (ETH)</option>
                                            <option value="tether" {{ 'selected' if crypto.symbol == 'tether' }}>3. Tether (USDT)</option>
                                            <option value="binancecoin" {{ 'selected' if crypto.symbol == 'binancecoin' }}>4. BNB (BNB)</option>
                                            <option value="solana" {{ 'selected' if crypto.symbol == 'solana' }}>5. Solana (SOL)</option>
                                            <option value="usd-coin" {{ 'selected' if crypto.symbol == 'usd-coin' }}>6. USDC (USDC)</option>
                                            <option value="ripple" {{ 'selected' if crypto.symbol == 'ripple' }}>7. XRP (XRP)</option>
                                            <option value="dogecoin" {{ 'selected' if crypto.symbol == 'dogecoin' }}>8. Dogecoin (DOGE)</option>
                                            <option value="cardano" {{ 'selected' if crypto.symbol == 'cardano' }}>9. Cardano (ADA)</option>
                                            <option value="tron" {{ 'selected' if crypto.symbol == 'tron' }}>10. TRON (TRX)</option>
                                            <option value="chainlink" {{ 'selected' if crypto.symbol == 'chainlink' }}>11. Chainlink (LINK)</option>
                                            <option value="polygon" {{ 'selected' if crypto.symbol == 'polygon' }}>12. Polygon (MATIC)</option>
                                            <option value="wrapped-bitcoin" {{ 'selected' if crypto.symbol == 'wrapped-bitcoin' }}>13. Wrapped Bitcoin (WBTC)</option>
                                            <option value="avalanche-2" {{ 'selected' if crypto.symbol == 'avalanche-2' }}>14. Avalanche (AVAX)</option>
                                            <option value="dai" {{ 'selected' if crypto.symbol == 'dai' }}>15. Dai (DAI)</option>
                                            <option value="shiba-inu" {{ 'selected' if crypto.symbol == 'shiba-inu' }}>16. Shiba Inu (SHIB)</option>
                                            <option value="polkadot" {{ 'selected' if crypto.symbol == 'polkadot' }}>17. Polkadot (DOT)</option>
                                            <option value="litecoin" {{ 'selected' if crypto.symbol == 'litecoin' }}>18. Litecoin (LTC)</option>
                                            <option value="bitcoin-cash" {{ 'selected' if crypto.symbol == 'bitcoin-cash' }}>19. Bitcoin Cash (BCH)</option>
                                            <option value="near" {{ 'selected' if crypto.symbol == 'near' }}>20. NEAR Protocol (NEAR)</option>
                                            <option value="uniswap" {{ 'selected' if crypto.symbol == 'uniswap' }}>21. Uniswap (UNI)</option>
                                            <option value="internet-computer" {{ 'selected' if crypto.symbol == 'internet-computer' }}>22. Internet Computer (ICP)</option>
                                            <option value="ethereum-classic" {{ 'selected' if crypto.symbol == 'ethereum-classic' }}>23. Ethereum Classic (ETC)</option>
                                            <option value="aptos" {{ 'selected' if crypto.symbol == 'aptos' }}>24. Aptos (APT)</option>
                                            <option value="stellar" {{ 'selected' if crypto.symbol == 'stellar' }}>25. Stellar (XLM)</option>
                                            <option value="monero" {{ 'selected' if crypto.symbol == 'monero' }}>26. Monero (XMR)</option>
                                            <option value="hedera-hashgraph" {{ 'selected' if crypto.symbol == 'hedera-hashgraph' }}>27. Hedera (HBAR)</option>
                                            <option value="cosmos" {{ 'selected' if crypto.symbol == 'cosmos' }}>28. Cosmos Hub (ATOM)</option>
                                            <option value="filecoin" {{ 'selected' if crypto.symbol == 'filecoin' }}>29. Filecoin (FIL)</option>
                                            <option value="arbitrum" {{ 'selected' if crypto.symbol == 'arbitrum' }}>30. Arbitrum (ARB)</option>
                                            <option value="vechain" {{ 'selected' if crypto.symbol == 'vechain' }}>31. VeChain (VET)</option>
                                            <option value="first-digital-usd" {{ 'selected' if crypto.symbol == 'first-digital-usd' }}>32. First Digital USD (FDUSD)</option>
                                            <option value="maker" {{ 'selected' if crypto.symbol == 'maker' }}>33. MakerDAO (MKR)</option>
                                            <option value="optimism" {{ 'selected' if crypto.symbol == 'optimism' }}>34. Optimism (OP)</option>
                                            <option value="immutable-x" {{ 'selected' if crypto.symbol == 'immutable-x' }}>35. Immutable (IMX)</option>
                                            <option value="render-token" {{ 'selected' if crypto.symbol == 'render-token' }}>36. Render (RNDR)</option>
                                            <option value="the-graph" {{ 'selected' if crypto.symbol == 'the-graph' }}>37. The Graph (GRT)</option>
                                            <option value="injective-protocol" {{ 'selected' if crypto.symbol == 'injective-protocol' }}>38. Injective (INJ)</option>
                                            <option value="sei-network" {{ 'selected' if crypto.symbol == 'sei-network' }}>39. Sei (SEI)</option>
                                            <option value="theta-token" {{ 'selected' if crypto.symbol == 'theta-token' }}>40. Theta Network (THETA)</option>
                                            <option value="bittensor" {{ 'selected' if crypto.symbol == 'bittensor' }}>41. Bittensor (TAO)</option>
                                            <option value="rune" {{ 'selected' if crypto.symbol == 'rune' }}>42. THORChain (RUNE)</option>
                                            <option value="stacks" {{ 'selected' if crypto.symbol == 'stacks' }}>43. Stacks (STX)</option>
                                            <option value="aave" {{ 'selected' if crypto.symbol == 'aave' }}>44. Aave (AAVE)</option>
                                            <option value="zcash" {{ 'selected' if crypto.symbol == 'zcash' }}>45. Zcash (ZEC)</option>
                                            <option value="dash" {{ 'selected' if crypto.symbol == 'dash' }}>46. Dash (DASH)</option>
                                            <option value="sushiswap" {{ 'selected' if crypto.symbol == 'sushiswap' }}>47. SushiSwap (SUSHI)</option>
                                            <option value="fantom" {{ 'selected' if crypto.symbol == 'fantom' }}>48. Fantom (FTM)</option>
                                            <option value="algorand" {{ 'selected' if crypto.symbol == 'algorand' }}>49. Algorand (ALGO)</option>
                                            <option value="neo" {{ 'selected' if crypto.symbol == 'neo' }}>50. NEO (NEO)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Quantité</label>
                                    <input type="number" step="0.00000001" class="form-control crypto-quantity" name="crypto_quantity[]" 
                                           value="{{ crypto.quantity }}" placeholder="0.00000000"
                                           style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Prix actuel</label>
                                    <div class="crypto-price" style="padding: 6px; background: rgba(19, 124, 139, 0.1); border-radius: 4px; font-weight: 600; color: var(--qlower-primary); text-align: center; font-size: 13px;">Chargement...</div>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Valeur détenue</label>
                                    <div class="crypto-value" style="padding: 6px; background: rgba(19, 124, 139, 0.1); border-radius: 4px; font-weight: 600; color: var(--qlower-primary); text-align: center; font-size: 13px;">0€</div>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; margin-top: 16px; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn btn-success btn-sm" onclick="addCrypto()" 
                        style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px; margin-top: 8px;">
                    <i class="fab fa-bitcoin"></i> Ajouter une cryptomonnaie
                </button>
                
                <!-- Total Cryptomonnaies -->
                <div id="totalCryptoEdit" style="margin-top: 20px; padding: 15px; background: rgba(19, 124, 139, 0.7); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fab fa-bitcoin" style="color: white;"></i>
                            <span style="font-weight: 600; color: white;">Total Cryptomonnaies</span>
                        </div>
                        <div id="totalCryptoEditValue" style="font-weight: 700; font-size: 16px; color: white;">
                            0€
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section AUTRES BIENS -->
            <div class="edit-section" style="margin-bottom: 30px;">
                <h4 style="color: var(--qlower-primary); font-weight: 700; font-size: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-gem"></i>
                    Autres Biens
                </h4>
                <div id="autresBiensContainer">
                    {% if current_user.investor_profile.autres_biens_data %}
                        {% for bien in current_user.investor_profile.autres_biens_data %}
                        <div class="dynamic-row" style="display: flex; gap: 15px; margin-bottom: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <label class="edit-label">Nom du bien</label>
                                <input type="text" class="form-control edit-input" name="autre_bien_name[]" 
                                       value="{{ bien.name }}" placeholder="Ex: Œuvre d'art, Collection">
                            </div>
                            <div style="flex: 1;">
                                <label class="edit-label">Valeur estimée</label>
                                <input type="number" step="0.01" class="form-control edit-input" name="autre_bien_valeur[]" 
                                       value="{{ bien.valeur }}" placeholder="0.00">
                            </div>
                            <button type="button" class="btn-remove" onclick="this.closest('.dynamic-row').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn btn-success btn-sm" onclick="addAutreBien()"
                        style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px;">
                    <i class="fas fa-gem"></i> Ajouter un autre bien
                </button>
                
                <!-- Total Autres Biens -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(19, 124, 139, 0.7); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-gem" style="color: white;"></i>
                            <span style="font-weight: 600; color: white;">Total Autres Biens</span>
                        </div>
                        <div id="edit-total-autres-biens-value" style="font-weight: 700; font-size: 16px; color: white;">
                            {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_autres_biens or 0) }}€
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOTAL ÉPARGNE & PATRIMOINE -->
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%); border-radius: 12px; color: white; box-shadow: 0 4px 20px rgba(19, 124, 139, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-coins" style="font-size: 24px;"></i>
                        <span style="font-weight: 700; font-size: 18px;">TOTAL ÉPARGNE & PATRIMOINE</span>
                    </div>
                    <div style="font-weight: 800; font-size: 24px;">
                        {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_actifs or 0) }}€
                    </div>
                </div>
            </div>
            {% else %}
            <!-- MODE VISUALISATION - ÉPARGNE & PATRIMOINE -->
            <!-- Note: Tous les totaux proviennent exclusivement des champs calculated_total_* de la BDD -->
            
            <!-- Sous-section LIQUIDITÉS -->
            {% set has_liquidites = false %}
            
            {% if current_user.investor_profile.livret_a_value or current_user.investor_profile.ldds_value or current_user.investor_profile.pel_cel_value or current_user.investor_profile.current_savings or current_user.investor_profile.current_account_value or current_user.investor_profile.liquidites_personnalisees_data %}
                {% set has_liquidites = true %}
            {% endif %}
            
            {% if has_liquidites %}
            <div class="revenue-subsection">
                <h4 class="revenue-subsection-title">
                    <i class="fas fa-tint"></i>
                    Liquidités
                </h4>
                <div class="data-list">
                    {% if current_user.investor_profile.livret_a_value %}
                        <div class="data-item">
                            <div class="data-label">Livret A</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.livret_a_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.ldds_value %}
                        <div class="data-item">
                            <div class="data-label">LDDS</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.ldds_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.pel_cel_value %}
                        <div class="data-item">
                            <div class="data-label">PEL/CEL</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.pel_cel_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.current_savings %}
                        <div class="data-item">
                            <div class="data-label">Épargne courante</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.current_savings) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.current_account_value %}
                        <div class="data-item">
                            <div class="data-label">Compte courant</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.current_account_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.liquidites_personnalisees_data %}
                        {% for liquidite in current_user.investor_profile.liquidites_personnalisees_data %}
                        <div class="data-item">
                            <div class="data-label">{{ liquidite.name }}</div>
                            <div class="data-value">{{ "{:,.0f}".format(liquidite.amount) }}€</div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    <div class="liquidites-compact-item-total">
                        <div class="liquidites-compact-name-total">Total Liquidités</div>
                        <div id="view-total-liquidites-value" class="liquidites-compact-value-total">{{ "{:,.0f}".format(current_user.investor_profile.calculated_total_liquidites or 0) }}€</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sous-section PLACEMENTS FINANCIERS -->
            {% set has_placements = false %}
            
            {% if current_user.investor_profile.pea_value or current_user.investor_profile.per_value or current_user.investor_profile.life_insurance_value or current_user.investor_profile.cto_value or current_user.investor_profile.pee_perco_value or current_user.investor_profile.private_equity_value or current_user.investor_profile.scpi_value or current_user.investor_profile.placements_personnalises_data %}
                {% set has_placements = true %}
            {% endif %}
            
            {% if has_placements %}
            <div class="revenue-subsection">
                <h4 class="revenue-subsection-title">
                    <i class="fas fa-chart-line"></i>
                    Placements Financiers
                </h4>
                <div class="data-list">
                    {% if current_user.investor_profile.pea_value %}
                        <div class="data-item">
                            <div class="data-label">PEA</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.pea_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.per_value %}
                        <div class="data-item">
                            <div class="data-label">PER</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.per_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.life_insurance_value %}
                        <div class="data-item">
                            <div class="data-label">Assurance Vie</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.life_insurance_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.cto_value %}
                        <div class="data-item">
                            <div class="data-label">CTO</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.cto_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.pee_perco_value %}
                        <div class="data-item">
                            <div class="data-label">PEE/PERCO</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.pee_perco_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.private_equity_value %}
                        <div class="data-item">
                            <div class="data-label">Private Equity</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.private_equity_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.scpi_value %}
                        <div class="data-item">
                            <div class="data-label">SCPI</div>
                            <div class="data-value">{{ "{:,.0f}".format(current_user.investor_profile.scpi_value) }}€</div>
                        </div>
                    {% endif %}
                    
                    {% if current_user.investor_profile.placements_personnalises_data %}
                        {% for placement in current_user.investor_profile.placements_personnalises_data %}
                        <div class="data-item">
                            <div class="data-label">{{ placement.name }}</div>
                            <div class="data-value">{{ "{:,.0f}".format(placement.amount) }}€</div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    <div class="placements-compact-item-total">
                        <div class="placements-compact-name-total">Total Placements</div>
                        <div id="view-total-placements-value" class="placements-compact-value-total">{{ "{:,.0f}".format(current_user.investor_profile.calculated_total_placements or 0) }}€</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sous-section IMMOBILIER -->
            {% if immobilier_with_calculations %}
            <div class="revenue-subsection">
                <h4 class="revenue-subsection-title">
                    <i class="fas fa-home"></i>
                    Immobilier
                </h4>
                
                {% for bien in immobilier_with_calculations %}
                <div class="dynamic-section">
                    <div class="dynamic-section-title">
                        {% if bien.type == 'residence_principale' %}
                            🏠 Résidence principale
                        {% elif bien.type == 'residence_secondaire' %}
                            🏖️ Résidence secondaire
                        {% elif bien.type == 'investissement_locatif' %}
                            🏢 {{ bien.description or 'Investissement locatif' }}
                        {% endif %}
                    </div>
                    
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Valeur du bien</div>
                            <div class="data-value financial">{{ "{:,.0f}".format(bien.valeur) }}€</div>
                        </div>
                    </div>
                    
                    {% if bien.surface %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Surface</div>
                            <div class="data-value">{{ bien.surface }} m²</div>
                        </div>
                    </div>
                    
                    {% if bien.valeur and bien.surface %}
                    {% set prix_m2 = (bien.valeur / bien.surface)|round|int %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Prix au m²</div>
                            <div class="data-value">{{ "{:,.0f}".format(prix_m2) }}€/m²</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {# Utilisation des valeurs précalculées par la route avec CreditCalculationService #}
                    <div class="liquidites-compact-item-total" style="margin-top: 8px;">
                        <div class="liquidites-compact-name-total">Total valeur nette du bien</div>
                        <div class="liquidites-compact-value-total">{{ "{:,.0f}".format(bien.calculated_valeur_nette) }}€</div>
                    </div>
                    
                    {% if bien.has_credit %}
                    <div class="revenue-subsection-subtitle" style="margin-top: 20px; margin-bottom: 8px; color: var(--qlower-primary); font-weight: 600;">
                        💳 Crédit immobilier associé
                    </div>
                    
                    {% if bien.credit_montant %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Montant initial</div>
                            <div class="data-value">{{ "{:,.0f}".format(bien.credit_montant) }}€</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if bien.credit_tag %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Taux TAG</div>
                            <div class="data-value">{{ bien.credit_tag }}%</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if bien.credit_taeg %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Taux TAEG</div>
                            <div class="data-value">{{ bien.credit_taeg }}%</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if bien.credit_duree %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Durée</div>
                            <div class="data-value">{{ bien.credit_duree }} ans</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if bien.credit_date %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Date de début</div>
                            <div class="data-value">{{ bien.credit_date }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if bien.calculated_mensualite > 0 %}
                    <div class="dynamic-item">
                        <div class="data-item">
                            <div class="data-label">Mensualité</div>
                            <div class="data-value">{{ "{:,.0f}".format(bien.calculated_mensualite) }}€</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if bien.calculated_capital_restant > 0 %}
                    <div class="liquidites-compact-item-total" style="margin-top: 8px; background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;">
                        <div class="liquidites-compact-name-total">Montant restant du crédit à rembourser</div>
                        <div class="liquidites-compact-value-total">{{ "{:,.0f}".format(bien.calculated_capital_restant) }}€</div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
                
                <!-- Total Immobilier Net -->
                <div id="totalImmobilierNet" style="margin-top: 20px; padding: 15px; background: rgba(19, 124, 139, 0.7); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-home" style="color: white;"></i>
                            <span style="font-weight: 600; color: white;">Total Immobilier Net</span>
                        </div>
                        <div style="font-weight: 700; font-size: 16px; color: white;">
                            {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_immobilier_net or 0) }}€
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sous-section CRYPTOMONNAIES -->
            {% if current_user.investor_profile.cryptomonnaies_data %}
            <div class="revenue-subsection">
                <h4 class="revenue-subsection-title">
                    <i class="fab fa-bitcoin"></i>
                    Cryptomonnaies
                </h4>
                <div class="data-list">
                    {% for crypto in current_user.investor_profile.cryptomonnaies_data %}
                    {% set crypto_symbol = 'BTC' if crypto.symbol.lower() in ['bitcoin', 'btc'] else 
                                          'ETH' if crypto.symbol.lower() in ['ethereum', 'eth'] else 
                                          'BNB' if crypto.symbol.lower() in ['binancecoin', 'bnb'] else 
                                          'ADA' if crypto.symbol.lower() in ['cardano', 'ada'] else 
                                          'SOL' if crypto.symbol.lower() in ['solana', 'sol'] else 
                                          'DOT' if crypto.symbol.lower() in ['polkadot', 'dot'] else 
                                          'MATIC' if crypto.symbol.lower() in ['matic', 'polygon'] else 
                                          'LINK' if crypto.symbol.lower() in ['chainlink', 'link'] else 
                                          'LTC' if crypto.symbol.lower() in ['litecoin', 'ltc'] else 
                                          'XRP' if crypto.symbol.lower() in ['ripple', 'xrp'] else 
                                          crypto.symbol.upper() %}
                    <div class="data-item crypto-layout">
                        <div class="crypto-symbol">{{ crypto_symbol }}</div>
                        <div class="crypto-quantity">{{ crypto.quantity }}</div>
                        <div class="crypto-value" data-symbol="{{ crypto.symbol.lower() }}" data-quantity="{{ crypto.quantity }}">
                            <span class="loading">Chargement...</span>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="liquidites-compact-item-total">
                        <div class="liquidites-compact-name-total">Total Cryptomonnaies</div>
                        <div class="liquidites-compact-value-total" id="totalCryptoValue">0€</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sous-section AUTRES BIENS -->
            {% if current_user.investor_profile.autres_biens_data %}
            <div class="revenue-subsection">
                <h4 class="revenue-subsection-title">
                    <i class="fas fa-gem"></i>
                    Autres Biens
                </h4>
                <div class="data-list">
                    {% for bien in current_user.investor_profile.autres_biens_data %}
                    <div class="data-item">
                        <div class="data-label">{{ bien.name }}</div>
                        <div class="data-value">{{ "{:,.0f}".format(bien.valeur) }}€</div>
                    </div>
                    {% endfor %}
                    
                    <div class="liquidites-compact-item-total">
                        <div class="liquidites-compact-name-total">Total Autres Biens</div>
                        <div id="view-total-autres-biens-value" class="liquidites-compact-value-total">{{ "{:,.0f}".format(current_user.investor_profile.calculated_total_autres_biens or 0) }}€</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- TOTAL ÉPARGNE & PATRIMOINE -->
            <div class="patrimoine-super-total" style="margin-top: 25px;">
                <div class="patrimoine-super-label">Total Épargne & Patrimoine</div>
                {% if edit_mode %}
                    {% set total_sans_crypto = (current_user.investor_profile.calculated_total_liquidites or 0) + (current_user.investor_profile.calculated_total_placements or 0) + (current_user.investor_profile.calculated_total_immobilier_net or 0) + (current_user.investor_profile.calculated_total_autres_biens or 0) %}
                    {% set total_sans_crypto_rounded = total_sans_crypto|round(0)|int %}
                    <div class="patrimoine-super-value" id="totalPatrimoineValue" 
                         data-total-sans-crypto="{{ total_sans_crypto_rounded }}">{{ "{:,}".format(total_sans_crypto_rounded) }}€</div>
                {% else %}
                    {% set total_actifs_raw = current_user.investor_profile.calculated_total_actifs or 0 %}
                    {% set total_actifs_rounded = total_actifs_raw|round(0)|int %}
                    <div class="patrimoine-super-value">{{ "{:,}".format(total_actifs_rounded) }}€</div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- CRÉDITS -->
    <div class="platform-card" id="credits">
        <div class="platform-card-header">
            <div>
                <div class="platform-card-title">CRÉDITS (hors immobilier)</div>
                <div class="platform-card-subtitle">Vos crédits à la consommation et autres emprunts</div>
            </div>
        </div>
        <div class="platform-card-body">
            {% if edit_mode %}
            <!-- MODE ÉDITION - CRÉDITS -->
            <div class="edit-section">
                <h4 style="color: var(--qlower-primary); font-weight: 700; font-size: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-credit-card"></i>
                    Crédits en cours
                </h4>
                
                <div id="creditsContainer">
                    {% if current_user.investor_profile.credits_data %}
                        {% for credit in current_user.investor_profile.credits_data %}
                        <div class="credit-edit-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #fafafa;">
                            <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                                <div class="edit-item">
                                    <label class="edit-label">Description du crédit *</label>
                                    <input type="text" class="form-control edit-input" name="credit_conso_description[]" 
                                           value="{{ credit.description }}" placeholder="Ex: Crédit auto, Prêt personnel..." required>
                                    <input type="hidden" name="credit_conso_id[]" value="{{ credit.get('id', loop.index0) }}">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label">Montant initial</label>
                                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_montant_initial[]" 
                                           value="{{ credit.montant_initial }}" placeholder="0.00">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label">Montant restant à rembourser</label>
                                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_montant_restant[]" 
                                           value="{{ credit.montant_restant or credit.montant_initial }}" placeholder="0.00">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label">Taux d'intérêt (%)</label>
                                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_taux[]" 
                                           value="{{ credit.taux or '' }}" placeholder="Ex: 3.5">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label">Durée initiale (années)</label>
                                    <input type="number" class="form-control edit-input" name="credit_conso_duree[]" 
                                           value="{{ credit.duree or '' }}" placeholder="Ex: 5">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label">Date de début</label>
                                    <input type="month" class="form-control edit-input" name="credit_conso_date_depart[]" 
                                           value="{{ credit.date_depart or '' }}">
                                </div>
                                <div class="edit-item">
                                    <label class="edit-label">Mensualité</label>
                                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_mensualite[]" 
                                           value="{{ credit.mensualite or '' }}" placeholder="0.00">
                                </div>
                                <div class="edit-item" style="display: flex; align-items: end;">
                                    <button type="button" class="btn-remove" onclick="this.closest('.credit-edit-card').remove(); updateTotalCreditsConsommation();" 
                                            style="width: 100%; padding: 10px; background: #dc3545 !important; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        <i class="fas fa-trash"></i> Supprimer ce crédit
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <button type="button" class="btn btn-success btn-sm" onclick="addCredit()" 
                        style="padding: 8px 16px; background: var(--qlower-primary); color: white; border: none; border-radius: 6px; margin-top: 15px;">
                    <i class="fas fa-plus"></i> Ajouter un crédit
                </button>
                
                <!-- Total Crédits -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fee 0%, #fdd 100%); border-radius: 8px; border-left: 4px solid #dc3545;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-credit-card" style="color: #dc3545;"></i>
                            <span style="font-weight: 600; color: #344D59;">Total Crédits à Rembourser</span>
                        </div>
                        <div style="font-weight: 700; font-size: 16px; color: #dc3545;">
                            {{ "{:,.0f}".format(current_user.investor_profile.calculated_total_credits_consommation or 0) }}€
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- MODE VISUALISATION - CRÉDITS -->
            {% if current_user.investor_profile.credits_data %}
            {% for credit in current_user.investor_profile.credits_data %}
            <div class="revenue-subsection">
                <h4 class="revenue-subsection-title">
                    <i class="fas fa-credit-card"></i>
                    {{ credit.description }}
                </h4>
                <div class="data-list">
                    <div class="data-item">
                        <div class="data-label">Montant initial</div>
                        <div class="data-value">{{ "{:,.0f}".format(credit.montant_initial) }}€</div>
                    </div>
                    
                    {% if credit.taux %}
                    <div class="data-item">
                        <div class="data-label">Taux d'intérêt</div>
                        <div class="data-value">{{ credit.taux }}%</div>
                    </div>
                    {% endif %}
                    
                    {% if credit.duree %}
                    <div class="data-item">
                        <div class="data-label">Durée</div>
                        <div class="data-value">{{ credit.duree }} ans</div>
                    </div>
                    {% endif %}
                    
                    {% if credit.date_depart %}
                    <div class="data-item">
                        <div class="data-label">Date de début</div>
                        <div class="data-value">{{ credit.date_depart }}</div>
                    </div>
                    {% endif %}
                    
                    {% if credit.get('mensualite') %}
                    <div class="data-item">
                        <div class="data-label">Mensualité</div>
                        <div class="data-value">{{ "{:,.0f}".format(credit.mensualite) }}€/mois</div>
                    </div>
                    {% endif %}
                    
                    <div class="liquidites-compact-item-total" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;">
                        <div class="liquidites-compact-name-total">Capital restant dû</div>
                        <div class="liquidites-compact-value-total">{{ "{:,.0f}".format(credit.get('capital_restant', credit.get('montant_restant', credit.montant_initial))) }}€</div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Total des crédits maintenant récupéré depuis calculated_total_credits_consommation -->
            
            <div class="patrimoine-super-total" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;">
                <div class="patrimoine-super-label">Total Crédits à Rembourser</div>
                <div class="patrimoine-super-value">{{ "{:,.0f}".format(current_user.investor_profile.calculated_total_credits_consommation or 0) }}€</div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- BILAN PATRIMONIAL FINAL -->
    <!-- IMPORTANT: Utilisation des totaux calculated_* sauvegardés en base -->
    
    <!-- Utilisation des totaux calculated depuis la base de données -->
    {% set total_actifs_visible = current_user.investor_profile.calculated_total_actifs or 0 %}
    {% set total_dettes_visible = current_user.investor_profile.calculated_total_credits_consommation or 0 %}
    {% set patrimoine_net_visible = current_user.investor_profile.calculated_patrimoine_total_net or 0 %}
    
    <div class="patrimoine-final" id="patrimoine-net-total">
        <div class="patrimoine-icon">
            <i class="fas fa-crown"></i>
        </div>
        <div class="patrimoine-title">PATRIMOINE NET TOTAL</div>
        <div class="patrimoine-value" id="patrimoineNetValue">{{ "{:,.0f}".format(patrimoine_net_visible) }}€</div>
        <div class="patrimoine-details">
            Total Actifs: <span id="totalActifsDetail">{{ "{:,.0f}".format(total_actifs_visible) }}€</span> • Total Dettes: <span id="totalDettesDetail">{{ "{:,.0f}".format(total_dettes_visible) }}€</span>
        </div>
    </div>
    
    {% if edit_mode %}
    </form>
    
    <!-- BOUTONS D'ACTION FLOTTANTS EN BAS A GAUCHE -->
    <div class="action-floating-buttons">
        <button type="button" onclick="window.location.href='{{ url_for('platform_investor.investor_data') }}'" 
                class="action-floating-btn cancel-btn" title="Annuler les modifications">
            <i class="fas fa-times"></i>
            <span>Annuler</span>
        </button>
        <button type="submit" form="investorEditForm"
                class="action-floating-btn save-btn" title="Sauvegarder les modifications">
            <i class="fas fa-save"></i>
            <span>Sauvegarder les modifications</span>
        </button>
    </div>
    {% else %}
    <!-- BOUTON D'ÉDITION FLOTTANT -->
    <button class="edit-floating-btn" type="button" title="Modifier les données"
            onclick="window.location.href='{{ url_for('platform_investor.investor_data', edit='true') }}'">
        <i class="fas fa-edit"></i>
        <span>Modifier les données</span>
    </button>
    {% endif %}
</div>

{% else %}
<!-- Utilisateur sans profil investisseur -->
<div class="investor-dashboard">
    <div class="platform-card">
        <div class="platform-card-body">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <div class="empty-state-title">Profil investisseur non complété</div>
                <div class="empty-state-text">Complétez votre profil pour accéder à vos données financières détaillées et bénéficier de nos conseils personnalisés.</div>
                <a href="{{ url_for('platform_investor.investor_data', edit=True) }}" class="platform-btn-primary">
                    <i class="fas fa-plus"></i>
                    Compléter mon profil
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCryptoPrices();
    initQuickNavigation();
    
    {% if edit_mode %}
    // 🔧 CORRECTION: Ces fonctions ne doivent s'exécuter qu'en mode édition
    console.log('🔧 Mode édition détecté - Initialisation des calculs JavaScript');
    setupConsumerCreditEventListeners();
    setupAllTotalsEventListeners();
    
    // Calculs initiaux des totaux (SEULEMENT en mode édition)
    updateTotalCreditsConsommation();
    updateTotalLiquidites();
    updateTotalPlacementsFinanciers();
    updateTotalAutresBiens();
    updateTotalEpargnePatrimoine();
    updatePatrimoineNetTotal();
    
    // Fonction debug pour forcer le recalcul (temporaire)
    window.debugRecalculerLiquidites = function() {
        console.log('🔍 DEBUG: Force recalcul liquidités...');
        updateTotalLiquidites();
    };
    {% else %}
    console.log('🔧 Mode visualisation détecté - Pas de calculs JavaScript, utilisation des valeurs DB');
    {% endif %}
});

async function loadCryptoPrices() {
    const cryptoElements = document.querySelectorAll('.crypto-value');
    if (cryptoElements.length === 0) return;
    
    try {
        console.log('🔄 Chargement des prix crypto depuis la DB...');
        // Utiliser l'API crypto qui lit TOUS les prix depuis la DB (mis à jour au démarrage)
        const response = await fetch('/plateforme/api/crypto-prices');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const pricesData = await response.json();
        
        if (pricesData.error) {
            throw new Error(pricesData.error);
        }
        
        console.log('💰 Données reçues:', Object.keys(pricesData));
        
        // Mapping des symbols pour correspondre aux données utilisateur (corrigé pour la DB)
        const symbolMapping = {
            'btc': 'bitcoin',
            'bitcoin': 'bitcoin', 
            'eth': 'ethereum',
            'ethereum': 'ethereum',
            'bnb': 'binancecoin',
            'binancecoin': 'binancecoin',
            'ada': 'cardano',
            'cardano': 'cardano',
            'sol': 'solana', 
            'solana': 'solana',
            'dot': 'polkadot',
            'polkadot': 'polkadot',
            'matic': 'polygon',
            'polygon': 'polygon',
            'link': 'chainlink',
            'chainlink': 'chainlink',
            'ltc': 'litecoin',
            'litecoin': 'litecoin',
            'xrp': 'ripple',
            'ripple': 'ripple'
        };
        
        // Mettre à jour chaque crypto
        let totalValue = 0;
        cryptoElements.forEach(el => {
            const symbol = el.dataset.symbol.toLowerCase();
            const quantity = parseFloat(el.dataset.quantity);
            
            console.log(`🔍 Recherche prix pour: ${symbol}, quantité: ${quantity}`);
            
            // Mapper vers l'ID utilisé en DB
            const dbSymbol = symbolMapping[symbol] || symbol;
            
            console.log(`🗂️ Symbole mappé: ${symbol} -> ${dbSymbol}`);
            
            if (pricesData[dbSymbol] && typeof pricesData[dbSymbol].eur === 'number') {
                const price = pricesData[dbSymbol].eur;
                const value = price * quantity;
                totalValue += value;
                
                console.log(`✅ ${dbSymbol}: €${price} × ${quantity} = €${value}`);
                
                el.innerHTML = `${value.toLocaleString('fr-FR', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })}`;
            } else {
                console.warn(`❌ Prix indisponible pour ${symbol} (mappé: ${dbSymbol})`);
                el.innerHTML = '<span class="error">Prix indisponible</span>';
            }
        });
        
        console.log(`💯 Total crypto calculé: €${totalValue}`);
        
        // Mettre à jour le total crypto
        const totalCryptoElement = document.getElementById('totalCryptoValue');
        if (totalCryptoElement) {
            const formattedValue = Math.round(totalValue).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            totalCryptoElement.textContent = `${formattedValue}€`;
        }
        
        // Mettre à jour le total patrimoine avec les cryptos
        updateTotalPatrimoine(totalValue);
        
    } catch (error) {
        console.error('❌ Erreur lors du chargement des prix crypto:', error);
        cryptoElements.forEach(el => {
            el.innerHTML = '<span class="error">Erreur de chargement</span>';
        });
    }
}

function updateTotalPatrimoine(cryptoTotalValue) {
    {% if edit_mode %}
    // Mettre à jour le "Total Épargne & Patrimoine" - UNIQUEMENT EN MODE ÉDITION
    const totalPatrimoineElement = document.getElementById('totalPatrimoineValue');
    if (totalPatrimoineElement) {
        const totalSansCrypto = parseFloat(totalPatrimoineElement.dataset.totalSansCrypto) || 0;
        const nouveauTotal = totalSansCrypto + cryptoTotalValue;
        
        const formattedTotal = Math.round(nouveauTotal).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        totalPatrimoineElement.textContent = `${formattedTotal}€`;
    }
    
    // Mettre à jour le "PATRIMOINE NET TOTAL" - UNIQUEMENT EN MODE ÉDITION
    const patrimoineNetElement = document.getElementById('patrimoineNetValue');
    const totalActifsDetailElement = document.getElementById('totalActifsDetail');
    
    if (patrimoineNetElement && totalActifsDetailElement) {
        const actifsSansCrypto = parseFloat(patrimoineNetElement.dataset.actifsSansCrypto) || 0;
        const passifs = parseFloat(patrimoineNetElement.dataset.passifs) || 0;
        
        const totalActifsAvecCrypto = actifsSansCrypto + cryptoTotalValue;
        const patrimoineNet = totalActifsAvecCrypto - passifs;
        
        // Formater les valeurs avec virgules
        const formattedActifs = Math.round(totalActifsAvecCrypto).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        const formattedPatrimoineNet = Math.round(patrimoineNet).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        // Mettre à jour l'affichage
        patrimoineNetElement.textContent = `${formattedPatrimoineNet}€`;
        totalActifsDetailElement.textContent = `${formattedActifs}€`;
        
        // IMPORTANT: Remplir les champs cachés pour la sauvegarde
        const hiddenTotalActifs = document.getElementById('hiddenTotalActifs');
        const hiddenPatrimoineNet = document.getElementById('hiddenPatrimoineNet');
        const hiddenTotalDettes = document.getElementById('hiddenTotalDettes');
        
        if (hiddenTotalActifs) {
            hiddenTotalActifs.value = Math.round(totalActifsAvecCrypto);
            console.log('🔧 hiddenTotalActifs.value =', hiddenTotalActifs.value);
        }
        if (hiddenPatrimoineNet) {
            hiddenPatrimoineNet.value = Math.round(patrimoineNet);
            console.log('🔧 hiddenPatrimoineNet.value =', hiddenPatrimoineNet.value);
        }
        if (hiddenTotalDettes) {
            hiddenTotalDettes.value = Math.round(passifs);
            console.log('🔧 hiddenTotalDettes.value =', hiddenTotalDettes.value);
        }
    }
    {% else %}
    // MODE VISUALISATION : Ne pas modifier les valeurs issues de la base de données
    console.log('👁️ updateTotalPatrimoine désactivée en mode visualisation');
    {% endif %}
}

function initQuickNavigation() {
    const navItems = document.querySelectorAll('.quick-nav-item');
    const sections = document.querySelectorAll('[id]');
    
    // Smooth scroll pour les liens de navigation
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetSection = document.getElementById(targetId);
            
            if (targetSection) {
                const navHeight = 100; // Compensation pour le sticky nav
                const targetPosition = targetSection.offsetTop - navHeight;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
                
                // Mettre à jour l'élément actif
                updateActiveNavItem(this);
            }
        });
    });
    
    // Mise à jour de l'élément actif au scroll
    window.addEventListener('scroll', function() {
        let current = '';
        const offset = 150; // Offset pour la détection de section active
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop - offset;
            const sectionHeight = section.offsetHeight;
            
            if (window.scrollY >= sectionTop && window.scrollY < sectionTop + sectionHeight) {
                current = section.getAttribute('id');
            }
        });
        
        if (current) {
            const activeItem = document.querySelector(`[href="#${current}"]`);
            if (activeItem) {
                updateActiveNavItem(activeItem);
            }
        }
    });
}

function updateActiveNavItem(activeItem) {
    // Retirer la classe active de tous les éléments
    document.querySelectorAll('.quick-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Ajouter la classe active à l'élément courant
    activeItem.classList.add('active');
}

// ============ FONCTIONS POUR LES ÉLÉMENTS DYNAMIQUES EN MODE ÉDITION ============

function addRevenuComplementaire() {
    const container = document.getElementById('revenus_complementaires_container');
    const newRow = document.createElement('div');
    newRow.className = 'dynamic-row';
    newRow.style = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;';
    
    newRow.innerHTML = `
        <div>
            <input type="text" class="form-control" name="revenu_complementaire_name[]" 
                   placeholder="Type de revenu"
                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
        </div>
        <div>
            <input type="number" class="form-control" name="revenu_complementaire_amount[]" 
                   placeholder="Montant en €" min="0" step="0.01"
                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(newRow);
    
    // Ajouter l'événement de suppression
    newRow.querySelector('.remove-row').addEventListener('click', function() {
        newRow.remove();
    });
}

function addChargeMensuelle() {
    const container = document.getElementById('charges_mensuelles_container');
    const newRow = document.createElement('div');
    newRow.className = 'dynamic-row';
    newRow.style = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;';
    
    newRow.innerHTML = `
        <div>
            <input type="text" class="form-control" name="charge_mensuelle_name[]" 
                   placeholder="Type de charge"
                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
        </div>
        <div>
            <input type="number" class="form-control" name="charge_mensuelle_amount[]" 
                   placeholder="Montant en €" min="0" step="0.01"
                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(newRow);
    
    // Ajouter l'événement de suppression
    newRow.querySelector('.remove-row').addEventListener('click', function() {
        newRow.remove();
    });
}

// Initialiser les événements de suppression pour les éléments existants
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des boutons de suppression pour les éléments dynamiques existants
    document.querySelectorAll('.remove-row').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('.dynamic-row');
            if (row) {
                // Déterminer le type de ligne avant suppression
                const isLiquidite = row.querySelector('input[name="liquidite_personnalisee_name[]"]');
                const isPlacement = row.querySelector('input[name="placement_personnalise_name[]"]');
                const isAutreBien = row.querySelector('input[name="autre_bien_name[]"]');
                
                // Supprimer la ligne
                row.remove();
                
                // Mettre à jour les totaux appropriés
                if (isLiquidite) {
                    console.log('🗑️ Liquidité personnalisée supprimée, recalcul du total...');
                    updateTotalLiquidites();
                } else if (isPlacement) {
                    console.log('🗑️ Placement personnalisé supprimé, recalcul du total...');
                    updateTotalPlacementsFinanciers();
                } else if (isAutreBien) {
                    console.log('🗑️ Autre bien supprimé, recalcul du total...');
                    updateTotalAutresBiens();
                }
            }
        });
    });
    
    // Initialiser le calcul du profil de risque
    initRiskProfileCalculation();
});

// ============ CALCUL AUTOMATIQUE DU PROFIL DE RISQUE ============

function initRiskProfileCalculation() {
    // Écouter tous les changements sur les radio buttons du profil de risque
    const radioButtons = document.querySelectorAll('input[name="tolerance_baisse"], input[name="horizon_placement"], input[name="besoin_liquidite"], input[name="experience_investissement"], input[name="attitude_volatilite"]');
    
    radioButtons.forEach(radio => {
        radio.addEventListener('change', calculateRiskProfile);
    });
}

function calculateRiskProfile() {
    // Récupérer toutes les réponses
    const toleranceBaisse = document.querySelector('input[name="tolerance_baisse"]:checked');
    const horizonPlacement = document.querySelector('input[name="horizon_placement"]:checked');
    const besoinLiquidite = document.querySelector('input[name="besoin_liquidite"]:checked');
    const experienceInvestissement = document.querySelector('input[name="experience_investissement"]:checked');
    const attitudeVolatilite = document.querySelector('input[name="attitude_volatilite"]:checked');
    
    // Vérifier que toutes les questions ont été répondues
    if (!toleranceBaisse || !horizonPlacement || !besoinLiquidite || !experienceInvestissement || !attitudeVolatilite) {
        document.getElementById('profil_result').style.display = 'none';
        return;
    }
    
    // Système de scoring pour calculer le profil
    let score = 0;
    
    // Question 1: Tolérance au risque (poids: 3)
    switch(toleranceBaisse.value) {
        case '5': score += 1 * 3; break;
        case '15': score += 2 * 3; break;
        case '30': score += 3 * 3; break;
    }
    
    // Question 2: Horizon de placement (poids: 2)
    switch(horizonPlacement.value) {
        case 'court': score += 1 * 2; break;
        case 'moyen': score += 2 * 2; break;
        case 'long': score += 3 * 2; break;
    }
    
    // Question 3: Besoin de liquidité (poids: 2)
    switch(besoinLiquidite.value) {
        case 'oui': score += 1 * 2; break;
        case 'non': score += 3 * 2; break;
    }
    
    // Question 4: Expérience (poids: 2)
    switch(experienceInvestissement.value) {
        case 'debutant': score += 1 * 2; break;
        case 'intermediaire': score += 2 * 2; break;
        case 'confirme': score += 3 * 2; break;
    }
    
    // Question 5: Attitude face à la volatilité (poids: 3)
    switch(attitudeVolatilite.value) {
        case 'vendre': score += 1 * 3; break;
        case 'attendre': score += 2 * 3; break;
        case 'investir_plus': score += 3 * 3; break;
    }
    
    // Déterminer le profil en fonction du score
    let profilName = '';
    let profilValue = '';
    let profilDescription = '';
    
    if (score <= 18) {
        profilName = 'Prudent';
        profilValue = 'prudent';
        profilDescription = 'Vous privilégiez la sécurité et acceptez des rendements plus faibles pour limiter les risques. Recommandation : fonds euros, obligations, placements garantis.';
    } else if (score <= 28) {
        profilName = 'Équilibré';
        profilValue = 'modere';
        profilDescription = 'Vous recherchez un bon équilibre entre sécurité et performance. Recommandation : mix d\'obligations et d\'actions, fonds diversifiés.';
    } else {
        profilName = 'Dynamique';
        profilValue = 'dynamique';
        profilDescription = 'Vous acceptez une forte volatilité pour un potentiel de rendement élevé. Recommandation : actions, ETF, investissements à fort potentiel.';
    }
    
    // Afficher le résultat avec animation
    const resultElement = document.getElementById('profil_result');
    document.getElementById('profil_name').textContent = profilName;
    document.getElementById('profil_description').textContent = profilDescription;
    document.getElementById('calculated_risk_profile').value = profilValue;
    
    // Animation d'apparition
    resultElement.style.display = 'block';
    resultElement.style.opacity = '0';
    resultElement.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        resultElement.style.transition = 'all 0.5s ease';
        resultElement.style.opacity = '1';
        resultElement.style.transform = 'translateY(0)';
    }, 100);
    
    // Scroll vers le résultat après un petit délai
    setTimeout(() => {
        resultElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }, 300);
}

// ===== FONCTIONS POUR ÉPARGNE & PATRIMOINE =====

function addLiquidite() {
    const container = document.getElementById('liquiditesContainer');
    const newRow = document.createElement('div');
    newRow.className = 'dynamic-row';
    newRow.style = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;';
    
    const html = `
        <div>
            <input type="text" class="form-control" name="liquidite_personnalisee_name[]" 
                   placeholder="Nom de la liquidité"
                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
        </div>
        <div>
            <input type="number" step="0.01" class="form-control" name="liquidite_personnalisee_amount[]" 
                   placeholder="Montant en €"
                   style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    newRow.innerHTML = html;
    container.appendChild(newRow);
    
    // Ajouter l'événement de suppression
    newRow.querySelector('.remove-row').addEventListener('click', function() {
        newRow.remove();
        updateTotalLiquidites();
    });
    
    setupAllTotalsEventListeners();
}

function addPlacement() {
    const container = document.getElementById('placementsContainer');
    const html = `
        <div class="dynamic-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;">
            <div>
                <input type="text" class="form-control" name="placement_personnalise_name[]" 
                       placeholder="Nom du placement"
                       style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
            </div>
            <div>
                <input type="number" step="0.01" class="form-control" name="placement_personnalise_amount[]" 
                       placeholder="Montant en €"
                       style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
            </div>
            <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    setupAllTotalsEventListeners();
}

function addCrypto() {
    const container = document.getElementById('cryptoContainer');
    const html = `
        <div class="crypto-edit-row" style="background: #f8f9fa; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                <div>
                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Cryptomonnaie</label>
                    <select class="form-control crypto-select" name="crypto_symbol[]"
                            style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;">
                        <option value="">Choisir une crypto...</option>
                        <optgroup label="🥇 Top 50 Cryptomonnaies">
                            <option value="bitcoin">1. Bitcoin (BTC)</option>
                            <option value="ethereum">2. Ethereum (ETH)</option>
                            <option value="tether">3. Tether (USDT)</option>
                            <option value="binancecoin">4. BNB (BNB)</option>
                            <option value="solana">5. Solana (SOL)</option>
                            <option value="usd-coin">6. USDC (USDC)</option>
                            <option value="ripple">7. XRP (XRP)</option>
                            <option value="dogecoin">8. Dogecoin (DOGE)</option>
                            <option value="cardano">9. Cardano (ADA)</option>
                            <option value="tron">10. TRON (TRX)</option>
                            <option value="chainlink">11. Chainlink (LINK)</option>
                            <option value="polygon">12. Polygon (MATIC)</option>
                            <option value="wrapped-bitcoin">13. Wrapped Bitcoin (WBTC)</option>
                            <option value="avalanche-2">14. Avalanche (AVAX)</option>
                            <option value="dai">15. Dai (DAI)</option>
                            <option value="shiba-inu">16. Shiba Inu (SHIB)</option>
                            <option value="polkadot">17. Polkadot (DOT)</option>
                            <option value="litecoin">18. Litecoin (LTC)</option>
                            <option value="bitcoin-cash">19. Bitcoin Cash (BCH)</option>
                            <option value="near">20. NEAR Protocol (NEAR)</option>
                            <option value="uniswap">21. Uniswap (UNI)</option>
                            <option value="internet-computer">22. Internet Computer (ICP)</option>
                            <option value="ethereum-classic">23. Ethereum Classic (ETC)</option>
                            <option value="aptos">24. Aptos (APT)</option>
                            <option value="stellar">25. Stellar (XLM)</option>
                            <option value="monero">26. Monero (XMR)</option>
                            <option value="hedera-hashgraph">27. Hedera (HBAR)</option>
                            <option value="cosmos">28. Cosmos Hub (ATOM)</option>
                            <option value="filecoin">29. Filecoin (FIL)</option>
                            <option value="arbitrum">30. Arbitrum (ARB)</option>
                            <option value="vechain">31. VeChain (VET)</option>
                            <option value="first-digital-usd">32. First Digital USD (FDUSD)</option>
                            <option value="maker">33. MakerDAO (MKR)</option>
                            <option value="optimism">34. Optimism (OP)</option>
                            <option value="immutable-x">35. Immutable (IMX)</option>
                            <option value="render-token">36. Render (RNDR)</option>
                            <option value="the-graph">37. The Graph (GRT)</option>
                            <option value="injective-protocol">38. Injective (INJ)</option>
                            <option value="sei-network">39. Sei (SEI)</option>
                            <option value="theta-token">40. Theta Network (THETA)</option>
                            <option value="bittensor">41. Bittensor (TAO)</option>
                            <option value="rune">42. THORChain (RUNE)</option>
                            <option value="stacks">43. Stacks (STX)</option>
                            <option value="aave">44. Aave (AAVE)</option>
                            <option value="zcash">45. Zcash (ZEC)</option>
                            <option value="dash">46. Dash (DASH)</option>
                            <option value="sushiswap">47. SushiSwap (SUSHI)</option>
                            <option value="fantom">48. Fantom (FTM)</option>
                            <option value="algorand">49. Algorand (ALGO)</option>
                            <option value="neo">50. NEO (NEO)</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Quantité</label>
                    <input type="number" step="0.00000001" class="form-control crypto-quantity" name="crypto_quantity[]" 
                           placeholder="0.00000000"
                           style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Prix actuel</label>
                    <div class="crypto-price" style="padding: 6px; background: rgba(19, 124, 139, 0.1); border-radius: 4px; font-weight: 600; color: var(--qlower-primary); text-align: center; font-size: 13px;">Choisissez une crypto</div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; color: #344D59; margin-bottom: 4px; font-size: 12px;">Valeur détenue</label>
                    <div class="crypto-value" style="padding: 6px; background: rgba(19, 124, 139, 0.1); border-radius: 4px; font-weight: 600; color: var(--qlower-primary); text-align: center; font-size: 13px;">0€</div>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-row" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; margin-top: 16px; font-size: 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    
    // Configurer les calculs pour la nouvelle ligne uniquement
    const newRow = container.lastElementChild;
    const selectElement = newRow.querySelector('.crypto-select');
    const quantityInput = newRow.querySelector('.crypto-quantity');
    
    selectElement.addEventListener('change', () => {
        updateCryptoCalculations(newRow);
    });
    
    quantityInput.addEventListener('input', () => {
        updateCryptoCalculations(newRow);
    });
    
    // Ajouter l'event listener pour le bouton de suppression
    const deleteButton = newRow.querySelector('.remove-row');
    deleteButton.addEventListener('click', () => {
        newRow.remove();
        updateTotalCrypto();
    });
}

function addAutreBien() {
    const container = document.getElementById('autresBiensContainer');
    const html = `
        <div class="dynamic-row" style="display: flex; gap: 15px; margin-bottom: 10px; align-items: end;">
            <div style="flex: 1;">
                <label class="edit-label">Nom du bien</label>
                <input type="text" class="form-control edit-input" name="autre_bien_name[]" 
                       placeholder="Ex: Œuvre d'art, Collection">
            </div>
            <div style="flex: 1;">
                <label class="edit-label">Valeur estimée</label>
                <input type="number" step="0.01" class="form-control edit-input" name="autre_bien_valeur[]" 
                       placeholder="0.00">
            </div>
            <button type="button" class="btn-remove" onclick="this.closest('.dynamic-row').remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    setupAllTotalsEventListeners();
}

// ===== FONCTIONS POUR IMMOBILIER =====

function addBienImmobilier() {
    const container = document.getElementById('immobilierContainer');
    const html = `
        <div class="bien-edit-card" style="background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 20px; border-left: 4px solid var(--qlower-primary);">
            <div class="bien-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h5 style="color: var(--qlower-dark); font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px;">
                    🏠 Nouveau bien immobilier
                </h5>
                <button type="button" class="btn-remove" onclick="this.closest('.bien-edit-card').remove()" 
                        style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
            
            <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Type de bien *</label>
                    <select class="form-control edit-input" name="bien_type[]" required
                            style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        <option value="">Choisir...</option>
                        <option value="residence_principale">Résidence principale</option>
                        <option value="residence_secondaire">Résidence secondaire</option>
                        <option value="investissement_locatif">Investissement locatif</option>
                    </select>
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Description</label>
                    <input type="text" class="form-control edit-input" name="bien_description[]" 
                           placeholder="Ex: Appartement 3 pièces Paris"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Valeur du bien *</label>
                    <input type="number" step="0.01" class="form-control edit-input bien-valeur-input" name="bien_valeur[]" 
                           placeholder="0.00" required
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Surface (m²)</label>
                    <input type="number" step="0.01" class="form-control edit-input bien-surface-input" name="bien_surface[]" 
                           placeholder="0.00"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                
                <!-- Prix au m² (calculé automatiquement) -->
                <div class="edit-item" style="display: none;">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Prix au m²</label>
                    <input type="text" class="form-control edit-input prix-m2-display" 
                           readonly placeholder="Calculé automatiquement"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; background-color: #f8f9fa; color: #6c757d;">
                </div>
            </div>
            
            <!-- Section Crédit Immobilier associé -->
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" name="bien_has_credit[]" value="1" 
                           onchange="toggleCreditSection(this)" style="transform: scale(1.2);">
                    <label style="font-weight: 600; color: #344D59; margin: 0;">Ce bien a un crédit immobilier associé</label>
                </div>
                
                <div class="credit-details" style="display: none; background: white; border-radius: 8px; padding: 20px; border: 1px solid #e5e7eb;">
                    <h6 style="color: var(--qlower-primary); font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-credit-card"></i>
                        Crédit immobilier
                    </h6>
                    <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="edit-item">
                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Montant emprunté</label>
                            <input type="number" step="0.01" class="form-control edit-input credit-montant-input" name="credit_montant[]" 
                                   placeholder="0.00"
                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div class="edit-item">
                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Taux TAEG (%)</label>
                            <input type="number" step="0.01" class="form-control edit-input credit-taeg-input" name="credit_taeg[]" 
                                   placeholder="Ex: 3.5"
                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div class="edit-item">
                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Durée (années)</label>
                            <input type="number" class="form-control edit-input credit-duree-input" name="credit_duree[]" 
                                   placeholder="25"
                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div class="edit-item">
                            <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Date de début</label>
                            <input type="month" class="form-control edit-input credit-date-input" name="credit_date[]"
                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                        </div>
                    </div>
                    
                    <!-- Détails calculés du crédit (mise à jour automatique) -->
                    <div class="credit-calculations" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                        <h6 style="color: var(--qlower-primary); font-weight: 600; margin-bottom: 15px; font-size: 14px;">Détails calculés du crédit</h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #7A90A4; margin-bottom: 4px;">Mensualités</div>
                                <div class="credit-mensualite" style="font-size: 16px; font-weight: 700; color: var(--qlower-primary);">0 €/mois</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #7A90A4; margin-bottom: 4px;">Montant restant à rembourser</div>
                                <div class="credit-montant-restant" style="font-size: 16px; font-weight: 700; color: var(--qlower-primary);">0 €</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #7A90A4; margin-bottom: 4px;">Total payé</div>
                                <div class="credit-total-paye" style="font-size: 16px; font-weight: 700; color: var(--qlower-primary);">0 €</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Valeur nette du bien (mise à jour automatique) -->
                <div style="margin-top: 15px; padding: 10px 15px; background: rgba(19, 124, 139, 0.7); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 600;">Valeur nette du bien</span>
                    <span class="valeur-nette-display" style="font-size: 16px; font-weight: 700; color: white;">0€</span>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    
    // Attacher les event listeners au nouveau bien ajouté
    const newBienCard = container.lastElementChild;
    setupBienEventListeners(newBienCard);
}

function setupBienEventListeners(bienCard) {
    // Event listeners pour tous les champs qui affectent les calculs
    const inputs = bienCard.querySelectorAll('.bien-valeur-input, .bien-surface-input, .credit-montant-input, .credit-taeg-input, .credit-duree-input, .credit-date-input');
    
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            updateBienCalculations(bienCard);
        });
    });
    
    // Event listener pour la checkbox de crédit
    const creditCheckbox = bienCard.querySelector('input[name="bien_has_credit[]"]');
    if (creditCheckbox) {
        creditCheckbox.addEventListener('change', () => {
            toggleCreditSection(creditCheckbox);
            updateBienCalculations(bienCard);
        });
    }
    
    // Calcul initial
    updateBienCalculations(bienCard);
    console.log('✅ Event listeners attachés au nouveau bien');
}

function toggleCreditSection(checkbox) {
    const creditDetails = checkbox.closest('div').nextElementSibling;
    if (checkbox.checked) {
        creditDetails.style.display = 'block';
    } else {
        creditDetails.style.display = 'none';
    }
}

// ===== FONCTIONS POUR CRÉDITS =====

function addCredit() {
    const container = document.getElementById('creditsContainer');
    const html = `
        <div class="credit-edit-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #fafafa;">
            <div class="edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Description du crédit *</label>
                    <input type="text" class="form-control edit-input" name="credit_conso_description[]" 
                           placeholder="Ex: Crédit auto, Prêt personnel..." required
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                    <input type="hidden" name="credit_conso_id[]" value="">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Montant initial</label>
                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_montant_initial[]" 
                           placeholder="0.00"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Montant restant à rembourser</label>
                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_montant_restant[]" 
                           placeholder="0.00"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Taux d'intérêt (%)</label>
                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_taux[]" 
                           placeholder="Ex: 3.5"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Durée initiale (années)</label>
                    <input type="number" class="form-control edit-input" name="credit_conso_duree[]" 
                           placeholder="Ex: 5"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Date de début</label>
                    <input type="month" class="form-control edit-input" name="credit_conso_date_depart[]"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item">
                    <label class="edit-label" style="display: block; font-weight: 600; color: #344D59; margin-bottom: 8px;">Mensualité</label>
                    <input type="number" step="0.01" class="form-control edit-input" name="credit_conso_mensualite[]" 
                           placeholder="0.00"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="edit-item" style="display: flex; align-items: end;">
                    <button type="button" class="btn-remove" onclick="this.closest('.credit-edit-card').remove(); updateTotalCreditsConsommation();" 
                            style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-trash"></i> Supprimer ce crédit
                    </button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    
    // Ajouter les event listeners pour le calcul automatique du nouveau crédit
    setupConsumerCreditEventListeners();
    
    // Mettre à jour le total des crédits et le patrimoine net
    updateTotalCreditsConsommation();
    updatePatrimoineNetTotal();
}

// Fonction pour toggle le crédit immobilier
function toggleCreditSection(checkbox) {
    const creditDetails = checkbox.parentElement.nextElementSibling;
    if (checkbox.checked) {
        creditDetails.style.display = 'block';
    } else {
        creditDetails.style.display = 'none';
    }
    
    // Recalculer la valeur nette après toggle
    const bienCard = checkbox.closest('.bien-edit-card');
    if (bienCard) {
        updateBienCalculations(bienCard);
    }
}

// CALCULS EN TEMPS RÉEL POUR LES BIENS IMMOBILIERS
function formatNumber(num) {
    return num.toLocaleString('fr-FR');
}

function calculateLoanPayment(principal, rate, years) {
    if (rate === 0) {
        return principal / (years * 12);
    }
    const monthlyRate = rate / 100 / 12;
    const numPayments = years * 12;
    return (principal * monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
           (Math.pow(1 + monthlyRate, numPayments) - 1);
}

function calculateRemainingBalance(principal, rate, years, monthsPassed) {
    if (monthsPassed <= 0) return principal;
    
    const duration_months = years * 12;
    
    // Si toutes les mensualités sont payées
    if (monthsPassed >= duration_months) {
        return 0;
    }
    
    // Calcul simplifié: capital remboursé = nb mois × mensualité
    const monthlyPayment = calculateLoanPayment(principal, rate, years);
    const capitalRepaid = monthlyPayment * monthsPassed;
    
    // Capital restant = capital initial - capital remboursé
    return Math.max(0, principal - capitalRepaid);
}

function getMonthsPassed(startDate) {
    if (!startDate) return 3; // Default à 3 mois pour exemple
    
    const start = new Date(startDate + '-01');
    const now = new Date();
    
    // Calcul simple : octobre 2025 = mois 9, décembre 2025 = mois 11
    // Différence = 2, mais on compte octobre, novembre, décembre = 3 mois
    const months = (now.getFullYear() - start.getFullYear()) * 12 + 
                   (now.getMonth() - start.getMonth()) + 1;
    
    return Math.max(1, months);
}

function updateBienCalculations(bienCard) {
    // Prix au m²
    const valeurInput = bienCard.querySelector('.bien-valeur-input');
    const surfaceInput = bienCard.querySelector('.bien-surface-input');
    const prixM2Display = bienCard.querySelector('.prix-m2-display');
    
    if (valeurInput && surfaceInput && prixM2Display) {
        const valeur = parseFloat(valeurInput.value) || 0;
        const surface = parseFloat(surfaceInput.value) || 0;
        
        if (valeur > 0 && surface > 0) {
            const prixM2 = Math.round(valeur / surface);
            prixM2Display.value = `${formatNumber(prixM2)} €/m²`;
            prixM2Display.parentElement.style.display = 'block';
        } else {
            prixM2Display.parentElement.style.display = 'none';
        }
    }
    
    // Calculs du crédit
    const montantInput = bienCard.querySelector('.credit-montant-input');
    const taegInput = bienCard.querySelector('.credit-taeg-input');
    const dureeInput = bienCard.querySelector('.credit-duree-input');
    const dateInput = bienCard.querySelector('.credit-date-input');
    const checkbox = bienCard.querySelector('input[name="bien_has_credit[]"]');
    
    const mensualiteDisplay = bienCard.querySelector('.credit-mensualite');
    const montantRestantDisplay = bienCard.querySelector('.credit-montant-restant');
    const totalPayeDisplay = bienCard.querySelector('.credit-total-paye');
    const valeurNetteDisplay = bienCard.querySelector('.valeur-nette-display');
    
    // Gestion des calculs de crédit
    const montant = parseFloat(montantInput?.value) || 0;
    const taeg = parseFloat(taegInput?.value) || 0;
    const duree = parseFloat(dureeInput?.value) || 0;
    const dateDebut = dateInput ? dateInput.value : '';
    const hasCredit = checkbox?.checked || montant > 0;
    
    // Afficher/masquer la section de calculs en fonction de la checkbox et des valeurs
    const creditCalculations = bienCard.querySelector('.credit-calculations');
    if (creditCalculations) {
        if (hasCredit && montant > 0 && duree > 0) {
            creditCalculations.style.display = 'block';
            
            // Calcul mensualités
            const mensualite = calculateLoanPayment(montant, taeg, duree);
            
            // Calcul montant restant
            const monthsPassed = getMonthsPassed(dateDebut);
            const montantRestant = calculateRemainingBalance(montant, taeg, duree, monthsPassed);
            
            // Capital remboursé = mensualité × nombre de mois passés
            const capitalRembourse = mensualite * monthsPassed;
            
            // Mise à jour affichage
            if (mensualiteDisplay) {
                mensualiteDisplay.textContent = `${formatNumber(Math.round(mensualite))} €/mois`;
            }
            if (montantRestantDisplay) {
                montantRestantDisplay.textContent = `${formatNumber(Math.round(Math.max(0, montantRestant)))} €`;
            }
            if (totalPayeDisplay) {
                totalPayeDisplay.textContent = `${formatNumber(Math.round(capitalRembourse))} €`;
            }
            
            // Valeur nette = valeur du bien - montant restant
            if (valeurNetteDisplay && valeurInput) {
                const valeurBien = parseFloat(valeurInput.value) || 0;
                const valeurNette = valeurBien - Math.max(0, montantRestant);
                valeurNetteDisplay.textContent = `${formatNumber(Math.round(valeurNette))}€`;
            }
        } else {
            creditCalculations.style.display = 'none';
            
            // Pas de crédit, valeur nette = valeur du bien
            if (valeurNetteDisplay && valeurInput) {
                const valeurBien = parseFloat(valeurInput.value) || 0;
                valeurNetteDisplay.textContent = `${formatNumber(Math.round(valeurBien))}€`;
            }
        }
    } else {
        // Fallback pour les anciens biens sans la section de calculs
        if (hasCredit && montant > 0 && duree > 0) {
            const mensualite = calculateLoanPayment(montant, taeg, duree);
            const monthsPassed = getMonthsPassed(dateDebut);
            const montantRestant = calculateRemainingBalance(montant, taeg, duree, monthsPassed);
            const capitalRembourse = mensualite * monthsPassed;
            
            if (mensualiteDisplay) {
                mensualiteDisplay.textContent = `${formatNumber(Math.round(mensualite))} €/mois`;
            }
            if (montantRestantDisplay) {
                montantRestantDisplay.textContent = `${formatNumber(Math.round(Math.max(0, montantRestant)))} €`;
            }
            if (totalPayeDisplay) {
                totalPayeDisplay.textContent = `${formatNumber(Math.round(capitalRembourse))} €`;
            }
            
            if (valeurNetteDisplay && valeurInput) {
                const valeurBien = parseFloat(valeurInput.value) || 0;
                const valeurNette = valeurBien - Math.max(0, montantRestant);
                valeurNetteDisplay.textContent = `${formatNumber(Math.round(valeurNette))}€`;
            }
        } else {
            if (valeurNetteDisplay && valeurInput) {
                const valeurBien = parseFloat(valeurInput.value) || 0;
                valeurNetteDisplay.textContent = `${formatNumber(Math.round(valeurBien))}€`;
            }
        }
    }
    
    // Mettre à jour le total immobilier après chaque calcul de bien
    updateTotalImmobilierNet();
}

function updateTotalImmobilierNet() {
    console.log('updateTotalImmobilierNet appelée');
    
    // Chercher d'abord l'élément en mode édition, puis en mode vue
    let totalImmobilierDisplay = document.querySelector('#totalImmobilierNetEdit div div:last-child');
    if (!totalImmobilierDisplay) {
        totalImmobilierDisplay = document.querySelector('#totalImmobilierNet .liquidites-compact-value-total');
    }
    console.log('Element trouvé:', totalImmobilierDisplay);
    
    if (!totalImmobilierDisplay) {
        console.log('Aucun élément trouvé pour totalImmobilierDisplay');
        return;
    }
    
    let totalNet = 0;
    
    // Mode édition - calculer à partir des valeurs saisies
    const valeurNetteDisplays = document.querySelectorAll('.valeur-nette-display');
    console.log('Nombre de valeur-nette-display trouvées:', valeurNetteDisplays.length);
    
    if (valeurNetteDisplays.length > 0) {
        valeurNetteDisplays.forEach(display => {
            const valueText = display.textContent.replace(/[€\s,]/g, '');
            const value = parseFloat(valueText) || 0;
            console.log('Valeur édition trouvée:', valueText, '-> parsée:', value);
            totalNet += value;
        });
    } else {
        // Mode vue - calculer à partir des valeurs affichées
        const netValueElements = document.querySelectorAll('.liquidites-compact-item-total');
        console.log('Nombre de liquidites-compact-item-total trouvées:', netValueElements.length);
        
        netValueElements.forEach(element => {
            const nameElement = element.querySelector('.liquidites-compact-name-total');
            if (nameElement) {
                console.log('Nom trouvé:', nameElement.textContent);
                if (nameElement.textContent.includes('Total valeur nette du bien')) {
                    const valueElement = element.querySelector('.liquidites-compact-value-total');
                    if (valueElement) {
                        const valueText = valueElement.textContent.replace(/[€\s,]/g, '');
                        const value = parseFloat(valueText) || 0;
                        console.log('Valeur vue trouvée:', valueText, '-> parsée:', value);
                        totalNet += value;
                    }
                }
            }
        });
    }
    
    console.log('Total calculé:', totalNet);
    
    // Mettre à jour l'affichage du total
    totalImmobilierDisplay.textContent = `${formatNumber(Math.round(totalNet))}€`;
    console.log('Total mis à jour avec:', totalImmobilierDisplay.textContent);
    
    // Mettre à jour le grand total patrimoine et le patrimoine net
    updateTotalEpargnePatrimoine();
    updatePatrimoineNetTotal();
}

// ===== FONCTIONS POUR CRÉDITS CONSOMMATION =====

function setupConsumerCreditEventListeners() {
    // Ajouter les event listeners pour tous les crédits conso existants et nouveaux
    const creditCards = document.querySelectorAll('.credit-edit-card');
    
    creditCards.forEach(card => {
        const montantInput = card.querySelector('input[name="credit_conso_montant_initial[]"]');
        const tauxInput = card.querySelector('input[name="credit_conso_taux[]"]');
        const dureeInput = card.querySelector('input[name="credit_conso_duree[]"]');
        const mensualiteInput = card.querySelector('input[name="credit_conso_mensualite[]"]');
        const montantRestantInput = card.querySelector('input[name="credit_conso_montant_restant[]"]');
        const dateInput = card.querySelector('input[name="credit_conso_date_depart[]"]');
        
        if (montantInput && tauxInput && dureeInput && mensualiteInput) {
            // Fonction de calcul pour ce crédit
            function updateConsumerCreditCalculations() {
                const montant = parseFloat(montantInput.value) || 0;
                const taux = parseFloat(tauxInput.value) || 0;
                const duree = parseInt(dureeInput.value) || 0;
                
                if (montant > 0 && duree > 0) {
                    // Calcul de la mensualité
                    const mensualite = calculateLoanPayment(montant, taux, duree);
                    mensualiteInput.value = mensualite.toFixed(2);
                    
                    // Calcul du montant restant si date disponible
                    if (dateInput && dateInput.value && montantRestantInput) {
                        const monthsPassed = getMonthsPassed(dateInput.value);
                        const montantRestant = calculateRemainingBalance(montant, taux, duree, monthsPassed);
                        montantRestantInput.value = montantRestant.toFixed(2);
                        
                        // Mettre à jour aussi l'affichage "Capital restant dû" 
                        updateConsumerCreditDisplay(card, montantRestant);
                        
                        // Mettre à jour le total des crédits et le patrimoine net
                        updateTotalCreditsConsommation();
                        updatePatrimoineNetTotal();
                    }
                } else {
                    mensualiteInput.value = '0.00';
                    if (montantRestantInput) {
                        montantRestantInput.value = montant.toFixed(2);
                        // Mettre à jour l'affichage avec le montant initial
                        updateConsumerCreditDisplay(card, montant);
                        
                        // Mettre à jour le total des crédits et le patrimoine net
                        updateTotalCreditsConsommation();
                        updatePatrimoineNetTotal();
                    }
                }
            }
            
            // Ajouter les event listeners
            montantInput.addEventListener('input', updateConsumerCreditCalculations);
            tauxInput.addEventListener('input', updateConsumerCreditCalculations);
            dureeInput.addEventListener('input', updateConsumerCreditCalculations);
            
            // Si la date change, recalculer le montant restant
            if (dateInput && montantRestantInput) {
                dateInput.addEventListener('input', updateConsumerCreditCalculations);
            }
        }
    });
}

function updateTotalCreditsConsommation() {
    console.log('updateTotalCreditsConsommation appelée');
    
    // Chercher l'élément d'affichage du total des crédits
    let totalCreditsDisplay = document.querySelector('div[style*="font-weight: 700; font-size: 16px; color: #dc3545;"]');
    
    if (!totalCreditsDisplay) {
        console.log('Aucun élément trouvé pour totalCreditsDisplay');
        return;
    }
    
    let totalRestant = 0;
    
    // Calculer le total à partir des montants restants de tous les crédits
    const creditCards = document.querySelectorAll('.credit-edit-card');
    console.log('Nombre de crédits trouvés:', creditCards.length);
    
    creditCards.forEach(card => {
        const montantRestantInput = card.querySelector('input[name="credit_conso_montant_restant[]"]');
        if (montantRestantInput && montantRestantInput.value) {
            const montant = parseFloat(montantRestantInput.value) || 0;
            totalRestant += montant;
            console.log('Crédit ajouté au total:', montant);
        }
    });
    
    console.log('Total calculé:', totalRestant);
    
    // Mettre à jour l'affichage
    totalCreditsDisplay.textContent = `${totalRestant.toLocaleString('fr-FR')}€`;
    console.log('Total mis à jour avec:', totalCreditsDisplay.textContent);
}

function updateConsumerCreditDisplay(creditCard, montantRestant) {
    // Chercher les éléments d'affichage "Capital restant dû" dans cette carte de crédit
    const displayElements = creditCard.querySelectorAll('.credit-remaining-total div:last-child');
    
    displayElements.forEach(element => {
        element.textContent = `${Math.round(montantRestant).toLocaleString('fr-FR')}€`;
    });
    
    // Chercher aussi d'autres éléments qui pourraient afficher le montant restant
    const valueElements = creditCard.querySelectorAll('.liquidites-compact-value-total');
    valueElements.forEach(element => {
        if (element.textContent.includes('€')) {
            element.textContent = `${Math.round(montantRestant).toLocaleString('fr-FR')}€`;
        }
    });
}

// ===== FONCTIONS POUR MISE À JOUR DES TOTAUX =====

function updateTotalLiquidites() {
    console.log('🔄 updateTotalLiquidites appelée');
    
    let total = 0;
    
    // Liquidités fixes
    const livretA = parseFloat(document.querySelector('input[name="livret_a_value"]')?.value) || 0;
    const ldds = parseFloat(document.querySelector('input[name="ldds_value"]')?.value) || 0;
    const pelCel = parseFloat(document.querySelector('input[name="pel_cel_value"]')?.value) || 0;
    const currentSavings = parseFloat(document.querySelector('input[name="current_savings"]')?.value) || 0;
    
    console.log('📊 Liquidités fixes détaillées:');
    console.log(`  - Livret A: ${livretA}€`);
    console.log(`  - LDDS: ${ldds}€`);
    console.log(`  - PEL/CEL: ${pelCel}€`);
    console.log(`  - Épargne courante: ${currentSavings}€`);
    
    total += livretA + ldds + pelCel + currentSavings;
    console.log(`✅ Sous-total liquidités fixes: ${total}€`);
    
    // Liquidités personnalisées
    const liquiditeNames = document.querySelectorAll('input[name="liquidite_personnalisee_name[]"]');
    const liquiditeAmounts = document.querySelectorAll('input[name="liquidite_personnalisee_amount[]"]');
    
    console.log(`🔍 Liquidités personnalisées trouvées: ${liquiditeNames.length} lignes`);
    
    let totalPerso = 0;
    for (let i = 0; i < Math.min(liquiditeNames.length, liquiditeAmounts.length); i++) {
        const name = liquiditeNames[i].value.trim();
        const amount = parseFloat(liquiditeAmounts[i].value) || 0;
        
        if (name) {
            console.log(`  - "${name}": ${amount}€`);
            totalPerso += amount;
        }
    }
    
    total += totalPerso;
    console.log(`✅ Total liquidités personnalisées: ${totalPerso}€`);
    console.log(`🎯 TOTAL LIQUIDITÉS CALCULÉ: ${total}€ (${livretA} + ${ldds} + ${pelCel} + ${currentSavings} + ${totalPerso})`);
    
    // Mettre à jour l'affichage avec les nouveaux IDs
    const editElement = document.getElementById('edit-total-liquidites-value');
    const viewElement = document.getElementById('view-total-liquidites-value');
    
    const formattedValue = `${Math.round(total).toLocaleString('fr-FR')}€`;
    
    if (editElement) {
        const oldValue = editElement.textContent;
        editElement.textContent = formattedValue;
        console.log(`✅ Mode édition mis à jour: ${oldValue} → ${formattedValue}`);
    }
    
    if (viewElement) {
        const oldValue = viewElement.textContent;
        viewElement.textContent = formattedValue;
        console.log(`✅ Mode visualisation mis à jour: ${oldValue} → ${formattedValue}`);
    }
    
    if (!editElement && !viewElement) {
        console.warn('⚠️ Aucun élément d\'affichage trouvé avec les nouveaux IDs!');
    }
    
    // Mettre à jour le patrimoine net total
    updatePatrimoineNetTotal();
    
    return total;
}

function updateTotalPlacementsFinanciers() {
    console.log('🔄 updateTotalPlacementsFinanciers appelée');
    
    let total = 0;
    
    // Placements fixes
    const pea = parseFloat(document.querySelector('input[name="pea_value"]')?.value) || 0;
    const per = parseFloat(document.querySelector('input[name="per_value"]')?.value) || 0;
    const lifeInsurance = parseFloat(document.querySelector('input[name="life_insurance_value"]')?.value) || 0;
    const cto = parseFloat(document.querySelector('input[name="cto_value"]')?.value) || 0;
    const peePerco = parseFloat(document.querySelector('input[name="pee_perco_value"]')?.value) || 0;
    const privateEquity = parseFloat(document.querySelector('input[name="private_equity_value"]')?.value) || 0;
    const scpi = parseFloat(document.querySelector('input[name="scpi_value"]')?.value) || 0;
    
    console.log('📊 Placements fixes détaillés:');
    console.log(`  - PEA: ${pea}€`);
    console.log(`  - PER: ${per}€`);
    console.log(`  - Assurance-vie: ${lifeInsurance}€`);
    console.log(`  - CTO: ${cto}€`);
    console.log(`  - PEE/PERCO: ${peePerco}€`);
    console.log(`  - Private Equity: ${privateEquity}€`);
    console.log(`  - SCPI: ${scpi}€`);
    
    total += pea + per + lifeInsurance + cto + peePerco + privateEquity + scpi;
    console.log(`✅ Sous-total placements fixes: ${total}€`);
    
    // Placements personnalisés
    const placementNames = document.querySelectorAll('input[name="placement_personnalise_name[]"]');
    const placementAmounts = document.querySelectorAll('input[name="placement_personnalise_amount[]"]');
    
    console.log(`🔍 Placements personnalisés trouvés: ${placementNames.length} lignes`);
    
    let totalPerso = 0;
    for (let i = 0; i < Math.min(placementNames.length, placementAmounts.length); i++) {
        const name = placementNames[i].value.trim();
        const amount = parseFloat(placementAmounts[i].value) || 0;
        
        if (name) {
            console.log(`  - "${name}": ${amount}€`);
            totalPerso += amount;
        }
    }
    
    total += totalPerso;
    console.log(`✅ Total placements personnalisés: ${totalPerso}€`);
    console.log(`🎯 TOTAL PLACEMENTS CALCULÉ: ${total}€`);
    
    // Mettre à jour l'affichage avec les nouveaux IDs
    const editElement = document.getElementById('edit-total-placements-value');
    const viewElement = document.getElementById('view-total-placements-value');
    
    const formattedValue = `${Math.round(total).toLocaleString('fr-FR')}€`;
    
    if (editElement) {
        const oldValue = editElement.textContent;
        editElement.textContent = formattedValue;
        console.log(`✅ Mode édition mis à jour: ${oldValue} → ${formattedValue}`);
    }
    
    if (viewElement) {
        const oldValue = viewElement.textContent;
        viewElement.textContent = formattedValue;
        console.log(`✅ Mode visualisation mis à jour: ${oldValue} → ${formattedValue}`);
    }
    
    // Mettre à jour le patrimoine net total
    updatePatrimoineNetTotal();
    
    return total;
}

function updateTotalAutresBiens() {
    console.log('🔄 updateTotalAutresBiens appelée');
    
    let total = 0;
    
    // Autres biens personnalisés
    const autreNames = document.querySelectorAll('input[name="autre_bien_name[]"]');
    const autreAmounts = document.querySelectorAll('input[name="autre_bien_valeur[]"]');
    
    console.log(`🔍 Autres biens trouvés: ${autreNames.length} lignes`);
    
    for (let i = 0; i < Math.min(autreNames.length, autreAmounts.length); i++) {
        const name = autreNames[i].value.trim();
        const amount = parseFloat(autreAmounts[i].value) || 0;
        
        if (name) {
            console.log(`  - "${name}": ${amount}€`);
            total += amount;
        }
    }
    
    console.log(`🎯 TOTAL AUTRES BIENS CALCULÉ: ${total}€`);
    
    // Mettre à jour l'affichage avec les nouveaux IDs
    const editElement = document.getElementById('edit-total-autres-biens-value');
    const viewElement = document.getElementById('view-total-autres-biens-value');
    
    const formattedValue = `${Math.round(total).toLocaleString('fr-FR')}€`;
    
    if (editElement) {
        const oldValue = editElement.textContent;
        editElement.textContent = formattedValue;
        console.log(`✅ Mode édition mis à jour: ${oldValue} → ${formattedValue}`);
    }
    
    if (viewElement) {
        const oldValue = viewElement.textContent;
        viewElement.textContent = formattedValue;
        console.log(`✅ Mode visualisation mis à jour: ${oldValue} → ${formattedValue}`);
    }
    
    // Mettre à jour le patrimoine net total
    updatePatrimoineNetTotal();
    
    return total;
}

function updateTotalEpargnePatrimoine() {
    console.log('updateTotalEpargnePatrimoine appelée');
    
    // Récupérer tous les totaux des sections
    let totalLiquidites = 0;
    let totalPlacements = 0;
    let totalAutresBiens = 0;
    let totalImmobilier = 0;
    let totalCrypto = 0;
    
    // Extraire les valeurs des affichages des totaux
    const liquiditesElements = document.querySelectorAll('div');
    liquiditesElements.forEach(element => {
        if (element.textContent.includes('Total Liquidités') && element.querySelector('div[style*="font-weight: 700"]')) {
            const valueDiv = element.querySelector('div[style*="font-weight: 700"]');
            if (valueDiv) {
                const value = valueDiv.textContent.replace(/[€\s,]/g, '');
                totalLiquidites = parseFloat(value) || 0;
            }
        }
        if (element.textContent.includes('Total Placements Financiers') && element.querySelector('div[style*="font-weight: 700"]')) {
            const valueDiv = element.querySelector('div[style*="font-weight: 700"]');
            if (valueDiv) {
                const value = valueDiv.textContent.replace(/[€\s,]/g, '');
                totalPlacements = parseFloat(value) || 0;
            }
        }
        if (element.textContent.includes('Total Autres Biens') && element.querySelector('div[style*="font-weight: 700"]')) {
            const valueDiv = element.querySelector('div[style*="font-weight: 700"]');
            if (valueDiv) {
                const value = valueDiv.textContent.replace(/[€\s,]/g, '');
                totalAutresBiens = parseFloat(value) || 0;
            }
        }
    });
    
    // Récupérer le total immobilier net depuis l'affichage
    const immobilierDisplay = document.querySelector('#totalImmobilierNetEdit div div:last-child');
    if (immobilierDisplay) {
        const value = immobilierDisplay.textContent.replace(/[€\s,]/g, '');
        totalImmobilier = parseFloat(value) || 0;
    }
    
    // Récupérer le total crypto depuis l'affichage
    const cryptoDisplay = document.querySelector('#totalCryptoEdit div div:last-child');
    if (cryptoDisplay) {
        const value = cryptoDisplay.textContent.replace(/[€\s,]/g, '');
        totalCrypto = parseFloat(value) || 0;
    }
    
    const grandTotal = totalLiquidites + totalPlacements + totalAutresBiens + totalImmobilier + totalCrypto;
    
    console.log('TOTAL ÉPARGNE & PATRIMOINE calculé:', grandTotal);
    console.log('  - Liquidités:', totalLiquidites);
    console.log('  - Placements:', totalPlacements);
    console.log('  - Autres Biens:', totalAutresBiens);
    console.log('  - Immobilier:', totalImmobilier);
    console.log('  - Crypto:', totalCrypto);
    
    // Mettre à jour l'affichage du grand total
    const grandTotalElements = document.querySelectorAll('div');
    grandTotalElements.forEach(element => {
        if (element.textContent.includes('TOTAL ÉPARGNE & PATRIMOINE') && element.querySelector('div[style*="font-weight: 800"]')) {
            const valueDiv = element.querySelector('div[style*="font-weight: 800"]');
            if (valueDiv) {
                valueDiv.textContent = `${Math.round(grandTotal).toLocaleString('fr-FR')}€`;
            }
        }
    });
}

function setupAllTotalsEventListeners() {
    console.log('setupAllTotalsEventListeners appelée');
    
    // Event listeners pour liquidités
    const liquiditesInputs = [
        'livret_a_value', 'ldds_value', 'pel_cel_value', 'current_savings',
        'liquidite_personnalisee_name[]', 'liquidite_personnalisee_amount[]'
    ];
    
    liquiditesInputs.forEach(inputName => {
        const inputs = document.querySelectorAll(`input[name="${inputName}"]`);
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                updateTotalLiquidites();
                updateTotalEpargnePatrimoine();
            });
        });
    });
    
    // Event listeners pour placements financiers
    const placementsInputs = [
        'pea_value', 'per_value', 'life_insurance_value', 'cto_value', 
        'pee_perco_value', 'private_equity_value', 'scpi_value',
        'placement_personnalise_name[]', 'placement_personnalise_amount[]'
    ];
    
    placementsInputs.forEach(inputName => {
        const inputs = document.querySelectorAll(`input[name="${inputName}"]`);
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                updateTotalPlacementsFinanciers();
                updateTotalEpargnePatrimoine();
            });
        });
    });
    
    // Event listeners pour autres biens
    const autresBiensInputs = ['autre_bien_name[]', 'autre_bien_valeur[]'];
    
    autresBiensInputs.forEach(inputName => {
        const inputs = document.querySelectorAll(`input[name="${inputName}"]`);
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                updateTotalAutresBiens();
                updateTotalEpargnePatrimoine();
            });
        });
    });
    
    console.log('Event listeners installés pour tous les totaux');
}

function updatePatrimoineNetTotal() {
    console.log('🔄 updatePatrimoineNetTotal appelée avec ID-based targeting');
    
    // Récupérer tous les totaux d'actifs via IDs spécifiques
    let totalLiquidites = 0;
    let totalPlacements = 0;
    let totalAutresBiens = 0;
    let totalImmobilier = 0;
    let totalCrypto = 0;
    
    // Utilisation des IDs précis pour récupérer les valeurs
    const liquiditesElement = document.getElementById('edit-total-liquidites-value');
    if (liquiditesElement) {
        const value = liquiditesElement.textContent.replace(/[€\s,]/g, '');
        totalLiquidites = parseFloat(value) || 0;
        console.log(`  💧 Liquidités: ${totalLiquidites}€`);
    }
    
    const placementsElement = document.getElementById('edit-total-placements-value');
    if (placementsElement) {
        const value = placementsElement.textContent.replace(/[€\s,]/g, '');
        totalPlacements = parseFloat(value) || 0;
        console.log(`  📈 Placements: ${totalPlacements}€`);
    }
    
    const autresBiensElement = document.getElementById('edit-total-autres-biens-value');
    if (autresBiensElement) {
        const value = autresBiensElement.textContent.replace(/[€\s,]/g, '');
        totalAutresBiens = parseFloat(value) || 0;
        console.log(`  💎 Autres Biens: ${totalAutresBiens}€`);
    }
    
    // Total immobilier net (garder l'ancien sélecteur car pas d'ID spécifique)
    const immobilierDisplay = document.querySelector('#totalImmobilierNetEdit div div:last-child');
    if (immobilierDisplay) {
        const value = immobilierDisplay.textContent.replace(/[€\s,]/g, '');
        totalImmobilier = parseFloat(value) || 0;
        console.log(`  🏠 Immobilier Net: ${totalImmobilier}€`);
    }
    
    // Total crypto (garder l'ancien sélecteur car pas d'ID spécifique)
    const cryptoDisplay = document.querySelector('#totalCryptoEditValue');
    if (cryptoDisplay) {
        const value = cryptoDisplay.textContent.replace(/[€\s,]/g, '');
        totalCrypto = parseFloat(value) || 0;
        console.log(`  ₿ Crypto: ${totalCrypto}€`);
    }
    
    // Récupérer le total des dettes (crédits) - garder l'ancienne méthode car pas d'ID spécifique
    let totalDettes = 0;
    const dettesElements = document.querySelectorAll('div');
    dettesElements.forEach(element => {
        if (element.textContent.includes('Total Crédits à Rembourser') && element.querySelector('div[style*="font-weight: 700"]')) {
            const valueDiv = element.querySelector('div[style*="font-weight: 700"]');
            if (valueDiv) {
                const value = valueDiv.textContent.replace(/[€\s,]/g, '');
                totalDettes = parseFloat(value) || 0;
                console.log(`  🔴 Total Dettes: ${totalDettes}€`);
            }
        }
    });
    
    // Calculs finaux
    const totalActifs = totalLiquidites + totalPlacements + totalAutresBiens + totalImmobilier + totalCrypto;
    const patrimoineNet = totalActifs - totalDettes;
    
    console.log('🎯 PATRIMOINE NET TOTAL calculé:');
    console.log(`  ✅ Total Actifs: ${totalActifs}€`);
    console.log(`    💧 Liquidités: ${totalLiquidites}€`);
    console.log(`    📈 Placements: ${totalPlacements}€`);
    console.log(`    💎 Autres Biens: ${totalAutresBiens}€`);
    console.log(`    🏠 Immobilier Net: ${totalImmobilier}€`);
    console.log(`    ₿ Crypto: ${totalCrypto}€`);
    console.log(`  🔴 Total Dettes: ${totalDettes}€`);
    console.log(`  🏆 PATRIMOINE NET: ${patrimoineNet}€`);
    
    // Mettre à jour les affichages
    const patrimoineNetElement = document.getElementById('patrimoineNetValue');
    const totalActifsDetailElement = document.getElementById('totalActifsDetail');
    const totalDettesDetailElement = document.getElementById('totalDettesDetail');
    
    const formattedPatrimoineNet = `${Math.round(patrimoineNet).toLocaleString('fr-FR')}€`;
    const formattedTotalActifs = `${Math.round(totalActifs).toLocaleString('fr-FR')}€`;
    const formattedTotalDettes = `${Math.round(totalDettes).toLocaleString('fr-FR')}€`;
    
    if (patrimoineNetElement) {
        patrimoineNetElement.textContent = formattedPatrimoineNet;
        console.log(`  📊 Mise à jour #patrimoineNetValue: ${formattedPatrimoineNet}`);
    }
    
    if (totalActifsDetailElement) {
        totalActifsDetailElement.textContent = formattedTotalActifs;
        console.log(`  📊 Mise à jour #totalActifsDetail: ${formattedTotalActifs}`);
    }
    
    if (totalDettesDetailElement) {
        totalDettesDetailElement.textContent = formattedTotalDettes;
        console.log(`  📊 Mise à jour #totalDettesDetail: ${formattedTotalDettes}`);
    }
    
    {% if edit_mode %}
    // 🔧 CORRECTION: Remplir les champs cachés pour la sauvegarde à chaque calcul
    console.log('🔧 Remplissage des champs cachés pour la sauvegarde...');
    const hiddenTotalActifs = document.getElementById('hiddenTotalActifs');
    const hiddenPatrimoineNet = document.getElementById('hiddenPatrimoineNet');
    const hiddenTotalDettes = document.getElementById('hiddenTotalDettes');

    if (hiddenTotalActifs) {
        hiddenTotalActifs.value = Math.round(totalActifs);
        console.log('🔧 hiddenTotalActifs.value =', hiddenTotalActifs.value);
    }
    if (hiddenPatrimoineNet) {
        hiddenPatrimoineNet.value = Math.round(patrimoineNet);
        console.log('🔧 hiddenPatrimoineNet.value =', hiddenPatrimoineNet.value);
    }
    if (hiddenTotalDettes) {
        hiddenTotalDettes.value = Math.round(totalDettes);
        console.log('🔧 hiddenTotalDettes.value =', hiddenTotalDettes.value);
    }
    console.log('✅ Champs cachés mis à jour pour sauvegarde !');
    {% endif %}
}

// ===== FONCTIONS POUR CRYPTOMONNAIES =====

// Cache des prix crypto pour éviter les appels répétés
let cryptoPrices = {};

// Récupérer tous les prix crypto depuis la DB au chargement
let allCryptoPrices = {};

async function loadAllCryptoPrices() {
    try {
        console.log('🔄 Chargement des prix crypto depuis la DB...');
        const response = await fetch('/plateforme/api/crypto-prices');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Reset du cache local
        allCryptoPrices = {};
        
        // Conversion du format API vers notre format local
        for (const symbol in data) {
            if (data[symbol] && typeof data[symbol].eur === 'number') {
                allCryptoPrices[symbol] = data[symbol].eur;
                console.log(`💰 Prix chargé ${symbol}: €${data[symbol].eur.toFixed(6)}`);
            }
        }
        
        console.log(`✅ ${Object.keys(allCryptoPrices).length} prix crypto chargés depuis la DB`);
        return true;
    } catch (error) {
        console.error('❌ Erreur chargement prix crypto:', error);
        // En cas d'erreur, vider le cache pour forcer les "Prix indisponible"
        allCryptoPrices = {};
        return false;
    }
}

function getCryptoPriceFromCache(symbol) {
    return allCryptoPrices[symbol] || 0;
}

function updateCryptoCalculations(cryptoRow) {
    const selectElement = cryptoRow.querySelector('.crypto-select');
    const quantityInput = cryptoRow.querySelector('.crypto-quantity');
    const priceDisplay = cryptoRow.querySelector('.crypto-price');
    const valueDisplay = cryptoRow.querySelector('.crypto-value');
    
    const symbol = selectElement.value;
    const quantity = parseFloat(quantityInput.value) || 0;
    
    if (!symbol) {
        priceDisplay.textContent = 'Choisissez une crypto';
        valueDisplay.textContent = '0€';
        updateTotalCrypto();
        return;
    }
    
    // Récupérer le prix depuis le cache local (base de données)
    const price = getCryptoPriceFromCache(symbol);
    
    if (price > 0) {
        // Afficher le prix formaté
        const formattedPrice = price.toLocaleString('fr-FR', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: price > 1 ? 2 : 6
        });
        priceDisplay.textContent = formattedPrice;
        
        // Calculer la valeur détenue = quantité × prix actuel
        const totalValue = price * quantity;
        const formattedValue = totalValue.toLocaleString('fr-FR', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        valueDisplay.textContent = formattedValue;
        
        console.log(`📊 ${symbol}: ${quantity} × €${price} = €${totalValue}`);
    } else {
        priceDisplay.textContent = 'Prix indisponible';
        valueDisplay.textContent = 'Erreur de chargement';
        console.warn(`⚠️ Prix indisponible pour ${symbol}`);
    }
    
    updateTotalCrypto();
}

function updateTotalCrypto() {
    const totalElement = document.getElementById('totalCryptoEditValue');
    if (!totalElement) return;
    
    let total = 0;
    const cryptoRows = document.querySelectorAll('.crypto-edit-row');
    
    cryptoRows.forEach(row => {
        const valueDisplay = row.querySelector('.crypto-value');
        if (valueDisplay && valueDisplay.textContent !== '0€' && valueDisplay.textContent !== 'Chargement...') {
            // Extraire la valeur numérique du texte formaté
            const valueText = valueDisplay.textContent.replace(/[€\s]/g, '').replace(',', '');
            const value = parseFloat(valueText) || 0;
            total += value;
        }
    });
    
    totalElement.textContent = `${formatNumber(Math.round(total))}€`;
    
    // Mettre à jour le total général épargne et patrimoine
    updateTotalEpargnePatrimoine();
    
    // Mettre à jour le patrimoine net total
    updatePatrimoineNetTotal();
}

async function setupCryptoCalculations() {
    // Charger tous les prix depuis la base de données
    console.log('🔄 Initialisation des calculs crypto...');
    await loadAllCryptoPrices();
    
    const cryptoRows = document.querySelectorAll('.crypto-edit-row');
    
    cryptoRows.forEach(row => {
        const selectElement = row.querySelector('.crypto-select');
        const quantityInput = row.querySelector('.crypto-quantity');
        
        // Event listeners
        selectElement.addEventListener('change', () => {
            updateCryptoCalculations(row);
        });
        
        quantityInput.addEventListener('input', () => {
            updateCryptoCalculations(row);
        });
        
        // Calcul initial si déjà rempli
        if (selectElement.value) {
            updateCryptoCalculations(row);
        }
    });
    
    console.log('✅ Calculs crypto initialisés');
}

// Event listeners pour les calculs en temps réel - UNIQUEMENT EN MODE ÉDITION
{% if edit_mode %}
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Initialisation des calculs temps réel en mode ÉDITION');
    
    const bienCards = document.querySelectorAll('.bien-edit-card');
    
    bienCards.forEach(bienCard => {
        setupBienEventListeners(bienCard);
    });
    
    // Calcul initial du total immobilier - forcer plusieurs appels
    updateTotalImmobilierNet();
    setTimeout(() => {
        updateTotalImmobilierNet();
    }, 100);
    setTimeout(() => {
        updateTotalImmobilierNet();
    }, 500);
    
    // Configuration initiale des calculs crypto (Binance + DB)
    setupCryptoCalculations();
    
    // IMPORTANT: Calculer les totaux et remplir les champs cachés dès le chargement
    setTimeout(() => {
        updatePatrimoineNetTotal();
        console.log('🔧 Champs cachés remplis au chargement de la page');
    }, 1000);
    
    // Event delegation pour tous les boutons de suppression crypto
    document.addEventListener('click', function(event) {
        if (event.target.closest('.crypto-edit-row .remove-row')) {
            const cryptoRow = event.target.closest('.crypto-edit-row');
            if (cryptoRow) {
                cryptoRow.remove();
                updateTotalCrypto();
                console.log('🗑️ Crypto supprimée via event delegation');
            }
        }
    });
    
    // 🔧 CORRECTION: Event delegation pour les boutons de suppression des placements
    document.addEventListener('click', function(event) {
        if (event.target.closest('#placementsContainer .remove-row')) {
            const placementRow = event.target.closest('.dynamic-row');
            if (placementRow) {
                placementRow.remove();
                updateTotalPlacementsFinanciers();
                updateTotalEpargnePatrimoine();
                updatePatrimoineNetTotal();
                console.log('🗑️ Placement supprimé via event delegation');
            }
        }
    });
});
{% else %}
document.addEventListener('DOMContentLoaded', function() {
    console.log('👁️ Mode VISUALISATION - Calculs JavaScript désactivés');
    console.log('📊 Les totaux affichés proviennent directement de la base de données');
});
{% endif %}
</script>
{% endblock %}