{% extends "platform/base.html" %}

{% block title %}Questionnaire Investisseur - Atlas{% endblock %}

{% block content %}
<div class="min-vh-100 py-4">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="bg-primary text-white py-4 mb-4 rounded">
                    <div class="container">
                        <h2 class="mb-2">
                            <i class="fas fa-clipboard-list me-2"></i>Votre Profil Investisseur Complet
                        </h2>
                        <p class="mb-0">Questionnaire détaillé pour personnaliser vos conseils financiers</p>
                        
                        <!-- Barre de progression -->
                        <div class="progress mt-3" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="formProgress"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <form method="POST" class="needs-validation" novalidate id="questionnaireForm">
                        
                        <!-- Section 1: IDENTITÉ -->
                        <div class="card mb-4 shadow-sm form-section">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <span class="badge bg-primary me-2">1</span>
                                    <i class="fas fa-id-card me-2 text-primary"></i>
                                    IDENTITÉ
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="civilite" class="form-label">Civilité *</label>
                                            <select class="form-select" id="civilite" name="civilite" required>
                                                <option value="">Choisir...</option>
                                                <option value="M.">M.</option>
                                                <option value="Mme">Mme</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="date_naissance" class="form-label">Date de naissance *</label>
                                            <input type="date" class="form-control" id="date_naissance" name="date_naissance" required>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="mb-3">
                                            <label for="nationalite" class="form-label">Nationalité *</label>
                                            <select class="form-select" id="nationalite" name="nationalite" required>
                                                <option value="">Choisir...</option>
                                                <option value="Française">Française</option>
                                                <option value="Union Européenne">Union Européenne</option>
                                                <option value="Autre">Autre</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="pays_residence" class="form-label">Pays de résidence *</label>
                                            <input type="text" class="form-control" id="pays_residence" name="pays_residence" value="France" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="family_situation" class="form-label">Situation familiale *</label>
                                            <select class="form-select" id="family_situation" name="family_situation" required>
                                                <option value="">Choisir...</option>
                                                <option value="célibataire">Célibataire</option>
                                                <option value="marié(e)">Marié(e)</option>
                                                <option value="pacsé(e)">Pacsé(e)</option>
                                                <option value="concubinage">Concubinage</option>
                                                <option value="divorcé(e)">Divorcé(e)</option>
                                                <option value="veuf/veuve">Veuf/Veuve</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: REVENUS -->
                        <div class="card mb-4 shadow-sm form-section">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <span class="badge bg-success me-2">2</span>
                                    <i class="fas fa-euro-sign me-2 text-success"></i>
                                    REVENUS
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="professional_situation" class="form-label">Situation professionnelle *</label>
                                            <select class="form-select" id="professional_situation" name="professional_situation" required>
                                                <option value="">Choisir...</option>
                                                <option value="employé">Employé</option>
                                                <option value="cadre">Cadre</option>
                                                <option value="dirigeant">Dirigeant</option>
                                                <option value="chef d'entreprise">Chef d'entreprise</option>
                                                <option value="profession libérale">Profession libérale</option>
                                                <option value="indépendant">Indépendant</option>
                                                <option value="fonctionnaire">Fonctionnaire</option>
                                                <option value="retraité">Retraité</option>
                                                <option value="sans emploi">Sans emploi</option>
                                                <option value="étudiant">Étudiant</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monthly_net_income" class="form-label">Revenus nets mensuels (€) *</label>
                                            <input type="number" class="form-control" id="monthly_net_income" name="monthly_net_income" min="0" step="100" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="charges_mensuelles" class="form-label">Charges mensuelles (€) *</label>
                                            <input type="number" class="form-control" id="charges_mensuelles" name="charges_mensuelles" min="0" step="100" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monthly_savings_capacity" class="form-label">Capacité d'épargne (€) *</label>
                                            <input type="number" class="form-control" id="monthly_savings_capacity" name="monthly_savings_capacity" min="0" step="50" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info" id="tauxEpargneDisplay" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Taux d'épargne calculé : <span id="tauxEpargneValue">0%</span></strong>
                                    <small class="d-block">Recommandation : 10-20% du revenu net</small>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: PATRIMOINE -->
                        <div class="card mb-4 shadow-sm form-section">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <span class="badge bg-warning me-2">3</span>
                                    <i class="fas fa-chart-pie me-2 text-warning"></i>
                                    PATRIMOINE
                                </h5>
                            </div>
                            <div class="card-body">
                                
                                <!-- Liquidités -->
                                <h6 class="text-primary mb-3"><i class="fas fa-coins me-2"></i>Liquidités</h6>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_current_account" name="has_current_account" onchange="toggleField('current_account')">
                                            <label class="form-check-label" for="has_current_account">
                                                <strong>Compte courant / Épargne</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="current_account_value" name="current_account_value" min="0" step="100" placeholder="Montant en €" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_livret_a" name="has_livret_a" onchange="toggleField('livret_a')">
                                            <label class="form-check-label" for="has_livret_a">
                                                <strong>Livret A / LDDS / LEP</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="livret_a_value" name="livret_a_value" min="0" step="100" placeholder="Montant en €" disabled>
                                    </div>
                                </div>

                                <!-- Placements financiers -->
                                <h6 class="text-success mb-3"><i class="fas fa-chart-line me-2"></i>Placements financiers</h6>
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_pea" name="has_pea" onchange="toggleField('pea')">
                                            <label class="form-check-label" for="has_pea">
                                                <strong>PEA</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="pea_value" name="pea_value" min="0" step="500" placeholder="Valeur €" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_per" name="has_per" onchange="toggleField('per')">
                                            <label class="form-check-label" for="has_per">
                                                <strong>PER</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="per_value" name="per_value" min="0" step="500" placeholder="Valeur €" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_life_insurance" name="has_life_insurance" onchange="toggleField('life_insurance')">
                                            <label class="form-check-label" for="has_life_insurance">
                                                <strong>Assurance Vie</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="life_insurance_value" name="life_insurance_value" min="0" step="1000" placeholder="Valeur €" disabled>
                                    </div>
                                </div>

                                <!-- Immobilier -->
                                <h6 class="text-info mb-3"><i class="fas fa-home me-2"></i>Immobilier</h6>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_immobilier" name="has_immobilier" onchange="toggleField('immobilier')">
                                            <label class="form-check-label" for="has_immobilier">
                                                <strong>Résidence principale / Investissement locatif</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="immobilier_value" name="immobilier_value" min="0" step="5000" placeholder="Valeur estimée €" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_autres_biens" name="has_autres_biens" onchange="toggleField('autres_biens')">
                                            <label class="form-check-label" for="has_autres_biens">
                                                <strong>Autres biens (voiture, œuvres d'art, etc.)</strong>
                                            </label>
                                        </div>
                                        <input type="number" class="form-control" id="autres_biens_value" name="autres_biens_value" min="0" step="1000" placeholder="Valeur estimée €" disabled>
                                    </div>
                                </div>

                                <!-- Crédits -->
                                <h6 class="text-danger mb-3"><i class="fas fa-credit-card me-2"></i>Crédits en cours</h6>
                                <div id="creditsContainer">
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <select class="form-control" name="credits[0][type]">
                                                <option value="">Type de crédit</option>
                                                <option value="immobilier">Crédit immobilier</option>
                                                <option value="consommation">Crédit consommation</option>
                                                <option value="auto">Crédit auto</option>
                                                <option value="travaux">Crédit travaux</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" name="credits[0][montant_restant]" placeholder="Capital restant €" min="0" step="1000">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" name="credits[0][mensualite]" placeholder="Mensualité €" min="0" step="10">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="addCredit()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-success" id="patrimoineDisplay" style="display: none;">
                                    <strong>Patrimoine brut calculé : <span id="patrimoineBrutValue">0€</span></strong><br>
                                    <strong>Patrimoine net calculé : <span id="patrimoineNetValue">0€</span></strong>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4: OBJECTIFS -->
                        <div class="card mb-4 shadow-sm form-section">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <span class="badge bg-info me-2">4</span>
                                    <i class="fas fa-target me-2 text-info"></i>
                                    OBJECTIFS
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Cochez vos objectifs d'investissement (plusieurs choix possibles) :</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="objectif_constitution_epargne" name="objectif_constitution_epargne">
                                            <label class="form-check-label" for="objectif_constitution_epargne">
                                                <i class="fas fa-piggy-bank me-2 text-primary"></i>
                                                <strong>Constitution d'une épargne de précaution</strong>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="objectif_retraite" name="objectif_retraite">
                                            <label class="form-check-label" for="objectif_retraite">
                                                <i class="fas fa-user-clock me-2 text-warning"></i>
                                                <strong>Préparer ma retraite</strong>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="objectif_immobilier" name="objectif_immobilier">
                                            <label class="form-check-label" for="objectif_immobilier">
                                                <i class="fas fa-home me-2 text-info"></i>
                                                <strong>Acquisition immobilière</strong>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="objectif_transmission" name="objectif_transmission">
                                            <label class="form-check-label" for="objectif_transmission">
                                                <i class="fas fa-heart me-2 text-danger"></i>
                                                <strong>Transmettre à mes enfants</strong>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="objectif_defiscalisation" name="objectif_defiscalisation">
                                            <label class="form-check-label" for="objectif_defiscalisation">
                                                <i class="fas fa-percentage me-2 text-success"></i>
                                                <strong>Défiscalisation</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="investment_horizon" class="form-label">Horizon de placement *</label>
                                    <select class="form-select" id="investment_horizon" name="investment_horizon" required>
                                        <option value="">Choisir...</option>
                                        <option value="court terme">Court terme (moins de 3 ans)</option>
                                        <option value="moyen terme">Moyen terme (3 à 8 ans)</option>
                                        <option value="long terme">Long terme (plus de 8 ans)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: PROFIL DE RISQUE -->
                        <div class="card mb-4 shadow-sm form-section">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <span class="badge bg-danger me-2">5</span>
                                    <i class="fas fa-chart-area me-2 text-danger"></i>
                                    PROFIL DE RISQUE
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <label class="form-label">Connaissez-vous votre profil de risque ? *</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="profil_risque_connu" id="profil_connu_oui" value="true" onchange="toggleProfilChoice(true)">
                                        <label class="form-check-label" for="profil_connu_oui">
                                            <strong>Oui, je connais mon profil de risque</strong>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="profil_risque_connu" id="profil_connu_non" value="false" onchange="toggleProfilChoice(false)">
                                        <label class="form-check-label" for="profil_connu_non">
                                            <strong>Non, j'aimerais le déterminer</strong>
                                        </label>
                                    </div>
                                </div>

                                <div id="profilChoiceSection" style="display: none;">
                                    <label for="profil_risque_choisi" class="form-label">Votre profil de risque :</label>
                                    <select class="form-select" id="profil_risque_choisi" name="profil_risque_choisi">
                                        <option value="">Choisir...</option>
                                        <option value="conservateur">Conservateur - Je privilégie la sécurité</option>
                                        <option value="modéré">Modéré - J'accepte un risque limité</option>
                                        <option value="dynamique">Dynamique - J'accepte des risques pour plus de rendement</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Section 6: QUESTIONS PROFIL DE RISQUE -->
                        <div class="card mb-4 shadow-sm form-section" id="questionsRisqueSection" style="display: none;">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <span class="badge bg-dark me-2">6</span>
                                    <i class="fas fa-question-circle me-2 text-dark"></i>
                                    QUESTIONNAIRE PROFIL DE RISQUE
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Question 1 -->
                                <div class="mb-4">
                                    <label class="form-label"><strong>1. Quel est votre horizon de placement principal ?</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_1_reponse" value="Court terme (moins de 2 ans)" id="q1_a">
                                        <label class="form-check-label" for="q1_a">Court terme (moins de 2 ans)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_1_reponse" value="Moyen terme (2 à 5 ans)" id="q1_b">
                                        <label class="form-check-label" for="q1_b">Moyen terme (2 à 5 ans)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_1_reponse" value="Long terme (plus de 5 ans)" id="q1_c">
                                        <label class="form-check-label" for="q1_c">Long terme (plus de 5 ans)</label>
                                    </div>
                                </div>

                                <!-- Question 2 -->
                                <div class="mb-4">
                                    <label class="form-label"><strong>2. Comment réagiriez-vous si vos placements perdaient 20% en 1 an ?</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_2_reponse" value="Je vendrais immédiatement" id="q2_a">
                                        <label class="form-check-label" for="q2_a">Je vendrais immédiatement</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_2_reponse" value="J'attendrais quelques mois puis vendrais" id="q2_b">
                                        <label class="form-check-label" for="q2_b">J'attendrais quelques mois puis vendrais</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_2_reponse" value="Je conserverais mes positions" id="q2_c">
                                        <label class="form-check-label" for="q2_c">Je conserverais mes positions</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_2_reponse" value="J'investirais davantage pour profiter des prix bas" id="q2_d">
                                        <label class="form-check-label" for="q2_d">J'investirais davantage pour profiter des prix bas</label>
                                    </div>
                                </div>

                                <!-- Question 3 -->
                                <div class="mb-4">
                                    <label class="form-label"><strong>3. Quelle importance accordez-vous à la liquidité de vos placements ?</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_3_reponse" value="Très importante" id="q3_a">
                                        <label class="form-check-label" for="q3_a">Très importante - Je dois pouvoir récupérer mon argent rapidement</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_3_reponse" value="Modérée" id="q3_b">
                                        <label class="form-check-label" for="q3_b">Modérée - Je peux bloquer une partie de mon épargne</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_3_reponse" value="Peu importante" id="q3_c">
                                        <label class="form-check-label" for="q3_c">Peu importante - Je peux bloquer mon épargne plusieurs années</label>
                                    </div>
                                </div>

                                <!-- Question 4 -->
                                <div class="mb-4">
                                    <label class="form-label"><strong>4. Quelle est votre expérience des marchés financiers ?</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_4_reponse" value="Aucune expérience" id="q4_a">
                                        <label class="form-check-label" for="q4_a">Aucune expérience</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_4_reponse" value="Quelques connaissances" id="q4_b">
                                        <label class="form-check-label" for="q4_b">Quelques connaissances de base</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_4_reponse" value="Bonne expérience" id="q4_c">
                                        <label class="form-check-label" for="q4_c">Bonne expérience, j'ai déjà investi</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_4_reponse" value="Expert" id="q4_d">
                                        <label class="form-check-label" for="q4_d">Expert - Je maîtrise bien les marchés</label>
                                    </div>
                                </div>

                                <!-- Question 5 -->
                                <div class="mb-4">
                                    <label class="form-label"><strong>5. Quel rendement annuel espérez-vous ?</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_5_reponse" value="0-2%" id="q5_a">
                                        <label class="form-check-label" for="q5_a">0-2% - Sécurité avant tout</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_5_reponse" value="2-4%" id="q5_b">
                                        <label class="form-check-label" for="q5_b">2-4% - Rendement modéré</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_5_reponse" value="4-6%" id="q5_c">
                                        <label class="form-check-label" for="q5_c">4-6% - Bon compromis risque/rendement</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_5_reponse" value="6%+" id="q5_d">
                                        <label class="form-check-label" for="q5_d">6%+ - Rendement élevé accepté</label>
                                    </div>
                                </div>

                                <div class="alert alert-info" id="syntheeseDisplay" style="display: none;">
                                    <strong>Profil de risque déterminé : <span id="profilCalcule"></span></strong>
                                    <p id="syntheseText" class="mb-0 mt-2"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons de soumission -->
                        <div class="card shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="data_consent" required>
                                        <label class="form-check-label" for="data_consent">
                                            J'accepte que mes données soient utilisées pour personnaliser mes conseils financiers *
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-check me-2"></i>Finaliser mon profil complet
                                </button>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-lock me-1"></i>
                                        Vos données sont sécurisées et ne seront jamais partagées
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let creditCount = 0;

function toggleField(type) {
    const checkbox = document.getElementById(`has_${type}`);
    const valueField = document.getElementById(`${type}_value`);
    
    if (checkbox.checked) {
        valueField.disabled = false;
        valueField.focus();
    } else {
        valueField.disabled = true;
        valueField.value = '';
    }
    calculatePatrimoine();
    updateProgress();
}

function toggleProfilChoice(connu) {
    const choiceSection = document.getElementById('profilChoiceSection');
    const questionsSection = document.getElementById('questionsRisqueSection');
    
    if (connu) {
        choiceSection.style.display = 'block';
        questionsSection.style.display = 'none';
    } else {
        choiceSection.style.display = 'none';
        questionsSection.style.display = 'block';
    }
    updateProgress();
}

function addCredit() {
    creditCount++;
    const container = document.getElementById('creditsContainer');
    const newCredit = document.createElement('div');
    newCredit.className = 'row mb-2';
    newCredit.innerHTML = `
        <div class="col-md-4">
            <select class="form-control" name="credits[${creditCount}][type]">
                <option value="">Type de crédit</option>
                <option value="immobilier">Crédit immobilier</option>
                <option value="consommation">Crédit consommation</option>
                <option value="auto">Crédit auto</option>
                <option value="travaux">Crédit travaux</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="credits[${creditCount}][montant_restant]" placeholder="Capital restant €" min="0" step="1000" onchange="calculatePatrimoine()">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="credits[${creditCount}][mensualite]" placeholder="Mensualité €" min="0" step="10">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.row').remove(); calculatePatrimoine();">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    `;
    container.appendChild(newCredit);
}

function calculateTauxEpargne() {
    const revenuNet = parseFloat(document.getElementById('monthly_net_income').value) || 0;
    const epargne = parseFloat(document.getElementById('monthly_savings_capacity').value) || 0;
    
    if (revenuNet > 0) {
        const taux = ((epargne / revenuNet) * 100).toFixed(1);
        document.getElementById('tauxEpargneValue').textContent = taux + '%';
        document.getElementById('tauxEpargneDisplay').style.display = 'block';
    } else {
        document.getElementById('tauxEpargneDisplay').style.display = 'none';
    }
}

function calculatePatrimoine() {
    let patrimoineBrut = 0;
    
    // Liquidités
    patrimoineBrut += parseFloat(document.getElementById('current_account_value').value) || 0;
    patrimoineBrut += parseFloat(document.getElementById('livret_a_value').value) || 0;
    
    // Placements
    patrimoineBrut += parseFloat(document.getElementById('pea_value').value) || 0;
    patrimoineBrut += parseFloat(document.getElementById('per_value').value) || 0;
    patrimoineBrut += parseFloat(document.getElementById('life_insurance_value').value) || 0;
    
    // Immobilier
    patrimoineBrut += parseFloat(document.getElementById('immobilier_value').value) || 0;
    patrimoineBrut += parseFloat(document.getElementById('autres_biens_value').value) || 0;
    
    // Calcul des crédits
    let totalCredits = 0;
    const creditInputs = document.querySelectorAll('[name*="montant_restant"]');
    creditInputs.forEach(input => {
        totalCredits += parseFloat(input.value) || 0;
    });
    
    const patrimoineNet = patrimoineBrut - totalCredits;
    
    document.getElementById('patrimoineBrutValue').textContent = patrimoineBrut.toLocaleString() + '€';
    document.getElementById('patrimoineNetValue').textContent = patrimoineNet.toLocaleString() + '€';
    document.getElementById('patrimoineDisplay').style.display = patrimoineBrut > 0 ? 'block' : 'none';
}

function calculateProfilRisque() {
    const questions = ['question_1_reponse', 'question_2_reponse', 'question_3_reponse', 'question_4_reponse', 'question_5_reponse'];
    const answers = {};
    let allAnswered = true;
    
    questions.forEach(q => {
        const checked = document.querySelector(`[name="${q}"]:checked`);
        if (checked) {
            answers[q] = checked.value;
        } else {
            allAnswered = false;
        }
    });
    
    if (!allAnswered) return;
    
    let score = 0;
    
    // Question 1 - Horizon
    if (answers.question_1_reponse?.includes('Long terme')) score += 3;
    else if (answers.question_1_reponse?.includes('Moyen terme')) score += 2;
    else score += 1;
    
    // Question 2 - Réaction aux pertes
    if (answers.question_2_reponse?.includes('investirais davantage')) score += 4;
    else if (answers.question_2_reponse?.includes('conserverais')) score += 3;
    else if (answers.question_2_reponse?.includes('attendrais')) score += 2;
    else score += 1;
    
    // Question 3 - Liquidité
    if (answers.question_3_reponse?.includes('Peu importante')) score += 3;
    else if (answers.question_3_reponse?.includes('Modérée')) score += 2;
    else score += 1;
    
    // Question 4 - Expérience
    if (answers.question_4_reponse?.includes('Expert')) score += 4;
    else if (answers.question_4_reponse?.includes('Bonne')) score += 3;
    else if (answers.question_4_reponse?.includes('Quelques')) score += 2;
    else score += 1;
    
    // Question 5 - Rendement espéré
    if (answers.question_5_reponse?.includes('6%+')) score += 4;
    else if (answers.question_5_reponse?.includes('4-6%')) score += 3;
    else if (answers.question_5_reponse?.includes('2-4%')) score += 2;
    else score += 1;
    
    let profil = 'conservateur';
    let synthese = '';
    
    if (score >= 15) {
        profil = 'dynamique';
        synthese = 'Vous êtes un investisseur dynamique, prêt à accepter des risques élevés pour des rendements potentiellement supérieurs sur le long terme.';
    } else if (score >= 10) {
        profil = 'modéré';
        synthese = 'Vous êtes un investisseur modéré, recherchant un équilibre entre sécurité et performance.';
    } else {
        profil = 'conservateur';
        synthese = 'Vous êtes un investisseur conservateur, privilégiant la sécurité du capital à la performance.';
    }
    
    document.getElementById('profilCalcule').textContent = profil.charAt(0).toUpperCase() + profil.slice(1);
    document.getElementById('syntheseText').textContent = synthese;
    document.getElementById('syntheeseDisplay').style.display = 'block';
}

function updateProgress() {
    const form = document.getElementById('questionnaireForm');
    const requiredFields = form.querySelectorAll('[required]');
    const checkboxes = form.querySelectorAll('input[type="checkbox"]:not([required])');
    let filledFields = 0;
    let totalFields = requiredFields.length;
    
    requiredFields.forEach(field => {
        if (field.type === 'checkbox') {
            if (field.checked) filledFields++;
        } else if (field.value.trim() !== '') {
            filledFields++;
        }
    });
    
    // Compter les objectifs cochés
    const objectifs = document.querySelectorAll('[name*="objectif_"]:checked');
    if (objectifs.length > 0) filledFields++;
    totalFields++;
    
    const progress = (filledFields / totalFields) * 100;
    document.getElementById('formProgress').style.width = progress + '%';
    
    if (progress < 30) {
        document.getElementById('formProgress').className = 'progress-bar bg-danger';
    } else if (progress < 70) {
        document.getElementById('formProgress').className = 'progress-bar bg-warning';
    } else {
        document.getElementById('formProgress').className = 'progress-bar bg-success';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('questionnaireForm');
    
    // Mise à jour de la progression et calculs
    form.addEventListener('input', function() {
        updateProgress();
        calculateTauxEpargne();
        calculatePatrimoine();
    });
    
    form.addEventListener('change', function() {
        updateProgress();
        calculateTauxEpargne();
        calculatePatrimoine();
        calculateProfilRisque();
    });
    
    // Animation d'entrée des sections
    const sections = document.querySelectorAll('.form-section');
    sections.forEach((section, index) => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            section.style.transition = 'all 0.5s ease';
            section.style.opacity = '1';
            section.style.transform = 'translateY(0)';
        }, index * 200);
    });
    
    updateProgress();
});
</script>
{% endblock %}