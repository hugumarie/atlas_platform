{% extends "admin/base.html" %}

{% block title %}{{ user.first_name }} {{ user.last_name }} - Atlas Admin{% endblock %}

{% block page_title %}
<div class="page-title-responsive">
    <span>Profil Utilisateur : {{ user.first_name }} {{ user.last_name }}</span>
    <a href="{{ url_for('platform_admin.users') }}" class="admin-btn admin-btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Retour à la liste
    </a>
</div>
{% endblock %}

{% block content %}
{% if user.investor_profile %}

{% if edit_mode %}
<!-- MODE ÉDITION ADMIN ÉTENDU -->
<div class="edit-mode-container">
    <div class="edit-header mb-4">
        <div class="alert alert-warning">
            <i class="fas fa-user-shield me-2"></i>
            <strong>Mode édition administrateur :</strong> Vous modifiez le profil complet de {{ user.first_name }} {{ user.last_name }}.
        </div>
    </div>
    
    <form id="adminEditFormExtended" method="POST" action="{{ url_for('platform_admin.update_user_data', user_id=user.id) }}">
        
        <!-- Section 1: IDENTITÉ -->
        <div class="platform-card mb-4">
            <div class="platform-card-header">
                <h3 class="platform-card-title">
                    IDENTITÉ
                </h3>
                <p class="platform-card-subtitle">Informations personnelles complètes</p>
            </div>
            <div class="platform-card-body">
                <div class="financial-edit-grid">
                    <!-- Ligne 1: Civilité + Nom + Prénom -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Civilité *</label>
                        <select class="form-control" name="civilite" required>
                            <option value="">Choisir...</option>
                            <option value="M." {{ 'selected' if user.investor_profile.civilite == 'M.' }}>M.</option>
                            <option value="Mme" {{ 'selected' if user.investor_profile.civilite == 'Mme' }}>Mme</option>
                        </select>
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Nom *</label>
                        <input type="text" class="form-control" name="last_name" 
                               value="{{ user.last_name }}" required>
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Prénom *</label>
                        <input type="text" class="form-control" name="first_name" 
                               value="{{ user.first_name }}" required>
                    </div>
                    
                    <!-- Ligne 2: Email + Téléphone + Nationalité -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Email</label>
                        <input type="email" class="form-control" value="{{ user.email }}" disabled>
                        <small class="text-muted">L'email ne peut pas être modifié</small>
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Numéro de téléphone</label>
                        <input type="tel" class="form-control" name="phone" 
                               value="{{ user.phone or '' }}" placeholder="Ex: +33 1 23 45 67 89">
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Nationalité *</label>
                        <select class="form-control" name="nationalite" required>
                            <option value="">Choisir...</option>
                            <option value="Française" {{ 'selected' if user.investor_profile.nationalite == 'Française' }}>Française</option>
                            <option value="Union Européenne" {{ 'selected' if user.investor_profile.nationalite == 'Union Européenne' }}>Union Européenne</option>
                            <option value="Autre" {{ 'selected' if user.investor_profile.nationalite == 'Autre' }}>Autre</option>
                        </select>
                    </div>
                    
                    <!-- Ligne 3: Date de naissance + Lieu de naissance + Pays résidence -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Date de naissance *</label>
                        <input type="date" class="form-control" name="date_naissance" 
                               value="{{ user.investor_profile.date_naissance.strftime('%Y-%m-%d') if user.investor_profile.date_naissance }}">
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Lieu de naissance</label>
                        <input type="text" class="form-control" name="lieu_naissance" 
                               value="{{ user.investor_profile.lieu_naissance or '' }}" placeholder="Ville, Pays">
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Pays de résidence *</label>
                        <input type="text" class="form-control" name="pays_residence" 
                               value="{{ user.investor_profile.pays_residence or 'France' }}">
                    </div>
                    
                    <!-- Ligne 4: Situation familiale -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Situation familiale *</label>
                        <select class="form-control" name="family_situation" required>
                            <option value="">Choisir...</option>
                            <option value="Célibataire" {{ 'selected' if user.investor_profile.family_situation == 'Célibataire' }}>Célibataire</option>
                            <option value="Marié(e)" {{ 'selected' if user.investor_profile.family_situation == 'Marié(e)' }}>Marié(e)</option>
                            <option value="Pacsé(e)" {{ 'selected' if user.investor_profile.family_situation == 'Pacsé(e)' }}>Pacsé(e)</option>
                            <option value="En concubinage" {{ 'selected' if user.investor_profile.family_situation == 'En concubinage' }}>En concubinage</option>
                            <option value="En couple" {{ 'selected' if user.investor_profile.family_situation == 'En couple' }}>En couple</option>
                            <option value="En couple avec enfants" {{ 'selected' if user.investor_profile.family_situation == 'En couple avec enfants' }}>En couple avec enfants</option>
                            <option value="Autre" {{ 'selected' if user.investor_profile.family_situation == 'Autre' }}>Autre</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: REVENUS -->
        <div class="platform-card mb-4">
            <div class="platform-card-header">
                <h3 class="platform-card-title">
                    REVENUS
                </h3>
                <p class="platform-card-subtitle">L'ensemble de vos flux mensuels, entrants et sortants</p>
            </div>
            <div class="platform-card-body">
                <div class="financial-edit-grid">
                    <!-- Ligne 1: Situation professionnelle + Métier -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Situation professionnelle *</label>
                        <select class="form-control" name="professional_situation" id="professionalSituation" onchange="toggleProfessionalSituationOther()" required>
                            <option value="">Choisir...</option>
                            <option value="Salarié" {{ 'selected' if user.investor_profile.professional_situation == 'Salarié' }}>Salarié</option>
                            <option value="Fonctionnaire" {{ 'selected' if user.investor_profile.professional_situation == 'Fonctionnaire' }}>Fonctionnaire</option>
                            <option value="Indépendant" {{ 'selected' if user.investor_profile.professional_situation == 'Indépendant' }}>Indépendant</option>
                            <option value="Étudiant" {{ 'selected' if user.investor_profile.professional_situation == 'Étudiant' }}>Étudiant</option>
                            <option value="Retraité" {{ 'selected' if user.investor_profile.professional_situation == 'Retraité' }}>Retraité</option>
                            <option value="Sans Emploi" {{ 'selected' if user.investor_profile.professional_situation == 'Sans Emploi' }}>Sans Emploi</option>
                            <option value="Autre" {{ 'selected' if user.investor_profile.professional_situation == 'Autre' }}>Autre</option>
                        </select>
                        <input type="text" class="form-control mt-2" name="professional_situation_other" id="professionalSituationOther" 
                               placeholder="Précisez votre situation..." style="display: none;">
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Métier</label>
                        <input type="text" class="form-control" name="metier" 
                               value="{{ user.investor_profile.metier or '' }}" placeholder="Ex: Développeur, Enseignant, Manager...">
                    </div>
                    
                    <!-- Ligne 2: Revenu mensuel net + Impôts mensuels -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Revenu mensuel net *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="monthly_net_income" id="monthlyNetIncome"
                                   value="{{ user.investor_profile.monthly_net_income }}" step="0.01" min="0" required>
                            <span class="input-group-text">€</span>
                        </div>
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Impôts mensuels</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="impots_mensuels" id="impotsMensuels"
                                   value="{{ user.investor_profile.impots_mensuels or 0 }}" step="0.01" min="0">
                            <span class="input-group-text">€</span>
                        </div>
                    </div>
                    
                    <!-- Ligne 3: Capacité d'épargne + Taux d'épargne -->
                    <div class="financial-edit-item">
                        <label class="financial-label">Capacité d'épargne mensuelle *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="monthly_savings_capacity" id="monthlySavingsCapacity"
                                   value="{{ user.investor_profile.monthly_savings_capacity }}" step="0.01" min="0" required>
                            <span class="input-group-text">€</span>
                        </div>
                    </div>
                    <div class="financial-edit-item">
                        <label class="financial-label">Taux d'épargne</label>
                        <div class="taux-epargne-display" id="tauxEpargneDisplay">
                            <span id="tauxEpargneValue">0.0</span>%
                        </div>
                    </div>
                </div>
                
                <!-- Revenus complémentaires (dynamique) -->
                <div class="mt-4">
                    <h4 class="financial-section-title">Revenus complémentaires</h4>
                    <div class="revenus-edit-grid" id="revenusGrid">
                        {% for revenu in user.investor_profile.revenus_complementaires_data %}
                        <div class="revenu-edit-item">
                            <button type="button" class="revenu-delete-btn" onclick="removeRevenuItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="revenu-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Type de revenu</label>
                                    <input type="text" class="form-control revenu-complementaire-input" name="revenu_complementaire_name[]" 
                                           value="{{ revenu.name }}" placeholder="Ex: Loyers, Dividendes...">
                                </div>
                                <div class="financial-edit-item">
                                    <label class="financial-label">Montant mensuel</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control revenu-complementaire-input" name="revenu_complementaire_amount[]" 
                                               value="{{ revenu.amount }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="patrimoine-edit-item add-revenu-grid-item" id="addRevenuGridItem">
                            <div class="patrimoine-checkbox add-revenu-checkbox" onclick="addRevenuInline()">
                                <div class="add-revenu-content">
                                    <i class="fas fa-plus"></i>
                                    <span>Ajouter un revenu</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charges mensuelles (dynamique) -->
                <div class="mt-4">
                    <h4 class="financial-section-title">Charges mensuelles</h4>
                    <div class="charges-edit-grid" id="chargesGrid">
                        {% for charge in user.investor_profile.charges_mensuelles_data %}
                        <div class="charge-edit-item">
                            <button type="button" class="charge-delete-btn" onclick="removeChargeItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="charge-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Type de charge</label>
                                    <input type="text" class="form-control charge-mensuelle-input" name="charge_mensuelle_name[]" 
                                           value="{{ charge.name }}" placeholder="Ex: Loyer, Crédit auto...">
                                </div>
                                <div class="financial-edit-item">
                                    <label class="financial-label">Montant mensuel</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control charge-mensuelle-input" name="charge_mensuelle_amount[]" 
                                               value="{{ charge.amount }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="patrimoine-edit-item add-charge-grid-item" id="addChargeGridItem">
                            <div class="patrimoine-checkbox add-charge-checkbox" onclick="addChargeInline()">
                                <div class="add-charge-content">
                                    <i class="fas fa-plus"></i>
                                    <span>Ajouter une charge</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: EPARGNE -->
        <div class="platform-card mb-4">
            <div class="platform-card-header">
                <h3 class="platform-card-title">
                    EPARGNE
                </h3>
                <p class="platform-card-subtitle">Dressez ici un état des lieux de vos avoirs financiers et immobiliers</p>
            </div>
            <div class="platform-card-body">
                <!-- Sous-section Liquidités -->
                <div class="mb-4">
                    <h4 class="financial-section-title">Liquidités</h4>
                    <div class="epargne-liquidites-grid" id="epargneLiquiditesGrid">
                        <!-- Livret A -->
                        <div class="epargne-liquidite-item">
                            <div class="epargne-liquidite-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Livret A</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="livret_a_value" id="epargne_livret_a"
                                               value="{{ user.investor_profile.livret_a_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- LDDS -->
                        <div class="epargne-liquidite-item">
                            <div class="epargne-liquidite-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Livret de Développement Durable et Solidaire (LDDS)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="ldds_value" id="epargne_ldds"
                                               value="{{ user.investor_profile.ldds_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PEL/CEL -->
                        <div class="epargne-liquidite-item">
                            <div class="epargne-liquidite-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Plan Épargne Logement / Compte Épargne Logement (PEL/CEL)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="pel_cel_value" id="epargne_pel_cel"
                                               value="{{ user.investor_profile.pel_cel_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Liquidités personnalisées existantes -->
                        {% for liquidite in user.investor_profile.liquidites_personnalisees_data %}
                        <div class="epargne-liquidite-item epargne-liquidite-custom">
                            <button type="button" class="epargne-liquidite-delete-btn" onclick="removeEpargneLiquiditeItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="epargne-liquidite-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Type de liquidité</label>
                                    <input type="text" class="form-control" name="liquidite_personnalisee_name[]" 
                                           value="{{ liquidite.name }}" placeholder="Nom de la liquidité">
                                </div>
                                <div class="financial-edit-item">
                                    <label class="financial-label">Montant</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="liquidite_personnalisee_amount[]" 
                                               value="{{ liquidite.amount }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Bouton d'ajout -->
                        <div class="epargne-liquidite-item epargne-add-liquidite-item" id="epargneLiquiditeAddItem">
                            <div class="epargne-add-liquidite-content" onclick="addEpargneLiquiditeInline()">
                                <i class="fas fa-plus"></i>
                                <span>Ajouter une liquidité</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Liquidités EPARGNE -->
                    <div class="total-section">
                        <div class="total-display">
                            <i class="fas fa-coins"></i> 
                            <span>Total Liquidités: </span>
                            <span id="totalEpargneLiquidites">0€</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sous-section Placements financiers -->
                <div class="mb-4">
                    <h4 class="financial-section-title">Placements financiers</h4>
                    <div class="epargne-placements-grid" id="epargnePlacementsGrid">
                        <!-- PEA -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Plan d'Épargne en Actions (PEA)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="pea_value" id="epargne_pea"
                                               value="{{ user.investor_profile.pea_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CTO -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Compte Titres Ordinaire (CTO)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="cto_value" id="epargne_cto"
                                               value="{{ user.investor_profile.cto_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assurance-vie -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Assurance-vie (AV)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="life_insurance_value" id="epargne_av"
                                               value="{{ user.investor_profile.life_insurance_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PER -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Plan d'Épargne Retraite (PER)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="per_value" id="epargne_per"
                                               value="{{ user.investor_profile.per_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PEE/PERCO -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Plan d'Épargne Entreprise (PEE / PERCO)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="pee_value" id="epargne_pee"
                                               value="{{ user.investor_profile.pee_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Private Equity -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Private Equity (PE)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="private_equity_value" id="epargne_pe"
                                               value="{{ user.investor_profile.private_equity_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parts de SCPI -->
                        <div class="epargne-placement-item">
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Parts de SCPI</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="scpi_value" id="epargne_scpi"
                                               value="{{ user.investor_profile.scpi_value or 0 }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Placements personnalisés existants -->
                        {% for placement in user.investor_profile.placements_personnalises_data %}
                        <div class="epargne-placement-item epargne-placement-custom">
                            <button type="button" class="epargne-placement-delete-btn" onclick="removeEpargnePlacementItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="epargne-placement-content">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Type de placement</label>
                                    <input type="text" class="form-control" name="placement_personnalise_name[]" 
                                           value="{{ placement.name }}" placeholder="Ex: Crowdfunding">
                                </div>
                                <div class="financial-edit-item">
                                    <label class="financial-label">Montant</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="placement_personnalise_amount[]" 
                                               value="{{ placement.amount }}" step="0.01" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Bouton d'ajout -->
                        <div class="epargne-placement-item epargne-add-placement-item" id="epargnePlacementAddItem">
                            <div class="epargne-add-placement-content" onclick="addEpargnePlacementInline()">
                                <i class="fas fa-plus"></i>
                                <span>Ajouter un placement</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Placements financiers EPARGNE -->
                    <div class="total-section">
                        <div class="total-display">
                            <i class="fas fa-chart-line"></i> 
                            <span>Total Placements financiers: </span>
                            <span id="totalEpargnePlacements">0€</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Immobilier -->
        <div class="platform-card mb-4">
            <div class="platform-card-header">
                <h3 class="platform-card-title">
                    <i class="fas fa-home text-primary"></i>
                    IMMOBILIER
                </h3>
                <p class="platform-card-subtitle">Patrimoine immobilier et crédits associés</p>
            </div>
            <div class="platform-card-body">
                <div class="immobilier-grid" id="immobilierGrid">
                    {% for bien in user.investor_profile.biens_immobiliers_data or [] %}
                    <div class="immobilier-item">
                        <button type="button" class="immobilier-delete-btn" onclick="removeImmobilierItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="immobilier-content">
                            <div class="immobilier-header">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Type de bien</label>
                                    <select class="form-control bien-type-select" name="bien_type[]">
                                        <option value="">Choisir...</option>
                                        <option value="residence_principale" {{ 'selected' if bien.type == 'residence_principale' }}>Résidence principale</option>
                                        <option value="residence_secondaire" {{ 'selected' if bien.type == 'residence_secondaire' }}>Résidence secondaire</option>
                                        <option value="investissement_locatif" {{ 'selected' if bien.type == 'investissement_locatif' }}>Investissement locatif</option>
                                    </select>
                                </div>
                                <div class="financial-edit-item description-field" style="display: {{ 'block' if bien.type == 'investissement_locatif' else 'none' }};">
                                    <label class="financial-label">Description</label>
                                    <input type="text" class="form-control" name="bien_description[]" 
                                           value="{{ bien.description or '' }}" placeholder="Ex: Appartement, Maison...">
                                </div>
                            </div>
                            
                            <div class="immobilier-values">
                                <div class="financial-edit-item">
                                    <label class="financial-label">Valeur estimée</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control bien-valeur-input" name="bien_valeur[]" 
                                               value="{{ bien.valeur or 0 }}" step="1000" min="0">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                                <div class="financial-edit-item">
                                    <label class="financial-label">Surface (m²)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control bien-surface-input" name="bien_surface[]" 
                                               value="{{ bien.surface or 0 }}" step="1" min="0">
                                        <span class="input-group-text">m²</span>
                                    </div>
                                </div>
                                <div class="financial-edit-item">
                                    <label class="financial-label">Prix au m²</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control prix-m2-display" readonly>
                                        <span class="input-group-text">€/m²</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="credit-section">
                                <div class="credit-checkbox-container">
                                    <input type="checkbox" class="credit-checkbox" name="bien_has_credit[]" value="1" 
                                           {{ 'checked' if bien.has_credit }}>
                                    <label class="credit-label">J'ai un crédit immobilier lié à ce bien</label>
                                </div>
                                
                                <div class="credit-details" style="display: {{ 'block' if bien.has_credit else 'none' }};">
                                    <div class="credit-row">
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Montant du crédit initial</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control credit-montant-input" name="credit_montant[]" 
                                                       value="{{ bien.credit_montant or 0 }}" step="1000" min="0">
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Durée (années)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control credit-duree-input" name="credit_duree[]" 
                                                       value="{{ bien.credit_duree or 0 }}" step="1" min="0" max="50">
                                                <span class="input-group-text">ans</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="credit-row">
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Taux TAG (%)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control credit-tag-input" name="credit_tag[]" 
                                                       value="{{ bien.credit_tag or 0 }}" step="0.01" min="0" max="20">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Taux TAEG (%)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control credit-taeg-input" name="credit_taeg[]" 
                                                       value="{{ bien.credit_taeg or 0 }}" step="0.01" min="0" max="20">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="credit-row">
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Date de départ</label>
                                            <input type="month" class="form-control credit-date-input" name="credit_date[]" 
                                                   value="{{ bien.credit_date or '' }}">
                                        </div>
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Mensualités</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control mensualites-display" readonly>
                                                <span class="input-group-text">€/mois</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="credit-row">
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Capital restant dû</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control capital-restant-display" readonly>
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                        <div class="financial-edit-item">
                                            <label class="financial-label">Total payé</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control total-paye-display" readonly>
                                                <span class="input-group-text">€</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="valeur-nette-section">
                                <div class="valeur-nette-display">
                                    <strong>Valeur nette du bien: <span class="valeur-nette-value">0€</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="immobilier-add-item" id="immobilierAddItem">
                        <div class="immobilier-add-content" onclick="addImmobilierInline()">
                            <i class="fas fa-plus"></i>
                            <span>Ajouter un bien immobilier</span>
                        </div>
                    </div>
                </div>
                
                <!-- Total Immobilier -->
                <div class="total-section">
                    <div class="total-display">
                        <i class="fas fa-home"></i> 
                        <span>Total Immobilier (valeur nette): </span>
                        <span id="totalImmobilier">0€</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="edit-actions">
            <a href="{{ url_for('platform_admin.user_detail', user_id=user.id) }}" class="admin-btn admin-btn-secondary">
                <i class="fas fa-times"></i>
                Annuler
            </a>
            <button type="submit" class="admin-btn admin-btn-primary">
                <i class="fas fa-save"></i>
                Sauvegarder les modifications
            </button>
        </div>
    </form>
</div>

{% else %}
<!-- MODE VISUALISATION -->
<div class="view-mode-container">
    <!-- Actions rapides -->
    <div class="admin-actions mb-4">
        <a href="{{ url_for('platform_admin.user_detail', user_id=user.id, edit='true') }}" class="admin-btn admin-btn-primary">
            <i class="fas fa-edit"></i>
            Modifier les données
        </a>
        {% if user.subscription %}
        <button class="admin-btn admin-btn-warning" onclick="manageSubscription({{ user.id }})">
            <i class="fas fa-crown"></i>
            Gérer l'abonnement
        </button>
        {% endif %}
    </div>

    <!-- Informations utilisateur -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-user text-primary"></i>
                Informations personnelles
            </h3>
            <p class="platform-card-subtitle">Données de base de l'utilisateur</p>
        </div>
        <div class="platform-card-body">
            <div class="user-info-grid">
                <div class="user-info-item">
                    <div class="info-label">Nom complet</div>
                    <div class="info-value">{{ user.first_name }} {{ user.last_name }}</div>
                </div>
                <div class="user-info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ user.email }}</div>
                </div>
                <div class="user-info-item">
                    <div class="info-label">Téléphone</div>
                    <div class="info-value">{{ user.phone or 'Non renseigné' }}</div>
                </div>
                <div class="user-info-item">
                    <div class="info-label">Date création</div>
                    <div class="info-value">{{ user.date_created.strftime('%d/%m/%Y à %H:%M') if user.date_created else '-' }}</div>
                </div>
                {% if user.last_login %}
                <div class="user-info-item">
                    <div class="info-label">Dernière connexion</div>
                    <div class="info-value">{{ user.last_login.strftime('%d/%m/%Y à %H:%M') }}</div>
                </div>
                {% endif %}
                <div class="user-info-item">
                    <div class="info-label">Statut</div>
                    <div class="info-value">
                        <span class="status-badge status-active">
                            Client
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Situation financière -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-euro-sign text-primary"></i>
                Situation financière
            </h3>
            <p class="platform-card-subtitle">Revenus et capacité d'épargne</p>
        </div>
        <div class="platform-card-body">
            <div class="financial-view-grid">
                <div class="financial-view-item">
                    <div class="financial-label">Revenus mensuels nets</div>
                    <div class="financial-value">{{ "{:,.0f}".format(user.investor_profile.monthly_net_income) }}€</div>
                </div>
                <div class="financial-view-item">
                    <div class="financial-label">Épargne actuelle</div>
                    <div class="financial-value">{{ "{:,.0f}".format(user.investor_profile.current_savings) }}€</div>
                </div>
                <div class="financial-view-item">
                    <div class="financial-label">Capacité d'épargne mensuelle</div>
                    <div class="financial-value">{{ "{:,.0f}".format(user.investor_profile.monthly_savings_capacity) }}€</div>
                </div>
                <div class="financial-view-item">
                    <div class="financial-label">Taux d'épargne</div>
                    <div class="financial-value">
                        {% set taux_epargne = (user.investor_profile.monthly_savings_capacity / user.investor_profile.monthly_net_income * 100) if user.investor_profile.monthly_net_income > 0 %}
                        {{ "{:.1f}".format(taux_epargne) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section revenus complémentaires -->
    {% if user.investor_profile.revenus_complementaires_data %}
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-plus-circle text-success"></i>
                REVENUS COMPLÉMENTAIRES
            </h3>
            <p class="platform-card-subtitle">Sources de revenus supplémentaires</p>
        </div>
        <div class="platform-card-body">
            <div class="revenue-view-grid">
                {% for revenu in user.investor_profile.revenus_complementaires_data %}
                <div class="revenue-view-item">
                    <div class="revenue-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="revenue-info">
                        <div class="revenue-name">{{ revenu.name }}</div>
                        <div class="revenue-amount">{{ "{:,.0f}".format(revenu.amount) }}€/mois</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Section 3: CHARGES -->
    {% if user.investor_profile.charges_data %}
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-minus-circle text-danger"></i>
                CHARGES
            </h3>
            <p class="platform-card-subtitle">Charges et dépenses mensuelles</p>
        </div>
        <div class="platform-card-body">
            <div class="charges-view-grid">
                {% for charge in user.investor_profile.charges_data %}
                <div class="charge-view-item">
                    <div class="charge-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="charge-info">
                        <div class="charge-name">{{ charge.name }}</div>
                        <div class="charge-amount">{{ "{:,.0f}".format(charge.amount) }}€/mois</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Section 4: LIQUIDITÉS -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-water text-info"></i>
                LIQUIDITÉS
            </h3>
            <p class="platform-card-subtitle">Comptes et liquidités disponibles</p>
        </div>
        <div class="platform-card-body">
            <div class="patrimoine-view-grid">
                <!-- Livret A -->
                {% if user.investor_profile.has_livret_a and user.investor_profile.livret_a_value > 0 %}
                <div class="patrimoine-view-item">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">Livret A</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(user.investor_profile.livret_a_value) }}€</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Compte Courant -->
                {% if user.investor_profile.has_current_account and user.investor_profile.current_account_value > 0 %}
                <div class="patrimoine-view-item">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">Compte courant</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(user.investor_profile.current_account_value) }}€</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Liquidités personnalisées -->
                {% for liquidite in user.investor_profile.liquidites_personnalisees_data %}
                <div class="patrimoine-view-item custom">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">{{ liquidite.name }}</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(liquidite.amount) }}€</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Total Liquidités - Style patrimoine exact -->
            {% set total_liquidites = 0 %}
            {% if user.investor_profile.has_livret_a and user.investor_profile.livret_a_value %}
                {% set total_liquidites = total_liquidites + user.investor_profile.livret_a_value %}
            {% endif %}
            {% if user.investor_profile.has_current_account and user.investor_profile.current_account_value %}
                {% set total_liquidites = total_liquidites + user.investor_profile.current_account_value %}
            {% endif %}
            {% if user.investor_profile.has_ldds and user.investor_profile.ldds_value %}
                {% set total_liquidites = total_liquidites + user.investor_profile.ldds_value %}
            {% endif %}
            {% if user.investor_profile.has_lep and user.investor_profile.lep_value %}
                {% set total_liquidites = total_liquidites + user.investor_profile.lep_value %}
            {% endif %}
            {% if user.investor_profile.has_pel_cel and user.investor_profile.pel_cel_value %}
                {% set total_liquidites = total_liquidites + user.investor_profile.pel_cel_value %}
            {% endif %}
            {% for liquidite in user.investor_profile.liquidites_personnalisees_data %}
                {% set total_liquidites = total_liquidites + liquidite.amount %}
            {% endfor %}
            
            {% if total_liquidites > 0 %}
            <div class="total-section-view">
                <div class="total-display-view liquidites">
                    <i class="fas fa-coins"></i> 
                    <span>Total Liquidités: {{ "{:,.0f}".format(total_liquidites) }}€</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section 5: PLACEMENTS FINANCIERS -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-chart-line text-success"></i>
                PLACEMENTS FINANCIERS
            </h3>
            <p class="platform-card-subtitle">Investissements et placements</p>
        </div>
        <div class="platform-card-body">
            <div class="patrimoine-view-grid">
                <!-- PEA -->
                {% if user.investor_profile.has_pea and user.investor_profile.pea_value > 0 %}
                <div class="patrimoine-view-item">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">PEA</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(user.investor_profile.pea_value) }}€</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- PER -->
                {% if user.investor_profile.has_per and user.investor_profile.per_value > 0 %}
                <div class="patrimoine-view-item">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">PER</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(user.investor_profile.per_value) }}€</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Assurance Vie -->
                {% if user.investor_profile.has_life_insurance and user.investor_profile.life_insurance_value > 0 %}
                <div class="patrimoine-view-item">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">Assurance Vie</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(user.investor_profile.life_insurance_value) }}€</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Placements personnalisés -->
                {% for placement in user.investor_profile.placements_personnalises_data %}
                <div class="patrimoine-view-item custom">
                    <div class="patrimoine-view-icon">
                        <i class="fas fa-chart-area"></i>
                    </div>
                    <div class="patrimoine-view-info">
                        <div class="patrimoine-view-name">{{ placement.name }}</div>
                        <div class="patrimoine-view-amount">{{ "{:,.0f}".format(placement.amount) }}€</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Total Placements - Calcul complet -->
            {% set total_placements = 0 %}
            {% if user.investor_profile.has_pea and user.investor_profile.pea_value %}
                {% set total_placements = total_placements + user.investor_profile.pea_value %}
            {% endif %}
            {% if user.investor_profile.has_per and user.investor_profile.per_value %}
                {% set total_placements = total_placements + user.investor_profile.per_value %}
            {% endif %}
            {% if user.investor_profile.has_life_insurance and user.investor_profile.life_insurance_value %}
                {% set total_placements = total_placements + user.investor_profile.life_insurance_value %}
            {% endif %}
            {% if user.investor_profile.has_pee and user.investor_profile.pee_value %}
                {% set total_placements = total_placements + user.investor_profile.pee_value %}
            {% endif %}
            {% if user.investor_profile.has_scpi and user.investor_profile.scpi_value %}
                {% set total_placements = total_placements + user.investor_profile.scpi_value %}
            {% endif %}
            {% for placement in user.investor_profile.placements_personnalises_data %}
                {% set total_placements = total_placements + placement.amount %}
            {% endfor %}
            
            <!-- Calcul du patrimoine total en temps réel -->
            {% set patrimoine_total = total_liquidites + total_placements %}
            
            {% if total_placements > 0 %}
            <div class="total-section-view">
                <div class="total-display-view placements">
                    <i class="fas fa-chart-line"></i> 
                    <span>Total Placements: {{ "{:,.0f}".format(total_placements) }}€</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Patrimoine total -->
            {% if patrimoine_total > 0 %}
            <div class="total-section-view mt-3">
                <div class="total-display-view patrimoine-total">
                    <i class="fas fa-coins"></i> 
                    <span>PATRIMOINE TOTAL: {{ "{:,.0f}".format(patrimoine_total) }}€</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section 6: CRYPTOMONNAIES -->
    {% if user.investor_profile.cryptomonnaies_data %}
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fab fa-bitcoin text-warning"></i>
                CRYPTOMONNAIES
            </h3>
            <p class="platform-card-subtitle">Portefeuille de cryptomonnaies détenues en direct</p>
        </div>
        <div class="platform-card-body">
            <div class="crypto-view-grid">
                {% for crypto in user.investor_profile.cryptomonnaies_data %}
                <div class="crypto-view-item">
                    <div class="crypto-view-icon">
                        <i class="fab fa-bitcoin"></i>
                    </div>
                    <div class="crypto-view-info">
                        <div class="crypto-view-name">{{ crypto.symbol }}</div>
                        <div class="crypto-view-quantity">{{ crypto.quantity }}</div>
                        <div class="crypto-view-note">Valeur temps réel à calculer</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="total-section-view">
                <div class="total-display-view crypto">
                    <i class="fab fa-bitcoin"></i> 
                    <span>Valeur totale: Calcul en temps réel requis</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Section 7: PROFIL INVESTISSEUR -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-chart-bar text-primary"></i>
                PROFIL INVESTISSEUR
            </h3>
            <p class="platform-card-subtitle">Profil et objectifs d'investissement</p>
        </div>
        <div class="platform-card-body">
            <div class="view-data-grid">
                <div class="view-data-item">
                    <div class="view-label">Revenus mensuels nets</div>
                    <div class="view-value amount">{{ "{:,.0f}".format(user.investor_profile.monthly_net_income) }}€</div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Épargne actuelle</div>
                    <div class="view-value amount">{{ "{:,.0f}".format(user.investor_profile.current_savings) }}€</div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Capacité d'épargne mensuelle</div>
                    <div class="view-value amount">{{ "{:,.0f}".format(user.investor_profile.monthly_savings_capacity) }}€</div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Situation familiale</div>
                    <div class="view-value">{{ user.investor_profile.family_situation|title if user.investor_profile.family_situation else '-' }}</div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Tolérance au risque</div>
                    <div class="view-value risk-{{ user.investor_profile.risk_tolerance|lower if user.investor_profile.risk_tolerance }}">
                        {{ user.investor_profile.risk_tolerance|title if user.investor_profile.risk_tolerance else '-' }}
                    </div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Expérience d'investissement</div>
                    <div class="view-value">{{ user.investor_profile.investment_experience|title if user.investor_profile.investment_experience else '-' }}</div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Horizon d'investissement</div>
                    <div class="view-value">{{ user.investor_profile.investment_horizon|title if user.investor_profile.investment_horizon else '-' }}</div>
                </div>
                <div class="view-data-item">
                    <div class="view-label">Situation professionnelle</div>
                    <div class="view-value">{{ user.investor_profile.professional_situation|title if user.investor_profile.professional_situation else '-' }}</div>
                </div>
            </div>
            
            {% if user.investor_profile.investment_goals %}
            <div class="objectives-content">
                <h4 class="objectives-title">Objectifs d'investissement</h4>
                <div class="objectives-text">
                    {{ user.investor_profile.investment_goals|replace('\n', '<br>')|safe }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endif %}

{% else %}
<!-- Utilisateur sans profil investisseur -->
<div class="platform-card">
    <div class="platform-card-body text-center">
        <i class="fas fa-user-slash text-muted" style="font-size: 48px; margin-bottom: 16px;"></i>
        <h4>Profil investisseur non complété</h4>
        <p class="text-muted">Cet utilisateur n'a pas encore complété son profil investisseur.</p>
    </div>
</div>
{% endif %}

<!-- Import des styles de la page profil -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/investor_data.css') }}">
<style>
/* Styles Atlas pour la grille de patrimoine */
.liquidites-edit-grid, .placements-edit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.patrimoine-edit-item {
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.patrimoine-edit-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.patrimoine-checkbox {
    display: flex;
    align-items: center;
    gap: 12px;
}

.patrimoine-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--qlower-primary);
    cursor: pointer;
}

.patrimoine-label {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
    cursor: pointer;
    margin: 0;
}

.patrimoine-label i {
    font-size: 20px;
    width: 24px;
    text-align: center;
    color: var(--qlower-primary);
}

.patrimoine-value {
    margin-top: 8px;
}

/* Boutons d'ajout intégrés dans la grille */
.add-liquidite-grid-item, .add-placement-grid-item, .add-crypto-grid-item {
    border: 2px dashed var(--qlower-primary) !important;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%) !important;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-liquidite-grid-item:hover, .add-placement-grid-item:hover, .add-crypto-grid-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(19, 124, 139, 0.15);
}

.add-liquidite-checkbox, .add-placement-checkbox, .add-crypto-checkbox {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 14px;
}

.add-liquidite-content, .add-placement-content, .add-crypto-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: white;
    font-weight: 600;
}

.add-liquidite-content i, .add-placement-content i, .add-crypto-content i {
    font-size: 24px;
}

/* Section totaux */
.total-section {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 2px solid var(--qlower-border);
}

.total-display {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
}

.total-display i {
    margin-right: 8px;
    font-size: 20px;
}

/* Styles pour les éléments personnalisés */
.liquidite-personnalisee-item, .placement-personnalise-item {
    border-color: var(--qlower-primary) !important;
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.05) 0%, rgba(112, 156, 167, 0.05) 100%);
}

.liquidite-name-input, .placement-name-input {
    border-right: none !important;
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

/* Crypto section styles */
.crypto-edit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.crypto-edit-item {
    background: var(--qlower-bg-light);
    border: 2px solid var(--qlower-border);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s ease;
    display: grid;
    grid-template-columns: 2fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.crypto-edit-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.crypto-select {
    font-size: 14px;
}

/* Styles généraux */
.financial-edit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.financial-edit-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.financial-label {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 14px;
    margin-bottom: 8px;
    display: block;
}

.form-control {
    display: block;
    width: 100%;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 400;
    line-height: 1.5;
    color: var(--qlower-dark);
    background-color: var(--qlower-white);
    background-clip: padding-box;
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    font-family: 'Inter', sans-serif;
}

.form-control:focus {
    color: var(--qlower-dark);
    background-color: var(--qlower-white);
    border-color: var(--qlower-primary);
    outline: 0;
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.input-group {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    width: 100%;
}

.input-group .form-control {
    position: relative;
    flex: 1 1 auto;
    width: 1%;
    min-width: 0;
    margin-bottom: 0;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    border-right: none;
}

.input-group-text {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 500;
    line-height: 1.5;
    color: var(--qlower-dark);
    text-align: center;
    white-space: nowrap;
    background-color: var(--qlower-bg-light);
    border: 2px solid var(--qlower-border);
    border-left: none;
    border-radius: 0 12px 12px 0;
    font-family: 'Inter', sans-serif;
}

.platform-card {
    background: var(--qlower-white);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--qlower-border);
    overflow: hidden;
    margin-bottom: 24px;
}

.platform-card-header {
    padding: 24px 24px 0;
    border-bottom: 1px solid var(--qlower-border);
    margin-bottom: 24px;
}

.platform-card-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-dark);
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.platform-card-subtitle {
    font-size: 14px;
    color: var(--qlower-text-light);
    margin: 0 0 24px 0;
}

.platform-card-body {
    padding: 0 24px 24px;
}

.edit-actions {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
    padding: 32px 0;
    border-top: 2px solid var(--qlower-border);
    margin-top: 32px;
}

.alert {
    padding: 16px 20px;
    margin-bottom: 24px;
    border: 1px solid transparent;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

/* Page title responsive */
.page-title-responsive {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}

@media (max-width: 768px) {
    .page-title-responsive {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .liquidites-edit-grid, .placements-edit-grid {
        grid-template-columns: 1fr;
    }
    
    .financial-edit-grid {
        grid-template-columns: 1fr;
    }
    
    .crypto-edit-grid {
        grid-template-columns: 1fr;
    }
    
    .crypto-edit-item {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .edit-actions {
        flex-direction: column;
        gap: 12px;
    }
}

/* Styles exactement copiés depuis prospect_detail.html */
.user-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.user-info-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 16px;
    background: var(--qlower-bg-light);
    border-radius: 8px;
}

.info-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.info-value {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

/* Styles spécifiques pour le mode visualisation */
.financial-view-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.financial-view-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 20px;
    background: var(--qlower-bg-light);
    border-radius: 12px;
    border: 1px solid var(--qlower-border);
}

.financial-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
    margin-bottom: 4px;
}

.financial-value {
    font-weight: 700;
    color: var(--qlower-dark);
    font-size: 20px;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
}

/* Styles pour les sections de revenus et charges */
.revenue-view-grid, .charges-view-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.revenue-view-item, .charge-view-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.revenue-view-item:hover, .charge-view-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(19, 124, 139, 0.1);
}

.revenue-icon, .charge-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}

.charge-icon {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.revenue-info, .charge-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.revenue-name, .charge-name {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
}

.revenue-amount {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-weight: 700;
    color: #28a745;
    font-size: 18px;
}

.charge-amount {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-weight: 700;
    color: #dc3545;
    font-size: 18px;
}

/* Styles pour le patrimoine en mode lecture */
.patrimoine-view-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.patrimoine-view-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.patrimoine-view-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(19, 124, 139, 0.1);
}

.patrimoine-view-item.custom {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.05) 0%, rgba(112, 156, 167, 0.05) 100%);
}

.patrimoine-view-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}

.patrimoine-view-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.patrimoine-view-name {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
}

.patrimoine-view-amount {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-weight: 700;
    color: var(--qlower-primary);
    font-size: 18px;
}

/* Styles pour les cryptos en mode lecture */
.crypto-view-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.crypto-view-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.crypto-view-item:hover {
    border-color: #f7931a;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(247, 147, 26, 0.1);
}

.crypto-view-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(135deg, #f7931a 0%, #ff9500 100%);
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}

.crypto-view-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.crypto-view-name {
    font-weight: 700;
    color: var(--qlower-dark);
    font-size: 16px;
    font-family: 'Encode Sans Condensed', sans-serif;
}

.crypto-view-quantity {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-weight: 600;
    color: #f7931a;
    font-size: 18px;
}

.crypto-view-note {
    font-size: 12px;
    color: var(--qlower-text-light);
    font-style: italic;
}

/* Styles pour les totaux en mode lecture */
.total-section-view {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 2px solid var(--qlower-border);
}

.total-display-view {
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.total-display-view.liquidites {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

.total-display-view.placements {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

.total-display-view.crypto {
    background: linear-gradient(135deg, #f7931a 0%, #ff9500 100%);
}

.total-display-view.patrimoine-total {
    background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
    font-size: 22px;
    font-weight: 800;
    border: 3px solid #6f42c1;
    box-shadow: 0 6px 25px rgba(111, 66, 193, 0.2);
}

.total-display-view i {
    font-size: 20px;
}

/* Objectives - copiés depuis prospect_detail.html */
.objectives-content {
    margin-top: 0;
}

.objectives-text {
    background: var(--qlower-bg-light);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--qlower-border);
    color: var(--qlower-dark);
    font-size: 15px;
    line-height: 1.6;
}

/* Styles pour la tolérance au risque */
.view-value.risk-conservateur {
    color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
}

.view-value.risk-modéré {
    color: #ffc107;
    background: rgba(255, 193, 7, 0.1);
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
}

.view-value.risk-dynamique {
    color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
}

/* Actions admin en mode lecture */
.admin-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 24px;
}

/* Styles pour le taux d'épargne */
.taux-epargne-display {
    display: inline-block;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 18px;
    font-weight: 700;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    text-align: center;
    min-width: 80px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.taux-epargne-display.taux-rouge {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-color: #dc3545;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.taux-epargne-display.taux-orange {
    background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
    color: white;
    border-color: #fd7e14;
    box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
}

.taux-epargne-display.taux-vert {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 15px rgba(19, 124, 139, 0.3);
}

/* Styles pour les grilles de revenus et charges */
.revenus-edit-grid, .charges-edit-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    margin-bottom: 24px;
}

.revenu-edit-item, .charge-edit-item {
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    padding: 16px;
    transition: all 0.3s ease;
    position: relative;
    min-height: 80px;
}

.revenu-edit-item:hover, .charge-edit-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

/* Contenu des revenus et charges */
.revenu-content, .charge-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: end;
}

/* Boutons de suppression en haut à droite */
.revenu-delete-btn, .charge-delete-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #dc3545;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.revenu-delete-btn:hover, .charge-delete-btn:hover {
    background: #c82333;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.revenu-delete-btn:active, .charge-delete-btn:active {
    transform: scale(0.95);
}

/* Boutons d'ajout pour revenus et charges */
.add-revenu-grid-item, .add-charge-grid-item {
    border: 2px dashed var(--qlower-primary) !important;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%) !important;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    padding: 8px 16px;
}

.add-revenu-grid-item:hover, .add-charge-grid-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(19, 124, 139, 0.15);
}

.add-revenu-checkbox, .add-charge-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
}

.add-revenu-content, .add-charge-content {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    color: white;
    font-weight: 600;
    font-size: 14px;
}

.add-revenu-content i, .add-charge-content i {
    font-size: 16px;
}

/* Styles pour la section EPARGNE - Liquidités */
.epargne-liquidites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.epargne-liquidite-item {
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    min-height: 120px;
}

.epargne-liquidite-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.epargne-liquidite-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}

/* Liquidités personnalisées avec bouton de suppression */
.epargne-liquidite-custom .epargne-liquidite-content {
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: end;
}

/* Bouton de suppression pour liquidités personnalisées */
.epargne-liquidite-delete-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #dc3545;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.epargne-liquidite-delete-btn:hover {
    background: #c82333;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.epargne-liquidite-delete-btn:active {
    transform: scale(0.95);
}

/* Bouton d'ajout de liquidité */
.epargne-add-liquidite-item {
    border: 2px dashed var(--qlower-primary) !important;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%) !important;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 120px;
}

.epargne-add-liquidite-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(19, 124, 139, 0.2);
}

/* Suppression du hover sur le total liquidités */
.total-section .total-display {
    cursor: default;
}

.total-section .total-display:hover {
    transform: none;
    box-shadow: none;
}

/* Suppression du hover sur la section total entière */
.total-section:hover {
    border-color: var(--qlower-border) !important;
    transform: none !important;
    box-shadow: none !important;
}

.total-section:hover .total-display {
    border-color: transparent !important;
}

.epargne-add-liquidite-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.epargne-add-liquidite-content i {
    font-size: 24px;
}

/* Styles pour la section EPARGNE - Placements financiers */
.epargne-placements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.epargne-placement-item {
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    min-height: 120px;
}

.epargne-placement-item:hover {
    border-color: var(--qlower-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.epargne-placement-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}

/* Placements personnalisés avec bouton de suppression */
.epargne-placement-custom .epargne-placement-content {
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: end;
}

/* Bouton de suppression pour placements personnalisés */
.epargne-placement-delete-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #dc3545;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.epargne-placement-delete-btn:hover {
    background: #c82333;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.epargne-placement-delete-btn:active {
    transform: scale(0.95);
}

/* Bouton d'ajout de placement */
.epargne-add-placement-item {
    border: 2px dashed var(--qlower-primary) !important;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%) !important;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 120px;
}

.epargne-add-placement-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(19, 124, 139, 0.2);
}

.epargne-add-placement-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.epargne-add-placement-content i {
    font-size: 24px;
}

/* Styles pour les titres de section financière */
.financial-section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--qlower-dark);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.financial-section-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--qlower-primary);
    border-radius: 2px;
}

/* Responsive pour le mode lecture */
@media (max-width: 768px) {
    .view-data-grid {
        grid-template-columns: 1fr;
    }
    
    .revenue-view-grid, .charges-view-grid, 
    .patrimoine-view-grid, .crypto-view-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-actions {
        flex-direction: column;
    }
    
    .revenu-content, .charge-content {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .epargne-liquidites-grid, .epargne-placements-grid {
        grid-template-columns: 1fr;
    }
    
    .epargne-liquidite-custom .epargne-liquidite-content,
    .epargne-placement-custom .epargne-placement-content {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

/* Styles pour la section IMMOBILIER */
.immobilier-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.immobilier-item {
    position: relative;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}

.immobilier-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
}

.immobilier-delete-btn:hover {
    background: #c82333;
    transform: scale(1.1);
}

.immobilier-header {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.immobilier-values {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.credit-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
}

.credit-checkbox-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.credit-checkbox {
    transform: scale(1.2);
}

.credit-label {
    font-weight: 500;
    color: #495057;
    margin: 0;
}

.credit-details {
    transition: all 0.3s ease;
}

.credit-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.credit-row:last-child {
    margin-bottom: 0;
}

.valeur-nette-section {
    background: linear-gradient(135deg, #137c8b, #1a8a9a);
    color: white;
    border-radius: 6px;
    padding: 12px 15px;
    text-align: center;
}

.valeur-nette-display strong {
    font-size: 1.1em;
}

.valeur-nette-value {
    color: #fff;
    font-size: 1.2em;
}

.immobilier-add-item {
    background: linear-gradient(135deg, #137c8b, #1a8a9a);
    border: none;
    border-radius: 14px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(19, 124, 139, 0.15);
}

.immobilier-add-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(19, 124, 139, 0.2);
}

.immobilier-add-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.immobilier-add-content i {
    font-size: 24px;
}

.prix-m2-display, .capital-restant-display, .mensualites-display, .total-paye-display {
    background: #f8f9fa !important;
    color: #6c757d;
    font-weight: 500;
}

/* Responsive pour mobile */
@media (max-width: 768px) {
    .immobilier-header,
    .immobilier-values,
    .credit-row {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Variables globales pour gérer les IDs uniques
let liquiditeCounter = 1000;
let placementCounter = 1000;
let cryptoCounter = 1000;

// Gestion de la situation professionnelle "Autre"
function toggleProfessionalSituationOther() {
    const select = document.getElementById('professionalSituation');
    const otherInput = document.getElementById('professionalSituationOther');
    
    if (select.value === 'Autre') {
        otherInput.style.display = 'block';
        otherInput.required = true;
    } else {
        otherInput.style.display = 'none';
        otherInput.required = false;
        otherInput.value = '';
    }
}

// Fonction pour calculer le taux d'épargne
function calculateTauxEpargne() {
    const revenuNet = parseFloat(document.getElementById('monthlyNetIncome').value || 0);
    const impots = parseFloat(document.getElementById('impotsMensuels').value || 0);
    const capaciteEpargne = parseFloat(document.getElementById('monthlySavingsCapacity').value || 0);
    
    // Calculer le revenu net après impôts
    const revenuNetApresImpots = revenuNet - impots;
    
    let tauxEpargne = 0;
    if (revenuNetApresImpots > 0) {
        tauxEpargne = (capaciteEpargne / revenuNetApresImpots) * 100;
    }
    
    // Limiter le taux à 100% maximum
    tauxEpargne = Math.min(tauxEpargne, 100);
    
    // Mettre à jour l'affichage
    const tauxDisplay = document.getElementById('tauxEpargneDisplay');
    const tauxValue = document.getElementById('tauxEpargneValue');
    
    tauxValue.textContent = tauxEpargne.toFixed(1);
    
    // Appliquer les couleurs conditionnelles
    tauxDisplay.className = 'taux-epargne-display';
    if (tauxEpargne < 10) {
        tauxDisplay.classList.add('taux-rouge');
    } else if (tauxEpargne >= 10 && tauxEpargne <= 20) {
        tauxDisplay.classList.add('taux-orange');
    } else if (tauxEpargne > 20) {
        tauxDisplay.classList.add('taux-vert');
    }
    
    return tauxEpargne;
}

// Fonction pour ajouter un revenu complémentaire
function addRevenuInline() {
    const grid = document.getElementById('revenusGrid');
    const addButton = document.getElementById('addRevenuGridItem');
    
    const newItem = document.createElement('div');
    newItem.className = 'revenu-edit-item';
    newItem.innerHTML = `
        <button type="button" class="revenu-delete-btn" onclick="removeRevenuItem(this)">
            <i class="fas fa-trash"></i>
        </button>
        <div class="revenu-content">
            <div class="financial-edit-item">
                <label class="financial-label">Type de revenu</label>
                <input type="text" class="form-control revenu-complementaire-input" name="revenu_complementaire_name[]" 
                       value="" placeholder="Ex: Loyers, Dividendes...">
            </div>
            <div class="financial-edit-item">
                <label class="financial-label">Montant mensuel</label>
                <div class="input-group">
                    <input type="number" class="form-control revenu-complementaire-input" name="revenu_complementaire_amount[]" 
                           value="0" step="0.01" min="0">
                    <span class="input-group-text">€</span>
                </div>
            </div>
        </div>
    `;
    
    grid.insertBefore(newItem, addButton);
    
    // Ajouter les événements pour le calcul du taux d'épargne
    newItem.querySelector('.revenu-complementaire-input[type="number"]').addEventListener('input', calculateTauxEpargne);
    
    // Focus sur le champ nom
    newItem.querySelector('input[type="text"]').focus();
}

// Fonction pour supprimer un revenu complémentaire
function removeRevenuItem(button) {
    button.closest('.revenu-edit-item').remove();
    calculateTauxEpargne();
}

// Fonction pour ajouter une charge mensuelle
function addChargeInline() {
    const grid = document.getElementById('chargesGrid');
    const addButton = document.getElementById('addChargeGridItem');
    
    const newItem = document.createElement('div');
    newItem.className = 'charge-edit-item';
    newItem.innerHTML = `
        <button type="button" class="charge-delete-btn" onclick="removeChargeItem(this)">
            <i class="fas fa-trash"></i>
        </button>
        <div class="charge-content">
            <div class="financial-edit-item">
                <label class="financial-label">Type de charge</label>
                <input type="text" class="form-control charge-mensuelle-input" name="charge_mensuelle_name[]" 
                       value="" placeholder="Ex: Loyer, Crédit auto...">
            </div>
            <div class="financial-edit-item">
                <label class="financial-label">Montant mensuel</label>
                <div class="input-group">
                    <input type="number" class="form-control charge-mensuelle-input" name="charge_mensuelle_amount[]" 
                           value="0" step="0.01" min="0">
                    <span class="input-group-text">€</span>
                </div>
            </div>
        </div>
    `;
    
    grid.insertBefore(newItem, addButton);
    
    // Ajouter les événements pour le calcul du taux d'épargne
    newItem.querySelector('.charge-mensuelle-input[type="number"]').addEventListener('input', calculateTauxEpargne);
    
    // Focus sur le champ nom
    newItem.querySelector('input[type="text"]').focus();
}

// Fonction pour supprimer une charge mensuelle
function removeChargeItem(button) {
    button.closest('.charge-edit-item').remove();
    calculateTauxEpargne();
}

// Fonction pour ajouter une liquidité personnalisée dans la section EPARGNE
function addEpargneLiquiditeInline() {
    const grid = document.getElementById('epargneLiquiditesGrid');
    const addButton = document.getElementById('epargneLiquiditeAddItem');
    
    const newItem = document.createElement('div');
    newItem.className = 'epargne-liquidite-item epargne-liquidite-custom';
    newItem.innerHTML = `
        <button type="button" class="epargne-liquidite-delete-btn" onclick="removeEpargneLiquiditeItem(this)">
            <i class="fas fa-trash"></i>
        </button>
        <div class="epargne-liquidite-content">
            <div class="financial-edit-item">
                <label class="financial-label">Type de liquidité</label>
                <input type="text" class="form-control" name="liquidite_personnalisee_name[]" 
                       value="" placeholder="Nom de la liquidité">
            </div>
            <div class="financial-edit-item">
                <label class="financial-label">Montant</label>
                <div class="input-group">
                    <input type="number" class="form-control" name="liquidite_personnalisee_amount[]" 
                           value="0" step="0.01" min="0">
                    <span class="input-group-text">€</span>
                </div>
            </div>
        </div>
    `;
    
    grid.insertBefore(newItem, addButton);
    
    // Ajouter l'événement pour le calcul du total
    newItem.querySelector('input[type="number"]').addEventListener('input', calculateTotalEpargneLiquidites);
    
    // Focus sur le champ nom
    newItem.querySelector('input[type="text"]').focus();
}

// Fonction pour supprimer une liquidité personnalisée de la section EPARGNE
function removeEpargneLiquiditeItem(button) {
    button.closest('.epargne-liquidite-item').remove();
    calculateTotalEpargneLiquidites();
}

// Fonction pour calculer le total des liquidités de la section EPARGNE
function calculateTotalEpargneLiquidites() {
    let total = 0;
    
    // Livret A
    const livretA = document.getElementById('epargne_livret_a');
    if (livretA) {
        total += parseFloat(livretA.value || 0);
    }
    
    // LDDS
    const ldds = document.getElementById('epargne_ldds');
    if (ldds) {
        total += parseFloat(ldds.value || 0);
    }
    
    // PEL/CEL
    const pelCel = document.getElementById('epargne_pel_cel');
    if (pelCel) {
        total += parseFloat(pelCel.value || 0);
    }
    
    // Liquidités personnalisées
    const liquiditesPersonnalisees = document.querySelectorAll('#epargneLiquiditesGrid input[name="liquidite_personnalisee_amount[]"]');
    liquiditesPersonnalisees.forEach(input => {
        const value = parseFloat(input.value || 0);
        total += value;
    });
    
    // Mettre à jour l'affichage
    const totalDisplay = document.getElementById('totalEpargneLiquidites');
    if (totalDisplay) {
        totalDisplay.textContent = `${total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')}€`;
    }
}

// Fonction pour ajouter un placement personnalisé dans la section EPARGNE
function addEpargnePlacementInline() {
    const grid = document.getElementById('epargnePlacementsGrid');
    const addButton = document.getElementById('epargnePlacementAddItem');
    
    const newItem = document.createElement('div');
    newItem.className = 'epargne-placement-item epargne-placement-custom';
    newItem.innerHTML = `
        <button type="button" class="epargne-placement-delete-btn" onclick="removeEpargnePlacementItem(this)">
            <i class="fas fa-trash"></i>
        </button>
        <div class="epargne-placement-content">
            <div class="financial-edit-item">
                <label class="financial-label">Type de placement</label>
                <input type="text" class="form-control" name="placement_personnalise_name[]" 
                       value="" placeholder="Ex: Crowdfunding">
            </div>
            <div class="financial-edit-item">
                <label class="financial-label">Montant</label>
                <div class="input-group">
                    <input type="number" class="form-control" name="placement_personnalise_amount[]" 
                           value="0" step="0.01" min="0">
                    <span class="input-group-text">€</span>
                </div>
            </div>
        </div>
    `;
    
    grid.insertBefore(newItem, addButton);
    
    // Ajouter l'événement pour le calcul du total
    newItem.querySelector('input[type="number"]').addEventListener('input', calculateTotalEpargnePlacements);
    
    // Focus sur le champ nom
    newItem.querySelector('input[type="text"]').focus();
}

// Fonction pour supprimer un placement personnalisé de la section EPARGNE
function removeEpargnePlacementItem(button) {
    button.closest('.epargne-placement-item').remove();
    calculateTotalEpargnePlacements();
}

// Fonction pour calculer le total des placements financiers de la section EPARGNE
function calculateTotalEpargnePlacements() {
    let total = 0;
    
    // PEA
    const pea = document.getElementById('epargne_pea');
    if (pea) {
        total += parseFloat(pea.value || 0);
    }
    
    // CTO
    const cto = document.getElementById('epargne_cto');
    if (cto) {
        total += parseFloat(cto.value || 0);
    }
    
    // Assurance-vie
    const av = document.getElementById('epargne_av');
    if (av) {
        total += parseFloat(av.value || 0);
    }
    
    // PER
    const per = document.getElementById('epargne_per');
    if (per) {
        total += parseFloat(per.value || 0);
    }
    
    // PEE
    const pee = document.getElementById('epargne_pee');
    if (pee) {
        total += parseFloat(pee.value || 0);
    }
    
    // Private Equity
    const pe = document.getElementById('epargne_pe');
    if (pe) {
        total += parseFloat(pe.value || 0);
    }
    
    // Parts de SCPI
    const scpi = document.getElementById('epargne_scpi');
    if (scpi) {
        total += parseFloat(scpi.value || 0);
    }
    
    // Placements personnalisés
    const placementsPersonnalises = document.querySelectorAll('#epargnePlacementsGrid input[name="placement_personnalise_amount[]"]');
    placementsPersonnalises.forEach(input => {
        const value = parseFloat(input.value || 0);
        total += value;
    });
    
    // Mettre à jour l'affichage
    const totalDisplay = document.getElementById('totalEpargnePlacements');
    if (totalDisplay) {
        totalDisplay.textContent = `${total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')}€`;
    }
}


// Fonction pour activer/désactiver un champ de patrimoine (fonction obsolète gardée pour compatibilité)
function togglePatrimoineField(fieldName) {
    const checkbox = document.getElementById(`admin_has_${fieldName}`);
    const input = document.getElementById(`${fieldName}_value`);
    
    if (checkbox && input) {
        if (checkbox.checked) {
            input.disabled = false;
            input.focus();
        } else {
            input.disabled = true;
            input.value = 0;
        }
    }
}


// Fonctions pour la section IMMOBILIER

// Fonction pour ajouter un bien immobilier
function addImmobilierInline() {
    const grid = document.getElementById('immobilierGrid');
    const addButton = document.getElementById('immobilierAddItem');
    
    const newItem = document.createElement('div');
    newItem.className = 'immobilier-item';
    newItem.innerHTML = `
        <button type="button" class="immobilier-delete-btn" onclick="removeImmobilierItem(this)">
            <i class="fas fa-trash"></i>
        </button>
        <div class="immobilier-content">
            <div class="immobilier-header">
                <div class="financial-edit-item">
                    <label class="financial-label">Type de bien</label>
                    <select class="form-control bien-type-select" name="bien_type[]">
                        <option value="">Choisir...</option>
                        <option value="residence_principale">Résidence principale</option>
                        <option value="residence_secondaire">Résidence secondaire</option>
                        <option value="investissement_locatif">Investissement locatif</option>
                    </select>
                </div>
                <div class="financial-edit-item description-field" style="display: none;">
                    <label class="financial-label">Description</label>
                    <input type="text" class="form-control" name="bien_description[]" 
                           value="" placeholder="Ex: Appartement, Maison...">
                </div>
            </div>
            
            <div class="immobilier-values">
                <div class="financial-edit-item">
                    <label class="financial-label">Valeur estimée</label>
                    <div class="input-group">
                        <input type="number" class="form-control bien-valeur-input" name="bien_valeur[]" 
                               value="0" step="1000" min="0">
                        <span class="input-group-text">€</span>
                    </div>
                </div>
                <div class="financial-edit-item">
                    <label class="financial-label">Surface (m²)</label>
                    <div class="input-group">
                        <input type="number" class="form-control bien-surface-input" name="bien_surface[]" 
                               value="0" step="1" min="0">
                        <span class="input-group-text">m²</span>
                    </div>
                </div>
                <div class="financial-edit-item">
                    <label class="financial-label">Prix au m²</label>
                    <div class="input-group">
                        <input type="text" class="form-control prix-m2-display" readonly>
                        <span class="input-group-text">€/m²</span>
                    </div>
                </div>
            </div>
            
            <div class="credit-section">
                <div class="credit-checkbox-container">
                    <input type="checkbox" class="credit-checkbox" name="bien_has_credit[]" value="1">
                    <label class="credit-label">J'ai un crédit immobilier lié à ce bien</label>
                </div>
                
                <div class="credit-details" style="display: none;">
                    <div class="credit-row">
                        <div class="financial-edit-item">
                            <label class="financial-label">Montant du crédit initial</label>
                            <div class="input-group">
                                <input type="number" class="form-control credit-montant-input" name="credit_montant[]" 
                                       value="0" step="1000" min="0">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="financial-edit-item">
                            <label class="financial-label">Durée (années)</label>
                            <div class="input-group">
                                <input type="number" class="form-control credit-duree-input" name="credit_duree[]" 
                                       value="0" step="1" min="0" max="50">
                                <span class="input-group-text">ans</span>
                            </div>
                        </div>
                    </div>
                    <div class="credit-row">
                        <div class="financial-edit-item">
                            <label class="financial-label">Taux TAG (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control credit-tag-input" name="credit_tag[]" 
                                       value="0" step="0.01" min="0" max="20">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="financial-edit-item">
                            <label class="financial-label">Taux TAEG (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control credit-taeg-input" name="credit_taeg[]" 
                                       value="0" step="0.01" min="0" max="20">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="credit-row">
                        <div class="financial-edit-item">
                            <label class="financial-label">Date de départ</label>
                            <input type="month" class="form-control credit-date-input" name="credit_date[]" value="">
                        </div>
                        <div class="financial-edit-item">
                            <label class="financial-label">Mensualités</label>
                            <div class="input-group">
                                <input type="text" class="form-control mensualites-display" readonly>
                                <span class="input-group-text">€/mois</span>
                            </div>
                        </div>
                    </div>
                    <div class="credit-row">
                        <div class="financial-edit-item">
                            <label class="financial-label">Capital restant dû</label>
                            <div class="input-group">
                                <input type="text" class="form-control capital-restant-display" readonly>
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="financial-edit-item">
                            <label class="financial-label">Total payé</label>
                            <div class="input-group">
                                <input type="text" class="form-control total-paye-display" readonly>
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="valeur-nette-section">
                <div class="valeur-nette-display">
                    <strong>Valeur nette du bien: <span class="valeur-nette-value">0€</span></strong>
                </div>
            </div>
        </div>
    `;
    
    grid.insertBefore(newItem, addButton);
    
    // Ajouter les événements
    setupImmobilierEventListeners(newItem);
    
    // Focus sur le select type
    newItem.querySelector('.bien-type-select').focus();
    
    // Calculer le total
    calculateTotalImmobilier();
}

// Fonction pour supprimer un bien immobilier
function removeImmobilierItem(button) {
    button.closest('.immobilier-item').remove();
    calculateTotalImmobilier();
}

// Fonction pour calculer le prix au m²
function calculatePrixM2(item) {
    const valeurInput = item.querySelector('.bien-valeur-input');
    const surfaceInput = item.querySelector('.bien-surface-input');
    const prixM2Display = item.querySelector('.prix-m2-display');
    
    const valeur = parseFloat(valeurInput.value || 0);
    const surface = parseFloat(surfaceInput.value || 0);
    
    if (surface > 0) {
        const prixM2 = valeur / surface;
        prixM2Display.value = prixM2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    } else {
        prixM2Display.value = '0';
    }
}

// Fonction pour calculer les mensualités et le capital restant dû
function calculateCapitalRestant(item) {
    const montantInput = item.querySelector('.credit-montant-input');
    const taegInput = item.querySelector('.credit-taeg-input');
    const dureeInput = item.querySelector('.credit-duree-input');
    const dateInput = item.querySelector('.credit-date-input');
    const mensualitesDisplay = item.querySelector('.mensualites-display');
    const capitalDisplay = item.querySelector('.capital-restant-display');
    const totalPayeDisplay = item.querySelector('.total-paye-display');
    
    const montantCredit = parseFloat(montantInput.value || 0);
    const taeg = parseFloat(taegInput.value || 0) / 100 / 12; // Taux mensuel TAEG
    const dureeAnnees = parseFloat(dureeInput.value || 0);
    const dureeMois = dureeAnnees * 12;
    const dateCredit = new Date(dateInput.value + '-01');
    
    if (montantCredit > 0 && taeg > 0 && dureeAnnees > 0 && dateInput.value) {
        // Calcul des mensualités avec le TAEG
        const mensualite = montantCredit * (taeg * Math.pow(1 + taeg, dureeMois)) / (Math.pow(1 + taeg, dureeMois) - 1);
        mensualitesDisplay.value = mensualite.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        
        // Nombre de mois écoulés depuis le début du crédit
        const dateActuelle = new Date();
        const moisEcoules = (dateActuelle.getFullYear() - dateCredit.getFullYear()) * 12 + 
                           (dateActuelle.getMonth() - dateCredit.getMonth());
        
        if (moisEcoules >= 0 && moisEcoules < dureeMois) {
            // Capital remboursé = somme des amortissements
            let capitalRembourse = 0;
            let capitalRestant = montantCredit;
            
            for (let i = 0; i < moisEcoules; i++) {
                const interets = capitalRestant * taeg;
                const amortissement = mensualite - interets;
                capitalRembourse += amortissement;
                capitalRestant -= amortissement;
            }
            
            capitalDisplay.value = Math.max(0, capitalRestant).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            totalPayeDisplay.value = (moisEcoules * mensualite).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        } else if (moisEcoules >= dureeMois) {
            capitalDisplay.value = '0';
            totalPayeDisplay.value = (dureeMois * mensualite).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        } else {
            capitalDisplay.value = montantCredit.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            totalPayeDisplay.value = '0';
        }
    } else {
        mensualitesDisplay.value = '0';
        capitalDisplay.value = '0';
        totalPayeDisplay.value = '0';
    }
}

// Fonction pour calculer la valeur nette d'un bien
function calculateValeurNette(item) {
    const valeurInput = item.querySelector('.bien-valeur-input');
    const creditCheckbox = item.querySelector('.credit-checkbox');
    const capitalDisplay = item.querySelector('.capital-restant-display');
    const valeurNetteValue = item.querySelector('.valeur-nette-value');
    
    const valeurBien = parseFloat(valeurInput.value || 0);
    let capitalRestant = 0;
    
    if (creditCheckbox.checked) {
        const capitalText = capitalDisplay.value.replace(/\s/g, '');
        capitalRestant = parseFloat(capitalText || 0);
    }
    
    const valeurNette = valeurBien - capitalRestant;
    valeurNetteValue.textContent = Math.max(0, valeurNette).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + '€';
}

// Fonction pour calculer le total immobilier
function calculateTotalImmobilier() {
    let total = 0;
    
    document.querySelectorAll('.immobilier-item').forEach(item => {
        const valeurNetteText = item.querySelector('.valeur-nette-value').textContent;
        const valeur = parseFloat(valeurNetteText.replace(/[€\s]/g, '') || 0);
        total += valeur;
    });
    
    const totalDisplay = document.getElementById('totalImmobilier');
    if (totalDisplay) {
        totalDisplay.textContent = total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + '€';
    }
}

// Fonction pour configurer les événements sur un élément immobilier
function setupImmobilierEventListeners(item) {
    const bienTypeSelect = item.querySelector('.bien-type-select');
    const descriptionField = item.querySelector('.description-field');
    const valeurInput = item.querySelector('.bien-valeur-input');
    const surfaceInput = item.querySelector('.bien-surface-input');
    const creditCheckbox = item.querySelector('.credit-checkbox');
    const creditDetails = item.querySelector('.credit-details');
    const creditInputs = item.querySelectorAll('.credit-montant-input, .credit-taeg-input, .credit-duree-input, .credit-date-input');
    
    // Afficher/masquer la description pour investissement locatif
    bienTypeSelect.addEventListener('change', function() {
        if (this.value === 'investissement_locatif') {
            descriptionField.style.display = 'block';
        } else {
            descriptionField.style.display = 'none';
            descriptionField.querySelector('input').value = '';
        }
    });
    
    // Calcul du prix au m² et valeur nette
    [valeurInput, surfaceInput].forEach(input => {
        input.addEventListener('input', function() {
            calculatePrixM2(item);
            calculateCapitalRestant(item);
            calculateValeurNette(item);
            calculateTotalImmobilier();
        });
    });
    
    // Afficher/masquer les détails du crédit
    creditCheckbox.addEventListener('change', function() {
        if (this.checked) {
            creditDetails.style.display = 'block';
        } else {
            creditDetails.style.display = 'none';
            // Reset des valeurs de crédit
            creditInputs.forEach(input => input.value = '');
            item.querySelector('.capital-restant-display').value = '0';
        }
        calculateValeurNette(item);
        calculateTotalImmobilier();
    });
    
    // Calcul du capital restant
    creditInputs.forEach(input => {
        input.addEventListener('input', function() {
            calculateCapitalRestant(item);
            calculateValeurNette(item);
            calculateTotalImmobilier();
        });
    });
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Calculer les totaux de la section EPARGNE
    calculateTotalEpargneLiquidites();
    calculateTotalEpargnePlacements();
    
    // Calculer le taux d'épargne initial
    calculateTauxEpargne();
    
    // Ajouter événement pour la situation professionnelle
    const professionalSituationSelect = document.getElementById('professionalSituation');
    if (professionalSituationSelect) {
        professionalSituationSelect.addEventListener('change', toggleProfessionalSituationOther);
        // Vérifier l'état initial
        toggleProfessionalSituationOther();
    }
    
    // Ajouter événements pour le calcul du taux d'épargne
    const revenusInputs = ['monthlyNetIncome', 'impotsMensuels', 'monthlySavingsCapacity'];
    revenusInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', calculateTauxEpargne);
        }
    });
    
    // Ajouter événements sur les revenus complémentaires existants
    document.querySelectorAll('.revenu-complementaire-input[type="number"]').forEach(input => {
        input.addEventListener('input', calculateTauxEpargne);
    });
    
    // Ajouter événements sur les charges mensuelles existantes
    document.querySelectorAll('.charge-mensuelle-input[type="number"]').forEach(input => {
        input.addEventListener('input', calculateTauxEpargne);
    });
    
    // Calculer le total des liquidités EPARGNE initial
    calculateTotalEpargneLiquidites();
    
    // Ajouter événements pour le calcul du total EPARGNE liquidités
    const epargneLiquiditesInputs = ['epargne_livret_a', 'epargne_ldds', 'epargne_pel_cel'];
    epargneLiquiditesInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', calculateTotalEpargneLiquidites);
        }
    });
    
    // Ajouter événements sur les liquidités personnalisées existantes (section EPARGNE)
    document.querySelectorAll('#epargneLiquiditesGrid input[name="liquidite_personnalisee_amount[]"]').forEach(input => {
        input.addEventListener('input', calculateTotalEpargneLiquidites);
    });
    
    // Calculer le total des placements EPARGNE initial
    calculateTotalEpargnePlacements();
    
    // Ajouter événements pour le calcul du total EPARGNE placements
    const epargnePlacementsInputs = ['epargne_pea', 'epargne_cto', 'epargne_av', 'epargne_per', 'epargne_pee', 'epargne_pe', 'epargne_scpi'];
    epargnePlacementsInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', calculateTotalEpargnePlacements);
        }
    });
    
    // Ajouter événements sur les placements personnalisés existants (section EPARGNE)
    document.querySelectorAll('#epargnePlacementsGrid input[name="placement_personnalise_amount[]"]').forEach(input => {
        input.addEventListener('input', calculateTotalEpargnePlacements);
    });
    
    // Initialiser la section immobilier
    calculateTotalImmobilier();
    
    // Configurer les événements pour les biens immobiliers existants
    document.querySelectorAll('.immobilier-item').forEach(item => {
        setupImmobilierEventListeners(item);
        // Calculer les valeurs initiales
        calculatePrixM2(item);
        calculateCapitalRestant(item);
        calculateValeurNette(item);
    });
    
    // Ajouter des événements sur tous les champs de montant de la section EPARGNE
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('change', function() {
            // Liquidités EPARGNE
            if (this.id && (this.id.startsWith('epargne_') && 
                (this.id.includes('livret_a') || this.id.includes('ldds') || this.id.includes('pel_cel')))) {
                calculateTotalEpargneLiquidites();
            }
            // Placements EPARGNE
            if (this.id && (this.id.startsWith('epargne_') && 
                (this.id.includes('pea') || this.id.includes('cto') || this.id.includes('av') || 
                 this.id.includes('per') || this.id.includes('pee') || this.id.includes('pe') || this.id.includes('scpi')))) {
                calculateTotalEpargnePlacements();
            }
            // Liquidités et placements personnalisés EPARGNE
            if (this.name && this.name.includes('liquidite_personnalisee_amount')) {
                calculateTotalEpargneLiquidites();
            }
            if (this.name && this.name.includes('placement_personnalise_amount')) {
                calculateTotalEpargnePlacements();
            }
        });
    });
    
    // Gestion de la soumission du formulaire
    const form = document.getElementById('adminEditFormExtended');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Formulaire soumis - à implémenter');
            alert('Sauvegarde à implémenter');
        });
    }
});
</script>
{% endblock %}