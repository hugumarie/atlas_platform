{% extends "platform/base.html" %}

{% block title %}Inscription - Atlas{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow border-0">
                    <div class="card-header bg-primary text-white text-center py-4">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <img src="{{ url_for('static', filename='images/logo-atlas.png') }}" alt="Atlas" height="50" class="me-2" style="filter: brightness(0) invert(1);">
                        </div>
                        <h3 class="mb-0">
                            <i class="fas fa-user-plus me-2"></i>Créer votre compte
                        </h3>
                        <p class="mb-0 mt-2">Commencez votre parcours d'investissement aujourd'hui</p>
                    </div>
                    
                    <div class="card-body p-4">
                        <form method="POST" class="needs-validation" novalidate id="registrationForm">
                            <!-- Informations personnelles -->
                            <div class="mb-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>Informations personnelles
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="first_name" class="form-label">Prénom *</label>
                                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                                            <div class="invalid-feedback">Veuillez saisir votre prénom.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="last_name" class="form-label">Nom *</label>
                                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                                            <div class="invalid-feedback">Veuillez saisir votre nom.</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="email" name="email" required>
                                            <div class="invalid-feedback">Veuillez saisir un email valide.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="phone" class="form-label">Téléphone</label>
                                            <input type="tel" class="form-control" id="phone" name="phone">
                                            <div class="form-text">Pour vos appels mensuels</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mot de passe -->
                            <div class="mb-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-lock me-2"></i>Sécurité du compte
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="password" class="form-label">Mot de passe *</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="password" name="password" required>
                                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                <small id="passwordHelp">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Minimum 8 caractères, 1 majuscule, 1 chiffre, 1 caractère spécial
                                                </small>
                                            </div>
                                            <div class="invalid-feedback">Le mot de passe ne respecte pas les critères de sécurité.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="password_confirm" class="form-label">Confirmer le mot de passe *</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="password_confirm" name="password_confirm" required>
                                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordConfirm">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="invalid-feedback">Les mots de passe ne correspondent pas.</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Indicateur de force du mot de passe -->
                                <div class="password-strength mb-3" style="display: none;">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="strengthText"></small>
                                </div>
                            </div>

                            <!-- Informations de paiement -->
                            <div class="mb-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-credit-card me-2"></i>Informations de paiement
                                </h5>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>20€/mois</strong> - Votre carte sera débitée aujourd'hui puis chaque mois automatiquement.
                                    Résiliation possible à tout moment.
                                </div>
                                
                                <div class="mb-3">
                                    <label for="card_name" class="form-label">Nom sur la carte *</label>
                                    <input type="text" class="form-control" id="card_name" name="card_name" required>
                                    <div class="invalid-feedback">Veuillez saisir le nom inscrit sur votre carte.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="card_number" class="form-label">Numéro de carte *</label>
                                    <input type="text" class="form-control" id="card_number" name="card_number" 
                                           placeholder="1234 5678 9012 3456" maxlength="19" required>
                                    <div class="invalid-feedback">Veuillez saisir un numéro de carte valide.</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="card_expiry" class="form-label">Date d'expiration *</label>
                                            <input type="text" class="form-control" id="card_expiry" name="card_expiry" 
                                                   placeholder="MM/YY" maxlength="5" required>
                                            <div class="invalid-feedback">Format requis : MM/YY</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="card_cvv" class="form-label">CVV *</label>
                                            <input type="text" class="form-control" id="card_cvv" name="card_cvv" 
                                                   placeholder="123" maxlength="4" required>
                                            <div class="invalid-feedback">Code de sécurité requis.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conditions -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="terms" required>
                                    <label class="form-check-label" for="terms">
                                        J'accepte les <a href="#" class="text-primary">conditions d'utilisation</a> 
                                        et la <a href="#" class="text-primary">politique de confidentialité</a> *
                                    </label>
                                    <div class="invalid-feedback">Vous devez accepter les conditions d'utilisation.</div>
                                </div>
                                
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="marketing">
                                    <label class="form-check-label" for="marketing">
                                        J'accepte de recevoir des emails marketing et conseils financiers
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Bouton de soumission -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="fas fa-lock me-2"></i>Créer mon compte et payer 20€
                                </button>
                            </div>
                        </form>
                        
                        <div class="text-center mt-4">
                            <p class="mb-2">Déjà un compte ? 
                                <a href="{{ url_for('platform_auth.login') }}" class="text-primary">Se connecter</a>
                            </p>
                            
                            <div class="d-flex justify-content-center gap-4 text-muted small">
                                <div><i class="fas fa-shield-alt me-1"></i>Paiement sécurisé</div>
                                <div><i class="fas fa-lock me-1"></i>Données cryptées</div>
                                <div><i class="fas fa-undo me-1"></i>Résiliation libre</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const passwordField = document.getElementById('password');
    const passwordConfirmField = document.getElementById('password_confirm');
    const cardNumberField = document.getElementById('card_number');
    const cardExpiryField = document.getElementById('card_expiry');
    const cardCvvField = document.getElementById('card_cvv');

    // Fonction de basculement de visibilité du mot de passe
    function setupPasswordToggle(fieldId, buttonId) {
        const field = document.getElementById(fieldId);
        const button = document.getElementById(buttonId);
        
        button.addEventListener('click', function() {
            const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
            field.setAttribute('type', type);
            
            const icon = button.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        });
    }

    setupPasswordToggle('password', 'togglePassword');
    setupPasswordToggle('password_confirm', 'togglePasswordConfirm');

    // Validation du mot de passe
    function validatePassword(password) {
        const criteria = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        const score = Object.values(criteria).reduce((acc, val) => acc + (val ? 1 : 0), 0);
        return { criteria, score };
    }

    // Indicateur de force du mot de passe
    passwordField.addEventListener('input', function() {
        const password = this.value;
        const strengthContainer = document.querySelector('.password-strength');
        const progressBar = strengthContainer.querySelector('.progress-bar');
        const strengthText = document.getElementById('strengthText');
        
        if (password.length > 0) {
            strengthContainer.style.display = 'block';
            const { criteria, score } = validatePassword(password);
            
            const percentage = (score / 4) * 100;
            progressBar.style.width = percentage + '%';
            
            // Couleur et texte selon la force
            if (score <= 1) {
                progressBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'Très faible';
            } else if (score === 2) {
                progressBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'Faible';
            } else if (score === 3) {
                progressBar.className = 'progress-bar bg-info';
                strengthText.textContent = 'Moyen';
            } else {
                progressBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'Fort';
            }
        } else {
            strengthContainer.style.display = 'none';
        }
    });

    // Formatage du numéro de carte
    cardNumberField.addEventListener('input', function() {
        let value = this.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        if (formattedValue !== this.value) {
            this.value = formattedValue;
        }
    });

    // Formatage de la date d'expiration
    cardExpiryField.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        this.value = value;
    });

    // Limitation du CVV aux chiffres
    cardCvvField.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
    });

    // Validation du formulaire
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        event.stopPropagation();

        let isValid = true;

        // Validation du mot de passe
        const password = passwordField.value;
        const { criteria } = validatePassword(password);
        
        if (!Object.values(criteria).every(Boolean)) {
            passwordField.setCustomValidity('Le mot de passe ne respecte pas tous les critères de sécurité.');
            isValid = false;
        } else {
            passwordField.setCustomValidity('');
        }

        // Validation de la confirmation du mot de passe
        if (password !== passwordConfirmField.value) {
            passwordConfirmField.setCustomValidity('Les mots de passe ne correspondent pas.');
            isValid = false;
        } else {
            passwordConfirmField.setCustomValidity('');
        }

        // Validation du numéro de carte
        const cardNumber = cardNumberField.value.replace(/\s/g, '');
        if (!/^[0-9]{15,16}$/.test(cardNumber)) {
            cardNumberField.setCustomValidity('Numéro de carte invalide.');
            isValid = false;
        } else {
            cardNumberField.setCustomValidity('');
        }

        // Validation de la date d'expiration
        const expiry = cardExpiryField.value;
        if (!/^(0[1-9]|1[0-2])\/[0-9]{2}$/.test(expiry)) {
            cardExpiryField.setCustomValidity('Format de date invalide (MM/YY).');
            isValid = false;
        } else {
            cardExpiryField.setCustomValidity('');
        }

        // Validation du CVV
        const cvv = cardCvvField.value;
        if (!/^[0-9]{3,4}$/.test(cvv)) {
            cardCvvField.setCustomValidity('CVV invalide (3 ou 4 chiffres).');
            isValid = false;
        } else {
            cardCvvField.setCustomValidity('');
        }

        form.classList.add('was-validated');

        if (isValid && form.checkValidity()) {
            // Simulation du traitement de paiement
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Traitement du paiement...';
            
            // Simulation d'un délai de traitement
            setTimeout(() => {
                form.submit();
            }, 2000);
        }
    });
});
</script>
{% endblock %}