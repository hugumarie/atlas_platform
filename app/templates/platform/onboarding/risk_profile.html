{% extends "platform/onboarding/base.html" %}

{% block title %}Profil de Risque - Étape 4/5{% endblock %}

{% block onboarding_content %}
<div class="onboarding-step" data-step="4">
    <div class="onboarding-header">
        <div class="onboarding-progress">
            <div class="onboarding-progress-bar" style="width: 80%;"></div>
        </div>
        <div class="onboarding-step-indicator">Étape 4 sur 5</div>
    </div>

    <div class="onboarding-content">
        <div class="onboarding-welcome">
            <h1>Votre profil de risque</h1>
            <p class="onboarding-subtitle">
                Quelques questions pour mieux comprendre votre relation au risque financier.
            </p>
        </div>

        <form class="onboarding-form" id="riskForm">
            <!-- Question 1 -->
            <div class="onboarding-form-group">
                <label class="onboarding-label">
                    Comment réagiriez-vous si votre portefeuille perdait 20% de sa valeur en un mois ?
                </label>
                <div class="onboarding-choices">
                    <div class="onboarding-choice">
                        <input type="radio" id="risk1_1" name="risk_reaction" value="panic" class="onboarding-choice-input">
                        <label for="risk1_1" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="onboarding-choice-title">Je vendrais tout</div>
                            <div class="onboarding-choice-description">Je ne supporterais pas cette baisse</div>
                        </label>
                    </div>

                    <div class="onboarding-choice">
                        <input type="radio" id="risk1_2" name="risk_reaction" value="concerned" class="onboarding-choice-input">
                        <label for="risk1_2" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="onboarding-choice-title">J'attendrais</div>
                            <div class="onboarding-choice-description">En espérant une remontée rapide</div>
                        </label>
                    </div>

                    <div class="onboarding-choice">
                        <input type="radio" id="risk1_3" name="risk_reaction" value="opportunity" class="onboarding-choice-input">
                        <label for="risk1_3" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="onboarding-choice-title">J'achèterais plus</div>
                            <div class="onboarding-choice-description">C'est une opportunité d'investir</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 2 -->
            <div class="onboarding-form-group">
                <label class="onboarding-label">
                    Quelle est votre expérience des marchés financiers ?
                </label>
                <div class="onboarding-choices">
                    <div class="onboarding-choice">
                        <input type="radio" id="exp_1" name="experience" value="novice" class="onboarding-choice-input">
                        <label for="exp_1" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <div class="onboarding-choice-title">Débutant</div>
                            <div class="onboarding-choice-description">Peu ou pas d'expérience</div>
                        </label>
                    </div>

                    <div class="onboarding-choice">
                        <input type="radio" id="exp_2" name="experience" value="intermediate" class="onboarding-choice-input">
                        <label for="exp_2" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="onboarding-choice-title">Intermédiaire</div>
                            <div class="onboarding-choice-description">Quelques années d'expérience</div>
                        </label>
                    </div>

                    <div class="onboarding-choice">
                        <input type="radio" id="exp_3" name="experience" value="expert" class="onboarding-choice-input">
                        <label for="exp_3" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="onboarding-choice-title">Expérimenté</div>
                            <div class="onboarding-choice-description">Plus de 5 ans d'expérience</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="onboarding-form-group">
                <label class="onboarding-label">
                    Quelle part de votre épargne êtes-vous prêt(e) à investir sur les marchés ?
                </label>
                <select class="onboarding-select" id="investment_part" name="investment_part" required>
                    <option value="">Sélectionnez un pourcentage</option>
                    <option value="0-10">Moins de 10%</option>
                    <option value="10-30">10% à 30%</option>
                    <option value="30-50">30% à 50%</option>
                    <option value="50-70">50% à 70%</option>
                    <option value="70-90">70% à 90%</option>
                    <option value="90-100">Plus de 90%</option>
                </select>
            </div>

            <!-- Question 4 -->
            <div class="onboarding-form-group">
                <label class="onboarding-label">
                    Qu'est-ce qui vous préoccupe le plus dans vos investissements ?
                </label>
                <div class="onboarding-choices">
                    <div class="onboarding-choice">
                        <input type="radio" id="concern_1" name="main_concern" value="capital_loss" class="onboarding-choice-input">
                        <label for="concern_1" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="onboarding-choice-title">Préserver mon capital</div>
                            <div class="onboarding-choice-description">Éviter les pertes avant tout</div>
                        </label>
                    </div>

                    <div class="onboarding-choice">
                        <input type="radio" id="concern_2" name="main_concern" value="inflation" class="onboarding-choice-input">
                        <label for="concern_2" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-trending-down"></i>
                            </div>
                            <div class="onboarding-choice-title">Lutter contre l'inflation</div>
                            <div class="onboarding-choice-description">Maintenir le pouvoir d'achat</div>
                        </label>
                    </div>

                    <div class="onboarding-choice">
                        <input type="radio" id="concern_3" name="main_concern" value="growth" class="onboarding-choice-input">
                        <label for="concern_3" class="onboarding-choice-label">
                            <div class="onboarding-choice-icon">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <div class="onboarding-choice-title">Maximiser les gains</div>
                            <div class="onboarding-choice-description">Rechercher la performance</div>
                        </label>
                    </div>
                </div>
            </div>
        </form>

        <!-- Résultat du profil de risque -->
        <div id="riskResult" class="onboarding-risk-result" style="display: none;">
            <div class="onboarding-risk-badge">
                <div class="onboarding-risk-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="onboarding-risk-content">
                    <h3 id="riskTitle">Votre profil</h3>
                    <p id="riskDescription">Description du profil</p>
                </div>
            </div>
        </div>
    </div>

    <div class="onboarding-actions">
        <a href="{{ url_for('platform_onboarding.objectives') }}" class="onboarding-btn-back">
            <i class="fas fa-arrow-left"></i>
            <span>Retour</span>
        </a>
        
        <button type="button" class="onboarding-btn-next" id="nextBtn" disabled>
            <span>Continuer</span>
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<style>
.onboarding-risk-result {
    margin-top: 32px;
    padding: 24px;
    background: var(--qlower-bg-light);
    border-radius: 16px;
    border: 2px solid var(--qlower-primary);
}

.onboarding-risk-badge {
    display: flex;
    align-items: center;
    gap: 16px;
}

.onboarding-risk-icon {
    width: 48px;
    height: 48px;
    background: var(--onboarding-gradient);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}

.onboarding-risk-content h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--qlower-dark);
    margin-bottom: 4px;
}

.onboarding-risk-content p {
    font-size: 15px;
    color: var(--qlower-text-light);
    line-height: 1.5;
    margin: 0;
}
</style>
{% endblock %}

{% block onboarding_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const step = document.querySelector('.onboarding-step');
    step.classList.add('animate-in');
    
    const form = document.getElementById('riskForm');
    const nextBtn = document.getElementById('nextBtn');
    const riskResult = document.getElementById('riskResult');
    const riskTitle = document.getElementById('riskTitle');
    const riskDescription = document.getElementById('riskDescription');
    
    const requiredFields = [
        'risk_reaction',
        'experience', 
        'investment_part',
        'main_concern'
    ];
    
    // Profils de risque
    const riskProfiles = {
        conservative: {
            title: "Profil Prudent",
            description: "Vous privilégiez la sécurité et la préservation de votre capital. Nous vous recommanderons des placements peu risqués."
        },
        moderate: {
            title: "Profil Équilibré", 
            description: "Vous acceptez un risque modéré pour obtenir un meilleur rendement. Un mix équilibré entre sécurité et performance."
        },
        dynamic: {
            title: "Profil Dynamique",
            description: "Vous acceptez une volatilité plus importante pour maximiser le potentiel de rendement de vos investissements."
        }
    };
    
    // Animation des choix
    setTimeout(() => {
        const choices = document.querySelectorAll('.onboarding-choice');
        choices.forEach((choice, index) => {
            setTimeout(() => {
                choice.style.opacity = '1';
                choice.style.transform = 'translateY(0)';
            }, index * 50);
        });
    }, 300);
    
    // Validation du formulaire
    function validateForm() {
        const formData = new FormData(form);
        let allFilled = true;
        
        requiredFields.forEach(field => {
            if (!formData.get(field)) {
                allFilled = false;
            }
        });
        
        if (allFilled) {
            calculateRiskProfile(formData);
            riskResult.style.display = 'block';
            nextBtn.disabled = false;
        } else {
            riskResult.style.display = 'none';
            nextBtn.disabled = true;
        }
    }
    
    // Calcul du profil de risque
    function calculateRiskProfile(formData) {
        let score = 0;
        
        // Question 1 - Réaction au risque
        const reaction = formData.get('risk_reaction');
        if (reaction === 'panic') score += 1;
        else if (reaction === 'concerned') score += 2;
        else if (reaction === 'opportunity') score += 3;
        
        // Question 2 - Expérience
        const experience = formData.get('experience');
        if (experience === 'novice') score += 1;
        else if (experience === 'intermediate') score += 2;
        else if (experience === 'expert') score += 3;
        
        // Question 3 - Part d'investissement
        const investmentPart = formData.get('investment_part');
        if (investmentPart === '0-10') score += 1;
        else if (investmentPart === '10-30') score += 1;
        else if (investmentPart === '30-50') score += 2;
        else if (investmentPart === '50-70') score += 2;
        else if (investmentPart === '70-90') score += 3;
        else if (investmentPart === '90-100') score += 3;
        
        // Question 4 - Préoccupation principale
        const concern = formData.get('main_concern');
        if (concern === 'capital_loss') score += 1;
        else if (concern === 'inflation') score += 2;
        else if (concern === 'growth') score += 3;
        
        // Déterminer le profil
        let profile;
        if (score <= 6) profile = 'conservative';
        else if (score <= 9) profile = 'moderate';
        else profile = 'dynamic';
        
        // Afficher le résultat
        riskTitle.textContent = riskProfiles[profile].title;
        riskDescription.textContent = riskProfiles[profile].description;
        
        // Stocker le profil pour l'étape suivante
        sessionStorage.setItem('riskProfile', profile);
    }
    
    // Écouter les changements
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', validateForm);
    });
    
    // Action du bouton suivant
    nextBtn.addEventListener('click', function() {
        if (!nextBtn.disabled) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            console.log('Risk profile data:', data);
            
            // Rediriger vers l'étape suivante
            window.location.href = "{{ url_for('platform_onboarding.summary') }}";
        }
    });
});
</script>
{% endblock %}