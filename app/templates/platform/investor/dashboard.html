{% extends "platform/base.html" %}

{% block title %}Tableau de bord - Atlas{% endblock %}

{% block page_title %}Tableau de bord{% endblock %}

{% block content %}
<!-- Première ligne - 3 boîtes statistiques -->
<div class="platform-grid platform-grid-3 mb-4">
    <div class="platform-card">
        <div class="platform-card-body">
            <div class="platform-stat">
                <div class="platform-stat-value" id="currentPatrimony">
                    {% if current_user.investor_profile %}
                        {{ "{:,.0f}".format(current_user.investor_profile.current_savings) }}€
                    {% else %}
                        45 250€
                    {% endif %}
                </div>
                <div class="platform-stat-label">Patrimoine actuel</div>
            </div>
        </div>
    </div>
    
    <div class="platform-card">
        <div class="platform-card-body">
            <div class="platform-stat">
                <div class="platform-stat-value" id="monthlySavingsGoal">
                    {% if current_user.investor_profile %}
                        {{ "{:,.0f}".format(current_user.investor_profile.monthly_savings_capacity) }}€
                    {% else %}
                        850€
                    {% endif %}
                </div>
                <div class="platform-stat-label">Objectif d'épargne mensuel</div>
            </div>
        </div>
    </div>
    
    <div class="platform-card">
        <div class="platform-card-body">
            <div class="platform-stat">
                <div class="platform-stat-value" id="monthlyIncome">
                    {% if current_user.investor_profile %}
                        {{ "{:,.0f}".format(current_user.investor_profile.monthly_net_income) }}€
                    {% else %}
                        3 200€
                    {% endif %}
                </div>
                <div class="platform-stat-label">Revenu mensuel</div>
            </div>
        </div>
    </div>
</div>

<!-- Barre de progression épargne annuelle -->
<div class="platform-card mb-4">
    <div class="platform-card-header">
        <h3 class="platform-card-title">
            <i class="fas fa-calendar-alt text-primary"></i>
            Objectif d'épargne annuelle
        </h3>
        <p class="platform-card-subtitle">Progression depuis votre inscription</p>
    </div>
    <div class="platform-card-body">
        <div class="savings-progress-container">
            <div class="savings-progress-info">
                <div class="savings-current">
                    <span class="savings-amount" id="currentYearlySavings">0€</span>
                    <span class="savings-label">Épargné cette année</span>
                </div>
                <div class="savings-target">
                    <span class="savings-amount" id="targetYearlySavings">10 200€</span>
                    <span class="savings-label">Objectif annuel</span>
                </div>
            </div>
            <div class="savings-progress-bar">
                <div class="savings-progress-track">
                    <div class="savings-progress-fill" id="savingsProgressFill"></div>
                </div>
                <div class="savings-progress-percentage" id="savingsProgressPercentage">0%</div>
            </div>
            <div class="savings-progress-months">
                <span>Jan</span>
                <span>Fév</span>
                <span>Mar</span>
                <span>Avr</span>
                <span>Mai</span>
                <span>Jun</span>
                <span>Jul</span>
                <span>Aoû</span>
                <span>Sep</span>
                <span>Oct</span>
                <span>Nov</span>
                <span>Déc</span>
            </div>
        </div>
    </div>
</div>

<!-- Camembert répartition des actifs -->
<div class="platform-card">
    <div class="platform-card-header">
        <h3 class="platform-card-title">
            <i class="fas fa-chart-pie text-primary"></i>
            Répartition de vos actifs
        </h3>
        <p class="platform-card-subtitle">Diversification de votre portefeuille</p>
    </div>
    <div class="platform-card-body">
        <div class="portfolio-chart-container">
            <div class="portfolio-chart">
                <canvas id="portfolioChart"></canvas>
            </div>
            <div class="portfolio-legend" id="portfolioLegend">
                <!-- Légende générée dynamiquement -->
            </div>
        </div>
    </div>
</div>

<style>
/* Styles pour la barre de progression d'épargne */
.savings-progress-container {
    padding: 20px 0;
}

.savings-progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.savings-current, .savings-target {
    text-align: center;
}

.savings-amount {
    display: block;
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 28px;
    font-weight: 800;
    color: var(--qlower-primary);
    line-height: 1;
}

.savings-target .savings-amount {
    color: var(--qlower-text-dark);
}

.savings-label {
    display: block;
    font-size: 14px;
    color: var(--qlower-text-light);
    font-weight: 500;
    margin-top: 4px;
}

.savings-progress-bar {
    position: relative;
    margin-bottom: 16px;
}

.savings-progress-track {
    width: 100%;
    height: 12px;
    background: var(--qlower-bg-light);
    border-radius: 6px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.savings-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    border-radius: 6px;
    width: 0%;
    transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.savings-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.savings-progress-percentage {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--qlower-white);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.savings-progress-months {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--qlower-text-light);
    margin-top: 8px;
}

/* Styles pour le camembert */
.portfolio-chart-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    align-items: center;
}

.portfolio-chart {
    position: relative;
    height: 300px;
}

.portfolio-legend {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--qlower-bg-light);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.legend-item:hover {
    background: var(--qlower-white);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.legend-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    flex-shrink: 0;
}

.legend-label {
    font-weight: 500;
    color: var(--qlower-text-dark);
    font-size: 14px;
}

.legend-values {
    text-align: right;
}

.legend-amount {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 14px;
}

.legend-percentage {
    font-size: 12px;
    color: var(--qlower-text-light);
}

@media (max-width: 768px) {
    .portfolio-chart-container {
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    .savings-progress-info {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .savings-progress-months {
        font-size: 10px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des statistiques au chargement
    animateStatsCards();
    
    // Animation de la barre de progression
    animateSavingsProgress();
    
    // Créer le camembert
    createPortfolioChart();
});

function animateStatsCards() {
    const statValues = document.querySelectorAll('.platform-stat-value');
    statValues.forEach((stat, index) => {
        setTimeout(() => {
            stat.style.opacity = '1';
            stat.style.transform = 'scale(1)';
        }, index * 150);
        
        stat.style.opacity = '0';
        stat.style.transform = 'scale(0.8)';
        stat.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    });
}

function animateSavingsProgress() {
    // Données simulées basées sur l'utilisateur
    const monthlyGoal = {% if current_user.investor_profile %}{{ current_user.investor_profile.monthly_savings_capacity }}{% else %}850{% endif %};
    const annualGoal = monthlyGoal * 12;
    
    // Calculer le nombre de mois depuis l'inscription (simulation: janvier à octobre = 9 mois)
    const registrationDate = new Date('{{ current_user.date_created.strftime("%Y-%m-%d") if current_user.date_created else "2024-01-01" }}');
    const now = new Date();
    
    // Pour la simulation, on considère que l'utilisateur épargne depuis janvier jusqu'à octobre de cette année
    // Janvier = mois 0, octobre = mois 9, donc 10 mois écoulés mais on simule 9 mois d'épargne effective
    const monthsSinceRegistration = 9; // Simulation: janvier à septembre inclus = 9 mois
    
    const currentSavings = monthlyGoal * monthsSinceRegistration;
    const progressPercentage = (currentSavings / annualGoal) * 100;
    
    // Mettre à jour les valeurs
    document.getElementById('targetYearlySavings').textContent = annualGoal.toLocaleString() + '€';
    
    // Animation de la barre et du montant
    let currentAmount = 0;
    const duration = 2000; // 2 secondes
    const steps = 60;
    const amountStep = currentSavings / steps;
    const progressStep = progressPercentage / steps;
    
    const progressBar = document.getElementById('savingsProgressFill');
    const progressText = document.getElementById('savingsProgressPercentage');
    const currentAmountElement = document.getElementById('currentYearlySavings');
    
    let step = 0;
    const interval = setInterval(() => {
        step++;
        currentAmount += amountStep;
        
        // Mettre à jour la barre
        progressBar.style.width = (progressStep * step) + '%';
        
        // Mettre à jour le texte
        progressText.textContent = Math.round(progressStep * step) + '%';
        currentAmountElement.textContent = Math.round(currentAmount).toLocaleString() + '€';
        
        if (step >= steps) {
            clearInterval(interval);
            // Valeurs finales exactes
            progressBar.style.width = progressPercentage + '%';
            progressText.textContent = Math.round(progressPercentage) + '%';
            currentAmountElement.textContent = currentSavings.toLocaleString() + '€';
        }
    }, duration / steps);
}

function createPortfolioChart() {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    
    // Données réelles de l'utilisateur avec palette Atlas
    const portfolioData = {};
    
    {% if current_user.investor_profile %}
        {% if current_user.investor_profile.has_livret_a and current_user.investor_profile.livret_a_value > 0 %}
            portfolioData['Livret A'] = { amount: {{ current_user.investor_profile.livret_a_value }}, color: '#137C8B' };
        {% endif %}
        
        {% if current_user.investor_profile.has_pea and current_user.investor_profile.pea_value > 0 %}
            portfolioData['PEA'] = { amount: {{ current_user.investor_profile.pea_value }}, color: '#709CA7' };
        {% endif %}
        
        {% if current_user.investor_profile.has_per and current_user.investor_profile.per_value > 0 %}
            portfolioData['PER'] = { amount: {{ current_user.investor_profile.per_value }}, color: '#B8CBD0' };
        {% endif %}
        
        {% if current_user.investor_profile.has_life_insurance and current_user.investor_profile.life_insurance_value > 0 %}
            portfolioData['Assurance Vie'] = { amount: {{ current_user.investor_profile.life_insurance_value }}, color: '#7A90A4' };
        {% endif %}
        
        {% if current_user.investor_profile.has_current_account and current_user.investor_profile.current_account_value > 0 %}
            portfolioData['Compte courant'] = { amount: {{ current_user.investor_profile.current_account_value }}, color: '#344D59' };
        {% endif %}
    {% endif %}
    
    // Si aucune donnée, utiliser des données d'exemple
    if (Object.keys(portfolioData).length === 0) {
        portfolioData['Livret A'] = { amount: 15000, color: '#137C8B' };
        portfolioData['PEA'] = { amount: 12000, color: '#709CA7' };
        portfolioData['PER'] = { amount: 8000, color: '#B8CBD0' };
        portfolioData['Assurance Vie'] = { amount: 6000, color: '#7A90A4' };
        portfolioData['Compte courant'] = { amount: 4250, color: '#344D59' };
    }
    
    const labels = Object.keys(portfolioData);
    const amounts = Object.values(portfolioData).map(item => item.amount);
    const colors = Object.values(portfolioData).map(item => item.color);
    const total = amounts.reduce((sum, amount) => sum + amount, 0);
    
    // Créer le graphique
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: amounts,
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverBorderWidth: 4,
                hoverBorderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // On utilise notre propre légende
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#137C8B',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const amount = context.parsed;
                            const percentage = ((amount / total) * 100).toFixed(1);
                            return `${amount.toLocaleString()}€ (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%',
            animation: {
                animateRotate: true,
                duration: 1500,
                easing: 'easeInOutCubic'
            }
        }
    });
    
    // Créer la légende personnalisée
    createCustomLegend(portfolioData, total);
}

function createCustomLegend(portfolioData, total) {
    const legendContainer = document.getElementById('portfolioLegend');
    legendContainer.innerHTML = '';
    
    Object.entries(portfolioData).forEach(([label, data]) => {
        const percentage = ((data.amount / total) * 100).toFixed(1);
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        
        legendItem.innerHTML = `
            <div class="legend-info">
                <div class="legend-color" style="background-color: ${data.color};"></div>
                <span class="legend-label">${label}</span>
            </div>
            <div class="legend-values">
                <div class="legend-amount">${data.amount.toLocaleString()}€</div>
                <div class="legend-percentage">${percentage}%</div>
            </div>
        `;
        
        legendContainer.appendChild(legendItem);
    });
}
</script>
{% endblock %}