{% extends "platform/base.html" %}

{% block title %}Mon conseiller IA - Atlas{% endblock %}

{% block page_title %}Mon conseiller IA{% endblock %}

{% block content %}
<!-- Chat Container -->
<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="chat-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="chat-info">
            <h3 class="chat-title">Conseiller Atlas</h3>
            <div class="chat-status">
                <i class="fas fa-circle"></i>
                <span>En ligne</span>
            </div>
        </div>
    </div>
    
    <!-- Chat Messages -->
    <div class="chat-messages" id="chatMessages">
        <!-- Message de bienvenue -->
        <div class="message-wrapper assistant-wrapper">
            <div class="message-bubble assistant-bubble">
                <p class="mb-1">Salut {{ current_user.first_name }} ! üëã Je suis Atlas</p>
                <p class="mb-0">Ton assistant pour apprendre √† √©pargner et investir simplement. PEA, assurance-vie, ETF... je t'explique tout en langage clair !</p>
            </div>
            <div class="message-time">Il y a quelques instants</div>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div class="chat-input-container">
        <form id="chatForm" class="chat-form">
            <div class="input-wrapper">
                <textarea id="messageInput" 
                         placeholder="Tapez votre message..." 
                         rows="1"></textarea>
                <button type="submit" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
        <div class="chat-hint">
            <i class="fas fa-info-circle"></i>
            Appuyez sur Entr√©e pour envoyer, Shift+Entr√©e pour une nouvelle ligne
        </div>
    </div>
</div>

<style>
/* Chat Container */
.chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 140px);
    background: var(--qlower-white);
    border-radius: 16px;
    box-shadow: var(--platform-card-shadow);
    border: 1px solid var(--qlower-border);
    overflow: hidden;
}

/* Chat Header */
.chat-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 24px;
    background: var(--qlower-bg-light);
    border-bottom: 1px solid var(--qlower-border);
}

.chat-avatar {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.chat-info {
    flex: 1;
}

.chat-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--qlower-dark);
    margin: 0 0 4px 0;
}

.chat-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: var(--qlower-text-light);
}

.chat-status i {
    color: #28a745;
    font-size: 8px;
}

/* Chat Messages */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: #ffffff;
}

/* Message Wrapper - Style iMessage */
.message-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 75%;
    margin-bottom: 4px;
}

.user-wrapper {
    align-self: flex-end;
    align-items: flex-end;
}

.assistant-wrapper {
    align-self: flex-start;
    align-items: flex-start;
}

/* Message Bubbles - Style iMessage */
.message-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    margin-bottom: 4px;
    word-wrap: break-word;
    position: relative;
    max-width: 100%;
    line-height: 1.3;
}

.message-bubble p {
    margin: 0 0 4px 0;
    line-height: 1.3;
}

.message-bubble p:last-child {
    margin-bottom: 0;
}

.user-bubble {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    border-bottom-right-radius: 4px;
    margin-left: auto;
}

.assistant-bubble {
    background: #E5E5EA;
    color: #000000;
    border-bottom-left-radius: 4px;
    margin-right: auto;
}

.message-time {
    font-size: 11px;
    color: #8E8E93;
    margin-top: 2px;
    padding: 0 8px;
}

.user-wrapper .message-time {
    text-align: right;
}

.assistant-wrapper .message-time {
    text-align: left;
}

/* Chat Input */
.chat-input-container {
    background: var(--qlower-bg-light);
    border-top: 1px solid var(--qlower-border);
    padding: 16px 24px;
}

.chat-form {
    margin-bottom: 8px;
}

.input-wrapper {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

#messageInput {
    flex: 1;
    border: 1px solid var(--qlower-border);
    border-radius: 20px;
    padding: 12px 16px;
    resize: none;
    max-height: 120px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.4;
    background: var(--qlower-white);
    transition: all 0.2s ease;
}

#messageInput:focus {
    outline: none;
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

#sendButton {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

#sendButton:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(19, 124, 139, 0.3);
}

#sendButton:active {
    transform: scale(0.95);
}

.chat-hint {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--qlower-text-light);
}

.chat-hint i {
    color: var(--qlower-primary);
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #E5E5EA;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    margin-bottom: 4px;
    max-width: fit-content;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #999;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { 
        transform: scale(0.8); 
        opacity: 0.5; 
    }
    40% { 
        transform: scale(1); 
        opacity: 1; 
    }
}

/* Responsive */
@media (max-width: 768px) {
    .chat-container {
        height: calc(100vh - 120px);
        border-radius: 0;
        margin: -32px;
    }
    
    .chat-messages {
        padding: 16px;
    }
    
    .chat-input-container {
        padding: 12px 16px;
    }
    
    .message-wrapper {
        max-width: 85%;
    }
}

/* Markdown Styling */
.message-bubble h4 {
    color: var(--qlower-primary) !important;
    font-weight: bold !important;
    margin: 8px 0 4px 0 !important;
    font-size: 16px !important;
    line-height: 1.2 !important;
}

.message-bubble strong {
    font-weight: bold !important;
    color: #333 !important;
}

.message-bubble em {
    font-style: italic !important;
    color: #666 !important;
    font-size: 13px !important;
}

.message-bubble .highlight-box {
    margin-top: 8px !important;
    margin-bottom: 4px !important;
    padding: 6px !important;
    background: rgba(19, 124, 139, 0.1) !important;
    border-left: 3px solid var(--qlower-primary) !important;
    border-radius: 0 4px 4px 0 !important;
}

.message-bubble .legal-notice {
    margin-top: 8px !important;
    padding: 6px !important;
    background: #f9f9f9 !important;
    border-radius: 4px !important;
    font-size: 12px !important;
    color: #666 !important;
    font-style: italic !important;
    line-height: 1.2 !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const sendButton = document.getElementById('sendButton');
    
    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Handle Enter key
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message
        addMessage(message, 'user');
        
        // Clear input
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Show typing indicator
        showTypingIndicator();
        
        // Send message to API
        fetch('{{ url_for("platform_investor.chat_api") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            if (data.response) {
                addMessage(data.response, 'assistant');
            } else {
                addMessage('Erreur de communication avec l\'assistant.', 'assistant');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            addMessage('Je ne suis pas encore connect√© √† votre intelligence artificielle, veuillez r√©essayer ult√©rieurement.', 'assistant');
        });
    }
    
    function formatMarkdown(text) {
        let formatted = text;
        
        // Titres avec ###
        formatted = formatted.replace(/### (.+)/g, '<h4>$1</h4>');
        
        // Gras avec **texte**
        formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // Listes avec - 
        formatted = formatted.replace(/^- (.+)/gm, '<div style="margin: 2px 0;"><span style="color: var(--qlower-primary); font-weight: bold;">‚Ä¢</span> $1</div>');
        
        // Listes num√©rot√©es
        formatted = formatted.replace(/^(\d+)\. (.+)/gm, '<div style="margin: 4px 0;"><span style="color: var(--qlower-primary); font-weight: bold; background: rgba(19, 124, 139, 0.1); padding: 2px 6px; border-radius: 50%; font-size: 12px;">$1</span> <strong>$2</strong></div>');
        
        // Texte en italique
        formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');
        
        // Retours √† la ligne simples
        formatted = formatted.replace(/\n\n/g, '<br><br>');
        formatted = formatted.replace(/\n/g, '<br>');
        
        // Sections sp√©ciales
        formatted = formatted.replace(/(√Ä retenir|Prochaine micro-action) ?:/g, '<div class="highlight-box"><strong style="color: var(--qlower-primary);">$1 :</strong></div>');
        
        // Mention l√©gale
        formatted = formatted.replace(/Information √©ducative uniquement(.+?)agr√©√©\./g, '<div class="legal-notice">Information √©ducative uniquement$1agr√©√©.</div>');
        
        return formatted;
    }
    
    function addMessage(text, sender) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper ${sender}-wrapper`;
        
        const timestamp = new Date().toLocaleTimeString('fr-FR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        if (sender === 'user') {
            messageWrapper.innerHTML = `
                <div class="message-bubble user-bubble">
                    <p class="mb-0">${text}</p>
                </div>
                <div class="message-time">${timestamp}</div>
            `;
        } else {
            const formattedText = formatMarkdown(text);
            messageWrapper.innerHTML = `
                <div class="message-bubble assistant-bubble">
                    ${formattedText}
                </div>
                <div class="message-time">${timestamp}</div>
            `;
        }
        
        chatMessages.appendChild(messageWrapper);
        scrollToBottom();
    }
    
    function showTypingIndicator() {
        const typingContainer = document.createElement('div');
        typingContainer.id = 'typingIndicator';
        typingContainer.className = 'message-wrapper assistant-wrapper';
        typingContainer.innerHTML = `
            <div class="typing-indicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        
        chatMessages.appendChild(typingContainer);
        scrollToBottom();
    }
    
    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Initial scroll to bottom
    scrollToBottom();
});
</script>
{% endblock %}