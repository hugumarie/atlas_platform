{% extends "platform/base.html" %}

{% block title %}Mon Profil - Atlas{% endblock %}

{% block page_title %}Mon Profil{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Section Mes Infos -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-user text-primary"></i>
                Mes informations
            </h3>
            <p class="platform-card-subtitle">Vos informations personnelles</p>
        </div>
        <div class="platform-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Prénom</div>
                    <div class="info-value">{{ current_user.first_name or 'Non renseigné' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Nom</div>
                    <div class="info-value">{{ current_user.last_name or 'Non renseigné' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ current_user.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Téléphone</div>
                    <div class="info-value">{{ current_user.phone or 'Non renseigné' }}</div>
                </div>
            </div>
            
            <div class="info-actions">
                <button class="platform-btn platform-btn-secondary" onclick="showEditInfoModal()">
                    <i class="fas fa-edit"></i>
                    Modifier mes informations
                </button>
            </div>
        </div>
    </div>

    <!-- Section Mon Abonnement -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-crown text-primary"></i>
                Mon abonnement
            </h3>
            <p class="platform-card-subtitle">Gérez votre plan d'abonnement</p>
        </div>
        <div class="platform-card-body">
            {% if current_user.subscription %}
            <div class="subscription-info">
                <!-- Plan actuel avec détails -->
                <div class="subscription-plan">
                    {% if current_user.subscription.tier == 'initia' %}
                    <div class="plan-card plan-initia">
                        <div class="plan-header">
                            <div class="plan-badge plan-initia">
                                <i class="fas fa-seedling"></i>
                                INITIA
                            </div>
                            <div class="plan-subtitle">Pour débuter sereinement</div>
                        </div>
                        <div class="plan-price">
                            <span class="price-amount">€24,99</span>
                            <span class="price-period">/mois</span>
                        </div>
                        <div class="plan-features">
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Analyse patrimoniale de base</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Recommandations personnalisées</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Suivi de 3 investissements</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Assistant IA de base</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Support par email</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Formations vidéo essentielles</span>
                            </div>
                        </div>
                    </div>
                    {% elif current_user.subscription.tier == 'optima' %}
                    <div class="plan-card plan-optima">
                        <div class="plan-header">
                            <div class="plan-badge">
                                <i class="fas fa-crown"></i>
                                OPTIMA
                                <span class="popular-badge">Le plus populaire</span>
                            </div>
                            <div class="plan-subtitle">Pour structurer votre patrimoine</div>
                        </div>
                        <div class="plan-price">
                            <span class="price-amount">€49,99</span>
                            <span class="price-period">/mois</span>
                        </div>
                        <div class="plan-features">
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Analyse patrimoniale avancée</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Optimisation fiscale complète</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Suivi illimité d'investissements</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Assistant IA avancé 24/7</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Conseiller dédié (1h/mois)</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Alertes en temps réel</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Formations complètes</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Rapports mensuels détaillés</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="subscription-status">
                    <div class="status-item">
                        <div class="status-label">Statut</div>
                        <div class="status-value status-{{ current_user.subscription.status }}">
                            {{ current_user.subscription.get_status_display() }}
                        </div>
                    </div>
                    {% if current_user.subscription.next_billing_date %}
                    <div class="status-item">
                        <div class="status-label">Prochaine facturation</div>
                        <div class="status-value">
                            {{ current_user.subscription.next_billing_date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    {% endif %}
                    {% if current_user.subscription.start_date %}
                    <div class="status-item">
                        <div class="status-label">Abonné depuis</div>
                        <div class="status-value">
                            {{ current_user.subscription.start_date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="subscription-actions">
                <button class="platform-btn platform-btn-primary" onclick="showPlanSelector()">
                    <i class="fas fa-exchange-alt"></i>
                    Changer d'abonnement
                </button>
            </div>
            {% else %}
            <div class="no-subscription">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Aucun abonnement actif</h4>
                <p>Vous n'avez pas d'abonnement actif. Souscrivez à un plan pour accéder à toutes les fonctionnalités.</p>
                <button class="platform-btn platform-btn-primary">
                    <i class="fas fa-plus"></i>
                    Choisir un plan
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section Moyens de paiement -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-credit-card text-primary"></i>
                Moyens de paiement
            </h3>
            <p class="platform-card-subtitle">Gérez vos cartes de paiement</p>
        </div>
        <div class="platform-card-body">
            <div class="payment-methods">
                {% if current_user.payment_methods and current_user.payment_methods|length > 0 %}
                    {% for payment_method in current_user.payment_methods %}
                    <div class="payment-card {{ 'payment-default' if payment_method.is_default }}">
                        <div class="payment-info">
                            <div class="payment-logo">
                                {% if payment_method.card_type == 'visa' %}
                                    <div class="card-logo visa-logo">
                                        <span>VISA</span>
                                    </div>
                                {% elif payment_method.card_type == 'mastercard' %}
                                    <div class="card-logo mastercard-logo">
                                        <div class="mc-circle mc-red"></div>
                                        <div class="mc-circle mc-yellow"></div>
                                    </div>
                                {% elif payment_method.card_type == 'amex' %}
                                    <div class="card-logo amex-logo">
                                        <span>AMEX</span>
                                    </div>
                                {% else %}
                                    <div class="card-logo generic-logo">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="payment-details">
                                <div class="payment-number">{{ payment_method.get_masked_number() }}</div>
                                <div class="payment-meta">
                                    <span class="payment-name">{{ payment_method.cardholder_name }}</span>
                                    <span class="payment-expiry">{{ payment_method.get_expiry_display() }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-actions">
                            {% if payment_method.is_default %}
                                <span class="payment-badge">Par défaut</span>
                            {% else %}
                                <button class="payment-btn-secondary" onclick="setDefaultPayment({{ payment_method.id }})">
                                    Définir par défaut
                                </button>
                            {% endif %}
                            
                            <button class="payment-btn-danger" onclick="removePayment({{ payment_method.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-payment-methods">
                        <i class="fas fa-credit-card"></i>
                        <h4>Aucun moyen de paiement</h4>
                        <p>Ajoutez une carte pour faciliter vos paiements.</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="payment-add-section">
                <button class="platform-btn platform-btn-primary" onclick="showAddPaymentModal()">
                    <i class="fas fa-plus"></i>
                    Ajouter un nouveau moyen de paiement
                </button>
            </div>
        </div>
    </div>

    <!-- Section Factures -->
    <div class="platform-card">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-file-invoice text-primary"></i>
                Mes factures
            </h3>
            <p class="platform-card-subtitle">Téléchargez vos factures mensuelles</p>
        </div>
        <div class="platform-card-body">
            <div class="invoice-generator">
                <div class="invoice-form">
                    <div class="form-group">
                        <label for="invoiceMonth">Mois</label>
                        <select id="invoiceMonth" class="form-control">
                            <option value="01">Janvier</option>
                            <option value="02">Février</option>
                            <option value="03">Mars</option>
                            <option value="04">Avril</option>
                            <option value="05">Mai</option>
                            <option value="06">Juin</option>
                            <option value="07">Juillet</option>
                            <option value="08">Août</option>
                            <option value="09">Septembre</option>
                            <option value="10" selected>Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Décembre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceYear">Année</label>
                        <select id="invoiceYear" class="form-control">
                            <option value="2023">2023</option>
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    
                    <button class="platform-btn platform-btn-primary" onclick="generateInvoice()">
                        <i class="fas fa-download"></i>
                        Générer la facture PDF
                    </button>
                </div>
                
                <div class="invoice-info">
                    <i class="fas fa-info-circle"></i>
                    <p>Les factures sont générées automatiquement à partir de votre historique d'abonnement. Sélectionnez le mois et l'année souhaités.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sélection Plan -->
<div id="planModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Changer d'abonnement</h3>
            <button class="modal-close" onclick="hidePlanSelector()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="plans-grid">
                <div class="plan-option" data-plan="initia">
                    <div class="plan-name">INITIA</div>
                    <div class="plan-price">24,99€<span>/mois</span></div>
                    <div class="plan-features">
                        <div class="feature">✓ Tableau de bord personnalisé</div>
                        <div class="feature">✓ Suivi de portefeuille</div>
                        <div class="feature">✓ Formations de base</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'initia' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select" onclick="changePlan('initia')">Choisir</button>
                    {% endif %}
                </div>
                
                <div class="plan-option" data-plan="optima">
                    <div class="plan-name">OPTIMA</div>
                    <div class="plan-price">49,99€<span>/mois</span></div>
                    <div class="plan-features">
                        <div class="feature">✓ Tout INITIA</div>
                        <div class="feature">✓ Conseiller IA avancé</div>
                        <div class="feature">✓ Formations premium</div>
                        <div class="feature">✓ Analyses approfondies</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'optima' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select" onclick="changePlan('optima')">Choisir</button>
                    {% endif %}
                </div>
                
                <div class="plan-option" data-plan="ultima">
                    <div class="plan-name">ULTIMA</div>
                    <div class="plan-price">Sur devis</div>
                    <div class="plan-features">
                        <div class="feature">✓ Tout OPTIMA</div>
                        <div class="feature">✓ Support prioritaire</div>
                        <div class="feature">✓ Gestion patrimoniale</div>
                        <div class="feature">✓ Conseils personnalisés</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'ultima' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select" onclick="changePlan('ultima')">Choisir</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modification Informations -->
<div id="editInfoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Modifier mes informations</h3>
            <button class="modal-close" onclick="hideEditInfoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editInfoForm" class="edit-info-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFirstName">Prénom *</label>
                        <input type="text" id="editFirstName" name="first_name" class="form-control" 
                               value="{{ current_user.first_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editLastName">Nom *</label>
                        <input type="text" id="editLastName" name="last_name" class="form-control" 
                               value="{{ current_user.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" class="form-control" 
                               value="{{ current_user.email }}" disabled>
                        <small class="form-help">L'email ne peut pas être modifié car il sert d'identifiant de compte</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPhone">Téléphone</label>
                        <input type="tel" id="editPhone" name="phone" class="form-control" 
                               value="{{ current_user.phone or '' }}" 
                               placeholder="Ex: 06 12 34 56 78">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="platform-btn platform-btn-secondary" onclick="hideEditInfoModal()">
                        Annuler
                    </button>
                    <button type="submit" class="platform-btn platform-btn-primary">
                        <i class="fas fa-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>\n\n<!-- Modal Ajout Moyen de Paiement -->
<div id="paymentModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ajouter un moyen de paiement</h3>
            <button class="modal-close" onclick="hideAddPaymentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="paymentForm" class="payment-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardNumber">Numéro de carte *</label>
                        <input type="text" id="cardNumber" name="cardNumber" class="form-control" 
                               placeholder="1234 5678 9012 3456" maxlength="19" required>
                        <div class="card-type-indicator" id="cardTypeIndicator"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group form-group-half">
                        <label for="expiryMonth">Mois d'expiration *</label>
                        <select id="expiryMonth" name="expiryMonth" class="form-control" required>
                            <option value="">Mois</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-group-half">
                        <label for="expiryYear">Année d'expiration *</label>
                        <select id="expiryYear" name="expiryYear" class="form-control" required>
                            <option value="">Année</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="2031">2031</option>
                            <option value="2032">2032</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardholderName">Nom du porteur *</label>
                        <input type="text" id="cardholderName" name="cardholderName" class="form-control" 
                               placeholder="Nom tel qu'il apparaît sur la carte" 
                               value="{{ current_user.first_name }} {{ current_user.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="setAsDefault" name="setAsDefault">
                            <span class="checkmark"></span>
                            Définir comme moyen de paiement par défaut
                        </label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="platform-btn platform-btn-secondary" onclick="hideAddPaymentModal()">
                        Annuler
                    </button>
                    <button type="submit" class="platform-btn platform-btn-primary">
                        <i class="fas fa-save"></i>
                        Ajouter la carte
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Profile Container */
.profile-container {
    max-width: 800px;
    margin: 0 auto;
}

/* Info Grid */
.info-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 24px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid var(--qlower-border);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.info-value {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
}

.info-actions {
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

/* Subscription */
.subscription-info {
    display: grid;
    gap: 24px;
    margin-bottom: 24px;
}

/* Plan Cards Styles */
.subscription-plan {
    margin-bottom: 24px;
}

.plan-card {
    border: 2px solid transparent;
    border-radius: 16px;
    padding: 24px;
    background: white;
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
    transition: all 0.3s ease;
}

.plan-card.plan-initia {
    border-color: #22c55e;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
}

.plan-card.plan-optima {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
}

.plan-header {
    margin-bottom: 20px;
}

.plan-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 8px;
}

.plan-badge.plan-initia {
    color: #16a34a;
}

.plan-badge .popular-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
    margin-left: 8px;
}

.plan-subtitle {
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
}

.plan-price {
    margin-bottom: 20px;
}

.price-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
}

.plan-initia .price-amount {
    color: #16a34a;
}

.price-period {
    font-size: 16px;
    color: #6b7280;
    font-weight: 500;
}

.plan-features {
    display: grid;
    gap: 12px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
}

.feature-item i {
    color: #16a34a;
    font-size: 12px;
    width: 12px;
    flex-shrink: 0;
}

.feature-item span {
    color: #374151;
    line-height: 1.4;
}

.subscription-plan .plan-period {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.9;
    color: white !important;
}

.subscription-status {
    display: grid;
    gap: 16px;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.status-value {
    font-weight: 600;
    font-size: 16px;
}

.status-active {
    color: var(--asset-success);
}

.status-trial {
    color: #ffc107;
}

.status-cancelled {
    color: var(--debt-primary);
}

.subscription-actions {
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

.no-subscription {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.no-subscription i {
    font-size: 48px;
    margin-bottom: 16px;
}

.no-subscription h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

/* Invoice Generator */
.invoice-generator {
    display: grid;
    gap: 24px;
}

.invoice-form {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: var(--qlower-text-dark);
    font-size: 14px;
}

.form-control {
    padding: 12px 16px;
    border: 1px solid var(--qlower-border);
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.invoice-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--qlower-bg-light);
    border-radius: 8px;
    border-left: 4px solid var(--qlower-primary);
}

.invoice-info i {
    color: var(--qlower-primary);
    font-size: 18px;
}

.invoice-info p {
    margin: 0;
    font-size: 14px;
    color: var(--qlower-text-light);
    line-height: 1.5;
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--qlower-border);
}

.modal-header h3 {
    margin: 0;
    color: var(--qlower-dark);
    font-size: 20px;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--qlower-text-light);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--qlower-bg-light);
    color: var(--qlower-dark);
}

.modal-body {
    padding: 24px;
}

.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.plan-option {
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.plan-option:hover {
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.15);
}

.plan-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

.plan-price {
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    margin-bottom: 20px;
}

.plan-price span {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.7;
}

.plan-features {
    text-align: left;
    margin-bottom: 24px;
}

.feature {
    padding: 6px 0;
    font-size: 14px;
    color: var(--qlower-text-dark);
}

.plan-btn {
    width: 100%;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.plan-btn-select {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
}

.plan-btn-select:hover {
    background: linear-gradient(135deg, #0f6b75 0%, #5d8a94 100%);
    transform: translateY(-1px);
}

.plan-btn-current {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-light);
    cursor: not-allowed;
}

/* Payment Methods */
.payment-methods {
    display: grid;
    gap: 16px;
    margin-bottom: 24px;
}

.payment-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    background: var(--qlower-white);
    transition: all 0.2s ease;
}

.payment-card:hover {
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.payment-default {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.05) 0%, rgba(19, 124, 139, 0.02) 100%);
}

.payment-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.payment-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 32px;
}

.card-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 4px;
    font-weight: 700;
    font-size: 12px;
}

.visa-logo {
    background: linear-gradient(135deg, #1a1f71 0%, #0066cc 100%);
    color: white;
}

.mastercard-logo {
    position: relative;
    background: #000;
}

.mc-circle {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
}

.mc-red {
    background: #eb001b;
    left: 8px;
}

.mc-yellow {
    background: #ff5f00;
    right: 8px;
}

.amex-logo {
    background: linear-gradient(135deg, #006fcf 0%, #00a8cc 100%);
    color: white;
    font-size: 10px;
}

.generic-logo {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-light);
}

.payment-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.payment-number {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--qlower-dark);
    letter-spacing: 1px;
}

.payment-meta {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: var(--qlower-text-light);
}

.payment-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.payment-badge {
    background: var(--qlower-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.payment-btn-secondary, .payment-btn-danger {
    background: none;
    border: 1px solid;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.payment-btn-secondary {
    border-color: var(--qlower-primary);
    color: var(--qlower-primary);
}

.payment-btn-secondary:hover {
    background: var(--qlower-primary);
    color: white;
}

.payment-btn-danger {
    border-color: var(--debt-primary);
    color: var(--debt-primary);
    padding: 6px 8px;
}

.payment-btn-danger:hover {
    background: var(--debt-primary);
    color: white;
}

.payment-add-section {
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
    text-align: center;
}

.no-payment-methods {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.no-payment-methods i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--qlower-primary);
}

.no-payment-methods h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

/* Edit Info Form */
.edit-info-form {
    display: grid;
    gap: 20px;
}

.form-help {
    font-size: 12px;
    color: var(--qlower-text-light);
    margin-top: 4px;
    font-style: italic;
}

.form-control:disabled {
    background-color: var(--qlower-bg-light);
    color: var(--qlower-text-light);
    cursor: not-allowed;
}

/* Payment Form */
.payment-form {
    display: grid;
    gap: 20px;
}

.form-row {
    display: grid;
    gap: 16px;
}

.form-group-half {
    grid-column: span 1;
}

.form-row:has(.form-group-half) {
    grid-template-columns: 1fr 1fr;
}

.card-type-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 600;
}

.form-group {
    position: relative;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: var(--qlower-text-dark);
    cursor: pointer;
}

.checkbox-container input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin: 0;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--qlower-border);
}

/* Responsive */
@media (max-width: 768px) {
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .subscription-plan {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }
    
    .invoice-form {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .plans-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    .payment-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .payment-actions {
        align-self: stretch;
        justify-content: space-between;
    }
    
    .form-row:has(.form-group-half) {
        grid-template-columns: 1fr;
    }
    
    .modal-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Fonctions de gestion des modales
function showPlanSelector() {
    document.getElementById('planModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hidePlanSelector() {
    document.getElementById('planModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Changement de plan
function changePlan(planTier) {
    if (confirm(`Êtes-vous sûr de vouloir changer pour le plan ${planTier.toUpperCase()} ?`)) {
        // Simuler le changement de plan
        fetch('/plateforme/profil/changer-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tier: planTier
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Plan changé avec succès !');
                location.reload();
            } else {
                alert('Erreur lors du changement de plan: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erreur lors du changement de plan.');
        });
    }
}

// Edit Info Modal Functions
function showEditInfoModal() {
    document.getElementById('editInfoModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideEditInfoModal() {
    document.getElementById('editInfoModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form to original values
    document.getElementById('editFirstName').value = '{{ current_user.first_name }}';
    document.getElementById('editLastName').value = '{{ current_user.last_name }}';
    document.getElementById('editPhone').value = '{{ current_user.phone or '' }}';
}

// Edit info form submission
function submitEditInfoForm(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    const data = {
        first_name: formData.get('first_name').trim(),
        last_name: formData.get('last_name').trim(),
        phone: formData.get('phone').trim() || null
    };
    
    // Basic validation
    if (!data.first_name || !data.last_name) {
        alert('Le prénom et le nom sont obligatoires');
        return;
    }
    
    // Phone validation (optional)
    if (data.phone && !/^[0-9\s\-\+\(\)\.]{10,}$/.test(data.phone)) {
        alert('Format de téléphone invalide');
        return;
    }
    
    fetch('/plateforme/profil/modifier-infos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Informations mises à jour avec succès !');
            hideEditInfoModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise à jour des informations: ' + error.message);
    });
}

// Génération de facture
function generateInvoice() {
    const month = document.getElementById('invoiceMonth').value;
    const year = document.getElementById('invoiceYear').value;
    
    if (!month || !year) {
        alert('Veuillez sélectionner un mois et une année');
        return;
    }
    
    // Créer l'URL pour télécharger la facture
    const downloadUrl = `/plateforme/profil/facture/${year}/${month}`;
    
    // Ouvrir dans un nouvel onglet pour téléchargement
    window.open(downloadUrl, '_blank');
}

// Fermer modal avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hidePlanSelector();
    }
});

// Fermer modal en cliquant à l'extérieur
document.getElementById('planModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hidePlanSelector();
    }
});

// Payment Methods Functions
function showAddPaymentModal() {
    document.getElementById('paymentModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideAddPaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('paymentForm').reset();
    document.getElementById('cardTypeIndicator').textContent = '';
}

// Set default payment method
function setDefaultPayment(paymentId) {
    if (confirm('Définir cette carte comme moyen de paiement par défaut ?')) {
        fetch('/plateforme/profil/paiement/defaut', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_id: paymentId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erreur lors de la modification.');
        });
    }
}

// Remove payment method
function removePayment(paymentId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette carte ?')) {
        fetch('/plateforme/profil/paiement/supprimer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_id: paymentId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erreur lors de la suppression.');
        });
    }
}

// Card type detection
function detectCardType(cardNumber) {
    const number = cardNumber.replace(/\s/g, '');
    
    if (number.startsWith('4')) {
        return 'VISA';
    } else if (number.startsWith('5') || number.startsWith('2')) {
        return 'MASTERCARD';
    } else if (number.startsWith('34') || number.startsWith('37')) {
        return 'AMEX';
    } else if (number.startsWith('6')) {
        return 'DISCOVER';
    }
    
    return '';
}

// Format card number input
function formatCardNumber(input) {
    let value = input.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    
    input.value = formattedValue;
    
    // Update card type indicator
    const cardType = detectCardType(value);
    document.getElementById('cardTypeIndicator').textContent = cardType;
}

// Payment form submission
function submitPaymentForm(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const cardNumber = formData.get('cardNumber').replace(/\s/g, '');
    
    // Basic validation
    if (cardNumber.length < 13 || cardNumber.length > 19) {
        alert('Numéro de carte invalide');
        return;
    }
    
    const data = {
        card_number: cardNumber,
        expiry_month: formData.get('expiryMonth'),
        expiry_year: formData.get('expiryYear'),
        cardholder_name: formData.get('cardholderName'),
        set_as_default: formData.get('setAsDefault') === 'on'
    };
    
    fetch('/plateforme/profil/paiement/ajouter', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Carte ajoutée avec succès !');
            hideAddPaymentModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erreur lors de l\'ajout de la carte.');
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Card number formatting
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function() {
            formatCardNumber(this);
        });
    }
    
    // Payment form submission
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', submitPaymentForm);
    }
    
    // Edit info form submission
    const editInfoForm = document.getElementById('editInfoForm');
    if (editInfoForm) {
        editInfoForm.addEventListener('submit', submitEditInfoForm);
    }
    
    // Close modals with Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideAddPaymentModal();
            hideEditInfoModal();
        }
    });
    
    // Close modals by clicking outside
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddPaymentModal();
            }
        });
    }
    
    const editInfoModal = document.getElementById('editInfoModal');
    if (editInfoModal) {
        editInfoModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideEditInfoModal();
            }
        });
    }
});
</script>
{% endblock %}