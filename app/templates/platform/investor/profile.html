{% extends "platform/base.html" %}

{% block title %}Mon Profil - Atlas{% endblock %}

{% block page_title %}Mon Profil{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Section Mes Infos -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-user text-primary"></i>
                Mes informations
            </h3>
            <p class="platform-card-subtitle">Vos informations personnelles</p>
        </div>
        <div class="platform-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Pr√©nom</div>
                    <div class="info-value">{{ current_user.first_name or 'Non renseign√©' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Nom</div>
                    <div class="info-value">{{ current_user.last_name or 'Non renseign√©' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ current_user.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">T√©l√©phone</div>
                    <div class="info-value">{{ current_user.phone or 'Non renseign√©' }}</div>
                </div>
            </div>
            
            <div class="info-actions">
                <button class="platform-btn platform-btn-secondary" onclick="showEditInfoModal()">
                    <i class="fas fa-edit"></i>
                    Modifier mes informations
                </button>
            </div>
        </div>
    </div>

    <!-- Section Mon Abonnement -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-crown text-primary"></i>
                Mon abonnement
            </h3>
            <p class="platform-card-subtitle">G√©rez votre plan d'abonnement</p>
        </div>
        <div class="platform-card-body">
            {% if current_user.subscription %}
            <div class="subscription-info">
                <!-- Plan actuel avec d√©tails -->
                <div class="subscription-plan">
                    {% if current_user.subscription.tier == 'initia' %}
                    <div class="plan-card plan-initia">
                        <div class="plan-header">
                            <div class="plan-badge plan-initia">
                                <i class="fas fa-seedling"></i>
                                INITIA
                            </div>
                            <div class="plan-subtitle">Pour d√©buter sereinement</div>
                        </div>
                        <div class="plan-price">
                            <span class="price-amount">‚Ç¨25</span>
                            <span class="price-period">/mois</span>
                        </div>
                        <div class="plan-features">
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Analyse de situation patrimoniale</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Strat√©gie d'investissement personnalis√©e</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Tableau de bord Atlas</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Pilotage de vos investissements</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Contenus p√©dagogiques</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Accompagnement 100% ind√©pendant</span>
                            </div>
                        </div>
                    </div>
                    {% elif current_user.subscription.tier == 'optima' %}
                    <div class="plan-card plan-optima">
                        <div class="plan-header">
                            <div class="plan-badge">
                                <i class="fas fa-crown"></i>
                                OPTIMA
                                <span class="popular-badge">Le plus populaire</span>
                            </div>
                            <div class="plan-subtitle">Pour structurer votre patrimoine</div>
                        </div>
                        <div class="plan-price">
                            <span class="price-amount">‚Ç¨50</span>
                            <span class="price-period">/mois</span>
                        </div>
                        <div class="plan-features">
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Tout INITIA inclus</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Optimisation patrimoine existant</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Classes d'actifs suppl√©mentaires</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Allocation multi-actifs</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Optimisation transmission</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Probl√©matiques sp√©cifiques</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="subscription-status">
                    <div class="status-item">
                        <div class="status-label">Statut</div>
                        <div class="status-value status-{{ current_user.subscription.status }}">
                            {{ current_user.subscription.get_status_display() }}
                        </div>
                    </div>
                    {% if current_user.subscription.next_billing_date %}
                    <div class="status-item">
                        <div class="status-label">Prochaine facturation</div>
                        <div class="status-value">
                            {{ current_user.subscription.next_billing_date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    {% endif %}
                    {% if current_user.subscription.start_date %}
                    <div class="status-item">
                        <div class="status-label">Abonn√© depuis</div>
                        <div class="status-value">
                            {{ current_user.subscription.start_date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="subscription-actions">
                <button class="platform-btn platform-btn-primary" onclick="showPlanSelector()">
                    <i class="fas fa-exchange-alt"></i>
                    Changer d'abonnement
                </button>
                
                <button class="platform-btn platform-btn-cancel-subscription" onclick="showCancelSubscriptionModal()">
                    <i class="fas fa-times-circle"></i>
                    Se d√©sabonner
                </button>
            </div>
            {% else %}
            <div class="no-subscription">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Aucun abonnement actif</h4>
                <p>Vous n'avez pas d'abonnement actif. Souscrivez √† un plan pour acc√©der √† toutes les fonctionnalit√©s.</p>
                <button class="platform-btn platform-btn-primary">
                    <i class="fas fa-plus"></i>
                    Choisir un plan
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section Moyens de paiement -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-credit-card text-primary"></i>
                Moyens de paiement
            </h3>
            <p class="platform-card-subtitle">G√©rez vos cartes de paiement</p>
        </div>
        <div class="platform-card-body">
            <div id="payment-methods-container">
                <div id="payment-methods-loading" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p style="margin-top: 16px;">Chargement des moyens de paiement...</p>
                </div>
                
                <div id="payment-methods-list" style="display: none;">
                    <!-- Les moyens de paiement seront inject√©s ici via JavaScript -->
                </div>
                
                <div id="payment-methods-empty" style="display: none;">
                    <div class="no-payment-methods">
                        <i class="fas fa-credit-card"></i>
                        <h4>Aucun moyen de paiement</h4>
                        <p>Ajoutez une carte pour faciliter vos paiements.</p>
                    </div>
                </div>
                
                <div id="payment-methods-error" style="display: none;">
                    <div class="no-payment-methods">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Erreur de chargement</h4>
                        <p>Impossible de r√©cup√©rer vos moyens de paiement. <button onclick="loadPaymentMethods()" class="btn btn-link p-0">R√©essayer</button></p>
                    </div>
                </div>
            </div>
            
            <div class="payment-add-section">
                <button class="platform-btn platform-btn-primary" onclick="addPaymentMethodWithCheckout()">
                    <i class="fas fa-plus"></i>
                    Ajouter un nouveau moyen de paiement
                </button>
                <p style="font-size: 12px; color: #6b7280; margin-top: 8px; text-align: center;">
                    <i class="fas fa-shield-alt"></i>
                    S√©curis√© par Stripe - Vos donn√©es ne transitent jamais par nos serveurs
                </p>
            </div>
        </div>
    </div>

    <!-- Section Factures -->
    <div class="platform-card">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-file-invoice text-primary"></i>
                Mes factures
            </h3>
            <p class="platform-card-subtitle">T√©l√©chargez vos factures mensuelles</p>
        </div>
        <div class="platform-card-body">
            <div id="invoices-container">
                <div id="invoices-loading" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p style="margin-top: 16px;">Chargement de vos factures...</p>
                </div>
                
                <div id="invoices-list" style="display: none;">
                    <!-- Les factures seront inject√©es ici via JavaScript -->
                </div>
                
                <div id="invoices-empty" style="display: none;">
                    <div class="no-invoices">
                        <i class="fas fa-file-invoice"></i>
                        <h4>Aucune facture disponible</h4>
                        <p>Vos factures appara√Ætront ici apr√®s vos premiers paiements.</p>
                    </div>
                </div>
                
                <div id="invoices-error" style="display: none;">
                    <div class="no-invoices">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Erreur de chargement</h4>
                        <p>Impossible de r√©cup√©rer vos factures. <button onclick="loadInvoices()" class="btn btn-link p-0">R√©essayer</button></p>
                    </div>
                </div>
            </div>
            
            <div class="invoice-info">
                <i class="fas fa-info-circle"></i>
                <p>Vos factures sont automatiquement g√©n√©r√©es par Stripe lors de chaque paiement. Cliquez sur "T√©l√©charger" pour obtenir le PDF officiel.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal S√©lection Plan -->
<div id="planModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Changer d'abonnement</h3>
            <button class="modal-close" onclick="hidePlanSelector()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="plans-grid">
                <div class="plan-option" data-plan="initia">
                    <div class="plan-name">INITIA</div>
                    <div class="plan-subtitle">"Pour d√©buter dans l'investissement"</div>
                    <div class="plan-price">25‚Ç¨<span>/mois</span></div>
                    <div class="plan-features">
                        <div class="feature">‚úì Analyse de situation patrimoniale</div>
                        <div class="feature">‚úì Strat√©gie d'investissement personnalis√©e</div>
                        <div class="feature">‚úì Tableau de bord Atlas</div>
                        <div class="feature">‚úì Pilotage de vos investissements</div>
                        <div class="feature">‚úì Contenus p√©dagogiques</div>
                        <div class="feature">‚úì Accompagnement 100% ind√©pendant</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'initia' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select" onclick="changePlan('initia')">
                        {% if current_user.subscription and current_user.subscription.tier == 'optima' %}
                        R√©trograder
                        {% else %}
                        Choisir ce plan
                        {% endif %}
                    </button>
                    {% endif %}
                </div>
                
                <div class="plan-option plan-popular" data-plan="optima">
                    <div class="plan-badge-popular">Le plus populaire</div>
                    <div class="plan-name">OPTIMA</div>
                    <div class="plan-subtitle">"Pour structurer et optimiser son patrimoine existant"</div>
                    <div class="plan-price">50‚Ç¨<span>/mois</span></div>
                    <div class="plan-features">
                        <div class="feature">‚úì Tout INITIA inclus</div>
                        <div class="feature">‚úì Optimisation patrimoine existant</div>
                        <div class="feature">‚úì Classes d'actifs suppl√©mentaires</div>
                        <div class="feature">‚úì Allocation multi-actifs</div>
                        <div class="feature">‚úì Optimisation transmission</div>
                        <div class="feature">‚úì Probl√©matiques sp√©cifiques</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'optima' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select plan-btn-upgrade" onclick="changePlan('optima')">
                        {% if current_user.subscription and current_user.subscription.tier == 'initia' %}
                        Passer √† OPTIMA
                        {% else %}
                        Choisir ce plan
                        {% endif %}
                    </button>
                    {% endif %}
                </div>
                
                <div class="plan-option" data-plan="ultima">
                    <div class="plan-name">ULTIMA</div>
                    <div class="plan-subtitle">"Pour des situations patrimoniales sp√©cifiques"</div>
                    <div class="plan-price">Nous consulter</div>
                    <div class="plan-features">
                        <div class="feature">‚úì Tout OPTIMA inclus</div>
                        <div class="feature">‚úì Gestion patrimoniale premium</div>
                        <div class="feature">‚úì Support prioritaire d√©di√©</div>
                        <div class="feature">‚úì Conseils sur-mesure</div>
                        <div class="feature">‚úì Accompagnement VIP</div>
                        <div class="feature">‚úì Solutions personnalis√©es</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'ultima' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select plan-btn-contact" onclick="contactForUltima()">
                        Nous contacter
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Disclaimer -->
            <div class="plan-disclaimer">
                <p><small>Tarifs TTC. Sans engagement. Vous restez libre de r√©silier √† tout moment.</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Annulation Abonnement -->
<div id="cancelSubscriptionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-warning">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle text-warning"></i> Annuler votre abonnement</h3>
            <button class="modal-close" onclick="hideCancelSubscriptionModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #92400e;">Annuler votre abonnement</h4>
                    <p style="margin: 8px 0 0 0; color: #78350f;">Votre acc√®s se terminera √† la fin de la p√©riode en cours.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="cancellationReason" style="display: block; margin-bottom: 8px; font-weight: 500;">Pourquoi partez-vous ? (optionnel)</label>
                    <select id="cancellationReason" class="form-control">
                        <option value="">S√©lectionner...</option>
                        <option value="price">Trop cher</option>
                        <option value="features">Pas assez de fonctionnalit√©s</option>
                        <option value="unused">Je n'utilise pas assez</option>
                        <option value="temporary">Situation temporaire</option>
                        <option value="other">Autre raison</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="platform-btn platform-btn-secondary" onclick="hideCancelSubscriptionModal()">
                    Annuler
                </button>
                
                <button type="button" class="platform-btn platform-btn-outline" onclick="downgradeToPlan()" style="background: #f59e0b; color: white; border-color: #f59e0b;">
                    Passer √† 25‚Ç¨/mois plut√¥t
                </button>
                
                <button type="button" class="platform-btn platform-btn-danger" onclick="directCancellation()">
                    Confirmer l'arr√™t
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modification Informations -->
<div id="editInfoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Modifier mes informations</h3>
            <button class="modal-close" onclick="hideEditInfoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editInfoForm" class="edit-info-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFirstName">Pr√©nom *</label>
                        <input type="text" id="editFirstName" name="first_name" class="form-control" 
                               value="{{ current_user.first_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editLastName">Nom *</label>
                        <input type="text" id="editLastName" name="last_name" class="form-control" 
                               value="{{ current_user.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" class="form-control" 
                               value="{{ current_user.email }}" disabled>
                        <small class="form-help">L'email ne peut pas √™tre modifi√© car il sert d'identifiant de compte</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPhone">T√©l√©phone</label>
                        <input type="tel" id="editPhone" name="phone" class="form-control" 
                               value="{{ current_user.phone or '' }}" 
                               placeholder="Ex: 06 12 34 56 78">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="platform-btn platform-btn-secondary" onclick="hideEditInfoModal()">
                        Annuler
                    </button>
                    <button type="submit" class="platform-btn platform-btn-primary">
                        <i class="fas fa-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajout Moyen de Paiement avec Stripe Elements -->
<!-- Modal supprim√© - On utilise maintenant Stripe Checkout -->

<style>
/* Profile Container */
.profile-container {
    max-width: 800px;
    margin: 0 auto;
}

/* Info Grid */
.info-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 24px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid var(--qlower-border);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.info-value {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
}

.info-actions {
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

/* Subscription */
.subscription-info {
    display: grid;
    gap: 24px;
    margin-bottom: 24px;
}

/* Plan Cards Styles */
.subscription-plan {
    margin-bottom: 24px;
}

.plan-card {
    border: 2px solid transparent;
    border-radius: 16px;
    padding: 24px;
    background: white;
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
    transition: all 0.3s ease;
}

.plan-card.plan-initia {
    border-color: #22c55e;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
}

.plan-card.plan-optima {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
}

.plan-header {
    margin-bottom: 20px;
}

.plan-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 8px;
}

.plan-badge.plan-initia {
    color: #16a34a;
}

.plan-badge .popular-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
    margin-left: 8px;
}

.plan-subtitle {
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
}

.plan-price {
    margin-bottom: 20px;
}

.price-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
}

.plan-initia .price-amount {
    color: #16a34a;
}

.price-period {
    font-size: 16px;
    color: #6b7280;
    font-weight: 500;
}

.plan-features {
    display: grid;
    gap: 12px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
}

.feature-item i {
    color: #16a34a;
    font-size: 12px;
    width: 12px;
    flex-shrink: 0;
}

.feature-item span {
    color: #374151;
    line-height: 1.4;
}

.subscription-plan .plan-period {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.9;
    color: white !important;
}

.subscription-status {
    display: grid;
    gap: 16px;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.status-value {
    font-weight: 600;
    font-size: 16px;
}

.status-active {
    color: var(--asset-success);
}

.status-trial {
    color: #ffc107;
}

.status-cancelled {
    color: var(--debt-primary);
}

.subscription-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

.platform-btn-cancel-subscription {
    background: none;
    border: 1px solid #d1d5db;
    color: #6b7280;
    font-size: 13px;
    padding: 8px 12px;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.platform-btn-cancel-subscription:hover {
    background: #f3f4f6;
    color: #374151;
    opacity: 1;
}

.platform-btn-cancel-subscription i {
    font-size: 12px;
}

.no-subscription {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.no-subscription i {
    font-size: 48px;
    margin-bottom: 16px;
}

.no-subscription h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

/* Invoice Generator */
.invoice-generator {
    display: grid;
    gap: 24px;
}

.invoice-form {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: var(--qlower-text-dark);
    font-size: 14px;
}

.form-control {
    padding: 12px 16px;
    border: 1px solid var(--qlower-border);
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.invoice-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--qlower-bg-light);
    border-radius: 8px;
    border-left: 4px solid var(--qlower-primary);
}

.invoice-info i {
    color: var(--qlower-primary);
    font-size: 18px;
}

.invoice-info p {
    margin: 0;
    font-size: 14px;
    color: var(--qlower-text-light);
    line-height: 1.5;
}

/* Plan Modal Styles */
.plan-subtitle {
    font-size: 12px;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 12px;
    text-align: center;
}

.plan-popular {
    position: relative;
    border-color: #f59e0b !important;
    box-shadow: 0 4px 25px rgba(245, 158, 11, 0.2) !important;
}

.plan-badge-popular {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 6px 16px;
    border-radius: 20px;
    white-space: nowrap;
}

.plan-btn-upgrade {
    background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
    color: white;
}

.plan-btn-upgrade:hover {
    background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
}

.plan-btn-contact {
    background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
    color: white;
}

.plan-btn-contact:hover {
    background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%);
}

.plan-disclaimer {
    margin-top: 24px;
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

.plan-disclaimer small {
    color: #6b7280;
    font-size: 12px;
}

/* Modal Cancellation */
.modal-warning {
    border-top: 4px solid #f59e0b;
}

.cancellation-warning {
    display: grid;
    gap: 20px;
}

.warning-message {
    text-align: center;
    padding: 16px;
    background: #fef3c7;
    border-radius: 8px;
    border-left: 4px solid #f59e0b;
}

.warning-message h4 {
    color: #92400e;
    margin-bottom: 8px;
}

.warning-message p {
    color: #78350f;
    margin: 0;
}

.cancellation-consequences {
    display: grid;
    gap: 12px;
}

.consequence-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
}

.consequence-item i {
    margin-top: 2px;
    width: 16px;
    flex-shrink: 0;
}

.consequence-item strong {
    display: block;
    color: var(--qlower-dark);
    margin-bottom: 4px;
}

.consequence-item span {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.4;
}

.cancellation-alternatives {
    background: #e0f2fe;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #0284c7;
}

.cancellation-alternatives h5 {
    color: #0c4a6e;
    margin-bottom: 12px;
}

.cancellation-alternatives ul {
    margin: 0;
    padding-left: 16px;
}

.cancellation-alternatives li {
    color: #075985;
    margin-bottom: 8px;
    line-height: 1.4;
}

.feedback-section {
    display: grid;
    gap: 12px;
}

.feedback-section label {
    font-weight: 500;
    color: var(--qlower-text-dark);
}

.platform-btn-outline {
    background: none;
    border: 2px solid var(--qlower-primary);
    color: var(--qlower-primary);
}

.platform-btn-outline:hover {
    background: var(--qlower-primary);
    color: white;
}

/* Stripe Elements Styling */
.stripe-security-notice {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
}

.security-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #0c4a6e;
    margin-bottom: 8px;
}

.security-badge i {
    font-size: 16px;
}

.stripe-security-notice p {
    margin: 0;
    font-size: 13px;
    color: #075985;
    line-height: 1.4;
}

.stripe-card-input {
    border: 1px solid var(--qlower-border);
    border-radius: 8px;
    padding: 0;
    background: white;
    transition: all 0.2s ease;
    min-height: 50px;
    position: relative;
    cursor: text;
    display: block;
    width: 100%;
}

.stripe-card-input:focus-within {
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.stripe-card-input.stripe-complete {
    border-color: #059669;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

/* S'assurer que Stripe Elements prend toute la largeur et est interactif */
.stripe-card-input .StripeElement {
    width: 100% !important;
    height: 100% !important;
    min-height: 48px !important;
    border: none !important;
    outline: none !important;
    pointer-events: auto !important;
    display: block !important;
    padding: 12px 16px !important;
    box-sizing: border-box !important;
}

.stripe-card-input .StripeElement--webkit-autofill {
    background: transparent !important;
}

/* Forcer l'iframe Stripe √† √™tre interactive et visible */
.stripe-card-input iframe {
    pointer-events: auto !important;
    width: 100% !important;
    height: 48px !important;
    min-height: 48px !important;
    border: none !important;
    display: block !important;
    background: transparent !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 1 !important;
}

/* Assurer que le container n'a pas de probl√®mes CSS */
#stripe-card-element {
    pointer-events: auto !important;
    position: relative !important;
    overflow: visible !important;
    display: block !important;
}

/* Debug CSS pour identifier les probl√®mes */
.stripe-card-input:empty:before {
    content: "Chargement des champs Stripe...";
    color: #9ca3af;
    font-style: italic;
    padding: 12px 16px;
    display: block;
}

.stripe-error-message {
    color: #dc2626;
    font-size: 12px;
    margin-top: 6px;
    min-height: 16px;
}

#stripe-submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#stripe-submit-btn:disabled:hover {
    background: var(--qlower-primary);
    transform: none;
}

/* Messages d'√©tat pour payment et invoices */
.payment-empty-message, .no-invoices {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.payment-empty-message i, .no-invoices i {
    font-size: 48px;
    margin-bottom: 16px;
}

.payment-empty-message h4, .no-invoices h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

.payment-empty-message p, .no-invoices p {
    margin: 0;
    line-height: 1.5;
}

.payment-empty-message .btn-link, .no-invoices .btn-link {
    color: var(--qlower-primary);
    text-decoration: none;
    font-weight: 500;
}

.payment-empty-message .btn-link:hover, .no-invoices .btn-link:hover {
    text-decoration: underline;
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    pointer-events: auto;
}

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    pointer-events: auto;
    z-index: 1051;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--qlower-border);
}

.modal-header h3 {
    margin: 0;
    color: var(--qlower-dark);
    font-size: 20px;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--qlower-text-light);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--qlower-bg-light);
    color: var(--qlower-dark);
}

.modal-body {
    padding: 24px;
}

.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.plan-option {
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.plan-option:hover {
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.15);
}

.plan-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

.plan-price {
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    margin-bottom: 20px;
}

.plan-price span {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.7;
}

.plan-features {
    text-align: left;
    margin-bottom: 24px;
}

.feature {
    padding: 6px 0;
    font-size: 14px;
    color: var(--qlower-text-dark);
}

.plan-btn {
    width: 100%;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.plan-btn-select {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
}

.plan-btn-select:hover {
    background: linear-gradient(135deg, #0f6b75 0%, #5d8a94 100%);
    transform: translateY(-1px);
}

.plan-btn-current {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-light);
    cursor: not-allowed;
}

/* Payment Methods */
.payment-methods {
    display: grid;
    gap: 16px;
    margin-bottom: 24px;
}

.payment-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    background: var(--qlower-white);
    transition: all 0.2s ease;
}

.payment-card:hover {
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.payment-default {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.05) 0%, rgba(19, 124, 139, 0.02) 100%);
}

.payment-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.payment-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 32px;
}

.card-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 4px;
    font-weight: 700;
    font-size: 12px;
}

.visa-logo {
    background: linear-gradient(135deg, #1a1f71 0%, #0066cc 100%);
    color: white;
}

.mastercard-logo {
    position: relative;
    background: #000;
}

.mc-circle {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
}

.mc-red {
    background: #eb001b;
    left: 8px;
}

.mc-yellow {
    background: #ff5f00;
    right: 8px;
}

.amex-logo {
    background: linear-gradient(135deg, #006fcf 0%, #00a8cc 100%);
    color: white;
    font-size: 10px;
}

.generic-logo {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-light);
}

.payment-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.payment-number {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--qlower-dark);
    letter-spacing: 1px;
}

.payment-meta {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: var(--qlower-text-light);
}

.payment-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.payment-badge {
    background: var(--qlower-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.payment-btn-secondary, .payment-btn-danger {
    background: none;
    border: 1px solid;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.payment-btn-secondary {
    border-color: var(--qlower-primary);
    color: var(--qlower-primary);
}

.payment-btn-secondary:hover {
    background: var(--qlower-primary);
    color: white;
}

.payment-btn-danger {
    border-color: var(--debt-primary);
    color: var(--debt-primary);
    padding: 6px 8px;
}

.payment-btn-danger:hover {
    background: var(--debt-primary);
    color: white;
}

.payment-btn-disabled {
    border: 1px solid #d1d5db;
    color: #9ca3af;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: not-allowed;
    background: #f9fafb;
    transition: none;
}

.payment-btn-disabled:hover {
    background: #f9fafb;
    color: #9ca3af;
    border-color: #d1d5db;
}

.payment-add-section {
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
    text-align: center;
}

.no-payment-methods {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.no-payment-methods i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--qlower-primary);
}

.no-payment-methods h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

/* Edit Info Form */
.edit-info-form {
    display: grid;
    gap: 20px;
}

.form-help {
    font-size: 12px;
    color: var(--qlower-text-light);
    margin-top: 4px;
    font-style: italic;
}

.form-control:disabled {
    background-color: var(--qlower-bg-light);
    color: var(--qlower-text-light);
    cursor: not-allowed;
}

/* Payment Form */
.payment-form {
    display: grid;
    gap: 20px;
}

.form-row {
    display: grid;
    gap: 16px;
}

.form-group-half {
    grid-column: span 1;
}

.form-row:has(.form-group-half) {
    grid-template-columns: 1fr 1fr;
}

.card-type-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 600;
}

.form-group {
    position: relative;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: var(--qlower-text-dark);
    cursor: pointer;
}

.checkbox-container input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin: 0;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--qlower-border);
}

/* Responsive */
@media (max-width: 768px) {
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .subscription-plan {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }
    
    .invoice-form {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .plans-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    .payment-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .payment-actions {
        align-self: stretch;
        justify-content: space-between;
    }
    
    .form-row:has(.form-group-half) {
        grid-template-columns: 1fr;
    }
    
    .modal-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Stripe Elements -->
<script src="https://js.stripe.com/v3/"></script>
<script>
// V√©rifier que Stripe.js est bien charg√©
console.log('üîç V√©rification Stripe.js:', typeof Stripe !== 'undefined' ? '‚úÖ Charg√©' : '‚ùå Non charg√©');

// Fonctions de gestion des modales
function showPlanSelector() {
    document.getElementById('planModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hidePlanSelector() {
    document.getElementById('planModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Changement de plan
function changePlan(planTier) {
    if (confirm(`√ätes-vous s√ªr de vouloir changer pour le plan ${planTier.toUpperCase()} ?`)) {
        // Afficher un indicateur de chargement
        const loadingMessage = "Traitement du changement de plan en cours...";
        
        // Afficher une notification de chargement (optionnel)
        const originalConfirm = window.confirm;
        
        fetch('/plateforme/profil/changer-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tier: planTier
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let successMessage = data.message;
                
                // Ajouter des informations sur la proration si c'est un upgrade
                if (data.proration_message) {
                    successMessage += '\n\nüí≥ ' + data.proration_message;
                }
                
                // Ajouter des informations sur le downgrade
                if (data.downgrade_message) {
                    successMessage += '\n\nüìã ' + data.downgrade_message;
                }
                
                // Ajouter les d√©tails du nouveau plan
                if (data.new_monthly_price) {
                    successMessage += `\n\nüìä Nouveau tarif mensuel: ${data.new_monthly_price}‚Ç¨/mois`;
                }
                
                // Afficher un avertissement si mode d√©grad√©
                if (data.warning) {
                    successMessage += '\n\n‚ö†Ô∏è ' + data.warning;
                }
                
                alert(successMessage);
                location.reload();
            } else {
                let errorMessage = 'Erreur lors du changement de plan: ' + data.message;
                
                // Messages sp√©cifiques pour certaines erreurs
                if (data.message.includes('ULTIMA')) {
                    errorMessage += '\n\nVeuillez utiliser le bouton "Nous contacter" pour le plan ULTIMA.';
                }
                
                alert(errorMessage);
            }
        })
        .catch(error => {
            console.error('Erreur r√©seau:', error);
            alert('Erreur de connexion lors du changement de plan. Veuillez r√©essayer ou nous contacter si le probl√®me persiste.');
        });
    }
}

// Contact pour ULTIMA
function contactForUltima() {
    alert('Vous allez √™tre redirig√© vers notre √©quipe commerciale pour discuter du plan ULTIMA sur-mesure.');
    // Ici on pourrait ouvrir un formulaire de contact ou rediriger vers une page de contact
    window.open('mailto:contact@atlas-patrimoine.fr?subject=Demande plan ULTIMA&body=Bonjour, je souhaite obtenir plus d\'informations sur le plan ULTIMA et ses tarifs personnalis√©s.', '_blank');
}

// Gestion modal d√©sabonnement
function showCancelSubscriptionModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideCancelSubscriptionModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('cancellationReason').value = '';
}

function downgradeToPlan() {
    if (confirm('Passer au plan INITIA √† 25‚Ç¨/mois au lieu d\'annuler ?')) {
        hideCancelSubscriptionModal();
        changePlan('initia');
    }
}

function directCancellation() {
    const reason = document.getElementById('cancellationReason').value;
    
    if (confirm('√ätes-vous s√ªr de vouloir arr√™ter votre abonnement ?')) {
        processCancellation(reason, null);
    }
}

function processCancellation(reason, otherReason) {
    const feedbackData = {
        reason: reason,
        other_reason: reason === 'other' ? otherReason : null
    };
    
    fetch('/plateforme/profil/annuler-abonnement', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(feedbackData)
    })
    .then(response => response.json())
    .then(data => {
        hideCancelSubscriptionModal();
        
        if (data.success) {
            alert('‚úÖ Votre abonnement a √©t√© annul√©.\n\n' +
                  'Vous conserverez l\'acc√®s jusqu\'√† la fin de votre p√©riode de facturation.\n\n' +
                  'Merci d\'avoir utilis√© Atlas. Nous esp√©rons vous revoir bient√¥t !');
            
            // Rediriger vers la page d'accueil ou recharger
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert('‚ùå Erreur lors de l\'annulation: ' + (data.error || data.message));
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        hideCancelSubscriptionModal();
        alert('‚ùå Erreur de connexion lors de l\'annulation. Veuillez r√©essayer ou nous contacter.');
    });
}

// Edit Info Modal Functions
function showEditInfoModal() {
    document.getElementById('editInfoModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideEditInfoModal() {
    document.getElementById('editInfoModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form to original values
    document.getElementById('editFirstName').value = '{{ current_user.first_name }}';
    document.getElementById('editLastName').value = '{{ current_user.last_name }}';
    document.getElementById('editPhone').value = '{{ current_user.phone or '' }}';
}

// Edit info form submission
function submitEditInfoForm(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    const data = {
        first_name: formData.get('first_name').trim(),
        last_name: formData.get('last_name').trim(),
        phone: formData.get('phone').trim() || null
    };
    
    // Basic validation
    if (!data.first_name || !data.last_name) {
        alert('Le pr√©nom et le nom sont obligatoires');
        return;
    }
    
    // Phone validation (optional)
    if (data.phone && !/^[0-9\s\-\+\(\)\.]{10,}$/.test(data.phone)) {
        alert('Format de t√©l√©phone invalide');
        return;
    }
    
    fetch('/plateforme/profil/modifier-infos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Informations mises √† jour avec succ√®s !');
            hideEditInfoModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour des informations: ' + error.message);
    });
}

// G√©n√©ration de facture
function generateInvoice() {
    const month = document.getElementById('invoiceMonth').value;
    const year = document.getElementById('invoiceYear').value;
    
    if (!month || !year) {
        alert('Veuillez s√©lectionner un mois et une ann√©e');
        return;
    }
    
    // Cr√©er l'URL pour t√©l√©charger la facture
    const downloadUrl = `/plateforme/profil/facture/${year}/${month}`;
    
    // Ouvrir dans un nouvel onglet pour t√©l√©chargement
    window.open(downloadUrl, '_blank');
}

// Fermer modal avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hidePlanSelector();
    }
});

// Fermer modal en cliquant √† l'ext√©rieur
document.getElementById('planModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hidePlanSelector();
    }
});


// Variables globales Stripe
let stripe = null;
let elements = null;
let cardElement = null;

// Initialiser Stripe √† partir du backend
async function initializeStripe() {
    try {
        console.log('üîÑ Tentative d\'initialisation Stripe...');
        console.log('üîç Stripe global disponible:', typeof Stripe !== 'undefined');
        
        // V√©rifier que Stripe.js est charg√©
        if (typeof Stripe === 'undefined') {
            console.error('‚ùå Stripe.js non charg√© !');
            return false;
        }
        
        // R√©cup√©rer la cl√© publique depuis le backend
        console.log('üì° Appel vers /plateforme/profil/stripe-config...');
        const response = await fetch('/plateforme/profil/stripe-config');
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response OK:', response.ok);
        
        if (!response.ok) {
            console.error('‚ùå Erreur HTTP:', response.status, response.statusText);
            return false;
        }
        
        const config = await response.json();
        console.log('üì° R√©ponse du serveur:', config);
        
        if (config.success && config.publishable_key) {
            console.log('üîë Cr√©ation instance Stripe avec cl√©:', config.publishable_key.substring(0, 20) + '...');
            stripe = Stripe(config.publishable_key);
            console.log('‚úÖ Stripe initialis√© avec succ√®s !');
            console.log('‚úÖ Instance stripe:', !!stripe);
            return true;
        } else {
            console.warn('‚ö†Ô∏è Stripe non disponible:', config.error || 'Configuration invalide');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Erreur initialisation Stripe:', error);
        console.error('‚ùå Stack:', error.stack);
        return false;
    }
}

// Payment Methods Functions - Version simplifi√©e avec Stripe Checkout
async function addPaymentMethodWithCheckout() {
    try {
        console.log('üîÑ D√©marrage ajout moyen de paiement...');
        
        // S'assurer que Stripe est initialis√©
        if (!stripe && !(await initializeStripe())) {
            alert('‚ùå Service de paiement non disponible.\n\nVeuillez r√©essayer plus tard ou contactez le support.');
            return;
        }

        console.log('‚úÖ Stripe initialis√©, cr√©ation du SetupIntent...');

        // Cr√©er un SetupIntent c√¥t√© serveur pour collecter les infos de paiement
        const response = await fetch('/plateforme/profil/create-payment-setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const setup = await response.json();
        console.log('üì° R√©ponse SetupIntent:', setup);

        if (!setup.success) {
            alert(`‚ùå Erreur: ${setup.error}`);
            return;
        }

        // Rediriger vers Stripe Checkout pour Setup
        const { error } = await stripe.redirectToCheckout({
            sessionId: setup.session_id
        });

        if (error) {
            console.error('‚ùå Erreur redirection Stripe:', error);
            alert(`‚ùå Erreur de redirection: ${error.message}`);
        }

    } catch (error) {
        console.error('‚ùå Erreur ajout moyen de paiement:', error);
        alert('‚ùå Une erreur est survenue. Veuillez r√©essayer.');
    }
}

function hideAddPaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('stripe-payment-form').reset();
    document.getElementById('stripe-cardholder-name').value = '{{ current_user.first_name }} {{ current_user.last_name }}';
    document.getElementById('stripe-set-as-default').checked = true;
    
    // Clear Stripe errors
    const errorElement = document.getElementById('stripe-card-errors');
    errorElement.textContent = '';
    
    if (cardElement) {
        cardElement.clear();
    }
}

// Configurer Stripe Elements
function setupStripeElements() {
    if (!stripe) {
        console.error('‚ùå Stripe non initialis√©');
        return;
    }
    
    console.log('üîß Configuration Stripe Elements...');
    
    try {
        // D√©truire les anciens √©l√©ments s'ils existent
        if (cardElement) {
            try {
                cardElement.unmount();
                cardElement.destroy();
            } catch (e) {
                console.log('Ancien cardElement d√©j√† d√©truit');
            }
        }
        if (elements) {
            try {
                elements = null;
            } catch (e) {}
        }
        
        // Cr√©er les elements avec la locale fran√ßaise
        elements = stripe.elements({
            locale: 'fr'
        });
        
        console.log('‚úÖ Stripe elements instance cr√©√©e');
        
        // Style pour le champ carte - simplifi√© pour √©viter les probl√®mes CSS
        const style = {
            base: {
                fontSize: '16px',
                color: '#424770',
                fontFamily: 'system-ui, -apple-system, sans-serif',
                lineHeight: '1.5',
                padding: '10px 14px',
                '::placeholder': {
                    color: '#a0a0a0',
                },
            },
            invalid: {
                color: '#dc2626',
            },
            complete: {
                color: '#059669',
            }
        };
        
        // Options simplifi√©es pour √©viter les conflits
        const cardOptions = {
            style: style,
            hidePostalCode: true,
            disableLink: true,
        };
        
        // Cr√©er le champ carte
        cardElement = elements.create('card', cardOptions);
        
        console.log('‚úÖ Card element cr√©√©');
        
        // V√©rifier que le container existe avant de monter
        const container = document.getElementById('stripe-card-element');
        if (!container) {
            console.error('‚ùå Container #stripe-card-element introuvable');
            return;
        }
        
        // Vider le container avant de monter
        container.innerHTML = '';
        
        // Monter le champ dans le DOM
        cardElement.mount('#stripe-card-element');
        console.log('‚úÖ Card element mont√© dans le DOM');
        
        // G√©rer les erreurs en temps r√©el
        cardElement.on('change', ({ error, complete }) => {
            const displayError = document.getElementById('stripe-card-errors');
            if (error) {
                displayError.textContent = error.message;
                console.warn('üî• Erreur Stripe:', error.message);
            } else {
                displayError.textContent = '';
            }
            
            // Indiquer visuellement quand le champ est complet
            const cardContainer = document.getElementById('stripe-card-element');
            if (complete) {
                cardContainer.classList.add('stripe-complete');
                console.log('‚úÖ Informations de carte compl√®tes');
            } else {
                cardContainer.classList.remove('stripe-complete');
            }
        });
        
        // Event pour savoir quand l'√©l√©ment est pr√™t
        cardElement.on('ready', () => {
            console.log('üéâ Stripe Elements pr√™t et interactif !');
            
            // V√©rifier une derni√®re fois que l'iframe est bien l√†
            setTimeout(() => {
                const iframe = container.querySelector('iframe');
                if (iframe) {
                    console.log('‚úÖ iframe Stripe Elements trouv√©e');
                    // S'assurer que l'iframe est visible et interactive
                    iframe.style.pointerEvents = 'auto';
                    iframe.style.minHeight = '40px';
                } else {
                    console.error('‚ùå iframe Stripe Elements manquante apr√®s ready');
                }
            }, 100);
        });
        
        // Event pour les erreurs de montage
        cardElement.on('escape', () => {
            console.log('Escape pressed dans Stripe Elements');
        });
        
        console.log('‚úÖ Stripe Elements configur√© avec gestionnaires d\'√©v√©nements');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la configuration Stripe Elements:', error);
        
        // Afficher l'erreur dans le container
        const container = document.getElementById('stripe-card-element');
        if (container) {
            container.innerHTML = `
                <div style="
                    padding: 20px;
                    text-align: center;
                    color: #dc2626;
                    border: 2px solid #dc2626;
                    border-radius: 8px;
                    background: #fef2f2;
                ">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <div style="font-weight: 500; margin-bottom: 4px;">Erreur Stripe Elements</div>
                    <div style="font-size: 14px;">${error.message}</div>
                </div>
            `;
        }
    }
}

// Charger les moyens de paiement depuis Stripe
function loadPaymentMethods() {
    // Afficher le loading
    document.getElementById('payment-methods-loading').style.display = 'block';
    document.getElementById('payment-methods-list').style.display = 'none';
    document.getElementById('payment-methods-empty').style.display = 'none';
    document.getElementById('payment-methods-error').style.display = 'none';
    
    fetch('/plateforme/profil/moyens-paiement')
        .then(response => response.json())
        .then(data => {
            document.getElementById('payment-methods-loading').style.display = 'none';
            
            if (data.success) {
                if (data.payment_methods && data.payment_methods.length > 0) {
                    displayPaymentMethods(data.payment_methods);
                } else {
                    // Afficher un message personnalis√© s'il y en a un
                    const emptyDiv = document.getElementById('payment-methods-empty');
                    if (data.message) {
                        emptyDiv.innerHTML = `
                            <div class="payment-empty-message">
                                <i class="fas fa-info-circle text-primary"></i>
                                <h4>Information</h4>
                                <p>${data.message}</p>
                            </div>
                        `;
                    }
                    emptyDiv.style.display = 'block';
                }
            } else {
                const errorDiv = document.getElementById('payment-methods-error');
                errorDiv.innerHTML = `
                    <div class="payment-empty-message">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Service indisponible</h4>
                        <p>${data.error || 'Impossible de r√©cup√©rer vos moyens de paiement.'}</p>
                        ${!data.error || !data.error.includes('d√©veloppement') ? '<button onclick="loadPaymentMethods()" class="btn btn-link p-0">R√©essayer</button>' : ''}
                    </div>
                `;
                errorDiv.style.display = 'block';
                console.error('Erreur:', data.error);
            }
        })
        .catch(error => {
            document.getElementById('payment-methods-loading').style.display = 'none';
            const errorDiv = document.getElementById('payment-methods-error');
            errorDiv.innerHTML = `
                <div class="payment-empty-message">
                    <i class="fas fa-wifi text-danger"></i>
                    <h4>Erreur de connexion</h4>
                    <p>V√©rifiez votre connexion internet. <button onclick="loadPaymentMethods()" class="btn btn-link p-0">R√©essayer</button></p>
                </div>
            `;
            errorDiv.style.display = 'block';
            console.error('Erreur r√©seau:', error);
        });
}

// Afficher les moyens de paiement
function displayPaymentMethods(paymentMethods) {
    const container = document.getElementById('payment-methods-list');
    container.innerHTML = '';
    
    const isOnlyPaymentMethod = paymentMethods.length === 1;
    
    paymentMethods.forEach(pm => {
        const cardHtml = `
            <div class="payment-card ${pm.is_default ? 'payment-default' : ''}">
                <div class="payment-info">
                    <div class="payment-logo">
                        ${getCardLogo(pm.card_type)}
                    </div>
                    
                    <div class="payment-details">
                        <div class="payment-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${pm.last4}</div>
                        <div class="payment-meta">
                            <span class="payment-name">${pm.cardholder_name}</span>
                            <span class="payment-expiry">${pm.exp_month}/${pm.exp_year}</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-actions">
                    ${pm.is_default ? 
                        '<span class="payment-badge">Par d√©faut</span>' :
                        `<button class="payment-btn-secondary" onclick="setDefaultPayment('${pm.id}')">D√©finir par d√©faut</button>`
                    }
                    
                    ${isOnlyPaymentMethod ? 
                        `<button class="payment-btn-disabled" disabled title="Ajoutez une autre carte avant de supprimer celle-ci">
                            <i class="fas fa-lock"></i>
                        </button>` :
                        `<button class="payment-btn-danger" onclick="removePayment('${pm.id}')">
                            <i class="fas fa-trash"></i>
                        </button>`
                    }
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;
    });
    
    document.getElementById('payment-methods-list').style.display = 'block';
}

// G√©n√©rer le logo de la carte
function getCardLogo(cardType) {
    switch(cardType) {
        case 'visa':
            return '<div class="card-logo visa-logo"><span>VISA</span></div>';
        case 'mastercard':
            return `
                <div class="card-logo mastercard-logo">
                    <div class="mc-circle mc-red"></div>
                    <div class="mc-circle mc-yellow"></div>
                </div>
            `;
        case 'amex':
            return '<div class="card-logo amex-logo"><span>AMEX</span></div>';
        default:
            return '<div class="card-logo generic-logo"><i class="fas fa-credit-card"></i></div>';
    }
}

// Set default payment method
function setDefaultPayment(paymentMethodId) {
    if (confirm('D√©finir cette carte comme moyen de paiement par d√©faut ?')) {
        fetch('/plateforme/profil/paiement/defaut', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_method_id: paymentMethodId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadPaymentMethods(); // Recharger la liste
            } else {
                alert('Erreur: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la modification.');
        });
    }
}

// Remove payment method
function removePayment(paymentMethodId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette carte ?')) {
        fetch('/plateforme/profil/paiement/supprimer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_method_id: paymentMethodId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Message de succ√®s
                if (data.message.includes('nouveau moyen par d√©faut')) {
                    alert('‚úÖ ' + data.message);
                }
                loadPaymentMethods(); // Recharger la liste
            } else {
                // Messages d'erreur plus informatifs
                let errorMessage = data.error || data.message;
                if (errorMessage.includes('unique moyen de paiement')) {
                    errorMessage = '‚ö†Ô∏è ' + errorMessage + '\n\nüí° Conseil : Ajoutez d\'abord une nouvelle carte, puis supprimez l\'ancienne.';
                }
                alert(errorMessage);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('‚ùå Erreur de connexion lors de la suppression. Veuillez r√©essayer.');
        });
    }
}

// Gestion formulaire Stripe Elements
async function handleStripePaymentForm(event) {
    event.preventDefault();
    
    if (!stripe || !cardElement) {
        alert('‚ùå Service de paiement non initialis√©');
        return;
    }
    
    // D√©sactiver le bouton et montrer le loading
    const submitButton = document.getElementById('stripe-submit-btn');
    const loadingDiv = document.getElementById('stripe-loading');
    const formDiv = document.getElementById('stripe-payment-form');
    
    submitButton.disabled = true;
    loadingDiv.style.display = 'block';
    formDiv.style.display = 'none';
    
    try {
        // 1. Cr√©er un SetupIntent c√¥t√© serveur
        const setupResponse = await fetch('/plateforme/profil/paiement/ajouter-setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const setupData = await setupResponse.json();
        if (!setupData.success) {
            throw new Error(setupData.error || 'Erreur cr√©ation SetupIntent');
        }
        
        // 2. Confirmer avec Stripe Elements
        const cardholderName = document.getElementById('stripe-cardholder-name').value;
        
        const { error, setupIntent } = await stripe.confirmCardSetup(
            setupData.client_secret,
            {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                }
            }
        );
        
        if (error) {
            throw new Error(error.message);
        }
        
        // 3. Finaliser c√¥t√© serveur
        const setAsDefault = document.getElementById('stripe-set-as-default').checked;
        
        const finalResponse = await fetch('/plateforme/profil/ajouter-carte-stripe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                setup_intent_id: setupIntent.id,
                set_as_default: setAsDefault
            })
        });
        
        const finalData = await finalResponse.json();
        if (finalData.success) {
            alert('‚úÖ ' + finalData.message);
            hideAddPaymentModal();
            loadPaymentMethods(); // Recharger la liste
        } else {
            throw new Error(finalData.error || 'Erreur ajout carte');
        }
        
    } catch (error) {
        console.error('Erreur ajout carte:', error);
        alert('‚ùå Erreur: ' + error.message);
        
        // Remettre le formulaire visible
        loadingDiv.style.display = 'none';
        formDiv.style.display = 'block';
        submitButton.disabled = false;
    }
}

// Charger les factures depuis Stripe
function loadInvoices() {
    // Afficher le loading
    document.getElementById('invoices-loading').style.display = 'block';
    document.getElementById('invoices-list').style.display = 'none';
    document.getElementById('invoices-empty').style.display = 'none';
    document.getElementById('invoices-error').style.display = 'none';
    
    fetch('/plateforme/profil/factures-stripe')
        .then(response => response.json())
        .then(data => {
            document.getElementById('invoices-loading').style.display = 'none';
            
            if (data.success) {
                if (data.invoices && data.invoices.length > 0) {
                    displayInvoices(data.invoices);
                } else {
                    // Afficher un message personnalis√© s'il y en a un
                    const emptyDiv = document.getElementById('invoices-empty');
                    if (data.message) {
                        emptyDiv.innerHTML = `
                            <div class="no-invoices">
                                <i class="fas fa-info-circle text-primary"></i>
                                <h4>Information</h4>
                                <p>${data.message}</p>
                            </div>
                        `;
                    }
                    emptyDiv.style.display = 'block';
                }
            } else {
                const errorDiv = document.getElementById('invoices-error');
                errorDiv.innerHTML = `
                    <div class="no-invoices">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Service indisponible</h4>
                        <p>${data.error || 'Impossible de r√©cup√©rer vos factures.'} <button onclick="loadInvoices()" class="btn btn-link p-0">R√©essayer</button></p>
                    </div>
                `;
                errorDiv.style.display = 'block';
                console.error('Erreur:', data.error);
            }
        })
        .catch(error => {
            document.getElementById('invoices-loading').style.display = 'none';
            const errorDiv = document.getElementById('invoices-error');
            errorDiv.innerHTML = `
                <div class="no-invoices">
                    <i class="fas fa-wifi text-danger"></i>
                    <h4>Erreur de connexion</h4>
                    <p>V√©rifiez votre connexion internet. <button onclick="loadInvoices()" class="btn btn-link p-0">R√©essayer</button></p>
                </div>
            `;
            errorDiv.style.display = 'block';
            console.error('Erreur r√©seau:', error);
        });
}

// Afficher les factures
function displayInvoices(invoices) {
    const container = document.getElementById('invoices-list');
    container.innerHTML = '';
    
    if (invoices.length === 0) {
        document.getElementById('invoices-empty').style.display = 'block';
        return;
    }
    
    invoices.forEach(invoice => {
        const invoiceDate = new Date(invoice.created * 1000);
        const periodStart = new Date(invoice.period_start * 1000);
        const periodEnd = new Date(invoice.period_end * 1000);
        
        const statusClass = invoice.status === 'paid' ? 'success' : 
                           invoice.status === 'open' ? 'warning' : 'danger';
        
        const statusText = invoice.status === 'paid' ? 'Pay√©e' :
                          invoice.status === 'open' ? 'En attente' : '√âchec';
        
        const invoiceCard = document.createElement('div');
        invoiceCard.className = 'invoice-card';
        invoiceCard.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        `;
        
        invoiceCard.innerHTML = `
            <div class="invoice-details">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <h4 style="margin: 0; font-size: 16px; color: #1f2937; font-weight: 600;">
                        ${invoice.number || 'Facture #' + invoice.id.substring(3, 8)}
                    </h4>
                    <span style="
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                        background: ${statusClass === 'success' ? '#d1fae5' : statusClass === 'warning' ? '#fef3c7' : '#fee2e2'};
                        color: ${statusClass === 'success' ? '#065f46' : statusClass === 'warning' ? '#92400e' : '#991b1b'};
                    ">
                        ${statusText}
                    </span>
                </div>
                <div style="color: #6b7280; font-size: 14px; line-height: 1.5;">
                    <div style="margin-bottom: 4px;">${invoice.description}</div>
                    <div>P√©riode: ${periodStart.toLocaleDateString('fr-FR')} - ${periodEnd.toLocaleDateString('fr-FR')}</div>
                    <div>Date: ${invoiceDate.toLocaleDateString('fr-FR')}</div>
                </div>
            </div>
            <div class="invoice-actions" style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                <div style="font-size: 18px; font-weight: 700; color: #137C8B;">
                    ${invoice.amount_paid.toFixed(2)}‚Ç¨
                </div>
                ${invoice.invoice_pdf ? 
                    `<a href="${invoice.invoice_pdf}" target="_blank" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        background: #137C8B;
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 500;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#0f6b75'" onmouseout="this.style.background='#137C8B'">
                        <i class="fas fa-download"></i> T√©l√©charger
                    </a>` : 
                    `<a href="${invoice.hosted_invoice_url}" target="_blank" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        background: #137C8B;
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 500;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#0f6b75'" onmouseout="this.style.background='#137C8B'">
                        <i class="fas fa-external-link-alt"></i> Voir facture
                    </a>`
                }
            </div>
        `;
        
        container.appendChild(invoiceCard);
    });
    
    document.getElementById('invoices-list').style.display = 'block';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Charger les moyens de paiement et les factures au d√©marrage
    loadPaymentMethods();
    loadInvoices();
    
    // Dropdown de raison simplifi√©e - plus de logique sp√©ciale n√©cessaire
    
    // Card number formatting
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function() {
            formatCardNumber(this);
        });
    }
    
    // Stripe payment form submission
    const stripePaymentForm = document.getElementById('stripe-payment-form');
    if (stripePaymentForm) {
        stripePaymentForm.addEventListener('submit', handleStripePaymentForm);
    }
    
    // Edit info form submission
    const editInfoForm = document.getElementById('editInfoForm');
    if (editInfoForm) {
        editInfoForm.addEventListener('submit', submitEditInfoForm);
    }
    
    // Close modals with Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideAddPaymentModal();
            hideEditInfoModal();
        }
    });
    
    // Close modals by clicking outside
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddPaymentModal();
            }
        });
    }
    
    const editInfoModal = document.getElementById('editInfoModal');
    if (editInfoModal) {
        editInfoModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideEditInfoModal();
            }
        });
    }
});
</script>
{% endblock %}