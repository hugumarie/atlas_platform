{% extends "platform/base.html" %}

{% block title %}Mon Profil - Atlas{% endblock %}

{% block page_title %}Mon Profil{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Section Mes Infos -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-user text-primary"></i>
                Mes informations
            </h3>
            <p class="platform-card-subtitle">Vos informations personnelles</p>
        </div>
        <div class="platform-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Prénom</div>
                    <div class="info-value">{{ current_user.first_name or 'Non renseigné' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Nom</div>
                    <div class="info-value">{{ current_user.last_name or 'Non renseigné' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ current_user.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Téléphone</div>
                    <div class="info-value">{{ current_user.phone or 'Non renseigné' }}</div>
                </div>
            </div>
            
            <div class="info-actions">
                <button class="platform-btn platform-btn-secondary" onclick="showEditInfoModal()">
                    <i class="fas fa-edit"></i>
                    Modifier mes informations
                </button>
            </div>
        </div>
    </div>

    <!-- Section Mon Abonnement -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-crown text-primary"></i>
                Mon abonnement
            </h3>
            <p class="platform-card-subtitle">Gérez votre plan d'abonnement</p>
        </div>
        <div class="platform-card-body">
            {% if current_user.subscription %}
            <div class="subscription-info">
                <!-- Plan actuel avec détails -->
                <div class="subscription-plan">
                    {% if current_user.subscription.tier == 'initia' %}
                    <div class="plan-card plan-initia">
                        <div class="plan-header">
                            <div class="plan-badge plan-initia">
                                <i class="fas fa-seedling"></i>
                                INITIA
                            </div>
                            <div class="plan-subtitle">Pour débuter sereinement</div>
                        </div>
                        <div class="plan-price">
                            <span class="price-amount">€25</span>
                            <span class="price-period">/mois</span>
                        </div>
                        <div class="plan-features">
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Analyse de situation patrimoniale</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Stratégie d'investissement personnalisée</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Tableau de bord Atlas</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Pilotage de vos investissements</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Contenus pédagogiques</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Accompagnement 100% indépendant</span>
                            </div>
                        </div>
                    </div>
                    {% elif current_user.subscription.tier == 'optima' %}
                    <div class="plan-card plan-optima">
                        <div class="plan-header">
                            <div class="plan-badge">
                                <i class="fas fa-crown"></i>
                                OPTIMA
                                <span class="popular-badge">Le plus populaire</span>
                            </div>
                            <div class="plan-subtitle">Pour structurer votre patrimoine</div>
                        </div>
                        <div class="plan-price">
                            <span class="price-amount">€50</span>
                            <span class="price-period">/mois</span>
                        </div>
                        <div class="plan-features">
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Tout INITIA inclus</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Optimisation patrimoine existant</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Classes d'actifs supplémentaires</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Allocation multi-actifs</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Optimisation transmission</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check"></i>
                                <span>Problématiques spécifiques</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="subscription-status">
                    <div class="status-item">
                        <div class="status-label">Statut</div>
                        <div class="status-value status-{{ current_user.subscription.status }}">
                            {{ current_user.subscription.get_status_display() }}
                        </div>
                    </div>
                    {% if current_user.subscription.next_billing_date %}
                    <div class="status-item">
                        <div class="status-label">Prochaine facturation</div>
                        <div class="status-value">
                            {{ current_user.subscription.next_billing_date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    {% endif %}
                    {% if current_user.subscription.start_date %}
                    <div class="status-item">
                        <div class="status-label">Abonné depuis</div>
                        <div class="status-value">
                            {{ current_user.subscription.start_date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="subscription-actions">
                <button class="platform-btn platform-btn-primary" onclick="showPlanSelector()">
                    <i class="fas fa-exchange-alt"></i>
                    Changer d'abonnement
                </button>
                
                <button class="platform-btn platform-btn-cancel-subscription" onclick="showCancelSubscriptionModal()">
                    <i class="fas fa-times-circle"></i>
                    Se désabonner
                </button>
            </div>
            {% else %}
            <div class="no-subscription">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Aucun abonnement actif</h4>
                <p>Vous n'avez pas d'abonnement actif. Souscrivez à un plan pour accéder à toutes les fonctionnalités.</p>
                <button class="platform-btn platform-btn-primary">
                    <i class="fas fa-plus"></i>
                    Choisir un plan
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section Moyens de paiement -->
    <div class="platform-card mb-4">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-credit-card text-primary"></i>
                Moyens de paiement
            </h3>
            <p class="platform-card-subtitle">Gérez vos cartes de paiement</p>
        </div>
        <div class="platform-card-body">
            <div id="payment-methods-container">
                <div id="payment-methods-loading" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p style="margin-top: 16px;">Chargement des moyens de paiement...</p>
                </div>
                
                <div id="payment-methods-list" style="display: none;">
                    <!-- Les moyens de paiement seront injectés ici via JavaScript -->
                </div>
                
                <div id="payment-methods-empty" style="display: none;">
                    <div class="no-payment-methods">
                        <i class="fas fa-credit-card"></i>
                        <h4>Aucun moyen de paiement</h4>
                        <p>Ajoutez une carte pour faciliter vos paiements.</p>
                    </div>
                </div>
                
                <div id="payment-methods-error" style="display: none;">
                    <div class="no-payment-methods">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Erreur de chargement</h4>
                        <p>Impossible de récupérer vos moyens de paiement. <button onclick="loadPaymentMethods()" class="btn btn-link p-0">Réessayer</button></p>
                    </div>
                </div>
            </div>
            
            <div class="payment-add-section">
                <button class="platform-btn platform-btn-primary" onclick="addPaymentMethodWithCheckout()">
                    <i class="fas fa-plus"></i>
                    Ajouter un nouveau moyen de paiement
                </button>
                <p style="font-size: 12px; color: #6b7280; margin-top: 8px; text-align: center;">
                    <i class="fas fa-shield-alt"></i>
                    Sécurisé par Stripe - Vos données ne transitent jamais par nos serveurs
                </p>
            </div>
        </div>
    </div>

    <!-- Section Factures -->
    <div class="platform-card">
        <div class="platform-card-header">
            <h3 class="platform-card-title">
                <i class="fas fa-file-invoice text-primary"></i>
                Mes factures
            </h3>
            <p class="platform-card-subtitle">Téléchargez vos factures mensuelles</p>
        </div>
        <div class="platform-card-body">
            <div id="invoices-container">
                <div id="invoices-loading" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p style="margin-top: 16px;">Chargement de vos factures...</p>
                </div>
                
                <div id="invoices-list" style="display: none;">
                    <!-- Les factures seront injectées ici via JavaScript -->
                </div>
                
                <div id="invoices-empty" style="display: none;">
                    <div class="no-invoices">
                        <i class="fas fa-file-invoice"></i>
                        <h4>Aucune facture disponible</h4>
                        <p>Vos factures apparaîtront ici après vos premiers paiements.</p>
                    </div>
                </div>
                
                <div id="invoices-error" style="display: none;">
                    <div class="no-invoices">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Erreur de chargement</h4>
                        <p>Impossible de récupérer vos factures. <button onclick="loadInvoices()" class="btn btn-link p-0">Réessayer</button></p>
                    </div>
                </div>
            </div>
            
            <div class="invoice-info">
                <i class="fas fa-info-circle"></i>
                <p>Vos factures sont automatiquement générées par Stripe lors de chaque paiement. Cliquez sur "Télécharger" pour obtenir le PDF officiel.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sélection Plan -->
<div id="planModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Changer d'abonnement</h3>
            <button class="modal-close" onclick="hidePlanSelector()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="plans-grid">
                <div class="plan-option" data-plan="initia">
                    <div class="plan-name">INITIA</div>
                    <div class="plan-subtitle">"Pour débuter dans l'investissement"</div>
                    <div class="plan-price">25€<span>/mois</span></div>
                    <div class="plan-features">
                        <div class="feature">✓ Analyse de situation patrimoniale</div>
                        <div class="feature">✓ Stratégie d'investissement personnalisée</div>
                        <div class="feature">✓ Tableau de bord Atlas</div>
                        <div class="feature">✓ Pilotage de vos investissements</div>
                        <div class="feature">✓ Contenus pédagogiques</div>
                        <div class="feature">✓ Accompagnement 100% indépendant</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'initia' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select" onclick="changePlan('initia')">
                        {% if current_user.subscription and current_user.subscription.tier == 'optima' %}
                        Rétrograder
                        {% else %}
                        Choisir ce plan
                        {% endif %}
                    </button>
                    {% endif %}
                </div>
                
                <div class="plan-option plan-popular" data-plan="optima">
                    <div class="plan-badge-popular">Le plus populaire</div>
                    <div class="plan-name">OPTIMA</div>
                    <div class="plan-subtitle">"Pour structurer et optimiser son patrimoine existant"</div>
                    <div class="plan-price">50€<span>/mois</span></div>
                    <div class="plan-features">
                        <div class="feature">✓ Tout INITIA inclus</div>
                        <div class="feature">✓ Optimisation patrimoine existant</div>
                        <div class="feature">✓ Classes d'actifs supplémentaires</div>
                        <div class="feature">✓ Allocation multi-actifs</div>
                        <div class="feature">✓ Optimisation transmission</div>
                        <div class="feature">✓ Problématiques spécifiques</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'optima' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select plan-btn-upgrade" onclick="changePlan('optima')">
                        {% if current_user.subscription and current_user.subscription.tier == 'initia' %}
                        Passer à OPTIMA
                        {% else %}
                        Choisir ce plan
                        {% endif %}
                    </button>
                    {% endif %}
                </div>
                
                <div class="plan-option" data-plan="ultima">
                    <div class="plan-name">ULTIMA</div>
                    <div class="plan-subtitle">"Pour des situations patrimoniales spécifiques"</div>
                    <div class="plan-price">Nous consulter</div>
                    <div class="plan-features">
                        <div class="feature">✓ Tout OPTIMA inclus</div>
                        <div class="feature">✓ Gestion patrimoniale premium</div>
                        <div class="feature">✓ Support prioritaire dédié</div>
                        <div class="feature">✓ Conseils sur-mesure</div>
                        <div class="feature">✓ Accompagnement VIP</div>
                        <div class="feature">✓ Solutions personnalisées</div>
                    </div>
                    {% if current_user.subscription and current_user.subscription.tier == 'ultima' %}
                    <button class="plan-btn plan-btn-current">Plan actuel</button>
                    {% else %}
                    <button class="plan-btn plan-btn-select plan-btn-contact" onclick="contactForUltima()">
                        Nous contacter
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Disclaimer -->
            <div class="plan-disclaimer">
                <p><small>Tarifs TTC. Sans engagement. Vous restez libre de résilier à tout moment.</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Annulation Abonnement -->
<div id="cancelSubscriptionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-warning">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle text-warning"></i> Annuler votre abonnement</h3>
            <button class="modal-close" onclick="hideCancelSubscriptionModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #92400e;">Annuler votre abonnement</h4>
                    <p style="margin: 8px 0 0 0; color: #78350f;">Votre accès se terminera à la fin de la période en cours.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="cancellationReason" style="display: block; margin-bottom: 8px; font-weight: 500;">Pourquoi partez-vous ? (optionnel)</label>
                    <select id="cancellationReason" class="form-control">
                        <option value="">Sélectionner...</option>
                        <option value="price">Trop cher</option>
                        <option value="features">Pas assez de fonctionnalités</option>
                        <option value="unused">Je n'utilise pas assez</option>
                        <option value="temporary">Situation temporaire</option>
                        <option value="other">Autre raison</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="platform-btn platform-btn-secondary" onclick="hideCancelSubscriptionModal()">
                    Annuler
                </button>
                
                <button type="button" class="platform-btn platform-btn-outline" onclick="downgradeToPlan()" style="background: #f59e0b; color: white; border-color: #f59e0b;">
                    Passer à 25€/mois plutôt
                </button>
                
                <button type="button" class="platform-btn platform-btn-danger" onclick="directCancellation()">
                    Confirmer l'arrêt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Changement de Plan avec Authentification -->
<div id="confirmPlanChangeModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 540px; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header moderne avec gradient -->
        <div style="background: linear-gradient(135deg, #137C8B 0%, #344D59 100%); padding: 32px 32px 24px; position: relative;">
            <button class="modal-close"
                    onclick="hideConfirmPlanChangeModal()"
                    style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 8px; color: white; font-size: 20px; cursor: pointer; transition: all 0.2s; backdrop-filter: blur(10px);">
                &times;
            </button>

            <div style="text-align: center; color: white;">
                <div style="width: 64px; height: 64px; background: rgba(255,255,255,0.15); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; backdrop-filter: blur(10px);">
                    <i class="fas fa-exchange-alt" style="font-size: 28px;"></i>
                </div>
                <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">Changement de plan</h3>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">Confirmez votre nouveau abonnement</p>
            </div>
        </div>

        <div class="modal-body" style="padding: 32px;">
            <!-- Carte du plan sélectionné -->
            <div style="background: linear-gradient(135deg, rgba(19,124,139,0.08) 0%, rgba(19,124,139,0.04) 100%); border: 2px solid #137C8B; border-radius: 16px; padding: 24px; margin-bottom: 24px; text-align: center;">
                <div style="color: #137C8B; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                    Nouveau plan
                </div>
                <div id="confirmPlanName" style="font-size: 36px; font-weight: 800; color: #344D59; margin-bottom: 4px;">OPTIMA</div>
                <div id="confirmPlanPrice" style="font-size: 28px; font-weight: 700; color: #137C8B;">
                    50€<span style="font-size: 18px; font-weight: 500; color: #709CA7;">/mois</span>
                </div>
            </div>

            <!-- Informations de facturation -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <div style="width: 32px; height: 32px; background: #137C8B; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-info-circle" style="color: white; font-size: 14px;"></i>
                    </div>
                    <h4 style="margin: 0; font-size: 15px; font-weight: 700; color: #344D59;">Ce qui va se passer</h4>
                </div>

                <div style="color: #7A90A4; font-size: 14px; line-height: 1.7; padding-left: 40px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <i class="fas fa-check" style="color: #137C8B; margin-top: 2px; flex-shrink: 0;"></i>
                        <span>Changement <strong style="color: #344D59;">immédiat</strong> de votre abonnement</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <i class="fas fa-check" style="color: #137C8B; margin-top: 2px; flex-shrink: 0;"></i>
                        <span>Facturation au <strong style="color: #344D59;">prorata</strong> de la différence aujourd'hui</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <i class="fas fa-check" style="color: #137C8B; margin-top: 2px; flex-shrink: 0;"></i>
                        <span>Prochain paiement au <strong style="color: #344D59;">nouveau tarif</strong></span>
                    </div>
                </div>
            </div>

            <!-- Formulaire de confirmation -->
            <form id="confirmPlanChangeForm" onsubmit="submitPlanChange(event)">
                <div style="background: #fef3c7; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; gap: 12px;">
                    <i class="fas fa-lock" style="color: #f59e0b; font-size: 18px; margin-top: 2px;"></i>
                    <div style="flex: 1;">
                        <p style="margin: 0 0 4px 0; font-size: 13px; font-weight: 700; color: #78350f;">Authentification requise</p>
                        <p style="margin: 0; font-size: 13px; color: #92400e; line-height: 1.5;">Saisissez votre mot de passe pour confirmer</p>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 24px;">
                    <input type="password"
                           id="confirmPassword"
                           class="form-control"
                           placeholder="Votre mot de passe"
                           required
                           autocomplete="current-password"
                           style="padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px; width: 100%; font-size: 15px; transition: all 0.2s; background: white;"
                           onfocus="this.style.borderColor='#137C8B'; this.style.boxShadow='0 0 0 3px rgba(19,124,139,0.1)'"
                           onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <div id="passwordError" style="color: #dc2626; font-size: 13px; margin-top: 10px; padding: 10px; background: #fee; border-radius: 8px; display: none;">
                        <i class="fas fa-exclamation-circle"></i> Mot de passe incorrect
                    </div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button type="button"
                            class="platform-btn"
                            onclick="hideConfirmPlanChangeModal()"
                            style="flex: 1; padding: 14px 20px; border: 2px solid #e5e7eb; background: white; color: #344D59; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'"
                            onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                        Annuler
                    </button>
                    <button type="submit"
                            class="platform-btn platform-btn-primary"
                            id="confirmPlanChangeBtn"
                            style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #137C8B 0%, #344D59 100%); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(19,124,139,0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(19,124,139,0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(19,124,139,0.3)'">
                        <i class="fas fa-check"></i> Confirmer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modification Informations -->
<div id="editInfoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Modifier mes informations</h3>
            <button class="modal-close" onclick="hideEditInfoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editInfoForm" class="edit-info-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFirstName">Prénom *</label>
                        <input type="text" id="editFirstName" name="first_name" class="form-control" 
                               value="{{ current_user.first_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editLastName">Nom *</label>
                        <input type="text" id="editLastName" name="last_name" class="form-control" 
                               value="{{ current_user.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" class="form-control" 
                               value="{{ current_user.email }}" disabled>
                        <small class="form-help">L'email ne peut pas être modifié car il sert d'identifiant de compte</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPhone">Téléphone</label>
                        <input type="tel" id="editPhone" name="phone" class="form-control" 
                               value="{{ current_user.phone or '' }}" 
                               placeholder="Ex: 06 12 34 56 78">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="platform-btn platform-btn-secondary" onclick="hideEditInfoModal()">
                        Annuler
                    </button>
                    <button type="submit" class="platform-btn platform-btn-primary">
                        <i class="fas fa-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajout Moyen de Paiement avec Stripe Elements -->
<!-- Modal supprimé - On utilise maintenant Stripe Checkout -->

<style>
/* Profile Container */
.profile-container {
    max-width: 800px;
    margin: 0 auto;
}

/* Info Grid */
.info-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 24px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid var(--qlower-border);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.info-value {
    font-weight: 600;
    color: var(--qlower-dark);
    font-size: 16px;
}

.info-actions {
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

/* Subscription */
.subscription-info {
    display: grid;
    gap: 24px;
    margin-bottom: 24px;
}

/* Plan Cards Styles */
.subscription-plan {
    margin-bottom: 24px;
}

.plan-card {
    border: 2px solid transparent;
    border-radius: 16px;
    padding: 24px;
    background: white;
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
    transition: all 0.3s ease;
}

.plan-card.plan-initia {
    border-color: #22c55e;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
}

.plan-card.plan-optima {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
}

.plan-header {
    margin-bottom: 20px;
}

.plan-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-primary);
    margin-bottom: 8px;
}

.plan-badge.plan-initia {
    color: #16a34a;
}

.plan-badge .popular-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
    margin-left: 8px;
}

.plan-subtitle {
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
}

.plan-price {
    margin-bottom: 20px;
}

.price-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
}

.plan-initia .price-amount {
    color: #16a34a;
}

.price-period {
    font-size: 16px;
    color: #6b7280;
    font-weight: 500;
}

.plan-features {
    display: grid;
    gap: 12px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
}

.feature-item i {
    color: #16a34a;
    font-size: 12px;
    width: 12px;
    flex-shrink: 0;
}

.feature-item span {
    color: #374151;
    line-height: 1.4;
}

.subscription-plan .plan-period {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.9;
    color: white !important;
}

.subscription-status {
    display: grid;
    gap: 16px;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label {
    font-weight: 500;
    color: var(--qlower-text-light);
    font-size: 14px;
}

.status-value {
    font-weight: 600;
    font-size: 16px;
}

.status-active {
    color: var(--asset-success);
}

.status-trial {
    color: #ffc107;
}

.status-cancelled {
    color: var(--debt-primary);
}

.subscription-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

.platform-btn-cancel-subscription {
    background: none;
    border: 1px solid #d1d5db;
    color: #6b7280;
    font-size: 13px;
    padding: 8px 12px;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.platform-btn-cancel-subscription:hover {
    background: #f3f4f6;
    color: #374151;
    opacity: 1;
}

.platform-btn-cancel-subscription i {
    font-size: 12px;
}

.no-subscription {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.no-subscription i {
    font-size: 48px;
    margin-bottom: 16px;
}

.no-subscription h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

/* Invoice Generator */
.invoice-generator {
    display: grid;
    gap: 24px;
}

.invoice-form {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: var(--qlower-text-dark);
    font-size: 14px;
}

.form-control {
    padding: 12px 16px;
    border: 1px solid var(--qlower-border);
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.invoice-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--qlower-bg-light);
    border-radius: 8px;
    border-left: 4px solid var(--qlower-primary);
}

.invoice-info i {
    color: var(--qlower-primary);
    font-size: 18px;
}

.invoice-info p {
    margin: 0;
    font-size: 14px;
    color: var(--qlower-text-light);
    line-height: 1.5;
}

/* Plan Modal Styles */
.plan-subtitle {
    font-size: 12px;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 12px;
    text-align: center;
}

.plan-popular {
    position: relative;
    border-color: #f59e0b !important;
    box-shadow: 0 4px 25px rgba(245, 158, 11, 0.2) !important;
}

.plan-badge-popular {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 6px 16px;
    border-radius: 20px;
    white-space: nowrap;
}

.plan-btn-upgrade {
    background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
    color: white;
}

.plan-btn-upgrade:hover {
    background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
}

.plan-btn-contact {
    background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
    color: white;
}

.plan-btn-contact:hover {
    background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%);
}

.plan-disclaimer {
    margin-top: 24px;
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
}

.plan-disclaimer small {
    color: #6b7280;
    font-size: 12px;
}

/* Modal Cancellation */
.modal-warning {
    border-top: 4px solid #f59e0b;
}

.cancellation-warning {
    display: grid;
    gap: 20px;
}

.warning-message {
    text-align: center;
    padding: 16px;
    background: #fef3c7;
    border-radius: 8px;
    border-left: 4px solid #f59e0b;
}

.warning-message h4 {
    color: #92400e;
    margin-bottom: 8px;
}

.warning-message p {
    color: #78350f;
    margin: 0;
}

.cancellation-consequences {
    display: grid;
    gap: 12px;
}

.consequence-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
}

.consequence-item i {
    margin-top: 2px;
    width: 16px;
    flex-shrink: 0;
}

.consequence-item strong {
    display: block;
    color: var(--qlower-dark);
    margin-bottom: 4px;
}

.consequence-item span {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.4;
}

.cancellation-alternatives {
    background: #e0f2fe;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #0284c7;
}

.cancellation-alternatives h5 {
    color: #0c4a6e;
    margin-bottom: 12px;
}

.cancellation-alternatives ul {
    margin: 0;
    padding-left: 16px;
}

.cancellation-alternatives li {
    color: #075985;
    margin-bottom: 8px;
    line-height: 1.4;
}

.feedback-section {
    display: grid;
    gap: 12px;
}

.feedback-section label {
    font-weight: 500;
    color: var(--qlower-text-dark);
}

.platform-btn-outline {
    background: none;
    border: 2px solid var(--qlower-primary);
    color: var(--qlower-primary);
}

.platform-btn-outline:hover {
    background: var(--qlower-primary);
    color: white;
}

/* Stripe Elements Styling */
.stripe-security-notice {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
}

.security-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #0c4a6e;
    margin-bottom: 8px;
}

.security-badge i {
    font-size: 16px;
}

.stripe-security-notice p {
    margin: 0;
    font-size: 13px;
    color: #075985;
    line-height: 1.4;
}

.stripe-card-input {
    border: 1px solid var(--qlower-border);
    border-radius: 8px;
    padding: 0;
    background: white;
    transition: all 0.2s ease;
    min-height: 50px;
    position: relative;
    cursor: text;
    display: block;
    width: 100%;
}

.stripe-card-input:focus-within {
    border-color: var(--qlower-primary);
    box-shadow: 0 0 0 3px rgba(19, 124, 139, 0.1);
}

.stripe-card-input.stripe-complete {
    border-color: #059669;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
}

/* S'assurer que Stripe Elements prend toute la largeur et est interactif */
.stripe-card-input .StripeElement {
    width: 100% !important;
    height: 100% !important;
    min-height: 48px !important;
    border: none !important;
    outline: none !important;
    pointer-events: auto !important;
    display: block !important;
    padding: 12px 16px !important;
    box-sizing: border-box !important;
}

.stripe-card-input .StripeElement--webkit-autofill {
    background: transparent !important;
}

/* Forcer l'iframe Stripe à être interactive et visible */
.stripe-card-input iframe {
    pointer-events: auto !important;
    width: 100% !important;
    height: 48px !important;
    min-height: 48px !important;
    border: none !important;
    display: block !important;
    background: transparent !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 1 !important;
}

/* Assurer que le container n'a pas de problèmes CSS */
#stripe-card-element {
    pointer-events: auto !important;
    position: relative !important;
    overflow: visible !important;
    display: block !important;
}

/* Debug CSS pour identifier les problèmes */
.stripe-card-input:empty:before {
    content: "Chargement des champs Stripe...";
    color: #9ca3af;
    font-style: italic;
    padding: 12px 16px;
    display: block;
}

.stripe-error-message {
    color: #dc2626;
    font-size: 12px;
    margin-top: 6px;
    min-height: 16px;
}

#stripe-submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#stripe-submit-btn:disabled:hover {
    background: var(--qlower-primary);
    transform: none;
}

/* Messages d'état pour payment et invoices */
.payment-empty-message, .no-invoices {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.payment-empty-message i, .no-invoices i {
    font-size: 48px;
    margin-bottom: 16px;
}

.payment-empty-message h4, .no-invoices h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

.payment-empty-message p, .no-invoices p {
    margin: 0;
    line-height: 1.5;
}

.payment-empty-message .btn-link, .no-invoices .btn-link {
    color: var(--qlower-primary);
    text-decoration: none;
    font-weight: 500;
}

.payment-empty-message .btn-link:hover, .no-invoices .btn-link:hover {
    text-decoration: underline;
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    pointer-events: auto;
}

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    pointer-events: auto;
    z-index: 1051;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--qlower-border);
}

.modal-header h3 {
    margin: 0;
    color: var(--qlower-dark);
    font-size: 20px;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--qlower-text-light);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--qlower-bg-light);
    color: var(--qlower-dark);
}

.modal-body {
    padding: 24px;
}

.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.plan-option {
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.plan-option:hover {
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.15);
}

.plan-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

.plan-price {
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    margin-bottom: 20px;
}

.plan-price span {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.7;
}

.plan-features {
    text-align: left;
    margin-bottom: 24px;
}

.feature {
    padding: 6px 0;
    font-size: 14px;
    color: var(--qlower-text-dark);
}

.plan-btn {
    width: 100%;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.plan-btn-select {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-light) 100%);
    color: white;
}

.plan-btn-select:hover {
    background: linear-gradient(135deg, #0f6b75 0%, #5d8a94 100%);
    transform: translateY(-1px);
}

.plan-btn-current {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-light);
    cursor: not-allowed;
}

/* Payment Methods */
.payment-methods {
    display: grid;
    gap: 16px;
    margin-bottom: 24px;
}

.payment-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    background: var(--qlower-white);
    transition: all 0.2s ease;
}

.payment-card:hover {
    border-color: var(--qlower-primary);
    box-shadow: 0 4px 20px rgba(19, 124, 139, 0.1);
}

.payment-default {
    border-color: var(--qlower-primary);
    background: linear-gradient(135deg, rgba(19, 124, 139, 0.05) 0%, rgba(19, 124, 139, 0.02) 100%);
}

.payment-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.payment-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 32px;
}

.card-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 4px;
    font-weight: 700;
    font-size: 12px;
}

.visa-logo {
    background: linear-gradient(135deg, #1a1f71 0%, #0066cc 100%);
    color: white;
}

.mastercard-logo {
    position: relative;
    background: #000;
}

.mc-circle {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
}

.mc-red {
    background: #eb001b;
    left: 8px;
}

.mc-yellow {
    background: #ff5f00;
    right: 8px;
}

.amex-logo {
    background: linear-gradient(135deg, #006fcf 0%, #00a8cc 100%);
    color: white;
    font-size: 10px;
}

.generic-logo {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-light);
}

.payment-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.payment-number {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--qlower-dark);
    letter-spacing: 1px;
}

.payment-meta {
    display: flex;
    gap: 16px;
    font-size: 14px;
    color: var(--qlower-text-light);
}

.payment-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.payment-badge {
    background: var(--qlower-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.payment-btn-secondary, .payment-btn-danger {
    background: none;
    border: 1px solid;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.payment-btn-secondary {
    border-color: var(--qlower-primary);
    color: var(--qlower-primary);
}

.payment-btn-secondary:hover {
    background: var(--qlower-primary);
    color: white;
}

.payment-btn-danger {
    border-color: var(--debt-primary);
    color: var(--debt-primary);
    padding: 6px 8px;
}

.payment-btn-danger:hover {
    background: var(--debt-primary);
    color: white;
}

.payment-btn-disabled {
    border: 1px solid #d1d5db;
    color: #9ca3af;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: not-allowed;
    background: #f9fafb;
    transition: none;
}

.payment-btn-disabled:hover {
    background: #f9fafb;
    color: #9ca3af;
    border-color: #d1d5db;
}

.payment-add-section {
    padding-top: 16px;
    border-top: 1px solid var(--qlower-border);
    text-align: center;
}

.no-payment-methods {
    text-align: center;
    padding: 40px 20px;
    color: var(--qlower-text-light);
}

.no-payment-methods i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--qlower-primary);
}

.no-payment-methods h4 {
    color: var(--qlower-dark);
    margin-bottom: 8px;
}

/* Edit Info Form */
.edit-info-form {
    display: grid;
    gap: 20px;
}

.form-help {
    font-size: 12px;
    color: var(--qlower-text-light);
    margin-top: 4px;
    font-style: italic;
}

.form-control:disabled {
    background-color: var(--qlower-bg-light);
    color: var(--qlower-text-light);
    cursor: not-allowed;
}

/* Payment Form */
.payment-form {
    display: grid;
    gap: 20px;
}

.form-row {
    display: grid;
    gap: 16px;
}

.form-group-half {
    grid-column: span 1;
}

.form-row:has(.form-group-half) {
    grid-template-columns: 1fr 1fr;
}

.card-type-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 600;
}

.form-group {
    position: relative;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: var(--qlower-text-dark);
    cursor: pointer;
}

.checkbox-container input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin: 0;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--qlower-border);
}

/* Responsive */
@media (max-width: 768px) {
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .subscription-plan {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }
    
    .invoice-form {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .plans-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    .payment-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .payment-actions {
        align-self: stretch;
        justify-content: space-between;
    }
    
    .form-row:has(.form-group-half) {
        grid-template-columns: 1fr;
    }
    
    .modal-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Stripe Elements -->
<script src="https://js.stripe.com/v3/"></script>
<script>
// Vérifier que Stripe.js est bien chargé
console.log('🔍 Vérification Stripe.js:', typeof Stripe !== 'undefined' ? '✅ Chargé' : '❌ Non chargé');

// Fonctions de gestion des modales
function showPlanSelector() {
    document.getElementById('planModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hidePlanSelector() {
    document.getElementById('planModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Variables globales pour le changement de plan
let pendingPlanChange = null;

// Changement de plan - ÉTAPE 1: Ouvrir modal de confirmation
function changePlan(planTier) {
    // Stocker le plan demandé
    pendingPlanChange = planTier;

    // Définir le prix selon le plan
    const planPrices = {
        'initia': 25,
        'optima': 50
    };

    const planPrice = planPrices[planTier] || '?';

    // Mettre à jour le contenu de la modal
    document.getElementById('confirmPlanName').textContent = planTier.toUpperCase();
    document.getElementById('confirmPlanPrice').innerHTML = `${planPrice}€<span style="font-size: 16px; font-weight: 400;">/mois</span>`;

    // Réinitialiser le formulaire
    document.getElementById('confirmPassword').value = '';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('confirmPlanChangeBtn').disabled = false;

    // Fermer la modal de sélection de plan
    hidePlanSelector();

    // Ouvrir la modal de confirmation
    document.getElementById('confirmPlanChangeModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Focus sur le champ mot de passe
    setTimeout(() => {
        document.getElementById('confirmPassword').focus();
    }, 300);
}

// Gestion modal confirmation changement de plan
function hideConfirmPlanChangeModal() {
    document.getElementById('confirmPlanChangeModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    pendingPlanChange = null;
}

// ÉTAPE 2: Soumettre le changement avec vérification mot de passe
function submitPlanChange(event) {
    event.preventDefault();

    if (!pendingPlanChange) {
        alert('Erreur: aucun plan sélectionné');
        return;
    }

    const password = document.getElementById('confirmPassword').value;
    const submitBtn = document.getElementById('confirmPlanChangeBtn');
    const passwordError = document.getElementById('passwordError');

    // Désactiver le bouton pendant le traitement
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
    passwordError.style.display = 'none';

    // Envoyer la requête avec le mot de passe
    fetch('/plateforme/profil/changer-plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tier: pendingPlanChange,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Succès - fermer la modal et afficher message
            hideConfirmPlanChangeModal();

            let successMessage = data.message;

            // Ajouter des informations sur la proration si c'est un upgrade
            if (data.proration_message) {
                successMessage += '\n\n💳 ' + data.proration_message;
            }

            // Ajouter des informations sur le downgrade
            if (data.downgrade_message) {
                successMessage += '\n\n📋 ' + data.downgrade_message;
            }

            // Ajouter les détails du nouveau plan
            if (data.new_monthly_price) {
                successMessage += `\n\n📊 Nouveau tarif mensuel: ${data.new_monthly_price}€/mois`;
            }

            // Afficher un avertissement si mode dégradé
            if (data.warning) {
                successMessage += '\n\n⚠️ ' + data.warning;
            }

            alert(successMessage);
            location.reload();
        } else {
            // Erreur - vérifier si c'est une erreur de mot de passe
            if (data.message && (data.message.includes('Mot de passe') || data.message.includes('mot de passe') || data.message.includes('password'))) {
                // Afficher l'erreur de mot de passe
                passwordError.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Confirmer le changement';

                // Focus sur le champ mot de passe
                document.getElementById('confirmPassword').select();
            } else {
                // Autre erreur
                hideConfirmPlanChangeModal();

                let errorMessage = 'Erreur lors du changement de plan: ' + data.message;

                // Messages spécifiques pour certaines erreurs
                if (data.message.includes('ULTIMA')) {
                    errorMessage += '\n\nVeuillez utiliser le bouton "Nous contacter" pour le plan ULTIMA.';
                }

                alert(errorMessage);
            }
        }
    })
    .catch(error => {
        console.error('Erreur réseau:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Confirmer le changement';
        alert('Erreur de connexion lors du changement de plan. Veuillez réessayer ou nous contacter si le problème persiste.');
    });
}

// Contact pour ULTIMA
function contactForUltima() {
    alert('Vous allez être redirigé vers notre équipe commerciale pour discuter du plan ULTIMA sur-mesure.');
    // Ici on pourrait ouvrir un formulaire de contact ou rediriger vers une page de contact
    window.open('mailto:contact@atlas-patrimoine.fr?subject=Demande plan ULTIMA&body=Bonjour, je souhaite obtenir plus d\'informations sur le plan ULTIMA et ses tarifs personnalisés.', '_blank');
}

// Gestion modal désabonnement
function showCancelSubscriptionModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideCancelSubscriptionModal() {
    document.getElementById('cancelSubscriptionModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('cancellationReason').value = '';
}

function downgradeToPlan() {
    if (confirm('Passer au plan INITIA à 25€/mois au lieu d\'annuler ?')) {
        hideCancelSubscriptionModal();
        changePlan('initia');
    }
}

function directCancellation() {
    const reason = document.getElementById('cancellationReason').value;
    
    if (confirm('Êtes-vous sûr de vouloir arrêter votre abonnement ?')) {
        processCancellation(reason, null);
    }
}

function processCancellation(reason, otherReason) {
    const feedbackData = {
        reason: reason,
        other_reason: reason === 'other' ? otherReason : null
    };
    
    fetch('/plateforme/profil/annuler-abonnement', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(feedbackData)
    })
    .then(response => response.json())
    .then(data => {
        hideCancelSubscriptionModal();
        
        if (data.success) {
            alert('✅ Votre abonnement a été annulé.\n\n' +
                  'Vous conserverez l\'accès jusqu\'à la fin de votre période de facturation.\n\n' +
                  'Merci d\'avoir utilisé Atlas. Nous espérons vous revoir bientôt !');
            
            // Rediriger vers la page d'accueil ou recharger
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert('❌ Erreur lors de l\'annulation: ' + (data.error || data.message));
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        hideCancelSubscriptionModal();
        alert('❌ Erreur de connexion lors de l\'annulation. Veuillez réessayer ou nous contacter.');
    });
}

// Edit Info Modal Functions
function showEditInfoModal() {
    document.getElementById('editInfoModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideEditInfoModal() {
    document.getElementById('editInfoModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form to original values
    document.getElementById('editFirstName').value = '{{ current_user.first_name }}';
    document.getElementById('editLastName').value = '{{ current_user.last_name }}';
    document.getElementById('editPhone').value = '{{ current_user.phone or '' }}';
}

// Edit info form submission
function submitEditInfoForm(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    const data = {
        first_name: formData.get('first_name').trim(),
        last_name: formData.get('last_name').trim(),
        phone: formData.get('phone').trim() || null
    };
    
    // Basic validation
    if (!data.first_name || !data.last_name) {
        alert('Le prénom et le nom sont obligatoires');
        return;
    }
    
    // Phone validation (optional)
    if (data.phone && !/^[0-9\s\-\+\(\)\.]{10,}$/.test(data.phone)) {
        alert('Format de téléphone invalide');
        return;
    }
    
    fetch('/plateforme/profil/modifier-infos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Informations mises à jour avec succès !');
            hideEditInfoModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise à jour des informations: ' + error.message);
    });
}

// Génération de facture
function generateInvoice() {
    const month = document.getElementById('invoiceMonth').value;
    const year = document.getElementById('invoiceYear').value;
    
    if (!month || !year) {
        alert('Veuillez sélectionner un mois et une année');
        return;
    }
    
    // Créer l'URL pour télécharger la facture
    const downloadUrl = `/plateforme/profil/facture/${year}/${month}`;
    
    // Ouvrir dans un nouvel onglet pour téléchargement
    window.open(downloadUrl, '_blank');
}

// Fermer modal avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hidePlanSelector();
    }
});

// Fermer modal en cliquant à l'extérieur
document.getElementById('planModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hidePlanSelector();
    }
});


// Variables globales Stripe
let stripe = null;
let elements = null;
let cardElement = null;

// Initialiser Stripe à partir du backend
async function initializeStripe() {
    try {
        console.log('🔄 Tentative d\'initialisation Stripe...');
        console.log('🔍 Stripe global disponible:', typeof Stripe !== 'undefined');
        
        // Vérifier que Stripe.js est chargé
        if (typeof Stripe === 'undefined') {
            console.error('❌ Stripe.js non chargé !');
            return false;
        }
        
        // Récupérer la clé publique depuis le backend
        console.log('📡 Appel vers /plateforme/profil/stripe-config...');
        const response = await fetch('/plateforme/profil/stripe-config');
        
        console.log('📡 Response status:', response.status);
        console.log('📡 Response OK:', response.ok);
        
        if (!response.ok) {
            console.error('❌ Erreur HTTP:', response.status, response.statusText);
            return false;
        }
        
        const config = await response.json();
        console.log('📡 Réponse du serveur:', config);
        
        if (config.success && config.publishable_key) {
            console.log('🔑 Création instance Stripe avec clé:', config.publishable_key.substring(0, 20) + '...');
            stripe = Stripe(config.publishable_key);
            console.log('✅ Stripe initialisé avec succès !');
            console.log('✅ Instance stripe:', !!stripe);
            return true;
        } else {
            console.warn('⚠️ Stripe non disponible:', config.error || 'Configuration invalide');
            return false;
        }
    } catch (error) {
        console.error('❌ Erreur initialisation Stripe:', error);
        console.error('❌ Stack:', error.stack);
        return false;
    }
}

// Payment Methods Functions - Version simplifiée avec Stripe Checkout
async function addPaymentMethodWithCheckout() {
    try {
        console.log('🔄 Démarrage ajout moyen de paiement...');
        
        // S'assurer que Stripe est initialisé
        if (!stripe && !(await initializeStripe())) {
            alert('❌ Service de paiement non disponible.\n\nVeuillez réessayer plus tard ou contactez le support.');
            return;
        }

        console.log('✅ Stripe initialisé, création du SetupIntent...');

        // Créer un SetupIntent côté serveur pour collecter les infos de paiement
        const response = await fetch('/plateforme/profil/create-payment-setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const setup = await response.json();
        console.log('📡 Réponse SetupIntent:', setup);

        if (!setup.success) {
            alert(`❌ Erreur: ${setup.error}`);
            return;
        }

        // Rediriger vers Stripe Checkout pour Setup
        const { error } = await stripe.redirectToCheckout({
            sessionId: setup.session_id
        });

        if (error) {
            console.error('❌ Erreur redirection Stripe:', error);
            alert(`❌ Erreur de redirection: ${error.message}`);
        }

    } catch (error) {
        console.error('❌ Erreur ajout moyen de paiement:', error);
        alert('❌ Une erreur est survenue. Veuillez réessayer.');
    }
}

function hideAddPaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reset form
    document.getElementById('stripe-payment-form').reset();
    document.getElementById('stripe-cardholder-name').value = '{{ current_user.first_name }} {{ current_user.last_name }}';
    document.getElementById('stripe-set-as-default').checked = true;
    
    // Clear Stripe errors
    const errorElement = document.getElementById('stripe-card-errors');
    errorElement.textContent = '';
    
    if (cardElement) {
        cardElement.clear();
    }
}

// Configurer Stripe Elements
function setupStripeElements() {
    if (!stripe) {
        console.error('❌ Stripe non initialisé');
        return;
    }
    
    console.log('🔧 Configuration Stripe Elements...');
    
    try {
        // Détruire les anciens éléments s'ils existent
        if (cardElement) {
            try {
                cardElement.unmount();
                cardElement.destroy();
            } catch (e) {
                console.log('Ancien cardElement déjà détruit');
            }
        }
        if (elements) {
            try {
                elements = null;
            } catch (e) {}
        }
        
        // Créer les elements avec la locale française
        elements = stripe.elements({
            locale: 'fr'
        });
        
        console.log('✅ Stripe elements instance créée');
        
        // Style pour le champ carte - simplifié pour éviter les problèmes CSS
        const style = {
            base: {
                fontSize: '16px',
                color: '#424770',
                fontFamily: 'system-ui, -apple-system, sans-serif',
                lineHeight: '1.5',
                padding: '10px 14px',
                '::placeholder': {
                    color: '#a0a0a0',
                },
            },
            invalid: {
                color: '#dc2626',
            },
            complete: {
                color: '#059669',
            }
        };
        
        // Options simplifiées pour éviter les conflits
        const cardOptions = {
            style: style,
            hidePostalCode: true,
            disableLink: true,
        };
        
        // Créer le champ carte
        cardElement = elements.create('card', cardOptions);
        
        console.log('✅ Card element créé');
        
        // Vérifier que le container existe avant de monter
        const container = document.getElementById('stripe-card-element');
        if (!container) {
            console.error('❌ Container #stripe-card-element introuvable');
            return;
        }
        
        // Vider le container avant de monter
        container.innerHTML = '';
        
        // Monter le champ dans le DOM
        cardElement.mount('#stripe-card-element');
        console.log('✅ Card element monté dans le DOM');
        
        // Gérer les erreurs en temps réel
        cardElement.on('change', ({ error, complete }) => {
            const displayError = document.getElementById('stripe-card-errors');
            if (error) {
                displayError.textContent = error.message;
                console.warn('🔥 Erreur Stripe:', error.message);
            } else {
                displayError.textContent = '';
            }
            
            // Indiquer visuellement quand le champ est complet
            const cardContainer = document.getElementById('stripe-card-element');
            if (complete) {
                cardContainer.classList.add('stripe-complete');
                console.log('✅ Informations de carte complètes');
            } else {
                cardContainer.classList.remove('stripe-complete');
            }
        });
        
        // Event pour savoir quand l'élément est prêt
        cardElement.on('ready', () => {
            console.log('🎉 Stripe Elements prêt et interactif !');
            
            // Vérifier une dernière fois que l'iframe est bien là
            setTimeout(() => {
                const iframe = container.querySelector('iframe');
                if (iframe) {
                    console.log('✅ iframe Stripe Elements trouvée');
                    // S'assurer que l'iframe est visible et interactive
                    iframe.style.pointerEvents = 'auto';
                    iframe.style.minHeight = '40px';
                } else {
                    console.error('❌ iframe Stripe Elements manquante après ready');
                }
            }, 100);
        });
        
        // Event pour les erreurs de montage
        cardElement.on('escape', () => {
            console.log('Escape pressed dans Stripe Elements');
        });
        
        console.log('✅ Stripe Elements configuré avec gestionnaires d\'événements');
        
    } catch (error) {
        console.error('❌ Erreur lors de la configuration Stripe Elements:', error);
        
        // Afficher l'erreur dans le container
        const container = document.getElementById('stripe-card-element');
        if (container) {
            container.innerHTML = `
                <div style="
                    padding: 20px;
                    text-align: center;
                    color: #dc2626;
                    border: 2px solid #dc2626;
                    border-radius: 8px;
                    background: #fef2f2;
                ">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <div style="font-weight: 500; margin-bottom: 4px;">Erreur Stripe Elements</div>
                    <div style="font-size: 14px;">${error.message}</div>
                </div>
            `;
        }
    }
}

// Charger les moyens de paiement depuis Stripe
function loadPaymentMethods() {
    // Afficher le loading
    document.getElementById('payment-methods-loading').style.display = 'block';
    document.getElementById('payment-methods-list').style.display = 'none';
    document.getElementById('payment-methods-empty').style.display = 'none';
    document.getElementById('payment-methods-error').style.display = 'none';
    
    fetch('/plateforme/profil/moyens-paiement')
        .then(response => response.json())
        .then(data => {
            document.getElementById('payment-methods-loading').style.display = 'none';
            
            if (data.success) {
                if (data.payment_methods && data.payment_methods.length > 0) {
                    displayPaymentMethods(data.payment_methods);
                } else {
                    // Afficher un message personnalisé s'il y en a un
                    const emptyDiv = document.getElementById('payment-methods-empty');
                    if (data.message) {
                        emptyDiv.innerHTML = `
                            <div class="payment-empty-message">
                                <i class="fas fa-info-circle text-primary"></i>
                                <h4>Information</h4>
                                <p>${data.message}</p>
                            </div>
                        `;
                    }
                    emptyDiv.style.display = 'block';
                }
            } else {
                const errorDiv = document.getElementById('payment-methods-error');
                errorDiv.innerHTML = `
                    <div class="payment-empty-message">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Service indisponible</h4>
                        <p>${data.error || 'Impossible de récupérer vos moyens de paiement.'}</p>
                        ${!data.error || !data.error.includes('développement') ? '<button onclick="loadPaymentMethods()" class="btn btn-link p-0">Réessayer</button>' : ''}
                    </div>
                `;
                errorDiv.style.display = 'block';
                console.error('Erreur:', data.error);
            }
        })
        .catch(error => {
            document.getElementById('payment-methods-loading').style.display = 'none';
            const errorDiv = document.getElementById('payment-methods-error');
            errorDiv.innerHTML = `
                <div class="payment-empty-message">
                    <i class="fas fa-wifi text-danger"></i>
                    <h4>Erreur de connexion</h4>
                    <p>Vérifiez votre connexion internet. <button onclick="loadPaymentMethods()" class="btn btn-link p-0">Réessayer</button></p>
                </div>
            `;
            errorDiv.style.display = 'block';
            console.error('Erreur réseau:', error);
        });
}

// Afficher les moyens de paiement
function displayPaymentMethods(paymentMethods) {
    const container = document.getElementById('payment-methods-list');
    container.innerHTML = '';
    
    const isOnlyPaymentMethod = paymentMethods.length === 1;
    
    paymentMethods.forEach(pm => {
        const cardHtml = `
            <div class="payment-card ${pm.is_default ? 'payment-default' : ''}">
                <div class="payment-info">
                    <div class="payment-logo">
                        ${getCardLogo(pm.card_type)}
                    </div>
                    
                    <div class="payment-details">
                        <div class="payment-number">•••• •••• •••• ${pm.last4}</div>
                        <div class="payment-meta">
                            <span class="payment-name">${pm.cardholder_name}</span>
                            <span class="payment-expiry">${pm.exp_month}/${pm.exp_year}</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-actions">
                    ${pm.is_default ? 
                        '<span class="payment-badge">Par défaut</span>' :
                        `<button class="payment-btn-secondary" onclick="setDefaultPayment('${pm.id}')">Définir par défaut</button>`
                    }
                    
                    ${isOnlyPaymentMethod ? 
                        `<button class="payment-btn-disabled" disabled title="Ajoutez une autre carte avant de supprimer celle-ci">
                            <i class="fas fa-lock"></i>
                        </button>` :
                        `<button class="payment-btn-danger" onclick="removePayment('${pm.id}')">
                            <i class="fas fa-trash"></i>
                        </button>`
                    }
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;
    });
    
    document.getElementById('payment-methods-list').style.display = 'block';
}

// Générer le logo de la carte
function getCardLogo(cardType) {
    switch(cardType) {
        case 'visa':
            return '<div class="card-logo visa-logo"><span>VISA</span></div>';
        case 'mastercard':
            return `
                <div class="card-logo mastercard-logo">
                    <div class="mc-circle mc-red"></div>
                    <div class="mc-circle mc-yellow"></div>
                </div>
            `;
        case 'amex':
            return '<div class="card-logo amex-logo"><span>AMEX</span></div>';
        default:
            return '<div class="card-logo generic-logo"><i class="fas fa-credit-card"></i></div>';
    }
}

// Set default payment method
function setDefaultPayment(paymentMethodId) {
    if (confirm('Définir cette carte comme moyen de paiement par défaut ?')) {
        fetch('/plateforme/profil/paiement/defaut', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_method_id: paymentMethodId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadPaymentMethods(); // Recharger la liste
            } else {
                alert('Erreur: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la modification.');
        });
    }
}

// Remove payment method
function removePayment(paymentMethodId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette carte ?')) {
        fetch('/plateforme/profil/paiement/supprimer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_method_id: paymentMethodId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Message de succès
                if (data.message.includes('nouveau moyen par défaut')) {
                    alert('✅ ' + data.message);
                }
                loadPaymentMethods(); // Recharger la liste
            } else {
                // Messages d'erreur plus informatifs
                let errorMessage = data.error || data.message;
                if (errorMessage.includes('unique moyen de paiement')) {
                    errorMessage = '⚠️ ' + errorMessage + '\n\n💡 Conseil : Ajoutez d\'abord une nouvelle carte, puis supprimez l\'ancienne.';
                }
                alert(errorMessage);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('❌ Erreur de connexion lors de la suppression. Veuillez réessayer.');
        });
    }
}

// Gestion formulaire Stripe Elements
async function handleStripePaymentForm(event) {
    event.preventDefault();
    
    if (!stripe || !cardElement) {
        alert('❌ Service de paiement non initialisé');
        return;
    }
    
    // Désactiver le bouton et montrer le loading
    const submitButton = document.getElementById('stripe-submit-btn');
    const loadingDiv = document.getElementById('stripe-loading');
    const formDiv = document.getElementById('stripe-payment-form');
    
    submitButton.disabled = true;
    loadingDiv.style.display = 'block';
    formDiv.style.display = 'none';
    
    try {
        // 1. Créer un SetupIntent côté serveur
        const setupResponse = await fetch('/plateforme/profil/paiement/ajouter-setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const setupData = await setupResponse.json();
        if (!setupData.success) {
            throw new Error(setupData.error || 'Erreur création SetupIntent');
        }
        
        // 2. Confirmer avec Stripe Elements
        const cardholderName = document.getElementById('stripe-cardholder-name').value;
        
        const { error, setupIntent } = await stripe.confirmCardSetup(
            setupData.client_secret,
            {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                }
            }
        );
        
        if (error) {
            throw new Error(error.message);
        }
        
        // 3. Finaliser côté serveur
        const setAsDefault = document.getElementById('stripe-set-as-default').checked;
        
        const finalResponse = await fetch('/plateforme/profil/ajouter-carte-stripe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                setup_intent_id: setupIntent.id,
                set_as_default: setAsDefault
            })
        });
        
        const finalData = await finalResponse.json();
        if (finalData.success) {
            alert('✅ ' + finalData.message);
            hideAddPaymentModal();
            loadPaymentMethods(); // Recharger la liste
        } else {
            throw new Error(finalData.error || 'Erreur ajout carte');
        }
        
    } catch (error) {
        console.error('Erreur ajout carte:', error);
        alert('❌ Erreur: ' + error.message);
        
        // Remettre le formulaire visible
        loadingDiv.style.display = 'none';
        formDiv.style.display = 'block';
        submitButton.disabled = false;
    }
}

// Charger les factures depuis Stripe
function loadInvoices() {
    // Afficher le loading
    document.getElementById('invoices-loading').style.display = 'block';
    document.getElementById('invoices-list').style.display = 'none';
    document.getElementById('invoices-empty').style.display = 'none';
    document.getElementById('invoices-error').style.display = 'none';
    
    fetch('/plateforme/profil/factures-stripe')
        .then(response => response.json())
        .then(data => {
            document.getElementById('invoices-loading').style.display = 'none';
            
            if (data.success) {
                if (data.invoices && data.invoices.length > 0) {
                    displayInvoices(data.invoices);
                } else {
                    // Afficher un message personnalisé s'il y en a un
                    const emptyDiv = document.getElementById('invoices-empty');
                    if (data.message) {
                        emptyDiv.innerHTML = `
                            <div class="no-invoices">
                                <i class="fas fa-info-circle text-primary"></i>
                                <h4>Information</h4>
                                <p>${data.message}</p>
                            </div>
                        `;
                    }
                    emptyDiv.style.display = 'block';
                }
            } else {
                const errorDiv = document.getElementById('invoices-error');
                errorDiv.innerHTML = `
                    <div class="no-invoices">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4>Service indisponible</h4>
                        <p>${data.error || 'Impossible de récupérer vos factures.'} <button onclick="loadInvoices()" class="btn btn-link p-0">Réessayer</button></p>
                    </div>
                `;
                errorDiv.style.display = 'block';
                console.error('Erreur:', data.error);
            }
        })
        .catch(error => {
            document.getElementById('invoices-loading').style.display = 'none';
            const errorDiv = document.getElementById('invoices-error');
            errorDiv.innerHTML = `
                <div class="no-invoices">
                    <i class="fas fa-wifi text-danger"></i>
                    <h4>Erreur de connexion</h4>
                    <p>Vérifiez votre connexion internet. <button onclick="loadInvoices()" class="btn btn-link p-0">Réessayer</button></p>
                </div>
            `;
            errorDiv.style.display = 'block';
            console.error('Erreur réseau:', error);
        });
}

// Afficher les factures
function displayInvoices(invoices) {
    const container = document.getElementById('invoices-list');
    container.innerHTML = '';
    
    if (invoices.length === 0) {
        document.getElementById('invoices-empty').style.display = 'block';
        return;
    }
    
    invoices.forEach(invoice => {
        const invoiceDate = new Date(invoice.created * 1000);
        const periodStart = new Date(invoice.period_start * 1000);
        const periodEnd = new Date(invoice.period_end * 1000);
        
        const statusClass = invoice.status === 'paid' ? 'success' : 
                           invoice.status === 'open' ? 'warning' : 'danger';
        
        const statusText = invoice.status === 'paid' ? 'Payée' :
                          invoice.status === 'open' ? 'En attente' : 'Échec';
        
        const invoiceCard = document.createElement('div');
        invoiceCard.className = 'invoice-card';
        invoiceCard.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        `;
        
        invoiceCard.innerHTML = `
            <div class="invoice-details">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <h4 style="margin: 0; font-size: 16px; color: #1f2937; font-weight: 600;">
                        ${invoice.number || 'Facture #' + invoice.id.substring(3, 8)}
                    </h4>
                    <span style="
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                        background: ${statusClass === 'success' ? '#d1fae5' : statusClass === 'warning' ? '#fef3c7' : '#fee2e2'};
                        color: ${statusClass === 'success' ? '#065f46' : statusClass === 'warning' ? '#92400e' : '#991b1b'};
                    ">
                        ${statusText}
                    </span>
                </div>
                <div style="color: #6b7280; font-size: 14px; line-height: 1.5;">
                    <div style="margin-bottom: 4px;">${invoice.description}</div>
                    <div>Période: ${periodStart.toLocaleDateString('fr-FR')} - ${periodEnd.toLocaleDateString('fr-FR')}</div>
                    <div>Date: ${invoiceDate.toLocaleDateString('fr-FR')}</div>
                </div>
            </div>
            <div class="invoice-actions" style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                <div style="font-size: 18px; font-weight: 700; color: #137C8B;">
                    ${invoice.amount_paid.toFixed(2)}€
                </div>
                ${invoice.invoice_pdf ? 
                    `<a href="${invoice.invoice_pdf}" target="_blank" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        background: #137C8B;
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 500;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#0f6b75'" onmouseout="this.style.background='#137C8B'">
                        <i class="fas fa-download"></i> Télécharger
                    </a>` : 
                    `<a href="${invoice.hosted_invoice_url}" target="_blank" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        background: #137C8B;
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 500;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#0f6b75'" onmouseout="this.style.background='#137C8B'">
                        <i class="fas fa-external-link-alt"></i> Voir facture
                    </a>`
                }
            </div>
        `;
        
        container.appendChild(invoiceCard);
    });
    
    document.getElementById('invoices-list').style.display = 'block';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Charger les moyens de paiement et les factures au démarrage
    loadPaymentMethods();
    loadInvoices();
    
    // Dropdown de raison simplifiée - plus de logique spéciale nécessaire
    
    // Card number formatting
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function() {
            formatCardNumber(this);
        });
    }
    
    // Stripe payment form submission
    const stripePaymentForm = document.getElementById('stripe-payment-form');
    if (stripePaymentForm) {
        stripePaymentForm.addEventListener('submit', handleStripePaymentForm);
    }
    
    // Edit info form submission
    const editInfoForm = document.getElementById('editInfoForm');
    if (editInfoForm) {
        editInfoForm.addEventListener('submit', submitEditInfoForm);
    }
    
    // Close modals with Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideAddPaymentModal();
            hideEditInfoModal();
        }
    });
    
    // Close modals by clicking outside
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddPaymentModal();
            }
        });
    }
    
    const editInfoModal = document.getElementById('editInfoModal');
    if (editInfoModal) {
        editInfoModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideEditInfoModal();
            }
        });
    }
});
</script>
{% endblock %}