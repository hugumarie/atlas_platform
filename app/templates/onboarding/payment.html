{% extends "site/base_new.html" %}

{% block title %}Finaliser votre abonnement - Atlas{% endblock %}

{% block head %}
<!-- Google Fonts - Encode Sans Condensed for hero -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Encode+Sans+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
/* MODERN PAYMENT DESIGN - SPLIT SCREEN */

/* Color Variables - Same as invitation and plan selection */
:root {
    --qlower-primary: #137C8B;
    --qlower-dark: #344D59;
    --qlower-light: #709CA7;
    --qlower-tertiary-color: #B8CBD0;
    --qlower-quaternary-color: #7A90A4;
    --qlower-bg-light: #f8f9fa;
    --qlower-text-dark: #344D59;
    --qlower-text-light: #7A90A4;
    --qlower-border: #e5e7eb;
    --qlower-white: #ffffff;
}

/* Global Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    color: var(--qlower-text-dark);
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-dark) 100%);
    min-height: 100vh;
    overflow-x: hidden;
}

/* MAIN SPLIT SCREEN CONTAINER */
.qlower-payment-container {
    min-height: 100vh;
    display: grid;
    grid-template-columns: 1fr 2fr;
    overflow: hidden;
}

.qlower-payment-left {
    background: linear-gradient(135deg, var(--qlower-primary) 0%, var(--qlower-dark) 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 60px;
    position: relative;
}

.qlower-payment-left::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="8" height="8" patternUnits="userSpaceOnUse"><path d="M 8 0 L 0 0 0 8" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
    opacity: 0.6;
}

.qlower-payment-right {
    background: var(--qlower-white);
    display: flex;
    flex-direction: column;
    padding: 60px;
    overflow-y: auto;
}

/* LEFT SIDE HERO */
.qlower-left-content {
    position: relative;
    z-index: 2;
    text-align: center;
    max-width: 400px;
}

.qlower-hero-badge {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50px;
    padding: 8px 20px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 32px;
}

.qlower-payment-title {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 48px;
    font-weight: 800;
    color: white;
    line-height: 1.1;
    margin-bottom: 20px;
    letter-spacing: -0.02em;
}

.qlower-payment-subtitle {
    font-size: 18px;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    margin-bottom: 40px;
}

.qlower-hero-features {
    list-style: none;
    padding: 0;
    margin: 0;
}

.qlower-hero-feature {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    font-size: 16px;
    color: rgba(255, 255, 255, 0.9);
}

.qlower-hero-feature-icon {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
}

/* RIGHT SIDE CONTENT */
.qlower-right-header {
    margin-bottom: 32px;
    text-align: center;
}

.qlower-right-title {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-dark);
    margin-bottom: 8px;
    letter-spacing: -0.02em;
}

.qlower-right-subtitle {
    font-size: 16px;
    color: var(--qlower-text-light);
}

/* COMPACT SUMMARY CARD */
.qlower-summary-card {
    background: var(--qlower-bg-light);
    border: 2px solid var(--qlower-border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 24px;
}

.qlower-plan-summary {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.qlower-plan-name {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 24px;
    font-weight: 800;
    color: var(--qlower-dark);
    margin: 0;
}

.qlower-plan-description {
    font-size: 14px;
    color: var(--qlower-text-light);
    margin: 0;
}

.qlower-plan-features {
    list-style: none;
    padding: 0;
    margin: 8px 0 0 0;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
}

.qlower-plan-features li {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--qlower-text-dark);
}

.qlower-plan-features i {
    color: #28a745;
    font-size: 12px;
}

.qlower-price-display {
    text-align: center;
    padding: 16px;
    background: var(--qlower-white);
    border-radius: 12px;
    border: 2px solid var(--qlower-primary);
    min-width: 120px;
}

.qlower-price-amount {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 800;
    color: var(--qlower-primary);
    line-height: 1;
    margin: 0;
}

.qlower-price-period {
    font-size: 12px;
    color: var(--qlower-text-light);
    margin: 2px 0 0 0;
}

.qlower-price-note {
    font-size: 11px;
    color: var(--qlower-text-light);
    margin: 4px 0 0 0;
}

/* PAYMENT SECTION */
.qlower-payment-section {
    background: var(--qlower-white);
    border: 2px solid var(--qlower-border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
}

.qlower-section-title {
    font-family: 'Encode Sans Condensed', 'Inter', sans-serif;
    font-size: 24px;
    font-weight: 700;
    color: var(--qlower-dark);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.qlower-payment-placeholder {
    background: linear-gradient(135deg, var(--qlower-bg-light) 0%, #e9ecef 100%);
    border: 2px dashed var(--qlower-border);
    border-radius: 12px;
    padding: 48px 32px;
    text-align: center;
}

.qlower-placeholder-icon {
    color: var(--qlower-text-light);
    font-size: 48px;
    margin-bottom: 24px;
}

.qlower-placeholder-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--qlower-dark);
    margin-bottom: 12px;
}

.qlower-placeholder-text {
    color: var(--qlower-text-light);
    margin-bottom: 32px;
}

/* SECURITY INFO */
.qlower-security-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 32px;
}

.qlower-info-card {
    background: var(--qlower-white);
    border: 1px solid var(--qlower-border);
    border-radius: 12px;
    padding: 20px;
}

.qlower-info-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--qlower-dark);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.qlower-info-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.qlower-info-list li {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--qlower-text-dark);
    margin-bottom: 6px;
}

.qlower-info-list i {
    color: #28a745;
    font-size: 12px;
}

.qlower-card-icons {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.qlower-card-icons i {
    font-size: 24px;
}

/* SIMULATE BUTTON */
.qlower-stripe-button {
    background: linear-gradient(135deg, #6772E5 0%, #5469D4 100%);
    color: white;
    padding: 16px 32px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    max-width: 350px;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(103, 114, 229, 0.3);
}

.qlower-stripe-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(103, 114, 229, 0.4);
    background: linear-gradient(135deg, #5A6ACF 0%, #4B5BC4 100%);
}

.qlower-stripe-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 4px 15px rgba(103, 114, 229, 0.2);
}

/* FOOTER BENEFITS */
.qlower-benefits-section {
    background: var(--qlower-bg-light);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 32px;
}

.qlower-benefits-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    text-align: center;
}

.qlower-benefit {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.qlower-benefit-icon {
    color: var(--qlower-primary);
    font-size: 32px;
    margin-bottom: 8px;
}

.qlower-benefit-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--qlower-dark);
    margin: 0;
}

.qlower-benefit-text {
    font-size: 12px;
    color: var(--qlower-text-light);
    margin: 0;
}

/* NAVIGATION */
.qlower-navigation {
    text-align: center;
    padding-top: 24px;
    border-top: 1px solid var(--qlower-border);
}

.qlower-nav-button {
    background: var(--qlower-bg-light);
    color: var(--qlower-text-dark);
    padding: 12px 24px;
    border: 2px solid var(--qlower-border);
    border-radius: 12px;
    font-weight: 500;
    font-size: 14px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.qlower-nav-button:hover {
    background: var(--qlower-white);
    border-color: var(--qlower-primary);
    color: var(--qlower-primary);
    text-decoration: none;
}

.qlower-nav-left:hover {
    background: rgba(255, 255, 255, 0.25) !important;
    border-color: rgba(255, 255, 255, 0.4) !important;
    color: white !important;
    text-decoration: none;
    transform: translateY(-2px);
}

/* SUPPORT SECTION */
.qlower-support-section {
    text-align: center;
    margin-top: 40px;
    padding: 24px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.qlower-support-text {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.8);
}

.qlower-support-text a {
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    font-weight: 500;
}

.qlower-support-text a:hover {
    text-decoration: underline;
    color: white;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
    .qlower-payment-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
    }
    
    .qlower-payment-left {
        padding: 40px 60px;
    }
    
    .qlower-payment-right {
        padding: 40px 60px;
    }
    
    .qlower-payment-title {
        font-size: 40px;
    }
}

@media (max-width: 768px) {
    .qlower-payment-left,
    .qlower-payment-right {
        padding: 32px;
    }
    
    .qlower-payment-title {
        font-size: 36px;
    }
    
    .qlower-summary-card {
        grid-template-columns: 1fr;
        gap: 16px;
        text-align: center;
    }
    
    .qlower-security-info {
        grid-template-columns: 1fr;
    }
    
    .qlower-benefits-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .qlower-plan-features {
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .qlower-payment-left,
    .qlower-payment-right {
        padding: 24px;
    }
    
    .qlower-payment-title {
        font-size: 28px;
    }
    
    .qlower-right-title {
        font-size: 28px;
    }
    
    .qlower-payment-section {
        padding: 24px;
    }
    
    .qlower-payment-placeholder {
        padding: 32px 24px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="qlower-payment-container">
    <!-- Left Side - Hero Section -->
    <div class="qlower-payment-left">
        <div class="qlower-left-content">
            <!-- Navigation Button -->
            <div style="margin-bottom: 32px; text-align: center;">
                <a href="{{ url_for('onboarding.plan_selection') }}" class="qlower-nav-button qlower-nav-left" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.9); text-decoration: none;">
                    <i class="fas fa-arrow-left"></i>
                    <span>Modifier ma formule</span>
                </a>
            </div>
            
            <div class="qlower-hero-badge">
                <i class="fas fa-credit-card"></i>
                <span>Finalisation de votre abonnement</span>
            </div>
            
            <h1 class="qlower-payment-title">
                Derni√®re √©tape<br>
                <strong style="background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">avant Atlas</strong>
            </h1>
            
            <p class="qlower-payment-subtitle">
                Votre plateforme d'investissement personnalis√©e vous attend. Quelques secondes et c'est parti !
            </p>
            
        </div>
        
        <!-- Support Section -->
        <div class="qlower-support-section">
            <div class="qlower-support-text">
                <i class="fas fa-headset" style="margin-right: 6px;"></i>
                <a href="mailto:support@atlas-invest.fr">Support Atlas</a>
            </div>
        </div>
    </div>

    <!-- Right Side - Payment Section -->
    <div class="qlower-payment-right">
        <!-- Right Header -->
        <div class="qlower-right-header">
            <img src="{{ url_for('static', filename='images/logo-atlas.png') }}" alt="Atlas" style="height: 40px; margin-bottom: 24px;">
            <h2 class="qlower-right-title">Finalisation de votre abonnement</h2>
            <p class="qlower-right-subtitle">V√©rifiez votre s√©lection et finalisez votre abonnement</p>
        </div>

        <!-- Plan Summary -->
        <div class="qlower-summary-card">
            <div class="qlower-plan-summary">
                <h3 class="qlower-plan-name">Atlas {{ user_plan.get_plan_name() }}</h3>
                <p class="qlower-plan-description">{{ plan_config.description }}</p>
                
                <ul class="qlower-plan-features">
                    {% for feature in plan_config.features[:4] %}
                    <li>
                        <i class="fas fa-check"></i>
                        <span>{{ feature }}</span>
                    </li>
                    {% endfor %}
                    {% if plan_config.features|length > 4 %}
                    <li>
                        <i class="fas fa-plus"></i>
                        <span>+{{ plan_config.features|length - 4 }} autres avantages</span>
                    </li>
                    {% endif %}
                </ul>
            </div>
            
            <div class="qlower-price-display">
                <div class="qlower-price-amount">‚Ç¨{{ user_plan.plan_price|int }}</div>
                <div class="qlower-price-period">/mois</div>
                <div class="qlower-price-note">TTC</div>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="qlower-payment-section">
            <h3 class="qlower-section-title">
                <i class="fas fa-credit-card"></i>
                Informations de paiement
            </h3>
            
            <!-- Security Info -->
            <div class="qlower-security-info">
                <div class="qlower-info-card">
                    <h5 class="qlower-info-title">
                        <i class="fas fa-shield-alt"></i>
                        S√©curit√©
                    </h5>
                    <ul class="qlower-info-list">
                        <li><i class="fas fa-check"></i>Chiffrement SSL 256 bits</li>
                        <li><i class="fas fa-check"></i>Conformit√© PCI DSS Level 1</li>
                        <li><i class="fas fa-check"></i>3D Secure 2.0</li>
                    </ul>
                </div>
                <div class="qlower-info-card">
                    <h5 class="qlower-info-title">
                        <i class="fas fa-credit-card"></i>
                        Cartes accept√©es
                    </h5>
                    <div class="qlower-card-icons">
                        <i class="fab fa-cc-visa" style="color: #1565C0;"></i>
                        <i class="fab fa-cc-mastercard" style="color: #FF9800;"></i>
                        <i class="fab fa-cc-amex" style="color: #2196F3;"></i>
                        <i class="fab fa-cc-apple-pay" style="color: #000000;"></i>
                    </div>
                    <p style="font-size: 12px; color: var(--qlower-text-light); margin: 0;">Paiement s√©curis√© par Stripe</p>
                </div>
            </div>
            
            <!-- Stripe Checkout Button -->
            <button id="checkoutBtn" class="qlower-stripe-button">
                <i class="fab fa-stripe"></i>
                <span id="checkoutBtnText">Proc√©der au paiement s√©curis√©</span>
                <div id="checkoutSpinner" class="spinner-border spinner-border-sm" style="width: 16px; height: 16px; display: none;"></div>
            </button>
            
            <p style="font-size: 12px; color: var(--qlower-text-light); margin-top: 12px; text-align: center;">
                <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                Vous serez redirig√© vers la page de paiement s√©curis√©e Stripe
            </p>
        </div>

        <!-- Benefits Section -->
        <div class="qlower-benefits-section">
            <div class="qlower-benefits-grid">
                <div class="qlower-benefit">
                    <div class="qlower-benefit-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h6 class="qlower-benefit-title">Sans engagement</h6>
                    <p class="qlower-benefit-text">R√©siliez √† tout moment depuis votre espace client</p>
                </div>
                <div class="qlower-benefit">
                    <div class="qlower-benefit-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h6 class="qlower-benefit-title">Changement de formule</h6>
                    <p class="qlower-benefit-text">Modifiez votre plan selon vos besoins</p>
                </div>
                <div class="qlower-benefit">
                    <div class="qlower-benefit-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h6 class="qlower-benefit-title">Support client</h6>
                    <p class="qlower-benefit-text">Assistance disponible 7j/7</p>
                </div>
            </div>
        </div>

    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkoutBtn = document.getElementById('checkoutBtn');
    const btnText = document.getElementById('checkoutBtnText');
    const spinner = document.getElementById('checkoutSpinner');
    
    // R√©cup√©rer le type de plan depuis le template
    const planType = '{{ user_plan.plan_type }}';

    checkoutBtn.addEventListener('click', function() {
        console.log('üîÑ D√©but cr√©ation session Stripe pour plan:', planType);
        
        // UI Loading
        this.disabled = true;
        btnText.textContent = 'Redirection vers Stripe...';
        spinner.style.display = 'inline-block';

        // Cr√©er la session de checkout Stripe
        console.log('üì° Envoi requ√™te vers /onboarding/stripe/create-checkout-session');
        fetch('/onboarding/stripe/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                plan_type: planType
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Session expir√©e. Veuillez vous reconnecter.');
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Rediriger vers Stripe Checkout
                btnText.textContent = 'Redirection...';
                window.location.href = data.checkout_url;
            } else {
                throw new Error(data.error || 'Erreur lors de la cr√©ation de la session');
            }
        })
        .catch(error => {
            console.error('Erreur Stripe:', error);
            
            // R√©initialiser le bouton
            checkoutBtn.disabled = false;
            btnText.textContent = 'Proc√©der au paiement s√©curis√©';
            spinner.style.display = 'none';
            
            // V√©rifier si c'est un probl√®me d'authentification
            if (error.message.includes('Unexpected token') || error.message.includes('<!doctype')) {
                alert('Session expir√©e. Vous allez √™tre redirig√© vers la page de connexion.');
                window.location.href = '/plateforme/connexion';
            } else {
                // Afficher l'erreur
                alert('Erreur lors de l\'acc√®s au paiement : ' + error.message);
            }
        })
    });
    
    // Animation d'entr√©e moderne
    const leftSide = document.querySelector('.qlower-payment-left');
    const rightSide = document.querySelector('.qlower-payment-right');
    
    // Animation du c√¥t√© gauche
    leftSide.style.opacity = '0';
    leftSide.style.transform = 'translateX(-30px)';
    leftSide.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    
    // Animation du c√¥t√© droit
    rightSide.style.opacity = '0';
    rightSide.style.transform = 'translateX(30px)';
    rightSide.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    
    setTimeout(() => {
        leftSide.style.opacity = '1';
        leftSide.style.transform = 'translateX(0)';
        
        setTimeout(() => {
            rightSide.style.opacity = '1';
            rightSide.style.transform = 'translateX(0)';
        }, 200);
    }, 100);
});
</script>
{% endblock %}