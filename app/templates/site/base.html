<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Atlas - Votre plateforme patrimoniale digitale{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon-white.png') }}?v=4">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon-white.png') }}?v=4">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- CSS personnalis√© -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('site_pages.index') }}">
                <img src="{{ url_for('static', filename='images/logo-atlas.png') }}" alt="Atlas" height="40" class="me-2" style="filter: brightness(0) invert(1);">
                <span class="d-none d-md-inline">Atlas</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('site_pages.index') }}">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('site_pages.about') }}">√Ä propos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('site_pages.pricing') }}">Tarifs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('site_pages.contact') }}">Contact</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/plateforme/connexion" target="_blank">
                            <i class="fas fa-sign-in-alt me-1"></i>Se connecter
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-outline-light ms-2" href="{{ url_for('platform_auth.register') }}" target="_blank">
                            <i class="fas fa-rocket me-1"></i>Commencer
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-5 pt-4">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Contenu principal -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Popup de prise de rendez-vous -->
    <!-- Modal de prise de RDV avec int√©gration Cal.com -->
    <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="appointmentModalLabel">
                        <i class="fas fa-calendar-alt me-2"></i>Rencontrer votre futur conseiller Atlas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Loader pendant le chargement -->
                    <div id="cal-loader" class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-3 text-muted">Chargement du calendrier...</p>
                    </div>
                    
                    <!-- Container pour Cal.com -->
                    <div id="cal-embed-container" class="d-none">
                        <!-- L'iframe Cal.com sera inject√© ici -->
                    </div>
                    
                    <!-- Fallback en cas d'erreur -->
                    <div id="cal-fallback" class="d-none text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-exclamation-triangle text-warning fs-1 mb-3"></i>
                            <h6 class="fw-bold mb-3">Impossible de charger le calendrier</h6>
                            <p class="text-muted mb-4">
                                Une erreur s'est produite lors du chargement du calendrier int√©gr√©.
                            </p>
                        </div>
                        <div class="d-flex gap-3 justify-content-center">
                            <a href="https://app.cal.com/atlas-finance/30min" 
                               target="_blank" 
                               class="btn btn-primary">
                                <i class="fas fa-external-link-alt me-2"></i>
                                Ouvrir le calendrier
                            </a>
                            <button type="button" 
                                    class="btn btn-secondary" 
                                    onclick="reloadCalEmbed()">
                                <i class="fas fa-redo me-2"></i>
                                R√©essayer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="qlower-footer">
        <div class="qlower-footer-container">
            <div class="qlower-footer-content">
                <div class="qlower-footer-brand">
                    <div class="qlower-footer-logo">
                        <img src="{{ url_for('static', filename='img/logo-atlas.png') }}" alt="Atlas" style="height: 28px; width: auto;">
                    </div>
                    <p class="qlower-footer-description">
                        Votre plateforme patrimoniale digitale. Optimisez vos finances avec nos conseils personnalis√©s.
                    </p>
                    <div class="qlower-footer-social">
                        <a href="#" class="qlower-social-link"><i class="fab fa-linkedin"></i></a>
                        <a href="#" class="qlower-social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="qlower-social-link"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="qlower-social-link"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                
                <div class="qlower-footer-links">
                    <div class="qlower-footer-column">
                        <h6>Produit</h6>
                        <ul>
                            <li><a href="{{ url_for('site_pages.solutions') }}" class="qlower-footer-link">Nos solutions</a></li>
                            <li><a href="{{ url_for('site_pages.pricing') }}" class="qlower-footer-link">Tarifs</a></li>
                            <li><a href="#" class="qlower-footer-link">S√©curit√©</a></li>
                            <li><a href="#" class="qlower-footer-link">Simulateur</a></li>
                        </ul>
                    </div>
                    
                    <div class="qlower-footer-column">
                        <h6>Ressources</h6>
                        <ul>
                            <li><a href="#" class="qlower-footer-link">Blog</a></li>
                            <li><a href="#" class="qlower-footer-link">Guides</a></li>
                            <li><a href="#" class="qlower-footer-link">FAQ</a></li>
                            <li><a href="{{ url_for('site_pages.contact') }}" class="qlower-footer-link">Contact</a></li>
                        </ul>
                    </div>
                    
                    <div class="qlower-footer-column">
                        <h6>Entreprise</h6>
                        <ul>
                            <li><a href="{{ url_for('site_pages.about') }}" class="qlower-footer-link">√Ä propos</a></li>
                            <li><a href="#" class="qlower-footer-link">Devenir Partenaire</a></li>
                            <li><a href="#" class="qlower-footer-link">Carri√®res</a></li>
                            <li><a href="#" class="qlower-footer-link">Presse</a></li>
                        </ul>
                    </div>
                    
                    <div class="qlower-footer-column">
                        <h6>L√©gal</h6>
                        <ul>
                            <li><a href="{{ url_for('site_pages.cgu') }}" class="qlower-footer-link">CGU</a></li>
                            <li><a href="{{ url_for('site_pages.privacy') }}" class="qlower-footer-link">Confidentialit√©</a></li>
                            <li><a href="{{ url_for('site_pages.cookies') }}" class="qlower-footer-link">Cookies</a></li>
                            <li><a href="{{ url_for('site_pages.legal') }}" class="qlower-footer-link">Mentions l√©gales</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="qlower-footer-bottom">
                <p>&copy; {{ 2026 }} Atlas. Tous droits r√©serv√©s.</p>
                <p>
                    <i class="fas fa-shield-alt"></i>
                    Donn√©es s√©curis√©es et crypt√©es
                </p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JS personnalis√© -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- CSS pour l'int√©gration Cal.com -->
    <style>
        /* Modal responsive pour Cal.com */
        #appointmentModal .modal-xl {
            max-width: 95vw;
        }
        
        #appointmentModal .modal-body {
            min-height: 600px;
            position: relative;
        }
        
        /* Container Cal.com */
        #cal-embed-container {
            width: 100%;
            height: 600px;
            position: relative;
        }
        
        #cal-embed-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0 0 8px 8px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            #appointmentModal .modal-xl {
                max-width: 98vw;
                margin: 10px;
            }
            
            #appointmentModal .modal-body {
                min-height: 500px;
            }
            
            #cal-embed-container {
                height: 500px;
            }
            
            #appointmentModal .modal-header {
                padding: 1rem;
            }
            
            #appointmentModal .modal-title {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 576px) {
            #appointmentModal .modal-body {
                min-height: 450px;
            }
            
            #cal-embed-container {
                height: 450px;
            }
        }
        
        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
            padding-right: 0 !important;
        }
        
        /* Loading animation */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Fallback buttons styling */
        #cal-fallback .btn {
            min-width: 180px;
        }
        
        /* Animation pour les notifications */
        .notification-enter {
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>

    <!-- Script pour l'int√©gration Cal.com -->
    <script>
        // Variables globales pour Cal.com
        let calEmbed = null;
        let calLoadTimeout = null;
        const EMBED_TIMEOUT = 10000; // 10 secondes

        document.addEventListener('DOMContentLoaded', function() {
            // Charger Cal.com embed quand le modal s'ouvre
            const appointmentModal = document.getElementById('appointmentModal');
            if (appointmentModal) {
                appointmentModal.addEventListener('show.bs.modal', function() {
                    loadCalEmbed();
                });
                
                appointmentModal.addEventListener('hidden.bs.modal', function() {
                    cleanupCalEmbed();
                });
            }
        });

        // Fonction pour charger l'embed Cal.com
        function loadCalEmbed() {
            const container = document.getElementById('cal-embed-container');
            const loader = document.getElementById('cal-loader');
            const fallback = document.getElementById('cal-fallback');
            
            // Reset des √©tats
            container.classList.add('d-none');
            fallback.classList.add('d-none');
            loader.classList.remove('d-none');
            
            try {
                // Nettoyer le container
                container.innerHTML = '';
                
                // Cr√©er le container Cal.com
                const calDiv = document.createElement('div');
                calDiv.style.width = '100%';
                calDiv.style.height = '100%';
                calDiv.style.overflow = 'scroll';
                calDiv.id = 'my-cal-inline-30min';
                container.appendChild(calDiv);
                
                // Charger le script Cal.com et initialiser l'embed
                (function (C, A, L) { 
                    let p = function (a, ar) { a.q.push(ar); }; 
                    let d = C.document; 
                    C.Cal = C.Cal || function () { 
                        let cal = C.Cal; 
                        let ar = arguments; 
                        if (!cal.loaded) { 
                            cal.ns = {}; 
                            cal.q = cal.q || []; 
                            d.head.appendChild(d.createElement("script")).src = A; 
                            cal.loaded = true; 
                        } 
                        if (ar[0] === L) { 
                            const api = function () { p(api, arguments); }; 
                            const namespace = ar[1]; 
                            api.q = api.q || []; 
                            if(typeof namespace === "string"){
                                cal.ns[namespace] = cal.ns[namespace] || api;
                                p(cal.ns[namespace], ar);
                                p(cal, ["initNamespace", namespace]);
                            } else p(cal, ar); 
                            return;
                        } 
                        p(cal, ar); 
                    }; 
                })(window, "https://app.cal.com/embed/embed.js", "init");
                
                Cal("init", "30min", {origin:"https://app.cal.com"});

                Cal.ns["30min"]("inline", {
                    elementOrSelector:"#my-cal-inline-30min",
                    config: {"layout":"month_view"},
                    calLink: "atlas-finance/30min",
                });

                Cal.ns["30min"]("ui", {
                    "cssVarsPerTheme":{"light":{"cal-brand":"#268290"}},
                    "hideEventTypeDetails":false,
                    "layout":"month_view"
                });
                
                // Masquer le loader et afficher le container apr√®s un court d√©lai
                setTimeout(function() {
                    clearTimeout(calLoadTimeout);
                    loader.classList.add('d-none');
                    container.classList.remove('d-none');
                    console.log('‚úÖ Cal.com embed charg√© avec succ√®s');
                }, 2000);
                
                calEmbed = calDiv;
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la cr√©ation de l\'embed:', error);
                showCalFallback();
            }
            
            // Timeout de s√©curit√©
            calLoadTimeout = setTimeout(function() {
                if (container.classList.contains('d-none')) {
                    showCalFallback();
                    console.warn('‚è∞ Timeout: Cal.com prend trop de temps √† charger');
                }
            }, EMBED_TIMEOUT);
        }

        // Fonction pour afficher le fallback
        function showCalFallback() {
            const container = document.getElementById('cal-embed-container');
            const loader = document.getElementById('cal-loader');
            const fallback = document.getElementById('cal-fallback');
            
            loader.classList.add('d-none');
            container.classList.add('d-none');
            fallback.classList.remove('d-none');
        }

        // Fonction pour r√©essayer le chargement
        function reloadCalEmbed() {
            console.log('üîÑ Rechargement de l\'embed Cal.com...');
            cleanupCalEmbed();
            loadCalEmbed();
        }

        // Fonction pour nettoyer l'embed
        function cleanupCalEmbed() {
            if (calLoadTimeout) {
                clearTimeout(calLoadTimeout);
                calLoadTimeout = null;
            }
            
            const container = document.getElementById('cal-embed-container');
            if (container) {
                container.innerHTML = '';
            }
            
            // Nettoyer les objets Cal.com globaux
            if (window.Cal && window.Cal.ns && window.Cal.ns["30min"]) {
                try {
                    // Essayer de nettoyer l'instance Cal.com
                    delete window.Cal.ns["30min"];
                } catch (e) {
                    console.warn('Erreur lors du nettoyage Cal.com:', e);
                }
            }
            
            calEmbed = null;
            console.log('üßπ Cal.com embed nettoy√©');
        }

        // Fonction pour afficher les notifications
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="${iconClass} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Supprimer automatiquement apr√®s 5 secondes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Gestion du message de booking r√©ussi (optionnel)
        window.addEventListener('message', function(e) {
            if (e.origin === 'https://cal.com') {
                if (e.data.type === 'booking_completed') {
                    console.log('üéâ Rendez-vous r√©serv√© avec succ√®s!');
                    showNotification('Rendez-vous r√©serv√© avec succ√®s! Vous allez recevoir un email de confirmation.', 'success');
                    
                    // Fermer le modal apr√®s 2 secondes
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
                        if (modal) modal.hide();
                    }, 2000);
                }
            }
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
